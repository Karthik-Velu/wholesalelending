<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KI Product Demo - India</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .view { display: none; }
        .view.active { display: block; }
        .page-view { display: none; }
        .page-view.active { display: block; }
        .home-tab-content { display: none; }
        .home-tab-content.active { display: block; }
        .sub-step { display: none; }
        .sub-step.active { display: block; }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active { background-color: #14b8a6; color: white; }
        .home-tab-link { transition: all 0.2s ease-in-out; border-bottom: 2px solid transparent; }
        .home-tab-link.active { border-color: #14b8a6; color: #0f766e; font-weight: 600; }
        .ki-score-link { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #14b8a6; cursor: pointer; border-radius: 50%; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #14b8a6; cursor: pointer; border-radius: 50%; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #14b8a6; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen flex flex-col">
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-3">
                        <button id="homeBtn">
                             <svg width="150" height="40" viewBox="0 0 264 69" fill="none" xmlns="http://www.w3.org/2000/svg"> 
                                 <path d="M0 28.6165L29.6939 14.0607V25.7053L0 40.2611V28.6165Z" fill="#0F547E"/> 
                                 <path d="M0 40.5523L29.6939 55.1081V43.4634L0 28.9076V40.5523Z" fill="#28B2B6"/> 
                                 <path d="M67.9042 27.1169L57.14 38.4274L68.1228 54H59.2164L52.1131 43.7276L49.1079 46.8967V54H41.8407V14.4402H49.1079V37.1161L58.3967 27.1169H67.9042ZM66.8046 46.6782C66.8046 44.3833 67.5513 42.5437 69.0448 41.1595C70.5383 39.7752 72.469 38.901 74.8367 38.5367L81.4482 37.5532C82.796 37.3711 83.4699 36.7336 83.4699 35.6408C83.4699 34.6208 83.0692 33.783 82.2678 33.1273C81.5029 32.4716 80.3918 32.1438 78.9348 32.1438C77.4048 32.1438 76.1845 32.5627 75.2738 33.4005C74.3996 34.2383 73.9078 35.2765 73.7985 36.515L67.351 35.149C67.6059 32.8177 68.7534 30.7596 70.7933 28.9746C72.8332 27.1897 75.5288 26.2972 78.8801 26.2972C82.8871 26.2972 85.8377 27.2626 87.7319 29.1932C89.6261 31.0874 90.5732 33.528 90.5732 36.515V49.738C90.5732 51.3408 90.6825 52.7615 90.901 54H84.2349C84.0528 53.1986 83.9617 52.124 83.9617 50.7762C82.2496 53.4354 79.6087 54.765 76.0388 54.765C73.2704 54.765 71.0301 53.9636 69.318 52.3608C67.6424 50.758 66.8046 48.8638 66.8046 46.6782ZM77.5687 49.3556C79.2808 49.3556 80.6833 48.882 81.7761 47.9349C82.9053 46.9514 83.4699 45.3486 83.4699 43.1265V41.9244L77.4048 42.8533C75.1828 43.1812 74.0717 44.3104 74.0717 46.241C74.0717 47.1153 74.3814 47.862 75.0006 48.4813C75.6199 49.0641 76.4759 49.3556 77.5687 49.3556ZM101.887 54H94.62V14.4402H101.887V54ZM111.689 37.4986H123.71C123.637 36.005 123.091 34.7483 122.071 33.7284C121.087 32.7084 119.63 32.1984 117.7 32.1984C115.951 32.1984 114.531 32.7448 113.438 33.8376C112.345 34.9305 111.762 36.1508 111.689 37.4986ZM124.42 44.4925L130.486 46.2957C129.757 48.7727 128.318 50.8126 126.169 52.4154C124.056 54.0182 121.415 54.8196 118.246 54.8196C114.385 54.8196 111.106 53.5264 108.411 50.9401C105.715 48.3174 104.367 44.8204 104.367 40.4491C104.367 36.2965 105.679 32.9088 108.301 30.286C110.924 27.6268 114.021 26.2972 117.59 26.2972C121.743 26.2972 124.985 27.5358 127.316 30.0128C129.684 32.4898 130.868 35.8958 130.868 40.2306C130.868 40.522 130.85 40.8498 130.813 41.2141C130.813 41.5784 130.813 41.8698 130.813 42.0884L130.759 42.4708H111.525C111.598 44.2193 112.29 45.6764 113.602 46.8421C114.913 48.0078 116.479 48.5906 118.301 48.5906C121.397 48.5906 123.437 47.2246 124.42 44.4925ZM140.58 54H133.312V27.1169H140.58V54ZM132.438 18.3197C132.438 17.0812 132.875 16.0248 133.749 15.1506C134.624 14.2399 135.68 13.7846 136.919 13.7846C138.157 13.7846 139.214 14.2217 140.088 15.0959C140.962 15.9702 141.399 17.0448 141.399 18.3197C141.399 19.5218 140.962 20.56 140.088 21.4342C139.214 22.3085 138.157 22.7456 136.919 22.7456C135.68 22.7456 134.624 22.3085 133.749 21.4342C132.875 20.56 132.438 19.5218 132.438 18.3197ZM170.708 14.4402V49.137C170.708 50.9219 170.781 52.5429 170.926 54H163.987C163.805 53.0893 163.714 52.0512 163.714 50.8855C163.095 52.0147 162.111 52.9254 160.763 53.6175C159.452 54.3096 157.922 54.6557 156.173 54.6557C152.349 54.6557 149.198 53.3261 146.721 50.6669C144.28 47.9713 143.06 44.5836 143.06 40.5038C143.06 36.5332 144.262 33.2002 146.666 30.5046C149.107 27.809 152.203 26.4612 155.955 26.4612C159.816 26.4612 162.348 27.5722 163.55 29.7942V14.4402H170.708ZM150.382 40.5038C150.382 42.8715 151.001 44.7475 152.239 46.1318C153.478 47.4796 155.081 48.1535 157.048 48.1535C158.978 48.1535 160.563 47.4613 161.801 46.0771C163.04 44.6929 163.659 42.8169 163.659 40.4491C163.659 38.1178 163.04 36.2965 161.801 34.9851C160.563 33.6373 158.978 32.9634 157.048 32.9634C155.117 32.9634 153.514 33.6373 152.239 34.9851C151.001 36.3329 150.382 38.1725 150.382 40.5038ZM182.526 46.1864C183.873 47.5342 185.494 48.2081 187.389 48.2081C189.283 48.2081 190.886 47.5342 192.197 46.1864C193.545 44.8386 194.219 42.9626 194.219 40.5584C194.219 38.1542 193.545 36.2783 192.197 34.9305C190.886 33.5827 189.283 32.9088 187.389 32.9088C185.494 32.9088 183.873 33.5827 182.526 34.9305C181.214 36.2783 180.558 38.1542 180.558 40.5584C180.558 42.9626 181.214 44.8386 182.526 46.1864ZM177.28 30.3406C179.976 27.645 183.345 26.2972 187.389 26.2972C191.432 26.2972 194.783 27.645 197.442 30.3406C200.138 33.0362 201.486 36.4422 201.486 40.5584C201.486 44.6747 200.138 48.0806 197.442 50.7762C194.783 53.4718 191.432 54.8196 187.389 54.8196C183.345 54.8196 179.976 53.4718 177.28 50.7762C174.621 48.0806 173.291 44.6747 173.291 40.5584C173.291 36.4422 174.621 33.0362 177.28 30.3406Z" fill="#0F547E"/> 
                                 <path d="M223.396 33.3459H212.632V54H205.31V33.3459H200.829V27.1169H205.31V24.057C205.31 21.0335 206.184 18.6111 207.933 16.7898C209.717 14.9684 212.103 14.0578 215.09 14.0578C216.693 14.0578 217.895 14.2399 218.697 14.6042V20.7239C218.077 20.5418 217.312 20.4507 216.402 20.4507C215.418 20.4507 214.544 20.7421 213.779 21.325C213.014 21.8714 212.632 22.8185 212.632 24.1663V27.1169H230.608V54H223.396V33.3459ZM223.833 21.4342C222.959 20.56 222.522 19.5036 222.522 18.2651C222.522 17.0266 222.959 15.9702 223.833 15.0959C224.707 14.1853 225.764 13.7299 227.002 13.7299C228.241 13.7299 229.297 14.1853 230.171 15.0959C231.045 15.9702 231.483 17.0266 231.483 18.2651C231.483 19.5036 231.045 20.56 230.171 21.4342C229.297 22.2721 228.241 22.691 227.002 22.691C225.764 22.691 224.707 22.2721 223.833 21.4342ZM242.403 38.5367V54H235.136V27.1169H242.184V30.4499C242.949 29.1386 244.042 28.1368 245.463 27.4447C246.884 26.7526 248.377 26.4065 249.943 26.4065C253.113 26.4065 255.517 27.4083 257.156 29.4118C258.832 31.3788 259.669 33.9287 259.669 37.0614V54H252.402V38.3182C252.402 36.7154 251.983 35.4222 251.146 34.4387C250.344 33.4552 249.106 32.9634 247.43 32.9634C245.9 32.9634 244.68 33.4916 243.769 34.548C242.858 35.6044 242.403 36.9339 242.403 38.5367Z" fill="#28B2B6"/> 
                             </svg>
                        </button>
                    </div>
                    <div class="bg-gray-100 p-1 rounded-lg flex space-x-1">
                        <button id="dealScreenBtn" class="nav-link active px-4 py-1.5 text-sm font-semibold rounded-md">KI DealScreen</button>
                        <button id="dealTrackBtn" class="nav-link px-4 py-1.5 text-sm font-semibold rounded-md">KI DealTrack</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow">
            <div id="dealScreenView" class="view active">
                <div id="dealScreenHomePage" class="page-view active">
                    <div class="bg-white border-b">
                        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                            <nav id="homeTabsNav" class="flex space-x-8 -mb-px">
                                <button data-tab="originators" class="home-tab-link active py-4 px-1 text-sm font-medium">Originators</button>
                                <button data-tab="transactions" class="home-tab-link py-4 px-1 text-sm font-medium">Transactions</button>
                            </nav>
                        </div>
                    </div>
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div id="originatorsTab" class="home-tab-content active">
                            <div class="flex justify-between items-center mb-6">
                                <h1 class="text-2xl font-bold text-gray-800">Onboarded Originators</h1>
                                <button id="addNewOriginatorBtn" class="bg-teal-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-teal-700 text-sm">Add New Originator</button>
                            </div>
                            <div class="bg-white p-5 rounded-lg border shadow-sm">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left text-gray-500">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3">Originator Name</th>
                                                <th scope="col" class="px-6 py-3">KI Score Grade</th>
                                                <th scope="col" class="px-6 py-3">GNPA %</th>
                                                <th scope="col" class="px-6 py-3">Avg. Yield</th>
                                                <th scope="col" class="px-6 py-3">Overall AUM (INR)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="originatorsTableBody">
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div id="transactionsTab" class="home-tab-content">
                             <div class="flex justify-between items-center mb-6">
                                <h1 class="text-2xl font-bold text-gray-800">Transactions</h1>
                                <button id="createNewTransactionBtn" class="bg-teal-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-teal-700 text-sm">Create New Transaction</button>
                            </div>
                            <div class="mb-8">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">Active Transactions</h2>
                                <div class="bg-white p-5 rounded-lg border shadow-sm">
                                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Search</label>
                                            <input type="text" placeholder="e.g., FMF-TW-001" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Originator</label>
                                            <select class="mt-1 block w-full rounded-md border-gray-300 py-2 shadow-sm sm:text-sm">
                                                <option>All</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Structure</label>
                                            <select class="mt-1 block w-full rounded-md border-gray-300 py-2 shadow-sm sm:text-sm">
                                                <option>All</option>
                                                <option>Term Loan</option>
                                                <option>Securitisation</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Status</label>
                                            <select class="mt-1 block w-full rounded-md border-gray-300 py-2 shadow-sm sm:text-sm">
                                                <option>All</option>
                                                <option>Active</option>
                                                <option>Covenant Setup</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-left text-gray-500">
                                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                                <tr>
                                                    <th scope="col" class="px-6 py-3">Transaction Name</th>
                                                    <th scope="col" class="px-6 py-3">Originator</th>
                                                    <th scope="col" class="px-6 py-3">Structure</th>
                                                    <th scope="col" class="px-6 py-3">KI Score Grade</th>
                                                    <th scope="col" class="px-6 py-3">Avg. Tenure</th>
                                                    <th scope="col" class="px-6 py-3">Pool Yield</th>
                                                    <th scope="col" class="px-6 py-3 text-center">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="activeTransactionsTableBody">
                                                </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">Available Transactions</h2>
                                 <div class="bg-white p-5 rounded-lg border shadow-sm">
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Search</label>
                                            <input type="text" placeholder="e.g., Agri-Finance Jun 2025" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Originator</label>
                                            <select class="mt-1 block w-full rounded-md border-gray-300 py-2 shadow-sm sm:text-sm">
                                                <option>All</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Asset Class</label>
                                            <select class="mt-1 block w-full rounded-md border-gray-300 py-2 shadow-sm sm:text-sm">
                                                <option>All</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-left text-gray-500">
                                             <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                                <tr>
                                                    <th scope="col" class="px-6 py-3">Portfolio Name</th>
                                                    <th scope="col" class="px-6 py-3">Originator</th>
                                                    <th scope="col" class="px-6 py-3">Asset Class</th>
                                                    <th scope="col" class="px-6 py-3">Pool Size (INR)</th>
                                                    <th scope="col" class="px-6 py-3">Avg. Tenure</th>
                                                    <th scope="col" class="px-6 py-3">Historical GNPA %</th>
                                                    <th scope="col" class="px-6 py-3 text-center">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="availablePortfoliosTableBody">
                                                </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="originatorOnboardingPage" class="page-view">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-2xl font-bold text-gray-800">Originator Onboarding & Analysis</h1>
                            <button class="back-btn bg-white text-gray-700 border border-gray-300 px-5 py-2 rounded-lg font-semibold hover:bg-gray-50 text-sm">← Back</button>
                        </div>
                        <div id="originatorUpload" class="max-w-2xl mx-auto text-center">
                            <div class="p-6 border-2 border-dashed border-gray-300 rounded-lg bg-white">
                                <p class="font-semibold mb-2">Upload Files</p>
                                <p class="text-sm text-gray-500 mb-4">Drag & drop or click to upload MIS portfolio report and financial statements.</p>
                                <button id="uploadOriginatorFilesBtn" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700">Upload & Analyze</button>
                            </div>
                        </div>
                        <div id="originatorAnalyzing" class="hidden max-w-2xl mx-auto text-center">
                            <div class="p-6 border border-gray-200 bg-white rounded-lg shadow-sm">
                                <p class="font-semibold mb-4">Analyzing Uploaded Files...</p>
                                <div class="space-y-3 text-left">
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                        <span class="text-sm font-medium text-gray-700">MIS_Portfolio_Jun2025.csv</span>
                                        <span class="text-sm text-green-600 font-semibold">✓ Uploaded</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                        <span class="text-sm font-medium text-gray-700">Audited_Financials_2024.pdf</span>
                                        <span class="text-sm text-green-600 font-semibold">✓ Uploaded</span>
                                    </div>
                                </div>
                                <div class="flex justify-center mt-6">
                                    <div class="spinner"></div>
                                </div>
                            </div>
                        </div>
                        <div id="originatorAnalysisResult" class="hidden mt-8 space-y-8">
                             <div class="max-w-2xl mx-auto bg-white p-4 rounded-lg border mb-6 text-center shadow-sm">
                                <h3 class="text-xl font-bold text-gray-800" id="analysisOriginatorName"></h3>
                                <p class="text-sm text-gray-500" id="analysisOriginatorCategory"></p>
                            </div>
                             <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
                                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-gray-500">Total AUM</p><p id="analysisAum" class="text-xl font-bold text-gray-800">₹5,000 Cr</p></div>
                                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-gray-500">Avg. Loan Size</p><p class="text-xl font-bold text-gray-800">₹1.25 Lakh</p></div>
                                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-gray-500">GNPA</p><p id="analysisPar" class="text-xl font-bold text-red-600">4.2%</p></div>
                                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-gray-500">Avg. Tenure</p><p class="text-xl font-bold text-gray-800">22 Months</p></div>
                                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-gray-500">Avg. Yield</p><p id="analysisYield" class="text-xl font-bold text-green-600">24.5%</p></div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <div class="bg-white p-4 rounded-lg border"><h3 class="font-semibold text-center mb-2">Asset-Class Distribution</h3><div class="chart-container h-48"><canvas id="assetClassDistChart"></canvas></div></div>
                                <div class="bg-white p-4 rounded-lg border"><h3 class="font-semibold text-center mb-2">Geographical Distribution</h3><div class="chart-container h-48"><canvas id="geographicalDistChart"></canvas></div></div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg border lg:col-span-1 mb-6">
                                <h3 class="font-semibold text-center mb-2">KI Score Grade</h3>
                                <div class="text-center mt-4">
                                    <p class="text-5xl font-bold text-teal-600"><button id="analysisKiScore" class="ki-score-link" data-score-type="originator" data-name=""></button></p>
                                </div>
                            </div>

                            <div id="originatorInsightsContainer" class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="bg-white p-4 rounded-lg border"><h3 class="font-semibold text-center mb-2">30+ DPD by Asset Class</h3><div class="chart-container h-64"><canvas id="delinquencyByAssetClass30"></canvas></div></div>
                                <div class="bg-white p-4 rounded-lg border"><h3 class="font-semibold text-center mb-2">90+ DPD (GNPA) by Asset Class</h3><div class="chart-container h-64"><canvas id="delinquencyByAssetClass90"></canvas></div></div>
                                <div class="bg-white p-4 rounded-lg border"><h3 class="font-semibold text-center mb-2">Portfolio Growth (AUM)</h3><div class="chart-container h-64"><canvas id="portfolioGrowthChart"></canvas></div></div>
                                <div class="bg-white p-4 rounded-lg border"><h3 class="font-semibold text-center mb-2">Yield vs. Cost of Funds</h3><div class="chart-container h-64"><canvas id="yieldVsCofChart"></canvas></div></div>
                            </div>
                             <div class="text-center mt-8">
                                <button id="onboardOriginatorBtn" class="bg-teal-600 text-white px-8 py-2.5 rounded-lg font-semibold hover:bg-teal-700">Onboard Originator</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="transactionTypePage" class="page-view">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                         <div class="flex justify-between items-center mb-8">
                            <h1 class="text-2xl font-bold text-gray-800">Create New Transaction</h1>
                             <button class="back-btn bg-white text-gray-700 border border-gray-300 px-5 py-2 rounded-lg font-semibold hover:bg-gray-50 text-sm">← Back</button>
                        </div>
                        <div class="max-w-md mx-auto text-center">
                            <p class="text-gray-600 mb-8">Please select the type of transaction you would like to create.</p>
                            <div class="space-y-4">
                                <button data-tx-type="Securitisation" class="tx-type-select-btn w-full bg-teal-600 text-white p-4 rounded-lg font-semibold text-lg hover:bg-teal-700">Securitisation</button>
                                <button data-tx-type="Term Loan" class="tx-type-select-btn w-full bg-white border border-gray-300 text-gray-700 p-4 rounded-lg font-semibold text-lg hover:bg-gray-50">Term Loan</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="poolCreationPage" class="page-view">
                     <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div id="poolUploadSubStep" class="sub-step active">
                             <div class="flex justify-between items-center mb-8">
                                <h1 class="text-2xl font-bold text-gray-800">Pool Creation: Upload & Map</h1>
                                <button class="back-btn bg-white text-gray-700 border border-gray-300 px-5 py-2 rounded-lg font-semibold hover:bg-gray-50 text-sm">← Back</button>
                            </div>
                            <div class="max-w-2xl mx-auto text-center">
                                 <p class="mt-1 text-gray-600 mb-4">Upload and map the pool file to begin the validation process.</p>
                                <div class="p-6 border-2 border-dashed border-gray-300 rounded-lg bg-white">
                                    <p class="font-semibold mb-2">Upload Pool File (.csv)</p>
                                    <div class="mt-4 flex justify-center items-center space-x-4">
                                        <select class="block rounded-md border-gray-300 shadow-sm"><option>Select Asset Class</option><option selected>Two-Wheeler Loans</option><option>Agri-Finance</option></select>
                                        <button id="uploadPoolBtn" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700">Upload & Map</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="poolMappingSubStep" class="sub-step">
                             <div class="max-w-4xl mx-auto bg-white border border-gray-200 p-6 rounded-lg">
                                <h4 class="font-bold text-gray-800 text-lg">Map Pool File Columns</h4>
                                <p class="text-sm text-gray-600 mt-1">Map the columns from your uploaded file to the required KI fields.</p>
                                <div id="mappingFieldsContainer" class="mt-4 space-y-3">
                                    <div class="grid grid-cols-2 gap-4"><span class="font-medium text-gray-500">Your File Column</span><span class="font-medium text-gray-500">KI Required Field</span></div>
                                    </div>
                                <div class="text-center mt-6">
                                    <button id="validateMappedPoolBtn" class="bg-teal-600 text-white px-8 py-2.5 rounded-lg font-semibold hover:bg-teal-700">Validate Pool</button>
                                </div>
                            </div>
                        </div>
                        <div id="poolValidationErrorSubStep" class="sub-step">
                            <div class="max-w-3xl mx-auto bg-red-50 border border-red-200 p-4 rounded-lg">
                                <h4 class="font-bold text-red-800">Validation Complete: Errors Found</h4>
                                <p class="text-sm text-red-700 mt-1">15,000 loans processed. 250 loans have data errors.</p>
                                <div class="mt-2 text-xs bg-white p-2 rounded border text-red-900">
                                    <p>Row 15: Invalid disbursement date format '2025/01/15'. Expected YYYY-MM-DD.</p>
                                    <p>Row 42: Principal amount is negative (-50000).</p>
                                </div>
                                <div class="mt-4 flex space-x-4">
                                    <button class="bg-red-600 text-white px-4 py-1.5 text-sm rounded-md font-semibold">Download Full Error File</button>
                                    <button id="reuploadPoolBtn" class="border border-gray-400 text-gray-700 px-4 py-1.5 text-sm rounded-md font-semibold">Re-upload Corrected File</button>
                                </div>
                            </div>
                        </div>
                        <div id="poolStructuringSubStep" class="sub-step">
                            <div class="text-center mb-8">
                                <h1 class="text-2xl font-bold text-gray-800">Simulations and Structuring</h1>
                                <p class="mt-1 text-gray-600">Apply filters and structure the deal to simulate outcomes.</p>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-1 bg-white p-6 rounded-lg border space-y-6">
                                    <div>
                                        <h4 class="font-semibold mb-3">Pool Filters</h4>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">KI Score Range (1-100, lower is better): <span id="kiScoreMinLabel" class="font-bold text-teal-600">1</span> - <span id="kiScoreMaxLabel" class="font-bold text-teal-600">40</span></label>
                                                <div class="flex space-x-2"><input id="kiScoreMinSlider" type="range" min="1" max="100" value="1"><input id="kiScoreMaxSlider" type="range" min="1" max="100" value="40"></div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Loan Amount (INR): <span id="loanAmountMinLabel" class="font-bold text-teal-600">₹50k</span> - <span id="loanAmountMaxLabel" class="font-bold text-teal-600">₹200k</span></label>
                                                <div class="flex space-x-2"><input id="loanAmountMinSlider" type="range" min="10000" max="250000" step="10000" value="50000"><input id="loanAmountMaxSlider" type="range" min="10000" max="250000" step="10000" value="200000"></div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Residual Tenure (Months): <span id="tenureMinLabel" class="font-bold text-teal-600">6</span> - <span id="tenureMaxLabel" class="font-bold text-teal-600">24</span></label>
                                                <div class="flex space-x-2"><input id="tenureMinSlider" type="range" min="1" max="48" value="6"><input id="tenureMaxSlider" type="range" min="1" max="48" value="24"></div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Loan Interest Rate (%): <span id="interestRateMinLabel" class="font-bold text-teal-600">18%</span> - <span id="interestRateMaxLabel" class="font-bold text-teal-600">30%</span></label>
                                                <div class="flex space-x-2"><input id="interestRateMinSlider" type="range" min="12" max="36" value="18"><input id="interestRateMaxSlider" type="range" min="12" max="36" value="30"></div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">States</label>
                                                <select id="countiesMultiSelect" multiple></select>
                                            </div>
                                            <div class="pt-2"><button id="applyFiltersBtn" class="w-full bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-700 text-sm">Apply Pool Filters</button></div>
                                        </div>
                                    </div>
                                    <div class="border-t pt-6">
                                        <h4 class="font-semibold mb-3">Deal Structure</h4>
                                        <div class="space-y-4">
                                             <div class="border rounded-lg p-3 bg-gray-50 text-sm">
                                                <div class="grid grid-cols-2 gap-2">
                                                    <span>India 2-Year G-Sec:</span><span class="font-bold" id="baseYield">7.2%</span>
                                                    <span>Senior Risk Premium:</span><span class="font-bold" id="seniorRiskPremium">2.5%</span>
                                                    <span>Mezzanine Risk Premium:</span><span class="font-bold" id="mezzRiskPremium">6.0%</span>
                                                </div>
                                            </div>
                                            <div class="border rounded-lg p-3">
                                                <p class="font-semibold text-teal-700">Senior Tranche</p>
                                                <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                                    <label>Size (%):</label><input type="number" value="80" class="border-gray-300 rounded-md shadow-sm w-full">
                                                    <label>Coupon (%):</label><input type="number" value="9.5" class="border-gray-300 rounded-md shadow-sm w-full">
                                                    <label>Suggested Yield:</label><span id="seniorYield" class="font-bold text-green-600">9.7%</span>
                                                </div>
                                            </div>
                                            <div class="border rounded-lg p-3">
                                                <p class="font-semibold text-teal-700">Mezzanine Tranche</p>
                                                <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                                    <label>Size (%):</label><input type="number" value="12" class="border-gray-300 rounded-md shadow-sm w-full">
                                                    <label>Coupon (%):</label><input type="number" value="13" class="border-gray-300 rounded-md shadow-sm w-full">
                                                    <label>Suggested Yield:</label><span id="mezzYield" class="font-bold text-green-600">13.2%</span>
                                                </div>
                                            </div>
                                             <div class="border rounded-lg p-3">
                                                <p class="font-semibold text-teal-700">Equity Tranche</p>
                                                <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                                    <label>Size (%):</label><input type="number" value="8" class="border-gray-300 rounded-md shadow-sm w-full" disabled>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="border-t pt-6">
                                        <h4 class="font-semibold mb-3">Sensitivity Analysis</h4>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Expected Loss Rate (%): <span id="sensitivityLossLabel" class="font-bold text-red-600">4.1%</span></label>
                                                <input id="sensitivityLossSlider" type="range" min="2" max="10" step="0.1" value="4.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Prepayment Rate (%): <span id="sensitivityPrepaymentLabel" class="font-bold text-blue-600">8.0%</span></label>
                                                <input id="sensitivityPrepaymentSlider" type="range" min="0" max="20" step="0.5" value="8.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                            </div>
                                            <div class="pt-2"><button id="runSensitivitySimulationBtn" class="w-full bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700 text-sm">Run Simulation</button></div>
                                        </div>
                                    </div>
                                </div>
                                <div id="simulationResultsPanel" class="lg:col-span-2 bg-white p-6 rounded-lg border space-y-6 hidden">
                                    <h4 class="font-semibold text-center">Simulation Results</h4>
                                    <p id="simulationOriginatorName" class="text-center text-sm text-gray-600 -mt-2"></p>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                                        <div class="bg-gray-50 p-3 rounded-md"><p class="text-sm text-gray-500">Transaction Grade</p><p id="poolGrade" class="text-xl font-bold text-teal-600"><button class="ki-score-link" data-score-type="pool" data-name="Simulated Pool">AA-</button></p></div>
                                        <div class="bg-gray-50 p-3 rounded-md"><p class="text-sm text-gray-500">Selected Loans</p><p id="selectedLoans" class="text-xl font-bold text-teal-600">9,540</p></div>
                                        <div class="bg-gray-50 p-3 rounded-md"><p class="text-sm text-gray-500">Pool Value (INR)</p><p id="poolValue" class="text-xl font-bold text-teal-600">₹98 Cr</p></div>
                                        <div class="bg-gray-50 p-3 rounded-md"><p class="text-sm text-gray-500">W.A. Tenure</p><p id="poolTenure" class="text-xl font-bold text-teal-600">18 mo</p></div>
                                        <div class="bg-gray-50 p-3 rounded-md"><p class="text-sm text-gray-500">W.A. KI Score</p><p id="poolKiScore" class="text-xl font-bold text-teal-600">25</p></div>
                                        <div class="bg-gray-50 p-3 rounded-md"><p class="text-sm text-gray-500">Estimated Loss</p><p id="estimatedLoss" class="text-xl font-bold text-red-600">4.1%</p></div>
                                    </div>
                                    <div class="border-t pt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="chart-container h-56"><canvas id="geoConcentrationChart"></canvas></div>
                                        <div class="chart-container h-56"><canvas id="kiScoreDistChart"></canvas></div>
                                        
                                        <div class="md:col-span-2 border-t pt-4 mt-4">
                                            <h4 class="font-semibold text-center text-gray-700 mb-4">Estimated Loss Rate by Filter</h4>
                                            <div class="overflow-x-auto">
                                                <table class="w-full text-sm text-left text-gray-500">
                                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                                        <tr>
                                                            <th scope="col" class="px-4 py-2">Filter</th>
                                                            <th scope="col" class="px-4 py-2">Selected Bucket</th>
                                                            <th scope="col" class="px-4 py-2 text-right">Bucket Loss Rate</th>
                                                            <th scope="col" class="px-4 py-2 text-right">Overall Portfolio Rate</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr class="bg-white border-b">
                                                            <td class="px-4 py-2 font-medium text-gray-900">Loan Tenure</td>
                                                            <td id="lossCompTenureBucket" class="px-4 py-2"></td>
                                                            <td id="lossCompTenureBucketRate" class="px-4 py-2 text-right font-semibold text-green-600"></td>
                                                            <td id="lossCompTenureOverallRate" class="px-4 py-2 text-right"></td>
                                                        </tr>
                                                        <tr class="bg-white border-b">
                                                            <td class="px-4 py-2 font-medium text-gray-900">Loan Amount</td>
                                                            <td id="lossCompAmountBucket" class="px-4 py-2"></td>
                                                            <td id="lossCompAmountBucketRate" class="px-4 py-2 text-right font-semibold text-green-600"></td>
                                                            <td id="lossCompAmountOverallRate" class="px-4 py-2 text-right"></td>
                                                        </tr>
                                                        <tr class="bg-white border-b">
                                                            <td class="px-4 py-2 font-medium text-gray-900">Interest Rate</td>
                                                            <td id="lossCompInterestBucket" class="px-4 py-2"></td>
                                                            <td id="lossCompInterestBucketRate" class="px-4 py-2 text-right font-semibold text-green-600"></td>
                                                            <td id="lossCompInterestOverallRate" class="px-4 py-2 text-right"></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="text-center mt-4 bg-gray-100 p-3 rounded-md">
                                                <p class="text-sm font-medium text-gray-600">Overall Estimated Loss for Selected Pool</p>
                                                <p id="overallEstimatedLoss" class="text-xl font-bold text-red-600"></p>
                                            </div>
                                        </div>

                                        <div class="md:col-span-2 chart-container h-64"><canvas id="waterfallChart"></canvas></div>
                                    </div>
                                    <div class="border-t pt-6 text-center space-x-3">
                                        <button id="finalizePoolBtn" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700">Finalize Pool</button>
                                        <button class="border border-gray-400 text-gray-700 px-6 py-2 rounded-lg font-semibold">Download Schedules</button>
                                    </div>
                                </div>
                            </div>
                            <div id="sensitivityModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50">
                                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-lg font-bold">Sensitivity Analysis Results</h3>
                                        <button id="closeSensitivityModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-4">Impact of changing the Expected Loss Rate from <span id="baseLossRate" class="font-bold"></span> to <span id="stressedLossRate" class="font-bold"></span>.</p>
                                    <table class="w-full text-sm text-left">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2">Tranche</th>
                                                <th class="px-4 py-2 text-right">Base Case Cashflow (INR Cr)</th>
                                                <th class="px-4 py-2 text-right">Stressed Case Cashflow (INR Cr)</th>
                                                <th class="px-4 py-2 text-right">Impact (INR Cr)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="border-b">
                                                <td class="px-4 py-2 font-medium">Senior Tranche</td>
                                                <td id="baseSenior" class="px-4 py-2 text-right"></td>
                                                <td id="stressedSenior" class="px-4 py-2 text-right"></td>
                                                <td id="impactSenior" class="px-4 py-2 text-right text-green-600"></td>
                                            </tr>
                                            <tr class="border-b">
                                                <td class="px-4 py-2 font-medium">Mezzanine Tranche</td>
                                                <td id="baseMezz" class="px-4 py-2 text-right"></td>
                                                <td id="stressedMezz" class="px-4 py-2 text-right"></td>
                                                <td id="impactMezz" class="px-4 py-2 text-right text-green-600"></td>
                                            </tr>
                                            <tr class="bg-red-50">
                                                <td class="px-4 py-2 font-bold text-red-800">Equity Tranche</td>
                                                <td id="baseEquity" class="px-4 py-2 text-right font-bold"></td>
                                                <td id="stressedEquity" class="px-4 py-2 text-right font-bold text-red-800"></td>
                                                <td id="impactEquity" class="px-4 py-2 text-right font-bold text-red-800"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="poolDetailsPage" class="page-view">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold text-gray-800">Loan Listing for <span id="poolDetailsTitle"></span></h1>
                            <button id="poolDetailsBackBtn" class="bg-white text-gray-700 border border-gray-300 px-5 py-2 rounded-lg font-semibold hover:bg-gray-50 text-sm">← Back</button>
                        </div>
                        <div class="bg-white p-5 rounded-lg border shadow-sm">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Loan ID</th>
                                            <th scope="col" class="px-6 py-3">Principal (INR)</th>
                                            <th scope="col" class="px-6 py-3">Tenure (Mo)</th>
                                            <th scope="col" class="px-6 py-3">Location</th>
                                            <th scope="col" class="px-6 py-3">Loan Cycle</th>
                                            <th scope="col" class="px-6 py-3">Interest Rate</th>
                                            <th scope="col" class="px-6 py-3">KI Score (1-100)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="loanListingTableBody">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="kiScoreDetailsPage" class="page-view">
                     <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold text-gray-800" id="kiScoreDetailsTitle"></h1>
                            <button class="back-btn bg-white text-gray-700 border border-gray-300 px-5 py-2 rounded-lg font-semibold hover:bg-gray-50 text-sm">← Back</button>
                        </div>
                        <div class="bg-white p-6 rounded-lg border shadow-sm mb-8">
                            <h2 class="text-lg font-semibold text-gray-800 mb-3">Top Contributors to Score</h2>
                            <div id="kiScoreContributors" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                </div>
                        </div>
                        <div id="kiScoreVariables" class="space-y-6">
                           </div>
                    </div>
                </div>
            </div>

            <div id="dealTrackView" class="view">
                 <div class="bg-white border-b">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                        <nav id="dealTrackNav" class="flex space-x-8 -mb-px">
                            <button data-track-view="covenantMonitoring" class="home-tab-link py-4 px-1 text-sm font-medium">Covenant Monitoring</button>
                            <button data-track-view="reports" class="home-tab-link py-4 px-1 text-sm font-medium">Reports</button>
                            <button data-track-view="insights" class="home-tab-link py-4 px-1 text-sm font-medium">Insights</button>
                            <button data-track-view="performance" class="home-tab-link py-4 px-1 text-sm font-medium">Performance</button>
                            <button data-track-view="impact" class="home-tab-link py-4 px-1 text-sm font-medium">Impact</button>
                        </nav>
                    </div>
                </div>
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div id="covenantSetupPage" class="page-view">
                        <div class="max-w-4xl mx-auto">
                             <div class="flex justify-between items-center mb-8">
                                <h1 class="text-2xl font-bold text-gray-800">Covenant Setup</h1>
                                <button id="backToDealScreenBtn" class="bg-white text-gray-700 border border-gray-300 px-5 py-2 rounded-lg font-semibold hover:bg-gray-50 text-sm">← Back to DealScreen</button>
                            </div>
                            <div class="text-center">
                                <p class="mt-1 text-gray-600 mb-8">Define monitoring rules for transaction: <strong id="covenantSetupTitle"></strong></p>
                            </div>
                            <div class="bg-white p-6 rounded-lg border shadow-sm mb-6 space-y-4">
                                <h3 class="font-semibold text-lg text-gray-800 border-b pb-3">Financial Covenants</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 items-center">
                                    <span>CRAR</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&gt;=</option><option>&lt;=</option></select>
                                    <div class="relative"><input type="text" value="15" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>
                                    
                                    <span>Gross NPA</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&lt;=</option><option>&gt;=</option></select>
                                    <div class="relative"><input type="text" value="5" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>

                                    <span>Net NPA</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&lt;=</option><option>&gt;=</option></select>
                                    <div class="relative"><input type="text" value="3" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>

                                    <span>Debt-to-Equity</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&lt;=</option><option>&gt;=</option></select>
                                    <div class="relative"><input type="text" value="4" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">x</span></div>

                                    <span>Interest Coverage</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&gt;=</option><option>&lt;=</option></select>
                                    <div class="relative"><input type="text" value="2.0" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">x</span></div>

                                    <span>RoA</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&gt;=</option><option>&lt;=</option></select>
                                    <div class="relative"><input type="text" value="1.5" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>
                                    
                                    <span>Opex Ratio</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&lt;=</option><option>&gt;=</option></select>
                                    <div class="relative"><input type="text" value="6" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>

                                    <span>Collection Eff.</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&gt;=</option><option>&lt;=</option></select>
                                    <div class="relative"><input type="text" value="98" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>

                                    <span>Geographic Conc.</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&lt;=</option><option>&gt;=</option></select>
                                    <div class="relative"><input type="text" value="30" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg border shadow-sm mb-6 space-y-4">
                                <h3 class="font-semibold text-lg text-gray-800 border-b pb-3">Document Requirements</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 items-center">
                                    <span>Audited Financials</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>Annually</option><option>Half-Yearly</option><option>Quarterly</option><option>Monthly</option></select>
                                    <input type="date" value="2026-05-30" class="block w-full rounded-md border-gray-300 shadow-sm">
                                    
                                    <span>Unaudited Financials</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>Quarterly</option><option>Annually</option><option>Half-Yearly</option><option>Monthly</option></select>
                                    <input type="date" value="2025-07-10" class="block w-full rounded-md border-gray-300 shadow-sm">

                                    <span>MIS Portfolio Report</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>Monthly</option><option>Quarterly</option><option>Annually</option><option>Half-Yearly</option></select>
                                    <input type="date" value="2025-10-01" class="block w-full rounded-md border-gray-300 shadow-sm">

                                    <span>Compliance Certificate</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>Quarterly</option><option>Monthly</option><option>Annually</option><option>Half-Yearly</option></select>
                                    <input type="date" value="2025-10-01" class="block w-full rounded-md border-gray-300 shadow-sm">

                                    <span>End-Use Certificate</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>Half-Yearly</option><option>Quarterly</option><option>Monthly</option><option>Annually</option></select>
                                    <input type="date" value="2026-07-01" class="block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                            </div>
                            <div class="text-center mt-8">
                                <button id="saveCovenantBtn" class="bg-teal-600 text-white px-8 py-2.5 rounded-lg font-semibold hover:bg-teal-700">Save Covenants & Activate Monitoring</button>
                            </div>
                        </div>
                    </div>
                    <div id="covenantMonitoringPage" class="page-view">
                        <div class="max-w-7xl mx-auto">
                            <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
                                <h1 class="text-2xl font-bold text-gray-800">Covenant Monitoring</h1>
                                <div class="flex items-center space-x-2">
                                    <label for="transactionSelector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Select Transaction:</label>
                                    <select id="transactionSelector" class="w-full md:w-64 block rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        </select>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg border shadow-sm mb-8">
                                <h3 class="font-semibold text-lg text-gray-800 mb-4">Covenant Status</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left text-gray-500">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2">Covenant</th>
                                                <th class="px-4 py-2">Condition</th>
                                                <th class="px-4 py-2">Required</th>
                                                <th class="px-4 py-2">Actual</th>
                                                <th class="px-4 py-2">Status</th>
                                                <th class="px-4 py-2 text-center">Trend (3 Mo)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="covenantStatusTableBody">
                                            </tbody>
                                    </table>
                                </div>
                            </div>

                             <div class="bg-white p-6 rounded-lg border shadow-sm mb-8">
                                <h3 class="font-semibold text-lg text-gray-800 mb-4">Document Status</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left text-gray-500">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2">Document</th>
                                                <th class="px-4 py-2">Frequency</th>
                                                <th class="px-4 py-2">Next Due Date</th>
                                                <th class="px-4 py-2">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="documentStatusTableBody">
                                            </tbody>
                                    </table>
                                </div>
                            </div>

                             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="bg-white p-4 rounded-lg border shadow-sm">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-semibold text-center">GNPA Movement</h3>
                                        <span id="par90EWS" class="text-xs font-bold"></span>
                                    </div>
                                    <div class="chart-container h-64"><canvas id="par90Chart"></canvas></div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-semibold text-center">Collection Efficiency</h3>
                                        <span id="collectionEffEWS" class="text-xs font-bold"></span>
                                    </div>
                                    <div class="chart-container h-64"><canvas id="collectionEffChart"></canvas></div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-semibold text-center">CRAR Movement</h3>
                                        <span id="crarEWS" class="text-xs font-bold"></span>
                                    </div>
                                    <div class="chart-container h-64"><canvas id="crarChart"></canvas></div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-semibold text-center">Portfolio Yield</h3>
                                        <span id="yieldEWS" class="text-xs font-bold"></span>
                                    </div>
                                    <div class="chart-container h-64"><canvas id="yieldChart"></canvas></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="reportsPage" class="page-view">
                        <div class="max-w-7xl mx-auto">
                            <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                                <h1 class="text-2xl font-bold text-gray-800">Reports & Documentation</h1>
                                <div class="flex flex-wrap items-center gap-3">
                                    <div class="flex items-center space-x-2">
                                        <label for="reportMonthSelector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Report Month:</label>
                                        <select id="reportMonthSelector" class="block rounded-md border-gray-300 shadow-sm sm:text-sm">
                                            <option value="2025-12">December 2025</option>
                                            <option value="2025-11">November 2025</option>
                                            <option value="2025-10">October 2025</option>
                                            <option value="2025-09">September 2025</option>
                                            <option value="2025-08">August 2025</option>
                                            <option value="2025-07">July 2025</option>
                                            <option value="2025-06">June 2025</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <label for="reportsTransactionSelector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Transaction:</label>
                                        <select id="reportsTransactionSelector" class="w-48 block rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Report Period Indicator -->
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-blue-700">
                                            <strong>Current Report Period:</strong> <span id="reportPeriodDisplay">November 2025</span> 
                                            <span class="mx-2">|</span>
                                            <strong>Collection Period:</strong> <span id="collectionPeriodDisplay">01-Nov-2025 to 30-Nov-2025</span>
                                            <span class="mx-2">|</span>
                                            <strong>Payment Date:</strong> <span id="paymentDateDisplay">01-Dec-2025</span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Standard Reports Section -->
                            <div class="bg-white p-6 rounded-lg border shadow-sm mb-8">
                                <h3 class="font-semibold text-lg text-gray-800 mb-6">Compliance Reports</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- PMA Report -->
                                    <div class="border rounded-lg p-5 hover:shadow-md transition-shadow">
                                        <div class="flex items-start justify-between mb-3">
                                            <div class="flex items-center space-x-3">
                                                <div class="bg-teal-100 p-2 rounded-lg">
                                                    <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <h4 class="font-semibold text-gray-800">Portfolio Monitoring Agent Report</h4>
                                                    <p class="text-sm text-gray-500">Monthly PMA Report</p>
                                                </div>
                                            </div>
                                            <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded">Required</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-3">Official PMA Letter covering:</p>
                                        <ul class="text-xs text-gray-600 space-y-1 mb-4 ml-4">
                                            <li>✓ Tested Eligibility Criteria verification</li>
                                            <li>✓ Delinquency Ratio, Dynamic Default Ratio calculations</li>
                                            <li>✓ Portfolio Concentration Limits confirmation</li>
                                            <li>✓ Discounted Balance & Collections reconciliation</li>
                                            <li>✓ Manifest errors identification</li>
                                        </ul>
                                        <div class="flex space-x-2">
                                            <button id="downloadPMAReport" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-teal-700 text-sm flex items-center justify-center space-x-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                </svg>
                                                <span>Download Letter</span>
                                            </button>
                                            <button class="px-4 py-2 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50 text-sm text-gray-700">Preview</button>
                                        </div>
                                        <div class="mt-3 text-xs text-gray-500">
                                            <span>Due: 2 Business Days after Servicer Report</span>
                                        </div>
                                    </div>

                                    <!-- Cash Manager Report -->
                                    <div class="border rounded-lg p-5 hover:shadow-md transition-shadow">
                                        <div class="flex items-start justify-between mb-3">
                                            <div class="flex items-center space-x-3">
                                                <div class="bg-blue-100 p-2 rounded-lg">
                                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <h4 class="font-semibold text-gray-800">Cash Manager Investor Report</h4>
                                                    <p class="text-sm text-gray-500">Monthly Cash Flow Report</p>
                                                </div>
                                            </div>
                                            <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded">Required</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-3">Monthly Investor Report including:</p>
                                        <ul class="text-xs text-gray-600 space-y-1 mb-4 ml-4">
                                            <li>✓ Receivables Portfolio Summary</li>
                                            <li>✓ Senior/Mezzanine/Junior Notes balances</li>
                                            <li>✓ Tests: PAR30, PAR60, PAR90, LTV</li>
                                            <li>✓ Priority of Payments waterfall</li>
                                            <li>✓ Available Receipts breakdown</li>
                                        </ul>
                                        <div class="flex space-x-2">
                                            <button id="downloadCashReport" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-teal-700 text-sm flex items-center justify-center space-x-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                </svg>
                                                <span>Download Report</span>
                                            </button>
                                            <button class="px-4 py-2 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50 text-sm text-gray-700">Preview</button>
                                        </div>
                                        <div class="mt-3 text-xs text-gray-500">
                                            <span>Due: 5 Business Days before Payment Date</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Dynamic Reporting Dashboards -->
                            <div class="bg-white p-6 rounded-lg border shadow-sm mb-8">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-semibold text-lg text-gray-800">Dynamic Reporting & Analytics</h3>
                                    <button class="text-teal-600 hover:text-teal-700 text-sm font-semibold">Export All Data</button>
                                </div>
                                
                                <!-- Key Metrics Summary -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                    <div class="bg-gray-50 p-4 rounded-lg border">
                                        <p class="text-xs text-gray-500 uppercase">Pool Size</p>
                                        <p id="reportPoolSize" class="text-2xl font-bold text-gray-800">₹93.5 Cr</p>
                                        <p class="text-xs text-green-600 mt-1">▲ 2.1% from last month</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg border">
                                        <p class="text-xs text-gray-500 uppercase">Total Loans</p>
                                        <p id="reportTotalLoans" class="text-2xl font-bold text-gray-800">9,450</p>
                                        <p class="text-xs text-gray-600 mt-1">Active accounts</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg border">
                                        <p class="text-xs text-gray-500 uppercase">GNPA %</p>
                                        <p id="reportGNPA" class="text-2xl font-bold text-gray-800">3.2%</p>
                                        <p class="text-xs text-green-600 mt-1">▼ 0.3% improvement</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg border">
                                        <p class="text-xs text-gray-500 uppercase">Avg Yield</p>
                                        <p id="reportYield" class="text-2xl font-bold text-gray-800">22.5%</p>
                                        <p class="text-xs text-gray-600 mt-1">Portfolio weighted</p>
                                    </div>
                                </div>

                                <!-- Collection & Cash Flow Analysis -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                    <div>
                                        <h4 class="font-semibold text-gray-800 mb-3">Collection Efficiency Trend</h4>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportCollectionChart"></canvas></div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800 mb-3">Cash Flow Waterfall (This Month)</h4>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportWaterfallChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Delinquency & Portfolio Composition -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                    <div>
                                        <h4 class="font-semibold text-gray-800 mb-3">DPD Bucket Analysis</h4>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportDPDChart"></canvas></div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800 mb-3">Portfolio Composition</h4>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportCompositionChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Geographic & Vintage Analysis -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div>
                                        <h4 class="font-semibold text-gray-800 mb-3">Geographic Concentration</h4>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportGeoChart"></canvas></div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800 mb-3">Vintage Analysis</h4>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportVintageChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Reports -->
                            <div class="bg-white p-6 rounded-lg border shadow-sm">
                                <h3 class="font-semibold text-lg text-gray-800 mb-4">Additional Reports & Exports</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <button class="border rounded-lg p-4 hover:bg-gray-50 text-left transition-colors">
                                        <div class="flex items-center space-x-3 mb-2">
                                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                            </svg>
                                            <span class="font-semibold text-gray-800">Loan-Level Data</span>
                                        </div>
                                        <p class="text-sm text-gray-600">Export detailed loan tape</p>
                                    </button>
                                    <button class="border rounded-lg p-4 hover:bg-gray-50 text-left transition-colors">
                                        <div class="flex items-center space-x-3 mb-2">
                                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                            </svg>
                                            <span class="font-semibold text-gray-800">Covenant Compliance</span>
                                        </div>
                                        <p class="text-sm text-gray-600">Covenant tracking report</p>
                                    </button>
                                    <button class="border rounded-lg p-4 hover:bg-gray-50 text-left transition-colors">
                                        <div class="flex items-center space-x-3 mb-2">
                                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <span class="font-semibold text-gray-800">Performance Summary</span>
                                        </div>
                                        <p class="text-sm text-gray-600">Executive summary report</p>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="insightsPage" class="page-view">
                         <div class="text-center mb-8">
                            <h1 class="text-2xl font-bold text-gray-800">Performance Insights</h1>
                             <p class="mt-1 text-gray-600 max-w-3xl mx-auto">Key observations for transaction: <strong>FMF-TW-001</strong></p>
                        </div>
                        <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-green-50 border border-green-200 p-6 rounded-lg flex items-start space-x-4">
                                <div class="w-8 h-8 flex-shrink-0 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-green-800">Strong Segment Performance</h4>
                                    <p class="text-green-800 text-sm font-medium mt-1">The Two-Wheeler loan portfolio continues to be the bedrock of performance, with DPD30+ consistently below 4.5%. High repayment rates in this core segment are driving overall portfolio stability and cash flow predictability.</p>
                                </div>
                            </div>
                            <div class="bg-red-50 border border-red-200 p-6 rounded-lg flex items-start space-x-4">
                                <div class="w-8 h-8 flex-shrink-0 bg-red-500 rounded-full flex items-center justify-center">
                                     <svg class="w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-red-800">Geographic Stress in Key Area</h4>
                                    <p class="text-red-800 text-sm font-medium mt-1">The Vidarbha region of Maharashtra, the third-highest AUM contributor, has a DPD60 above 8% with collection efficiency less than 95%. This indicates rising stress in a key geographical area, posing a concentration risk that requires targeted intervention.</p>
                                </div>
                            </div>
                            <div class="bg-green-50 border border-green-200 p-6 rounded-lg flex items-start space-x-4">
                                <div class="w-8 h-8 flex-shrink-0 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-green-800">Effective Underwriting Vintage</h4>
                                    <p class="text-green-800 text-sm font-medium mt-1">Vintage analysis of loans originated in Q4 2024 shows the lowest early-stage delinquency. This strongly suggests that recent underwriting policy improvements are effective and should be maintained or expanded.</p>
                                </div>
                            </div>
                             <div class="bg-red-50 border border-red-200 p-6 rounded-lg flex items-start space-x-4">
                                <div class="w-8 h-8 flex-shrink-0 bg-red-500 rounded-full flex items-center justify-center">
                                     <svg class="w-5 h-8 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-red-800">Risk from First-Cycle Borrowers</h4>
                                    <p class="text-red-800 text-sm font-medium mt-1">First-cycle borrowers now account for 65% of all new delinquencies in the past 90 days. This highlights a significant risk concentration in the new customer onboarding process, suggesting a need for tighter initial criteria.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="performancePage" class="page-view">
                        <div class="max-w-7xl mx-auto">
                             <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                                <h1 class="text-2xl font-bold text-gray-800">Portfolio Performance</h1>
                                <div class="flex items-center space-x-2">
                                    <label for="perfTransactionSelector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Select Transaction:</label>
                                    <select id="perfTransactionSelector" class="w-full md:w-64 block rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center">
                                    <p class="text-sm text-gray-500">Principal Outstanding (POS)</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-1">₹95.5 Cr</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center">
                                    <p class="text-sm text-gray-500">Overall Collection Efficiency</p>
                                    <p class="text-3xl font-bold text-green-600 mt-1">98.2%</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center">
                                    <p class="text-sm text-gray-500">Live Portfolio Count</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-1">9,450</p>
                                </div>
                            </div>

                             <div class="mb-8">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">Portfolio Composition</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="bg-white p-4 rounded-lg border shadow-sm"><h3 class="font-semibold text-center mb-2">POS by Loan Purpose</h3><div class="chart-container h-64"><canvas id="posByLoanPurposeChart"></canvas></div></div>
                                    <div class="bg-white p-4 rounded-lg border shadow-sm"><h3 class="font-semibold text-center mb-2">POS by State</h3><div class="chart-container h-64"><canvas id="posByCountyChart"></canvas></div></div>
                                </div>
                            </div>

                             <div class="mb-8">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">Delinquency Analysis (DPD 30+)</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="bg-white p-4 rounded-lg border shadow-sm"><h3 class="font-semibold text-center mb-2">by Loan Purpose</h3><div class="chart-container h-64"><canvas id="parByLoanPurposeChart"></canvas></div></div>
                                    <div class="bg-white p-4 rounded-lg border shadow-sm"><h3 class="font-semibold text-center mb-2">by State</h3><div class="chart-container h-64"><canvas id="parByCountyChart"></canvas></div></div>
                                    <div class="bg-white p-4 rounded-lg border shadow-sm"><h3 class="font-semibold text-center mb-2">by Loan Cycle</h3><div class="chart-container h-64"><canvas id="parByLoanCycleChart"></canvas></div></div>
                                    <div class="bg-white p-4 rounded-lg border shadow-sm"><h3 class="font-semibold text-center mb-2">by KI Score Band</h3><div class="chart-container h-64"><canvas id="parByKiScoreChart"></canvas></div></div>
                                </div>
                            </div>
                            
                            <div>
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">Vintage Analysis</h2>
                                <div class="bg-white p-4 rounded-lg border shadow-sm">
                                    <h3 class="font-semibold text-center mb-2">GNPA (90+ DPD) by Origination Quarter</h3>
                                    <div class="chart-container h-72"><canvas id="vintageAnalysisChart"></canvas></div>
                                </div>
                            </div>

                        </div>
                    </div>
                     <div id="impactPage" class="page-view">
                        <div class="max-w-7xl mx-auto">
                             <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                                <h1 class="text-2xl font-bold text-gray-800">Impact Analysis</h1>
                                <div class="flex items-center space-x-2">
                                    <label for="impactTransactionSelector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Select Transaction:</label>
                                    <select id="impactTransactionSelector" class="w-full md:w-64 block rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center"><p class="text-sm text-gray-500">Female Borrowers</p><p class="text-2xl font-bold text-teal-600 mt-1">4,158 (44%)</p></div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center"><p class="text-sm text-gray-500">Rural Outreach</p><p class="text-2xl font-bold text-teal-600 mt-1">5,197 (55%)</p></div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center"><p class="text-sm text-gray-500">First-Time Borrowers</p><p class="text-2xl font-bold text-teal-600 mt-1">2,835 (30%)</p></div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center"><p class="text-sm text-gray-500">Youth Borrowers (&lt;35)</p><p class="text-2xl font-bold text-teal-600 mt-1">3,780 (40%)</p></div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-1 space-y-8">
                                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                                        <h3 class="font-semibold text-gray-800 mb-3">Gender & Social Lens</h3>
                                        <div class="space-y-3 text-sm">
                                            <div class="flex justify-between"><span>Value to Women (INR):</span><span class="font-bold">₹41 Cr</span></div>
                                            <div class="flex justify-between"><span>Avg. Loan to Women (INR):</span><span class="font-bold">₹98,600</span></div>
                                            <div class="flex justify-between"><span>Avg. Loan to Men (INR):</span><span class="font-bold">₹1.03 Lakh</span></div>
                                        </div>
                                        <div class="chart-container h-48 mt-4"><canvas id="genderPerformanceChart"></canvas></div>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                                        <h3 class="font-semibold text-gray-800 mb-3">Geographic Outreach</h3>
                                        <div class="chart-container h-56"><canvas id="ruralUrbanChart"></canvas></div>
                                    </div>
                                </div>
                                
                                <div class="lg:col-span-2 space-y-8">
                                    <div class="bg-white p-6 rounded-lg border shadow-sm">
                                        <h3 class="font-semibold text-gray-800 mb-4">End-Use & SDG Alignment</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <h4 class="font-medium text-center text-sm mb-2">End-Use Sector</h4>
                                                <div class="chart-container h-48"><canvas id="sectorDoughnutChart"></canvas></div>
                                            </div>
                                             <div>
                                                <h4 class="font-medium text-center text-sm mb-2">SDG Alignment</h4>
                                                <div class="chart-container h-48"><canvas id="sdgDoughnutChart"></canvas></div>
                                                <div class="text-xs space-y-1 mt-2 text-center">
                                                    <p><span class="font-bold text-teal-600">48%</span> No Poverty (SDG 1)</p>
                                                    <p><span class="font-bold text-teal-600">32%</span> Decent Work & Econ. Growth (SDG 8)</p>
                                                    <p><span class="font-bold text-teal-600">20%</span> Reduced Inequality (SDG 10)</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bg-white p-6 rounded-lg border shadow-sm">
                                        <h3 class="font-semibold text-gray-800 mb-4">Economic Opportunity</h3>
                                         <div class="chart-container h-64"><canvas id="borrowerProfileChart"></canvas></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // State Management
            const state = { currentView: 'dealScreen', currentPage: 'dealScreenHomePage', previousPage: null, charts: {}, transactions: [], originators: [], availablePortfolios: [], currentTransactionId: null, covenantData: {}, simulationBaseCase: {} };

            // Selectors
            const app = document.getElementById('app');
            const dealScreenBtn = document.getElementById('dealScreenBtn');
            const dealTrackBtn = document.getElementById('dealTrackBtn');
            const dealScreenView = document.getElementById('dealScreenView');
            const dealTrackView = document.getElementById('dealTrackView');
            const pageViews = document.querySelectorAll('.page-view');
            const homeBtn = document.getElementById('homeBtn');
            
            // Home Page Selectors
            const homeTabsNav = document.getElementById('homeTabsNav');
            const homeTabContents = document.querySelectorAll('.home-tab-content');
            const addNewOriginatorBtn = document.getElementById('addNewOriginatorBtn');
            const createNewTransactionBtn = document.getElementById('createNewTransactionBtn');
            
            // Originator Onboarding Selectors
            const uploadOriginatorFilesBtn = document.getElementById('uploadOriginatorFilesBtn');
            const originatorUpload = document.getElementById('originatorUpload');
            const originatorAnalyzing = document.getElementById('originatorAnalyzing');
            const originatorAnalysisResult = document.getElementById('originatorAnalysisResult');
            const onboardOriginatorBtn = document.getElementById('onboardOriginatorBtn');
            const analysisOriginatorName = document.getElementById('analysisOriginatorName');
            const analysisOriginatorCategory = document.getElementById('analysisOriginatorCategory');
            const originatorInsightsContainer = document.getElementById('originatorInsightsContainer');

            // Pool Creation Selectors
            const poolSubSteps = document.querySelectorAll('#poolCreationPage .sub-step');
            const uploadPoolBtn = document.getElementById('uploadPoolBtn');
            const validateMappedPoolBtn = document.getElementById('validateMappedPoolBtn');
            const reuploadPoolBtn = document.getElementById('reuploadPoolBtn');
            const finalizePoolBtn = document.getElementById('finalizePoolBtn');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const runSensitivitySimulationBtn = document.getElementById('runSensitivitySimulationBtn');
            const simulationResultsPanel = document.getElementById('simulationResultsPanel');
            const simulationOriginatorName = document.getElementById('simulationOriginatorName');
            
            // Pool Details Page Selectors
            const poolDetailsTitle = document.getElementById('poolDetailsTitle');
            const loanListingTableBody = document.getElementById('loanListingTableBody');

            // KI Score Details Page Selectors
            const kiScoreDetailsPage = document.getElementById('kiScoreDetailsPage');
            const kiScoreDetailsTitle = document.getElementById('kiScoreDetailsTitle');
            const kiScoreVariables = document.getElementById('kiScoreVariables');
            const kiScoreContributors = document.getElementById('kiScoreContributors');

            // Structuring Sliders & Labels
            const kiScoreMinSlider = document.getElementById('kiScoreMinSlider');
            const kiScoreMaxSlider = document.getElementById('kiScoreMaxSlider');
            const kiScoreMinLabel = document.getElementById('kiScoreMinLabel');
            const kiScoreMaxLabel = document.getElementById('kiScoreMaxLabel');

            const loanAmountMinSlider = document.getElementById('loanAmountMinSlider');
            const loanAmountMaxSlider = document.getElementById('loanAmountMaxSlider');
            const loanAmountMinLabel = document.getElementById('loanAmountMinLabel');
            const loanAmountMaxLabel = document.getElementById('loanAmountMaxLabel');

            const tenureMinSlider = document.getElementById('tenureMinSlider');
            const tenureMaxSlider = document.getElementById('tenureMaxSlider');
            const tenureMinLabel = document.getElementById('tenureMinLabel');
            const tenureMaxLabel = document.getElementById('tenureMaxLabel');

            const interestRateMinSlider = document.getElementById('interestRateMinSlider');
            const interestRateMaxSlider = document.getElementById('interestRateMaxSlider');
            const interestRateMinLabel = document.getElementById('interestRateMinLabel');
            const interestRateMaxLabel = document.getElementById('interestRateMaxLabel');

            const sensitivityLossSlider = document.getElementById('sensitivityLossSlider');
            const sensitivityLossLabel = document.getElementById('sensitivityLossLabel');
            const sensitivityPrepaymentSlider = document.getElementById('sensitivityPrepaymentSlider');
            const sensitivityPrepaymentLabel = document.getElementById('sensitivityPrepaymentLabel');

            
            // DealTrack Selectors
            const dealTrackNav = document.getElementById('dealTrackNav');
            const dealTrackPages = document.querySelectorAll('#dealTrackView .page-view');
            const covenantSetupTitle = document.getElementById('covenantSetupTitle');
            const saveCovenantBtn = document.getElementById('saveCovenantBtn');
            const activeTransactionsTableBody = document.getElementById('activeTransactionsTableBody');
            const originatorsTableBody = document.getElementById('originatorsTableBody');
            const availablePortfoliosTableBody = document.getElementById('availablePortfoliosTableBody');
            
            // Covenant Monitoring Page Selectors
            const transactionSelector = document.getElementById('transactionSelector');
            const perfTransactionSelector = document.getElementById('perfTransactionSelector');
            const impactTransactionSelector = document.getElementById('impactTransactionSelector');
            const covenantStatusTableBody = document.getElementById('covenantStatusTableBody');
            const documentStatusTableBody = document.getElementById('documentStatusTableBody');
            const ewsPar90 = document.getElementById('par90EWS');
            const ewsCollectionEff = document.getElementById('collectionEffEWS');
            const ewsCrar = document.getElementById('crarEWS');
            const ewsYield = document.getElementById('yieldEWS');

            // Transaction Type Page
            const transactionTypePage = document.getElementById('transactionTypePage');

            // Finalize Pool Modal
            const finalizePoolModal = document.createElement('div');
            finalizePoolModal.id = 'finalizePoolModal';
            finalizePoolModal.className = 'modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50';
            finalizePoolModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
                    <h3 class="text-lg font-bold mb-4">Finalize Transaction</h3>
                    <p class="text-sm text-gray-600 mb-2">Please provide a name for this new transaction portfolio.</p>
                    <input type="text" id="newTransactionName" placeholder="e.g., FMF-TW-002" class="w-full border-gray-300 rounded-md shadow-sm">
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="cancelFinalizeBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                        <button id="saveTransactionBtn" class="px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700">Save Transaction</button>
                    </div>
                </div>
            `;
            document.body.appendChild(finalizePoolModal);

            const finalizeTransactionNameInput = document.getElementById('newTransactionName');
            const cancelFinalizeBtn = document.getElementById('cancelFinalizeBtn');
            const saveTransactionBtn = document.getElementById('saveTransactionBtn');
            const sensitivityModal = document.getElementById('sensitivityModal');
            const closeSensitivityModalBtn = document.getElementById('closeSensitivityModalBtn');

            let countiesMultiSelect;


            function initializeData() {
                state.originators = [
                    { id: 'sf', name: 'Alpha Finance Ltd', score: 'BBB', par: '5.5%', yield: '22.0%', aum: '₹32,000 Cr' },
                    { id: 'usfb', name: 'Beta Micro Bank', score: 'AA-', par: '3.8%', yield: '24.5%', aum: '₹68,000 Cr' },
                    { id: 'esfb', name: 'Gamma Credit Bank', score: 'A', par: '4.8%', yield: '23.5%', aum: '₹45,000 Cr' },
                    { id: 'ssfb', name: 'Delta Small Finance', score: 'BB', par: '6.2%', yield: '26.0%', aum: '₹21,000 Cr' },
                    { id: 'ssfl', name: 'Epsilon Microfinance', score: 'A-', par: '4.5%', yield: '24.0%', aum: '₹39,000 Cr' },
                    { id: 'af', name: 'Zeta Finance Corp', score: 'A+', par: '4.0%', yield: '25.0%', aum: '₹55,000 Cr' },
                    { id: 'tvsc', name: 'Theta Credit Solutions', score: 'BBB+', par: '5.1%', yield: '21.0%', aum: '₹41,000 Cr' },
                    { id: 'bf', name: 'Kappa Finance Group', score: 'A', par: '4.3%', yield: '20.5%', aum: '₹1,20,000 Cr' },
                    { id: 'mf', name: 'Lambda Financial Services', score: 'BBB', par: '5.8%', yield: '19.5%', aum: '₹82,000 Cr' }
                ];

                state.transactions = [
                    { id: 'SF-AGRI-003', name: 'SF-AGRI-003', originator: 'Alpha Finance Ltd', structure: 'Securitisation', grade: 'A+', tenure: '24 Months', yield: '10.5%', covenantsSet: false },
                    { id: 'USFB-MSME-005', name: 'USFB-MSME-005', originator: 'Beta Micro Bank', structure: 'Securitisation', grade: 'AA', tenure: '36 Months', yield: '9.8%', covenantsSet: true },
                    { id: 'FMF-TW-001', name: 'FMF-TW-001', originator: 'Omega Microfinance', structure: 'Term Loan', grade: 'AA-', tenure: '18 Months', yield: '11.0%', covenantsSet: true },
                    { id: 'SF-VEHICLE-001', name: 'SF-VEHICLE-001', originator: 'Alpha Finance Ltd', structure: 'Term Loan', grade: 'A', tenure: '24 Months', yield: '11.5%', covenantsSet: true },
                    { id: 'BF-SAL-012', name: 'BF-SAL-012', originator: 'Kappa Finance Group', structure: 'Securitisation', grade: 'A+', tenure: '30 Months', yield: '10.2%', covenantsSet: true },
                    { id: 'ESFB-BIZ-008', name: 'ESFB-BIZ-008', originator: 'Gamma Credit Bank', structure: 'Term Loan', grade: 'A', tenure: '24 Months', yield: '10.8%', covenantsSet: false },
                    { id: 'AF-AGRI-021', name: 'AF-AGRI-021', originator: 'Zeta Finance Corp', structure: 'Securitisation', grade: 'AA-', tenure: '36 Months', yield: '10.0%', covenantsSet: true },
                    { id: 'TVSC-UC-050', name: 'TVSC-UC-050', originator: 'Theta Credit Solutions', structure: 'Term Loan', grade: 'BBB+', tenure: '18 Months', yield: '12.0%', covenantsSet: true },
                    { id: 'MF-PERS-015', name: 'MF-PERS-015', originator: 'Lambda Financial Services', structure: 'Term Loan', grade: 'BBB', tenure: '20 Months', yield: '12.5%', covenantsSet: false },
                    { id: 'SSFL-EDU-004', name: 'SSFL-EDU-004', originator: 'Epsilon Microfinance', structure: 'Securitisation', grade: 'A-', tenure: '12 Months', yield: '10.3%', covenantsSet: true },
                ];
                
                state.availablePortfolios = [
                     { id: 'fmf-agri-25', name: 'Agri-Finance Jun 2025', originator: 'Omega Microfinance', assetClass: 'Agri-Finance', size: '₹75 Cr', tenure: '24 Months', par: '3.5%' },
                     { id: 'usfb-msme-25', name: 'MSME Loans Jun 2025', originator: 'Beta Micro Bank', assetClass: 'MSME Loans', size: '₹150 Cr', tenure: '36 Months', par: '3.1%' },
                     { id: 'sf-tw-25', name: 'Two-Wheeler May 2025', originator: 'Alpha Finance Ltd', assetClass: 'Two-Wheeler', size: '₹45 Cr', tenure: '18 Months', par: '5.2%' },
                     { id: 'bf-sal-25', name: 'Salaried Personal Loans Jul 2025', originator: 'Kappa Finance Group', assetClass: 'Salaried Personal Loans', size: '₹200 Cr', tenure: '48 Months', par: '2.9%' },
                     { id: 'esfb-group-25', name: 'Group Loans Jul 2025', originator: 'Gamma Credit Bank', assetClass: 'Group Loans', size: '₹60 Cr', tenure: '12 Months', par: '4.1%' },
                ];

                initializeCovenantData();
                renderOriginators();
                renderActiveTransactions();
                renderAvailablePortfolios();
            }

            function initializeCovenantData() {
                const generateChartData = (start, trend, volatility, breach, isUpwardBreach, willBreach, ensureNoHistoricalBreach = false, trailingTrendPoints = 0) => {
                    const data = { actuals: [], estimates: [], labels: [], breachLine: [], predictedBreach: false };
                    let currentValue = start;
                    const today = new Date('2025-07-01');

                    for (let i = -12; i <= 0; i++) {
                        const monthDate = new Date(today);
                        monthDate.setMonth(today.getMonth() + i);
                        data.labels.push(monthDate);
                        data.breachLine.push(breach);
                        
                        let currentTrend = (i > -trailingTrendPoints -1) ? trend : trend / 3;
                        let nextValue = currentValue + currentTrend + (Math.random() - 0.5) * volatility;

                        if (ensureNoHistoricalBreach) {
                            if (!isUpwardBreach) nextValue = Math.max(nextValue, breach * 1.01);
                            else nextValue = Math.min(nextValue, breach * 0.99);
                        }
                        data.actuals.push(nextValue);
                        currentValue = nextValue;
                    }
                    
                    data.estimates = new Array(data.actuals.length - 1).fill(null);
                    data.estimates.push(data.actuals[data.actuals.length - 1]);

                    let forecastValue = data.actuals[data.actuals.length - 1];
                    for (let i = 1; i <= 6; i++) {
                        const monthDate = new Date(today);
                        monthDate.setMonth(today.getMonth() + i);
                        data.labels.push(monthDate);
                        data.breachLine.push(breach);
                        
                        const forecastTrend = willBreach ? trend * 2.5 : trend;
                        forecastValue += forecastTrend;
                        data.estimates.push(forecastValue);

                        if (!data.predictedBreach && willBreach) {
                            if (isUpwardBreach && forecastValue > breach) data.predictedBreach = true;
                            if (!isUpwardBreach && forecastValue < breach) data.predictedBreach = true;
                        }
                    }
                    return data;
                };
                
                state.transactions.filter(t => t.covenantsSet).forEach(tx => {
                    state.covenantData[tx.id] = {
                        covenants: [
                            { name: 'CRAR', condition: '>=', required: '15.0%', actual: '15.2%', status: 'at_risk', trend: '↘' },
                            { name: 'Gross NPA', condition: '<=', required: '5.0%', actual: '4.8%', status: 'compliant', trend: '→' },
                            { name: 'Interest Coverage', condition: '>=', required: '2.0x', actual: '2.1x', status: 'compliant', trend: '→' },
                            { name: 'Net NPA', condition: '<=', required: '3.0%', actual: '2.8%', status: 'compliant', trend: '→' },
                            { name: 'Collection Efficiency', condition: '>=', required: '98%', actual: '98.2%', status: 'compliant', trend: '→' },
                            { name: 'GNPA', condition: '<=', required: '4.0%', actual: '3.8%', status: 'compliant', trend: '→' },
                        ],
                        documents: [
                            { name: 'MIS Portfolio Report', frequency: 'Monthly', nextDue: '31-Jul-2025', status: 'submitted' },
                            { name: 'Unaudited Financials', frequency: 'Quarterly', nextDue: '15-Aug-2025', status: 'submitted' },
                            { name: 'Audited Financials', frequency: 'Annually', nextDue: '30-May-2026', status: 'submitted' },
                        ],
                        charts: {
                            par90: { ...generateChartData(3.2, -0.01, 0.1, 4.0, true, false) },
                            collectionEff: { ...generateChartData(99.2, 0.01, 0.2, 98.0, false, false) },
                            crar: { ...generateChartData(15.8, -0.1, 0.2, 15.0, false, true, true, 3) },
                            yield: { ...generateChartData(11.0, 0, 0.1, 9.5, false, false) }
                        }
                    };
                });
            }

            function renderOriginators() {
                originatorsTableBody.innerHTML = '';
                state.originators.forEach(o => {
                    const row = `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium text-gray-900">${o.name}</td>
                            <td class="px-6 py-4 font-semibold text-teal-600"><button class="ki-score-link" data-score-type="originator" data-name="${o.name}">${o.score}</button></td>
                            <td class="px-6 py-4 font-medium text-red-600">${o.par}</td>
                            <td class="px-6 py-4 font-medium text-green-600">${o.yield}</td>
                            <td class="px-6 py-4 font-bold text-gray-800">${o.aum}</td>
                        </tr>
                    `;
                    originatorsTableBody.innerHTML += row;
                });
            }

            function renderActiveTransactions() {
                activeTransactionsTableBody.innerHTML = '';
                state.transactions.forEach(tx => {
                    const actionButton = tx.covenantsSet 
                        ? `<button class="view-performance-btn font-medium text-teal-600 hover:underline" data-tx-id="${tx.id}">View Performance</button>`
                        : `<button class="setup-covenant-btn font-medium text-orange-600 hover:underline" data-tx-id="${tx.id}">Setup Covenant</button>`;

                    const row = `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium text-gray-900"><button class="pool-details-link text-teal-600 hover:underline" data-pool-name="${tx.name}">${tx.name}</button></td>
                            <td class="px-6 py-4">${tx.originator}</td>
                            <td class="px-6 py-4">${tx.structure}</td>
                            <td class="px-6 py-4 font-semibold text-green-500"><button class="ki-score-link" data-score-type="pool" data-name="${tx.name}">${tx.grade}</button></td>
                            <td class="px-6 py-4">${tx.tenure}</td>
                            <td class="px-6 py-4">${tx.yield}</td>
                            <td class="px-6 py-4 text-center">${actionButton}</td>
                        </tr>
                    `;
                    activeTransactionsTableBody.innerHTML += row;
                });
            }

            function renderAvailablePortfolios() {
                availablePortfoliosTableBody.innerHTML = '';
                state.availablePortfolios.forEach(p => {
                    const row = `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium text-gray-900">${p.name}</td>
                            <td class="px-6 py-4">${p.originator}</td>
                            <td class="px-6 py-4">${p.assetClass}</td>
                            <td class="px-6 py-4">${p.size}</td>
                            <td class="px-6 py-4">${p.tenure}</td>
                            <td class="px-6 py-4">${p.par}</td>
                            <td class="px-6 py-4 text-center"><button class="font-medium text-teal-600 hover:underline">Structure Deal</button></td>
                        </tr>
                    `;
                    availablePortfoliosTableBody.innerHTML += row;
                });
            }

            function updateMainView(targetView, txId = null) {
                state.currentView = targetView;
                dealScreenView.classList.toggle('active', state.currentView === 'dealScreen');
                dealTrackView.classList.toggle('active', state.currentView === 'dealTrack');
                dealScreenBtn.classList.toggle('active', state.currentView === 'dealScreen');
                dealTrackBtn.classList.toggle('active', state.currentView === 'dealTrack');

                if(targetView === 'dealTrack') {
                    populateTransactionSelector(txId);
                }
            }

            function showPage(pageId) {
                state.previousPage = state.currentPage;
                state.currentPage = pageId;
                pageViews.forEach(page => page.classList.toggle('active', page.id === pageId));
            }
            
            function updateDealTrackPage(pageId, txId = null) {
                dealTrackPages.forEach(page => page.classList.toggle('active', page.id === pageId));
                const currentTxId = txId || transactionSelector.value;
                if (pageId === 'covenantMonitoringPage') {
                    renderCovenantMonitoringPage(currentTxId);
                } else if (pageId === 'reportsPage') {
                    renderReportsPage(currentTxId);
                } else if (pageId === 'performancePage') {
                    renderPerformancePage(currentTxId);
                } else if (pageId === 'impactPage') {
                    renderImpactPage(currentTxId);
                }
            }

            function goBack() {
                if (state.previousPage) {
                    showPage(state.previousPage);
                } else {
                    showPage('dealScreenHomePage');
                }
            }

            function updateHomeTab(targetTab) {
                homeTabsNav.querySelectorAll('button').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === targetTab));
                homeTabContents.forEach(content => content.classList.toggle('active', content.id === `${targetTab}Tab`));
            }
            
            function updatePoolSubStep(targetSubStepId) {
                poolSubSteps.forEach(sub => sub.classList.remove('active'));
                document.getElementById(targetSubStepId)?.classList.add('active');
            }

            function createOrUpdateChart(chartId, config) {
                const ctx = document.getElementById(chartId)?.getContext('2d');
                if (!ctx) return;
                if (state.charts[chartId]) state.charts[chartId].destroy();
                state.charts[chartId] = new Chart(ctx, config);
            }
            
            function renderVariables(container, title, variables) {
                let html = `<div class="bg-white p-5 rounded-lg border shadow-sm"><h3 class="text-md font-semibold text-gray-700 mb-4 border-b pb-2">${title}</h3><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">`;
                variables.forEach(v => {
                    html += `<div><p class="text-xs text-gray-500">${v.label}</p><p class="text-sm font-medium text-gray-800">${v.value}</p></div>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            }

            function showKiScoreDetails(type, name, id) {
                const scoreData = {
                    originator: {
                        title: `KI Score Grade Details for ${name}`,
                        contributors: [
                            { label: 'Strong Capitalization', value: 'CRAR: 18.5%', icon: '✅' },
                            { label: 'Low NPAs', value: 'GNPA: 4.2%', icon: '✅' },
                            { label: 'Diversified Portfolio', value: 'Top 3 products < 60%', icon: '✅' }
                        ],
                        cards: [
                            { title: 'Financial Health', variables: [
                                { label: 'CRAR', value: '18.5%' }, { label: 'Debt-to-Equity', value: '2.1' }, { label: 'Return on Assets (RoA)', value: '2.8%' }, { label: 'Return on Equity (RoE)', value: '15.2%' }, { label: 'Net Interest Margin', value: '8.1%' }, { label: 'Cost-to-Income Ratio', value: '45%' }, { label: 'Liquidity Ratio', value: '1.5' }, { label: 'Portfolio Growth (YoY)', value: '15%' }, { label: 'Operating Expense Ratio', value: '4.5%' }, { label: 'Provision Coverage Ratio', value: '75%' }
                            ]},
                            { title: 'Portfolio Quality', variables: [
                                { label: '90+ DPD % (GNPA)', value: '4.2%' }, { label: 'Write-off Ratio', value: '1.1%' }, { label: 'Collection Efficiency', value: '98.5%' }, { label: '30+ DPD %', value: '5.1%' }, { label: 'Avg. Seasoning', value: '14 Months' }, { label: 'NPA by 2023 Vintage', value: '3.8%' }, { label: 'Geographic Diversification', value: 'High (8 states)' }, { label: 'Product Diversification', value: 'High (5+ products)' }
                            ]}
                        ]
                    },
                    pool: {
                        title: `KI Score Grading Details for ${name}`,
                        contributors: [
                            { label: 'High Avg. Loan Score', value: 'Avg. Score: 25', icon: '👍' },
                            { label: 'Low Geographic Risk', value: 'Top State < 25%', icon: '👍' },
                            { label: 'Short Avg. Tenure', value: 'W.A. Tenure: 18 Mo', icon: '👍' }
                        ],
                        cards: [
                           { title: 'Pool Composition', variables: [
                                { label: 'W.A. KI Score (1-100)', value: '25' }, { label: 'W.A. Tenure', value: '18 Months' }, { label: 'W.A. Interest Rate', value: '24.5%' }, { label: 'Loan Count', value: '9,540' }, { label: 'Total Pool Value', value: '₹98 Cr' }, { label: 'Standard Deviation of Scores', value: '15.2' }, { label: 'W.A. LTV', value: '78%' }, { label: 'W.A. DTI Ratio', value: '0.45' }
                            ]},
                            { title: 'Risk Metrics', variables: [
                               { label: 'Top State Concentration', value: 'Maharashtra (22%)' }, { label: 'Top 3 State Concentration', value: '45%' }, { label: 'Product Concentration', value: 'Two-Wheeler (100%)' }, { label: 'Expected Loss (EL)', value: '4.1%' }, { label: 'Predicted Default Rate', value: '5.5%' }, { label: 'Predicted Prepayment Rate', value: '8.0%' }
                            ]},
                            { title: 'Eligibility Criteria', variables: [
                               { label: 'Max KI Score', value: '40' }, { label: 'Max Loan Amount', value: '₹2.5 Lakh' }, { label: 'Max Residual Tenure', value: '24 Months' }, { label: 'Min Credit History', value: '12 Months' }, { label: 'Excluded Geographies', value: 'None' }, { label: 'Loan Cycle', value: '> 1' }
                            ]}
                        ]
                    },
                    loan: {
                        title: `KI Score Details for Loan #${id}`,
                        contributors: [
                            { label: 'Excellent Repayment', value: '0 defaults on record', icon: '💯' },
                            { label: 'Long Credit History', value: '36 Months', icon: '💯' },
                            { label: 'Low DTI Ratio', value: '0.4', icon: '💯' }
                        ],
                        cards: [
                             { title: 'Score Explanation', variables: [{label: 'KI Score (1-100)', value: 'A lower score indicates lower risk.'}] },
                            { title: 'Customer Bureau Data', variables: [
                                { label: 'CIBIL Score', value: '780' }, { label: 'Inquiries (Last 6 Mo)', value: '1' }, { label: 'Total Active Tradelines', value: '4' }, { label: 'Credit Utilization Ratio', value: '35%' }, { label: 'Age of Oldest Credit Line', value: '48 Months' }, { label: 'Delinquent Accounts', value: '0' }
                            ]},
                            { title: 'Customer Financials & Stability', variables: [
                                { label: 'Stated Monthly Income', value: '₹80,000' }, { label: 'Debt-to-Income (DTI) Ratio', value: '0.4' }, { label: 'Bank Acct. Balance Trend', value: 'Increasing' }, { label: 'Avg. Monthly Transactions', value: '25' }, { label: 'Customer Vintage', value: '4 Years' }, { label: 'Employment Status', value: 'Salaried' }
                            ]},
                            { title: 'Loan & Behavioral Data', variables: [
                                { label: 'Loan Amount', value: '₹1,50,000' }, { label: 'Interest Rate', value: '25%' }, { label: 'Tenure', value: '24 Months' }, { label: 'Loan-to-Value (LTV)', value: '80%' }, { label: 'Loan Cycle with Lender', value: '3' }, { label: 'Repayment History', value: 'No Missed Payments' }, { label: 'Loan Purpose', value: 'Business Expansion' }
                            ]}
                        ]
                    }
                };

                const data = scoreData[type];
                if (!data) return;

                kiScoreDetailsTitle.textContent = data.title;
                kiScoreContributors.innerHTML = data.contributors.map(c => `<div class="bg-gray-100 p-3 rounded-lg"><p class="text-3xl">${c.icon}</p><p class="text-sm font-semibold text-gray-800 mt-1">${c.label}</p><p class="text-xs text-gray-500">${c.value}</p></div>`).join('');
                kiScoreVariables.innerHTML = '';
                data.cards.forEach(card => renderVariables(kiScoreVariables, card.title, card.variables));
                
                showPage('kiScoreDetailsPage');
            }

            function showPoolDetails(poolName) {
                poolDetailsTitle.textContent = poolName;
                loanListingTableBody.innerHTML = ''; // Clear previous results
                
                const locations = ['Mumbai', 'Delhi', 'Bengaluru', 'Chennai', 'Kolkata'];

                for (let i = 1; i <= 20; i++) {
                    const loanId = 'LAN' + String(1000 + i).padStart(4, '0');
                    const principal = (Math.floor(Math.random() * 20) + 5) * 10000;
                    const tenure = Math.floor(Math.random() * 18) + 6;
                    const score = Math.floor(Math.random() * 60) + 5; // Score between 5 and 65
                    const location = locations[i % locations.length];
                    const cycle = Math.floor(i / 5) + 1;
                    const interestRate = (Math.random() * 12 + 18).toFixed(1);
                    
                    const row = `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium text-gray-900">${loanId}</td>
                            <td class="px-6 py-4">${principal.toLocaleString()}</td>
                            <td class="px-6 py-4">${tenure}</td>
                            <td class="px-6 py-4">${location}</td>
                            <td class="px-6 py-4">${cycle}</td>
                            <td class="px-6 py-4">${interestRate}%</td>
                            <td class="px-6 py-4 font-semibold text-teal-600">
                                <button class="ki-score-link" data-score-type="loan" data-name="${loanId}" data-id="${loanId}">${score}</button>
                            </td>
                        </tr>
                    `;
                    loanListingTableBody.innerHTML += row;
                }
                showPage('poolDetailsPage');
            }


            // --- Event Listeners ---
            app.addEventListener('click', (e) => {
                const backBtn = e.target.closest('.back-btn');
                if(backBtn) {
                    goBack();
                    return;
                }

                if (e.target.closest('#poolDetailsBackBtn')) {
                    showPage('dealScreenHomePage');
                    updateHomeTab('transactions');
                    return;
                }

                const kiScoreLink = e.target.closest('.ki-score-link');
                if (kiScoreLink) {
                    const type = kiScoreLink.dataset.scoreType;
                    const name = kiScoreLink.dataset.name;
                    const id = kiScoreLink.dataset.id;
                    showKiScoreDetails(type, name, id);
                    return;
                }

                const poolDetailsLink = e.target.closest('.pool-details-link');
                if (poolDetailsLink) {
                    const poolName = poolDetailsLink.dataset.poolName;
                    showPoolDetails(poolName);
                    return;
                }
                
                const setupCovenantBtn = e.target.closest('.setup-covenant-btn');
                if(setupCovenantBtn) {
                    const txId = setupCovenantBtn.dataset.txId;
                    state.currentTransactionId = txId;
                    covenantSetupTitle.textContent = txId;
                    updateMainView('dealTrack');
                    updateDealTrackPage('covenantSetupPage');
                    dealTrackNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    return;
                }

                const viewPerformanceBtn = e.target.closest('.view-performance-btn');
                if (viewPerformanceBtn) {
                    const txId = viewPerformanceBtn.dataset.txId;
                    state.currentTransactionId = txId;
                    updateMainView('dealTrack', txId);
                    dealTrackNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    const monitoringTab = dealTrackNav.querySelector('[data-track-view="covenantMonitoring"]');
                    if(monitoringTab) monitoringTab.classList.add('active');
                    updateDealTrackPage('covenantMonitoringPage', txId);
                    return;
                }

                const txTypeBtn = e.target.closest('.tx-type-select-btn');
                if(txTypeBtn) {
                    const type = txTypeBtn.dataset.txType;
                    if (type === 'Securitisation') {
                        showPage('poolCreationPage');
                        updatePoolSubStep('poolUploadSubStep');
                    }
                    return;
                }
            });

            // Main View Navigation
            dealScreenBtn.addEventListener('click', () => updateMainView('dealScreen'));
            dealTrackBtn.addEventListener('click', () => {
                updateMainView('dealTrack');
                dealTrackNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                const firstTab = dealTrackNav.querySelector('button');
                if (firstTab) {
                    firstTab.classList.add('active');
                    const firstTxId = state.transactions.find(t => t.covenantsSet)?.id;
                    updateDealTrackPage(firstTab.dataset.trackView + 'Page', firstTxId);
                }
            });
            homeBtn.addEventListener('click', () => {
                window.location.href = '../home/';
            });
            
            document.getElementById('backToDealScreenBtn').addEventListener('click', () => {
                updateMainView('dealScreen');
                showPage('dealScreenHomePage');
            });
            
            // Home Page Tabs
            homeTabsNav.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    updateHomeTab(e.target.dataset.tab);
                }
            });

            // Workflow Initiation
            addNewOriginatorBtn.addEventListener('click', () => showPage('originatorOnboardingPage'));
            createNewTransactionBtn.addEventListener('click', () => {
                showPage('transactionTypePage');
            });
            
            function renderOriginatorInsights() {
                 originatorInsightsContainer.innerHTML = `
                    <div class="bg-green-50 border border-green-200 p-4 rounded-lg flex items-start space-x-4">
                        <div class="w-8 h-8 flex-shrink-0 bg-green-500 rounded-full flex items-center justify-center text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                        </div>
                        <div>
                            <h4 class="font-bold text-green-800">High-Performing Asset Class</h4>
                            <p class="text-sm text-green-700 mt-1">The Agri-Finance portfolio is a standout performer, showing the lowest GNPA (3.5%) and presenting a strong case for securitization or targeted term loan financing.</p>
                        </div>
                    </div>
                     <div class="bg-green-50 border border-green-200 p-4 rounded-lg flex items-start space-x-4">
                        <div class="w-8 h-8 flex-shrink-0 bg-green-500 rounded-full flex items-center justify-center text-white">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                        </div>
                        <div>
                            <h4 class="font-bold text-green-800">Robust Growth & Capitalization</h4>
                            <p class="text-sm text-green-700 mt-1">Consistent portfolio growth (AUM up 15% YoY) combined with a strong CRAR of 18.5% underpins the A+ KI Score, indicating solid financial health and expansion capacity.</p>
                        </div>
                    </div>
                     <div class="bg-red-50 border border-red-200 p-4 rounded-lg flex items-start space-x-4">
                        <div class="w-8 h-8 flex-shrink-0 bg-red-500 rounded-full flex items-center justify-center text-white">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </div>
                        <div>
                            <h4 class="font-bold text-red-800">Risk in Digital Loans</h4>
                            <p class="text-sm text-red-700 mt-1">The Digital Loans portfolio, while small, shows a worrying trend with the highest and rising delinquency (6.8% DPD 30+), suggesting a need for immediate underwriting policy review.</p>
                        </div>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg flex items-start space-x-4">
                        <div class="w-8 h-8 flex-shrink-0 bg-orange-500 rounded-full flex items-center justify-center text-white">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a2 2 0 00-.266 1.4z" /></svg>
                        </div>
                         <div>
                            <h4 class="font-bold text-orange-800">Potential Margin Pressure</h4>
                            <p class="text-sm text-orange-700 mt-1">The narrowing spread between portfolio yield (24.5%) and cost of funds (12.5%) indicates potential margin pressure. This could be mitigated by focusing growth on higher-quality, lower-risk segments.</p>
                        </div>
                    </div>
                `;
            }

            // Originator Onboarding Workflow
            uploadOriginatorFilesBtn.addEventListener('click', () => {
                originatorUpload.classList.add('hidden');
                originatorAnalyzing.classList.remove('hidden');
                setTimeout(() => {
                    originatorAnalyzing.classList.add('hidden');
                    originatorAnalysisResult.classList.remove('hidden');
                    
                    const extractedName = "Fusion Microfinance";
                    const extractedCategory = "NBFC-MFI";
                    const extractedScore = "A+";

                    analysisOriginatorName.textContent = extractedName;
                    analysisOriginatorCategory.textContent = extractedCategory;
                    const analysisKiScoreBtn = document.getElementById('analysisKiScore');
                    analysisKiScoreBtn.dataset.name = extractedName;
                    analysisKiScoreBtn.textContent = extractedScore;
                    
                    renderOriginatorInsights();

                    createOrUpdateChart('assetClassDistChart', { type: 'doughnut', data: { labels: ['Two-Wheeler', 'Agri-Finance', 'MSME Loans', 'Digital Loans'], datasets: [{ data: [35, 25, 20, 20], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#0f766e'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });
                    createOrUpdateChart('geographicalDistChart', { type: 'doughnut', data: { labels: ['Maharashtra', 'Uttar Pradesh', 'Tamil Nadu', 'Karnataka', 'Other'], datasets: [{ data: [45, 25, 15, 10, 5], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#0f766e', '#99f6e4'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });
                    createOrUpdateChart('delinquencyByAssetClass30', { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Two-Wheeler', data: [4.1,4.2,4.5,4.3,4.6,4.5], borderColor: '#14b8a6' }, { label: 'Agri-Finance', data: [3.1,3.2,3.5,3.3,3.6,3.5], borderColor: '#84cc16' }, { label: 'MSME Loans', data: [5.1,5.2,5.5,5.3,5.6,5.5], borderColor: '#f97316' }, { label: 'Digital Loans', data: [6.1,6.2,6.5,6.3,6.6,6.8], borderColor: '#ef4444' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
                    createOrUpdateChart('delinquencyByAssetClass90', { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Two-Wheeler', data: [1.8,1.9,2.1,2.0,2.2,2.1], borderColor: '#14b8a6' }, { label: 'Agri-Finance', data: [0.8,0.9,0.9,0.8,0.9,0.9], borderColor: '#84cc16' }, { label: 'MSME Loans', data: [2.8,2.9,3.1,3.0,3.2,3.1], borderColor: '#f97316' }, { label: 'Digital Loans', data: [3.8,3.9,4.1,4.0,4.2,4.2], borderColor: '#ef4444' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
                    createOrUpdateChart('portfolioGrowthChart', { type: 'bar', data: { labels: ['Q1 24', 'Q2 24', 'Q3 24', 'Q4 24', 'Q1 25', 'Q2 25'], datasets: [{ label: 'AUM (INR Crores)', data: [4100, 4300, 4400, 4600, 4800, 5000], backgroundColor: '#14b8a6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                    createOrUpdateChart('yieldVsCofChart', { type: 'line', data: { labels: ['Q1 24', 'Q2 24', 'Q3 24', 'Q4 24', 'Q1 25', 'Q2 25'], datasets: [{ label: 'Portfolio Yield', data: [25.1, 25.3, 25.0, 24.8, 24.6, 24.5], borderColor: '#14b8a6' }, { label: 'Cost of Funds', data: [11.1, 11.3, 11.5, 11.8, 12.0, 12.5], borderColor: '#f97316' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
                }, 2000);
            });
            onboardOriginatorBtn.addEventListener('click', () => {
                const kiScoreButton = document.getElementById('analysisKiScore');
                const newOriginator = {
                    id: analysisOriginatorName.textContent.toLowerCase().replace(/\s/g, ''),
                    name: analysisOriginatorName.textContent,
                    score: kiScoreButton.textContent,
                    par: document.getElementById('analysisPar').textContent,
                    yield: document.getElementById('analysisYield').textContent,
                    aum: document.getElementById('analysisAum').textContent
                };
                state.originators.push(newOriginator);
                renderOriginators();
                showPage('dealScreenHomePage');
                updateHomeTab('originators');
                originatorAnalysisResult.classList.add('hidden');
                originatorUpload.classList.remove('hidden');
            });

            // Pool Creation Workflow
            uploadPoolBtn.addEventListener('click', () => updatePoolSubStep('poolMappingSubStep'));
            validateMappedPoolBtn.addEventListener('click', () => updatePoolSubStep('poolValidationErrorSubStep'));
            reuploadPoolBtn.addEventListener('click', () => {
                updatePoolSubStep('poolStructuringSubStep');
            });

            function calculateWaterfall(poolValue, lossRate) {
                const totalPrincipal = poolValue * 0.85;
                const totalInterest = poolValue * 0.15;
                const totalCashflow = totalPrincipal + totalInterest;

                const seniorPrincipalDue = totalPrincipal * 0.8;
                const seniorInterestDue = totalInterest * 0.8; 
                const mezzPrincipalDue = totalPrincipal * 0.12;
                const mezzInterestDue = totalInterest * 0.12;

                const totalLoss = poolValue * (lossRate / 100);
                const availableCashflow = totalCashflow - totalLoss;
                
                const seniorPayout = Math.min(availableCashflow, seniorPrincipalDue + seniorInterestDue);
                const cashAfterSenior = availableCashflow - seniorPayout;
                
                const mezzPayout = Math.min(cashAfterSenior, mezzPrincipalDue + mezzInterestDue);
                const cashAfterMezz = cashAfterSenior - mezzPayout;

                const equityPayout = Math.max(0, cashAfterMezz);

                const split = (payout) => ({
                    principal: payout * 0.85,
                    interest: payout * 0.15
                });
                
                return {
                    senior: split(seniorPayout),
                    mezz: split(mezzPayout),
                    equity: split(equityPayout)
                };
            }

            function applyFilters() {
                simulationResultsPanel.classList.remove('hidden');
                simulationOriginatorName.textContent = 'For Originator: Fusion Microfinance';
                document.getElementById('selectedLoans').textContent = '9,540';
                document.getElementById('poolValue').textContent = `₹98 Cr`;
                document.getElementById('poolTenure').textContent = `18 mo`;
                
                const baseLossRate = 4.1;
                sensitivityLossSlider.value = baseLossRate;
                sensitivityLossLabel.textContent = `${baseLossRate}%`;
                
                const baseCase = calculateWaterfall(98, baseLossRate);
                state.simulationBaseCase = { ...baseCase, lossRate: baseLossRate };

                runSensitivitySimulation(false); // Run initial simulation without showing modal

                 createOrUpdateChart('geoConcentrationChart', {
                    type: 'doughnut',
                    data: {
                        labels: ['Maharashtra', 'Uttar Pradesh', 'Tamil Nadu', 'Karnataka', 'Rajasthan'],
                        datasets: [{ data: [25, 22, 20, 18, 15], backgroundColor: ['#14b8a6', '#0f766e', '#5eead4', '#99f6e4', '#a7f3d0'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Geographic Concentration' } } }
                });

                createOrUpdateChart('kiScoreDistChart', {
                    type: 'bar',
                    data: {
                        labels: ['1-20', '21-40', '41-60', '61-80', '81-100'],
                        datasets: [{ label: 'Loan Count', data: [4500, 3200, 1500, 340, 0], backgroundColor: '#14b8a6' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'KI Score Distribution (Lower is Better)' } } }
                });
            }

            function runSensitivitySimulation(showModal = true) {
                const lossRate = parseFloat(sensitivityLossSlider.value);
                document.getElementById('estimatedLoss').textContent = `${lossRate.toFixed(1)}%`;
                
                const tenureMin = tenureMinSlider.value;
                const tenureMax = tenureMaxSlider.value;
                document.getElementById('lossCompTenureBucket').textContent = `${tenureMin} to ${tenureMax} months`;
                document.getElementById('lossCompTenureBucketRate').textContent = `${(lossRate - 0.2).toFixed(2)}%`;
                document.getElementById('lossCompTenureOverallRate').textContent = `${(lossRate + 1.0).toFixed(2)}%`;

                const amountMin = loanAmountMinSlider.value / 1000;
                const amountMax = loanAmountMaxSlider.value / 1000;
                document.getElementById('lossCompAmountBucket').textContent = `₹${amountMin}k to ₹${amountMax}k`;
                document.getElementById('lossCompAmountBucketRate').textContent = `${(lossRate - 0.1).toFixed(2)}%`;
                document.getElementById('lossCompAmountOverallRate').textContent = `${(lossRate + 1.5).toFixed(2)}%`;

                const interestMin = interestRateMinSlider.value;
                const interestMax = interestRateMaxSlider.value;
                document.getElementById('lossCompInterestBucket').textContent = `${interestMin}% to ${interestMax}%`;
                document.getElementById('lossCompInterestBucketRate').textContent = `${(lossRate + 0.2).toFixed(2)}%`;
                document.getElementById('lossCompInterestOverallRate').textContent = `${(lossRate + 1.2).toFixed(2)}%`;

                document.getElementById('overallEstimatedLoss').textContent = `${lossRate.toFixed(1)}%`;


                const stressedCase = calculateWaterfall(98, lossRate);

                createOrUpdateChart('waterfallChart', {
                    type: 'bar',
                    data: {
                        labels: ['Senior', 'Mezzanine', 'Equity (Residual)'],
                        datasets: [{
                            label: 'Principal',
                            data: [
                                stressedCase.senior.principal.toFixed(1),
                                stressedCase.mezz.principal.toFixed(1),
                                stressedCase.equity.principal.toFixed(1)
                            ],
                            backgroundColor: '#0d9488'
                        }, {
                            label: 'Interest',
                            data: [
                                stressedCase.senior.interest.toFixed(1),
                                stressedCase.mezz.interest.toFixed(1),
                                stressedCase.equity.interest.toFixed(1)
                            ],
                            backgroundColor: '#5eead4'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'Cashflow Payout Waterfall (INR Crores)'
                            }
                        },
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'INR Crores'
                                }
                            }
                        }
                    }
                });

                if (showModal && state.simulationBaseCase.lossRate) {
                    document.getElementById('baseLossRate').textContent = `${state.simulationBaseCase.lossRate.toFixed(1)}%`;
                    document.getElementById('stressedLossRate').textContent = `${lossRate.toFixed(1)}%`;
                    
                    const baseSeniorTotal = state.simulationBaseCase.senior.principal + state.simulationBaseCase.senior.interest;
                    const stressedSeniorTotal = stressedCase.senior.principal + stressedCase.senior.interest;

                    const baseMezzTotal = state.simulationBaseCase.mezz.principal + state.simulationBaseCase.mezz.interest;
                    const stressedMezzTotal = stressedCase.mezz.principal + stressedCase.mezz.interest;

                    const baseEquityTotal = state.simulationBaseCase.equity.principal + state.simulationBaseCase.equity.interest;
                    const stressedEquityTotal = stressedCase.equity.principal + stressedCase.equity.interest;

                    document.getElementById('baseSenior').textContent = baseSeniorTotal.toFixed(1);
                    document.getElementById('stressedSenior').textContent = stressedSeniorTotal.toFixed(1);
                    document.getElementById('impactSenior').textContent = (stressedSeniorTotal - baseSeniorTotal).toFixed(1);

                    document.getElementById('baseMezz').textContent = baseMezzTotal.toFixed(1);
                    document.getElementById('stressedMezz').textContent = stressedMezzTotal.toFixed(1);
                    document.getElementById('impactMezz').textContent = (stressedMezzTotal - baseMezzTotal).toFixed(1);

                    const equityImpact = stressedEquityTotal - baseEquityTotal;
                    document.getElementById('baseEquity').textContent = baseEquityTotal.toFixed(1);
                    document.getElementById('stressedEquity').textContent = stressedEquityTotal.toFixed(1);
                    document.getElementById('impactEquity').textContent = equityImpact.toFixed(1);

                    sensitivityModal.classList.add('active');
                }
            }

            applyFiltersBtn.addEventListener('click', applyFilters);
            runSensitivitySimulationBtn.addEventListener('click', () => runSensitivitySimulation(true));
            closeSensitivityModalBtn.addEventListener('click', () => sensitivityModal.classList.remove('active'));

            finalizePoolBtn.addEventListener('click', () => {
                finalizePoolModal.classList.add('active');
            });
            cancelFinalizeBtn.addEventListener('click', () => finalizePoolModal.classList.remove('active'));
            saveTransactionBtn.addEventListener('click', () => {
                const name = finalizeTransactionNameInput.value.trim();
                if (name) {
                    const newTransaction = {
                        id: name.toUpperCase().replace(/\s/g, '-'),
                        name: name,
                        originator: 'Fusion Microfinance',
                        structure: 'Securitisation',
                        grade: document.getElementById('poolGrade').textContent,
                        tenure: document.getElementById('poolTenure').textContent,
                        yield: 'N/A',
                        covenantsSet: false
                    };
                    state.transactions.unshift(newTransaction);
                    renderActiveTransactions();
                    finalizePoolModal.classList.remove('active');
                    finalizeTransactionNameInput.value = '';
                    showPage('dealScreenHomePage');
                    updateHomeTab('transactions');
                }
            });

            function setupRangeSlider(minSlider, maxSlider, minLabel, maxLabel, formatter) {
                minSlider.addEventListener('input', () => {
                    if (parseInt(minSlider.value) > parseInt(maxSlider.value)) {
                        minSlider.value = maxSlider.value;
                    }
                    minLabel.textContent = formatter(minSlider.value);
                });
                maxSlider.addEventListener('input', () => {
                     if (parseInt(maxSlider.value) < parseInt(minSlider.value)) {
                        maxSlider.value = minSlider.value;
                    }
                    maxLabel.textContent = formatter(maxSlider.value);
                });
            }

            setupRangeSlider(kiScoreMinSlider, kiScoreMaxSlider, kiScoreMinLabel, kiScoreMaxLabel, val => val);
            setupRangeSlider(loanAmountMinSlider, loanAmountMaxSlider, loanAmountMinLabel, loanAmountMaxLabel, val => `₹${val/1000}k`);
            setupRangeSlider(tenureMinSlider, tenureMaxSlider, tenureMinLabel, tenureMaxLabel, val => val);
            setupRangeSlider(interestRateMinSlider, interestRateMaxSlider, interestRateMinLabel, interestRateMaxLabel, val => `${val}%`);

            sensitivityLossSlider.addEventListener('input', (e) => { sensitivityLossLabel.textContent = `${parseFloat(e.target.value).toFixed(1)}%`; });
            sensitivityPrepaymentSlider.addEventListener('input', (e) => { sensitivityPrepaymentLabel.textContent = `${parseFloat(e.target.value).toFixed(1)}%`; });


            // --- DealTrack Initialization ---
            dealTrackNav.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    dealTrackNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    const pageId = e.target.dataset.trackView + 'Page';
                    const txId = transactionSelector.value;
                    updateDealTrackPage(pageId, txId);
                }
            });

            saveCovenantBtn.addEventListener('click', () => {
                const tx = state.transactions.find(t => t.id === state.currentTransactionId);
                if (tx) {
                    tx.covenantsSet = true;
                    if (!state.covenantData[tx.id]) {
                        initializeCovenantData();
                    }
                }
                renderActiveTransactions();
                updateMainView('dealScreen');
                showPage('dealScreenHomePage');
                updateHomeTab('transactions');
            });

            // --- Covenant Monitoring Logic ---
            function populateTransactionSelector(selectedTxId) {
                const selectors = [transactionSelector, perfTransactionSelector, impactTransactionSelector];
                selectors.forEach(selector => {
                    selector.innerHTML = '';
                    const eligibleTransactions = state.transactions.filter(t => t.covenantsSet);
                    eligibleTransactions.forEach(tx => {
                        const option = document.createElement('option');
                        option.value = tx.id;
                        option.textContent = tx.name;
                        selector.appendChild(option);
                    });
                     if (selectedTxId && eligibleTransactions.some(t => t.id === selectedTxId)) {
                        selector.value = selectedTxId;
                    }
                });
            }

            function renderCovenantMonitoringPage(txId) {
                const data = state.covenantData[txId];
                if (!data) {
                    covenantStatusTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">No covenant data available for this transaction.</td></tr>';
                    documentStatusTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">No document data available for this transaction.</td></tr>';
                    return;
                }

                const statusClasses = {
                    compliant: 'px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full',
                    submitted: 'px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full',
                    at_risk: 'px-2 py-1 font-semibold leading-tight text-orange-700 bg-orange-100 rounded-full',
                };

                covenantStatusTableBody.innerHTML = '';
                data.covenants.forEach(c => {
                    const row = `
                        <tr class="border-b">
                            <td class="px-4 py-2 font-medium text-gray-800">${c.name}</td>
                            <td class="px-4 py-2">${c.condition}</td>
                            <td class="px-4 py-2">${c.required}</td>
                            <td class="px-4 py-2">${c.actual}</td>
                            <td class="px-4 py-2"><span class="${statusClasses[c.status] || ''}">${c.status.replace('_', ' ')}</span></td>
                            <td class="px-4 py-2 text-center text-xl">${c.trend || ''}</td>
                        </tr>
                    `;
                    covenantStatusTableBody.innerHTML += row;
                });

                documentStatusTableBody.innerHTML = '';
                 data.documents.forEach(d => {
                    const row = `
                        <tr class="border-b">
                            <td class="px-4 py-2 font-medium text-gray-800">${d.name}</td>
                            <td class="px-4 py-2">${d.frequency}</td>
                            <td class="px-4 py-2">${d.nextDue}</td>
                            <td class="px-4 py-2"><span class="${statusClasses[d.status] || ''}">${d.status.replace('_', ' ')}</span></td>
                        </tr>
                    `;
                    documentStatusTableBody.innerHTML += row;
                });
                
                renderEWSChart('par90Chart', data.charts.par90, ewsPar90);
                renderEWSChart('collectionEffChart', data.charts.collectionEff, ewsCollectionEff);
                renderEWSChart('crarChart', data.charts.crar, ewsCrar);
                renderEWSChart('yieldChart', data.charts.yield, ewsYield);
            }

            function renderEWSChart(chartId, chartData, ewsElement) {
                const config = {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            {
                                label: 'Actuals',
                                data: chartData.actuals,
                                borderColor: '#0d9488',
                                backgroundColor: '#0d9488',
                                tension: 0.1,
                                borderWidth: 2
                            },
                            {
                                label: 'Estimates',
                                data: chartData.estimates,
                                borderColor: '#2563eb',
                                backgroundColor: '#2563eb',
                                borderDash: [5, 5],
                                tension: 0.1,
                                borderWidth: 2
                            },
                            {
                                label: 'Breach',
                                data: chartData.breachLine,
                                borderColor: '#ef4444',
                                backgroundColor: '#ef4444',
                                borderDash: [5, 5],
                                pointRadius: 0,
                                borderWidth: 1.5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'month', displayFormats: { month: 'MMM yy' } },
                                grid: { display: false }
                            },
                            y: { beginAtZero: false }
                        },
                        plugins: {
                            legend: { position: 'bottom', labels: { usePointStyle: true } },
                            tooltip: { mode: 'index', intersect: false }
                        }
                    }
                };
                createOrUpdateChart(chartId, config);

                if (chartData.predictedBreach) {
                    ewsElement.innerHTML = `
                        <span class="flex items-center text-red-600">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                            BREACH PREDICTED
                        </span>`;
                } else {
                    ewsElement.innerHTML = `
                        <span class="flex items-center text-green-600">
                           <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                            STABLE
                        </span>`;
                }
            }
            
            function renderPerformancePage(txId) {
                createOrUpdateChart('posByLoanPurposeChart', {
                    type: 'doughnut',
                    data: { labels: ['Two-Wheeler', 'Agri-Finance', 'MSME Loans', 'Other'], datasets: [{ data: [45, 25, 20, 10], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#0f766e'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
                createOrUpdateChart('posByCountyChart', {
                    type: 'doughnut',
                    data: { labels: ['Maharashtra', 'Uttar Pradesh', 'Tamil Nadu', 'Karnataka', 'Other'], datasets: [{ data: [40, 22, 18, 12, 8], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#0f766e', '#99f6e4'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });

                const barOptions = { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, title: { display: true, text: 'DPD 30+ (%)' } } } };
                createOrUpdateChart('parByLoanPurposeChart', { type: 'bar', data: { labels: ['Two-Wheeler', 'Agri-Finance', 'MSME Loans', 'Other'], datasets: [{ data: [4.2, 3.1, 5.5, 6.8], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#ef4444'] }] }, options: barOptions });
                createOrUpdateChart('parByCountyChart', { type: 'bar', data: { labels: ['Maharashtra', 'Uttar Pradesh', 'Tamil Nadu', 'Karnataka', 'Other'], datasets: [{ data: [4.1, 4.5, 8.1, 3.9, 5.2], backgroundColor: ['#14b8a6', '#5eead4', '#ef4444', '#0d9488', '#0f766e'] }] }, options: barOptions });
                createOrUpdateChart('parByLoanCycleChart', { type: 'bar', data: { labels: ['Cycle 1', 'Cycle 2', 'Cycle 3', 'Cycle 4+'], datasets: [{ data: [7.5, 4.1, 2.5, 1.8], backgroundColor: ['#ef4444', '#f97316', '#14b8a6', '#0d9488'] }] }, options: barOptions });
                createOrUpdateChart('parByKiScoreChart', { type: 'bar', data: { labels: ['> 60', '41-60', '21-40', '< 20'], datasets: [{ data: [9.2, 6.3, 3.1, 1.5], backgroundColor: ['#ef4444', '#f97316', '#14b8a6', '#0d9488'] }] }, options: barOptions });

                createOrUpdateChart('vintageAnalysisChart', {
                    type: 'line',
                    data: {
                        labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
                        datasets: [
                            { label: 'Q3 2024', data: [0.5, 1.1, 1.8, 2.5, 3.0, 3.4, 3.7, 3.9, 4.1, 4.2, 4.3, 4.3], borderColor: '#06b6d4', tension: 0.1 },
                            { label: 'Q4 2024', data: [0.4, 0.9, 1.5, 2.1, 2.6, 3.0, 3.3, 3.5, 3.6, null, null, null], borderColor: '#14b8a6', tension: 0.1 },
                            { label: 'Q1 2025', data: [0.3, 0.8, 1.3, 1.9, 2.3, null, null, null, null, null, null, null], borderColor: '#84cc16', tension: 0.1 },
                            { label: 'Q2 2025', data: [0.2, 0.6, 1.1, null, null, null, null, null, null, null, null, null], borderColor: '#f97316', tension: 0.1 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: {
                            x: { title: { display: true, text: 'Months on Book' } },
                            y: { title: { display: true, text: 'GNPA (%)' }, beginAtZero: true }
                        }
                    }
                });
            }

            function renderImpactPage(txId) {
                createOrUpdateChart('genderPerformanceChart', {
                    type: 'bar',
                    data: { labels: ['DPD 30+', 'Collection %'], datasets: [ { label: 'Female', data: [4.8, 98.5], backgroundColor: '#14b8a6' }, { label: 'Male', data: [5.3, 97.9], backgroundColor: '#0f766e' } ] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
                });
                createOrUpdateChart('sdgDoughnutChart', {
                    type: 'doughnut',
                    data: { labels: ['No Poverty', 'Decent Work', 'Reduced Inequality'], datasets: [{ data: [48, 32, 20], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '60%' }
                });
                createOrUpdateChart('sectorDoughnutChart', {
                    type: 'doughnut',
                    data: { labels: ['Retail', 'Transport', 'Agriculture', 'Services', 'Other'], datasets: [{ data: [35, 25, 20, 15, 5], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#0f766e', '#99f6e4'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, cutout: '60%' }
                });
                createOrUpdateChart('ruralUrbanChart', {
                    type: 'bar',
                    data: { labels: ['Rural', 'Semi-Urban', 'Urban'], datasets: [{ label: 'Borrower Count', data: [5197, 2362, 1891], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                 createOrUpdateChart('borrowerProfileChart', {
                    type: 'bar',
                    data: {
                        labels: ['First-Time Borrowers', 'Youth (<35)', 'Female Entrepreneurs'],
                        datasets: [{
                            label: 'Number of Borrowers',
                            data: [2835, 3780, 1850],
                            backgroundColor: ['#14b8a6', '#5eead4', '#0d9488']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
                });
            }

            function renderReportsPage(txId) {
                // Populate transaction selector for reports
                const reportsSelector = document.getElementById('reportsTransactionSelector');
                if (reportsSelector) {
                    reportsSelector.innerHTML = '';
                    state.transactions.filter(t => t.covenantsSet).forEach(tx => {
                        const option = document.createElement('option');
                        option.value = tx.id;
                        option.textContent = tx.name;
                        option.selected = tx.id === txId;
                        reportsSelector.appendChild(option);
                    });
                }

                // Collection Efficiency Trend
                createOrUpdateChart('reportCollectionChart', {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Collection Efficiency %',
                            data: [97.2, 97.5, 98.1, 97.8, 98.3, 98.5, 98.2, 98.7, 98.4, 98.9, 99.1, 98.8],
                            borderColor: '#14b8a6',
                            backgroundColor: 'rgba(20, 184, 166, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false, min: 96, max: 100 } } }
                });

                // Cash Flow Waterfall
                createOrUpdateChart('reportWaterfallChart', {
                    type: 'bar',
                    data: {
                        labels: ['Collections', 'Fees & Charges', 'Senior Expenses', 'Interest Payment', 'Principal Payment', 'Reserve Account', 'Residual'],
                        datasets: [{
                            label: 'Amount (₹ Cr)',
                            data: [8.5, 0.3, -0.5, -3.2, -4.1, -0.5, 0.5],
                            backgroundColor: ['#14b8a6', '#5eead4', '#ef4444', '#ef4444', '#ef4444', '#f59e0b', '#10b981']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                // DPD Bucket Analysis
                createOrUpdateChart('reportDPDChart', {
                    type: 'bar',
                    data: {
                        labels: ['Current', '1-30 DPD', '31-60 DPD', '61-90 DPD', '90+ DPD'],
                        datasets: [{
                            label: 'Number of Loans',
                            data: [8750, 420, 180, 60, 40],
                            backgroundColor: ['#10b981', '#f59e0b', '#fb923c', '#f97316', '#ef4444']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                // Portfolio Composition
                createOrUpdateChart('reportCompositionChart', {
                    type: 'doughnut',
                    data: {
                        labels: ['Two-Wheeler', 'MSME Loans', 'Agri-Finance', 'Personal Loans', 'Other'],
                        datasets: [{
                            data: [45, 25, 15, 10, 5],
                            backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#0f766e', '#99f6e4']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });

                // Geographic Concentration
                createOrUpdateChart('reportGeoChart', {
                    type: 'bar',
                    data: {
                        labels: ['Maharashtra', 'Uttar Pradesh', 'Tamil Nadu', 'Karnataka', 'Rajasthan', 'Gujarat', 'Others'],
                        datasets: [{
                            label: 'AUM (₹ Cr)',
                            data: [25, 18, 15, 12, 10, 8, 5.5],
                            backgroundColor: '#14b8a6'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
                });

                // Vintage Analysis
                createOrUpdateChart('reportVintageChart', {
                    type: 'line',
                    data: {
                        labels: ['Q1 2024', 'Q2 2024', 'Q3 2024', 'Q4 2024', 'Q1 2025', 'Q2 2025'],
                        datasets: [{
                            label: 'GNPA %',
                            data: [3.8, 3.5, 3.2, 3.0, 2.8, 3.2],
                            borderColor: '#14b8a6',
                            backgroundColor: 'rgba(20, 184, 166, 0.1)',
                            fill: true
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            function generatePMAReport(txId) {
                const transaction = state.transactions.find(t => t.id === txId) || state.transactions[0];
                const reportMonth = document.getElementById('reportMonthSelector')?.value || '2025-11';
                const [year, month] = reportMonth.split('-');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const monthName = monthNames[parseInt(month) - 1];
                const reportDate = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'long', year: 'numeric' });
                
                // Calculate required metrics
                const delinquencyRatio = '4.4%';
                const dynamicDefaultRatio = '0.42%';
                const repaymentSpeed = '8.5% CPR';
                const discountedBalance = '₹93.5 Cr';
                const previousCollections = '₹8.5 Cr';
                const transactionAccountBalance = '₹8.5 Cr';
                const difference = '₹0.00';
                
                // Generate PMA Report content following exact template
                const reportContent = `
PORTFOLIO MONITORING AGENT LETTER
=====================================

${reportDate}

Required Recipients:
[Issuer Name]
[Security Trustee Name]
[Cash Manager Name]
[Senior Note Agent Name]
[Servicer Name]

Dear Required Recipients,

Re: Portfolio Monitoring Agent Services - ${transaction.name}

We, Kaleidofin Private Limited, in our capacity as the Portfolio Monitoring Agent, hereby provide this letter to the Required Recipients in accordance with Clause 3.1 (Services) and subject to, without limitation, Clause 7.1 (Portfolio Monitoring Agent limitation of liability) of the Portfolio Monitoring Agreement. This letter serves to specify the determinations and confirmations to be made by us for the reporting period ending ${monthName} ${year}, as outlined below:

1. DETERMINATION OF TESTED ELIGIBILITY CRITERIA
------------------------------------------------
We confirm that, in our reasonable opinion based on the information provided, there are no breaches of the Tested Eligibility Criteria with respect to the Receivables in the portfolio as of the Month-End Reporting Cut-Off Date.

Status: ✓ NO BREACHES IDENTIFIED

2. CONSISTENCY AND CALCULATIONS
--------------------------------
We have reviewed the information provided in the Monthly Receivables Data Tape we received on ${reportDate} and compared it with the information in the systems used by the Servicer to service, administer, collect and manage the Portfolio Receivables which we have access to.

We hereby confirm that: NO MANIFEST ERRORS HAVE BEEN IDENTIFIED

The information in the Draft Servicer Report and Monthly Receivables Data Tape regarding Defaulted Receivables, Delinquent Receivables, and Repayment Speed is materially consistent with the information available in the Servicer's systems.

Additionally, we have calculated the following metrics:

   Delinquency Ratio: ${delinquencyRatio}
   Dynamic Default Ratio: ${dynamicDefaultRatio}
   Repayment Speed: ${repaymentSpeed}

Calculation Details:
- Delinquency Ratio = (Delinquent Receivables / Total Portfolio Balance) × 100
- Dynamic Default Ratio = (Defaulted Receivables in Period / Beginning Portfolio Balance) × 100
- Repayment Speed = Annualized prepayment rate (CPR method)

3. CONCENTRATION LIMITS
-----------------------
We confirm that the Portfolio Concentration Limits are satisfied with respect to the current portfolio composition.

Geographic Concentration:
   - Highest single state concentration: 26.7% (within limit)
   - Top 5 states represent: 85.5% (within limit)

Product Concentration:
   - Highest single product: 45% (within limit)
   - Diversification index: Satisfactory

Status: ✓ ALL CONCENTRATION LIMITS SATISFIED

4. DISCOUNTED BALANCE AND COLLECTIONS
--------------------------------------
Using the information in the Monthly Receivables Data Tape made available to us by the Servicer on ${reportDate}, we calculate that:

a) The Discounted Balance of all Portfolio Receivables (excluding Defaulted Receivables) is:
   ${discountedBalance}

b) Present Value Factor Applied: 0.952

c) Repayment Speed Applied: ${repaymentSpeed}

d) Minimum Remaining Tenor Confirmation: All receivables have minimum remaining tenor of not shorter than 6 months ✓

e) Collections Reconciliation:
   - Collections specified in Draft Servicer Report: ${previousCollections}
   - Amount in Transaction Account (as provided by Cash Manager): ${transactionAccountBalance}
   - Difference: ${difference}

Status: ✓ RECONCILIATION COMPLETE - NO MATERIAL DIFFERENCES

5. SERVICER REPORT VALIDATION
------------------------------
We have liaised with the Servicer regarding the Monthly Servicer Report and confirm that we are reasonably satisfied with the form and content of the proposed Monthly Servicer Report for ${monthName} ${year}.

Status: ✓ APPROVED FOR PUBLICATION

PORTFOLIO SUMMARY (as of Month-End)
------------------------------------
Pool Size: ₹93.5 Cr
Number of Receivables: 9,450
Average Receivable Size: ₹99,000
Weighted Average Yield: 22.5%
Weighted Average Remaining Tenor: 18 months

Delinquency Status:
- Current (0 DPD): 92.6% (8,750 receivables)
- 1-30 DPD: 4.4% (420 receivables)
- 31-60 DPD: 1.9% (180 receivables)
- 61-90 DPD: 0.6% (60 receivables)
- 90+ DPD: 0.4% (40 receivables)

CONCLUSION
----------
Based on our review and analysis, we confirm that:
✓ No material breaches of eligibility criteria
✓ No manifest errors identified
✓ All concentration limits satisfied
✓ Collections properly reconciled
✓ Servicer Report approved

Should you require any further information or clarification, please do not hesitate to contact us.

Yours faithfully,

_______________________________
[Portfolio Monitoring Agent Representative Name]
Kaleidofin Private Limited
Portfolio Monitoring Agent
Email: pma@kaleidofin.com
Date: ${reportDate}

---
CONFIDENTIAL - FOR AUTHORIZED RECIPIENTS ONLY
Next Report Due: 2 Business Days after next Month-End Servicer Report
`;

                // Create and download the report
                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `PMA_Report_${transaction.name}_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function generateCashManagerReport(txId) {
                const transaction = state.transactions.find(t => t.id === txId) || state.transactions[0];
                
                // Generate Cash Manager Report content
                const reportContent = `
CASH MANAGER INVESTOR REPORT
==============================
Transaction: ${transaction.name}
Originator: ${transaction.originator}
Report Date: ${new Date().toLocaleDateString('en-IN')}
Payment Date: 01-Dec-2025

TRANSACTION OVERVIEW
--------------------
Original Pool Size: ₹100.0 Cr
Current Pool Balance: ₹93.5 Cr
Number of Loans: 9,450
Transaction Structure: ${transaction.structure}
KI Score Grade: ${transaction.grade}

CASH FLOW SUMMARY (THIS MONTH)
-------------------------------
Opening Balance: ₹93.5 Cr

Inflows:
- Principal Collections: ₹7.2 Cr
- Interest Collections: ₹1.3 Cr
- Fees & Other Income: ₹0.3 Cr
Total Inflows: ₹8.8 Cr

Outflows:
- Senior Expenses (Servicing): ₹0.5 Cr
- Interest Payment to Investors: ₹3.2 Cr
- Principal Payment to Investors: ₹4.1 Cr
- Reserve Account Top-up: ₹0.5 Cr
Total Outflows: ₹8.3 Cr

Closing Balance: ₹94.0 Cr

PAYMENT WATERFALL
-----------------
1. Senior Fees & Expenses: ₹0.5 Cr ✓ Paid
2. Interest on Senior Tranche: ₹2.5 Cr ✓ Paid
3. Principal on Senior Tranche: ₹3.5 Cr ✓ Paid
4. Interest on Mezzanine Tranche: ₹0.7 Cr ✓ Paid
5. Principal on Mezzanine Tranche: ₹0.6 Cr ✓ Paid
6. Reserve Account (if below target): ₹0.5 Cr ✓ Funded
7. Residual to Originator: ₹0.5 Cr ✓ Paid

RESERVE ACCOUNTS
----------------
Cash Reserve Account:
- Required Balance: ₹2.0 Cr
- Current Balance: ₹2.0 Cr
- Status: ✓ Fully Funded

Credit Enhancement:
- Initial: 15.0%
- Current: 15.5%
- Status: ✓ Above Minimum

INVESTOR ALLOCATIONS
--------------------
Senior Tranche (Class A):
- Original Balance: ₹75.0 Cr
- Current Balance: ₹70.5 Cr
- Interest Rate: 9.5% p.a.
- This Month Interest: ₹2.5 Cr
- This Month Principal: ₹3.5 Cr

Mezzanine Tranche (Class B):
- Original Balance: ₹10.0 Cr
- Current Balance: ₹9.4 Cr
- Interest Rate: 11.5% p.a.
- This Month Interest: ₹0.7 Cr
- This Month Principal: ₹0.6 Cr

PORTFOLIO PERFORMANCE
---------------------
Weighted Average Coupon: 22.5%
Gross NPA: 3.2%
Collection Efficiency: 98.8%
Prepayment Rate (CPR): 8.5% annualized

UPCOMING OBLIGATIONS
--------------------
Next Payment Date: 01-Jan-2026
Expected Collections: ₹8.2 Cr
Expected Interest Payment: ₹3.1 Cr
Expected Principal Payment: ₹4.0 Cr

COMPLIANCE & COVENANTS
----------------------
✓ All financial covenants met
✓ All documentation current
✓ Reserve accounts fully funded
✓ No events of default

NOTES
-----
- All payments made on scheduled payment date
- No delays or deferrals
- Portfolio performing within expected parameters
- Credit enhancement levels maintained

---
Report Prepared by: KI Platform - Cash Management Services
Next Report Date: 01-Jan-2026
Contact: cashmanagement@kaleidofin.com
`;

                // Create and download the report
                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `CashManager_Report_${transaction.name}_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Event listeners for reports
            document.getElementById('downloadPMAReport')?.addEventListener('click', () => {
                const txId = document.getElementById('reportsTransactionSelector')?.value || state.transactions.filter(t => t.covenantsSet)[0]?.id;
                if (txId) generatePMAReport(txId);
            });

            document.getElementById('downloadCashReport')?.addEventListener('click', () => {
                const txId = document.getElementById('reportsTransactionSelector')?.value || state.transactions.filter(t => t.covenantsSet)[0]?.id;
                if (txId) generateCashManagerReport(txId);
            });

            document.getElementById('reportsTransactionSelector')?.addEventListener('change', (e) => {
                renderReportsPage(e.target.value);
            });

            transactionSelector.addEventListener('change', (e) => {
                renderCovenantMonitoringPage(e.target.value);
            });
             perfTransactionSelector.addEventListener('change', (e) => {
                renderPerformancePage(e.target.value);
            });
            impactTransactionSelector.addEventListener('change', (e) => {
                renderImpactPage(e.target.value);
            });


            function initializeMappingFields() {
                const container = document.getElementById('mappingFieldsContainer');
                const fields = ['loan_id', 'customer_id', 'customer_name', 'customer_dob', 'customer_gender', 'customer_location', 'principal_amount', 'disbursement_date', 'maturity_date', 'interest_rate', 'emi_amount', 'loan_cycle', 'collateral_type', 'collateral_value', 'bureau_score', 'dpd', 'last_payment_date', 'outstanding_principal', 'asset_make', 'asset_model'];
                let html = '<div class="grid grid-cols-2 gap-4"><span class="font-medium text-gray-500">Your File Column</span><span class="font-medium text-gray-500">KI Required Field</span></div>';
                fields.forEach(field => {
                    const formattedField = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    html += `<div class="grid grid-cols-2 gap-4 items-center p-2 bg-gray-50 rounded-md"><span class="text-sm">${field}</span><select class="block w-full rounded-md border-gray-300 shadow-sm text-sm"><option>${formattedField}</option></select></div>`;
                });
                container.innerHTML = html;
            }

            function initializeCountyMultiSelect() {
                 const indianStates = ["Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal", "Andaman and Nicobar Islands", "Chandigarh", "Dadra and Nagar Haveli and Daman and Diu", "Delhi", "Jammu and Kashmir", "Ladakh", "Lakshadweep", "Puducherry"];
                 const select = document.getElementById('countiesMultiSelect');
                 indianStates.forEach(state => {
                     const option = document.createElement('option');
                     option.value = state;
                     option.innerText = state;
                     select.appendChild(option);
                 });
                 countiesMultiSelect = new Choices(select, { removeItemButton: true });
                 countiesMultiSelect.setValue(['Maharashtra', 'Uttar Pradesh', 'Tamil Nadu', 'Karnataka', 'Rajasthan']);
            }
            
            // Initial Load
            updateMainView('dealScreen');
            showPage('dealScreenHomePage');
            updateHomeTab('originators');
            initializeData();
            initializeMappingFields();
            initializeCountyMultiSelect();
        });
    </script>
</body>
</html>