<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KI Product Demo - Kenya</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: White & Teal Professional -->
    <!-- Application Structure Plan: The application is structured as a Single Page Application (SPA) with two primary, switchable modules: "KI DealScreen" and "KI DealTrack". DealScreen features a tabbed home page for "Originators" and "Transactions". The Transactions tab is further divided into "Active" and "Available" portfolios. A new workflow is implemented where an "Active" transaction can have its covenants set up, which then changes its state and available actions. -->
    <!-- Visualization & Content Choices: 
        - Home Page: Goal: Overview/Navigate. Method: Tabbed interface. Detailed tables for originators and transactions (split into active/available). Interaction: Buttons to initiate workflows, filters, and links to other views/modules. Justification: Provides a clear, data-rich, and actionable starting point.
        - Loan Listing: Goal: Detailed view. Method: An expanded table listing individual loans within a pool. Interaction: Clickable KI scores. Justification: Fulfills the requirement for more detailed loan-level data.
        - KI Score Page: Goal: Explain/Drill-down. Method: A full-page view with a summary card for top contributors and multiple categorized cards for over 20 influencing variables. Justification: Adds a crucial layer of transparency and explainability.
        - Covenant Setup: Goal: Configure Monitoring. Method: A dedicated page matching the Figma design for setting up document and financial covenants. Justification: Implements a key user workflow.
        - Library/Method: Chart.js for all charting, Vanilla JS for all state management and interactivity, Tailwind CSS for all styling.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .view { display: none; }
        .view.active { display: block; }
        #dealTrackView { margin: 0; padding: 0; }
        #dealTrackView > div:first-child { margin-top: 0; }
        .page-view { display: none; }
        .page-view.active { display: block; }
        .home-tab-content { display: none; }
        .home-tab-content.active { display: block; }
        .sub-step { display: none; }
        .sub-step.active { display: block; }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active { background-color: #14b8a6; color: white; }
        .home-tab-link { transition: all 0.2s ease-in-out; border-bottom: 2px solid transparent; }
        .home-tab-link.active { border-color: #14b8a6; color: #0f766e; font-weight: 600; }
        .ki-score-link { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #14b8a6; cursor: pointer; border-radius: 50%; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #14b8a6; cursor: pointer; border-radius: 50%; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #14b8a6; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; }
        .modal.active { display: block; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Main Header -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-3">
                        <button id="homeBtn">
                             <svg width="150" height="40" viewBox="0 0 264 69" fill="none" xmlns="http://www.w3.org/2000/svg"> 
                                 <path d="M0 28.6165L29.6939 14.0607V25.7053L0 40.2611V28.6165Z" fill="#0F547E"/> 
                                 <path d="M0 40.5523L29.6939 55.1081V43.4634L0 28.9076V40.5523Z" fill="#28B2B6"/> 
                                 <path d="M67.9042 27.1169L57.14 38.4274L68.1228 54H59.2164L52.1131 43.7276L49.1079 46.8967V54H41.8407V14.4402H49.1079V37.1161L58.3967 27.1169H67.9042ZM66.8046 46.6782C66.8046 44.3833 67.5513 42.5437 69.0448 41.1595C70.5383 39.7752 72.469 38.901 74.8367 38.5367L81.4482 37.5532C82.796 37.3711 83.4699 36.7336 83.4699 35.6408C83.4699 34.6208 83.0692 33.783 82.2678 33.1273C81.5029 32.4716 80.3918 32.1438 78.9348 32.1438C77.4048 32.1438 76.1845 32.5627 75.2738 33.4005C74.3996 34.2383 73.9078 35.2765 73.7985 36.515L67.351 35.149C67.6059 32.8177 68.7534 30.7596 70.7933 28.9746C72.8332 27.1897 75.5288 26.2972 78.8801 26.2972C82.8871 26.2972 85.8377 27.2626 87.7319 29.1932C89.6261 31.0874 90.5732 33.528 90.5732 36.515V49.738C90.5732 51.3408 90.6825 52.7615 90.901 54H84.2349C84.0528 53.1986 83.9617 52.124 83.9617 50.7762C82.2496 53.4354 79.6087 54.765 76.0388 54.765C73.2704 54.765 71.0301 53.9636 69.318 52.3608C67.6424 50.758 66.8046 48.8638 66.8046 46.6782ZM77.5687 49.3556C79.2808 49.3556 80.6833 48.882 81.7761 47.9349C82.9053 46.9514 83.4699 45.3486 83.4699 43.1265V41.9244L77.4048 42.8533C75.1828 43.1812 74.0717 44.3104 74.0717 46.241C74.0717 47.1153 74.3814 47.862 75.0006 48.4813C75.6199 49.0641 76.4759 49.3556 77.5687 49.3556ZM101.887 54H94.62V14.4402H101.887V54ZM111.689 37.4986H123.71C123.637 36.005 123.091 34.7483 122.071 33.7284C121.087 32.7084 119.63 32.1984 117.7 32.1984C115.951 32.1984 114.531 32.7448 113.438 33.8376C112.345 34.9305 111.762 36.1508 111.689 37.4986ZM124.42 44.4925L130.486 46.2957C129.757 48.7727 128.318 50.8126 126.169 52.4154C124.056 54.0182 121.415 54.8196 118.246 54.8196C114.385 54.8196 111.106 53.5264 108.411 50.9401C105.715 48.3174 104.367 44.8204 104.367 40.4491C104.367 36.2965 105.679 32.9088 108.301 30.286C110.924 27.6268 114.021 26.2972 117.59 26.2972C121.743 26.2972 124.985 27.5358 127.316 30.0128C129.684 32.4898 130.868 35.8958 130.868 40.2306C130.868 40.522 130.85 40.8498 130.813 41.2141C130.813 41.5784 130.813 41.8698 130.813 42.0884L130.759 42.4708H111.525C111.598 44.2193 112.29 45.6764 113.602 46.8421C114.913 48.0078 116.479 48.5906 118.301 48.5906C121.397 48.5906 123.437 47.2246 124.42 44.4925ZM140.58 54H133.312V27.1169H140.58V54ZM132.438 18.3197C132.438 17.0812 132.875 16.0248 133.749 15.1506C134.624 14.2399 135.68 13.7846 136.919 13.7846C138.157 13.7846 139.214 14.2217 140.088 15.0959C140.962 15.9702 141.399 17.0448 141.399 18.3197C141.399 19.5218 140.962 20.56 140.088 21.4342C139.214 22.3085 138.157 22.7456 136.919 22.7456C135.68 22.7456 134.624 22.3085 133.749 21.4342C132.875 20.56 132.438 19.5218 132.438 18.3197ZM170.708 14.4402V49.137C170.708 50.9219 170.781 52.5429 170.926 54H163.987C163.805 53.0893 163.714 52.0512 163.714 50.8855C163.095 52.0147 162.111 52.9254 160.763 53.6175C159.452 54.3096 157.922 54.6557 156.173 54.6557C152.349 54.6557 149.198 53.3261 146.721 50.6669C144.28 47.9713 143.06 44.5836 143.06 40.5038C143.06 36.5332 144.262 33.2002 146.666 30.5046C149.107 27.809 152.203 26.4612 155.955 26.4612C159.816 26.4612 162.348 27.5722 163.55 29.7942V14.4402H170.708ZM150.382 40.5038C150.382 42.8715 151.001 44.7475 152.239 46.1318C153.478 47.4796 155.081 48.1535 157.048 48.1535C158.978 48.1535 160.563 47.4613 161.801 46.0771C163.04 44.6929 163.659 42.8169 163.659 40.4491C163.659 38.1178 163.04 36.2965 161.801 34.9851C160.563 33.6373 158.978 32.9634 157.048 32.9634C155.117 32.9634 153.514 33.6373 152.239 34.9851C151.001 36.3329 150.382 38.1725 150.382 40.5038ZM182.526 46.1864C183.873 47.5342 185.494 48.2081 187.389 48.2081C189.283 48.2081 190.886 47.5342 192.197 46.1864C193.545 44.8386 194.219 42.9626 194.219 40.5584C194.219 38.1542 193.545 36.2783 192.197 34.9305C190.886 33.5827 189.283 32.9088 187.389 32.9088C185.494 32.9088 183.873 33.5827 182.526 34.9305C181.214 36.2783 180.558 38.1542 180.558 40.5584C180.558 42.9626 181.214 44.8386 182.526 46.1864ZM177.28 30.3406C179.976 27.645 183.345 26.2972 187.389 26.2972C191.432 26.2972 194.783 27.645 197.442 30.3406C200.138 33.0362 201.486 36.4422 201.486 40.5584C201.486 44.6747 200.138 48.0806 197.442 50.7762C194.783 53.4718 191.432 54.8196 187.389 54.8196C183.345 54.8196 179.976 53.4718 177.28 50.7762C174.621 48.0806 173.291 44.6747 173.291 40.5584C173.291 36.4422 174.621 33.0362 177.28 30.3406Z" fill="#0F547E"/> 
                                 <path d="M223.396 33.3459H212.632V54H205.31V33.3459H200.829V27.1169H205.31V24.057C205.31 21.0335 206.184 18.6111 207.933 16.7898C209.717 14.9684 212.103 14.0578 215.09 14.0578C216.693 14.0578 217.895 14.2399 218.697 14.6042V20.7239C218.077 20.5418 217.312 20.4507 216.402 20.4507C215.418 20.4507 214.544 20.7421 213.779 21.325C213.014 21.8714 212.632 22.8185 212.632 24.1663V27.1169H230.608V54H223.396V33.3459ZM223.833 21.4342C222.959 20.56 222.522 19.5036 222.522 18.2651C222.522 17.0266 222.959 15.9702 223.833 15.0959C224.707 14.1853 225.764 13.7299 227.002 13.7299C228.241 13.7299 229.297 14.1853 230.171 15.0959C231.045 15.9702 231.483 17.0266 231.483 18.2651C231.483 19.5036 231.045 20.56 230.171 21.4342C229.297 22.2721 228.241 22.691 227.002 22.691C225.764 22.691 224.707 22.2721 223.833 21.4342ZM242.403 38.5367V54H235.136V27.1169H242.184V30.4499C242.949 29.1386 244.042 28.1368 245.463 27.4447C246.884 26.7526 248.377 26.4065 249.943 26.4065C253.113 26.4065 255.517 27.4083 257.156 29.4118C258.832 31.3788 259.669 33.9287 259.669 37.0614V54H252.402V38.3182C252.402 36.7154 251.983 35.4222 251.146 34.4387C250.344 33.4552 249.106 32.9634 247.43 32.9634C245.9 32.9634 244.68 33.4916 243.769 34.548C242.858 35.6044 242.403 36.9339 242.403 38.5367Z" fill="#28B2B6"/> 
                             </svg>
                        </button>
                    </div>
                    <div class="bg-gray-100 p-1 rounded-lg flex space-x-1">
                        <button id="dealScreenBtn" class="nav-link active px-4 py-1.5 text-sm font-semibold rounded-md">KI DealScreen</button>
                        <button id="dealTrackBtn" class="nav-link px-4 py-1.5 text-sm font-semibold rounded-md">KI DealTrack</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow">
            <!-- KI DealScreen View -->
            <div id="dealScreenView" class="view active">
                <div id="dealScreenHomePage" class="page-view active">
                    <div class="bg-white border-b">
                        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                            <nav id="homeTabsNav" class="flex space-x-8 -mb-px">
                                <button data-tab="originators" class="home-tab-link active py-4 px-1 text-sm font-medium">Originators</button>
                                <button data-tab="transactions" class="home-tab-link py-4 px-1 text-sm font-medium">Transactions</button>
                            </nav>
                        </div>
                    </div>
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <!-- Originators Tab -->
                        <div id="originatorsTab" class="home-tab-content active">
                            <div class="flex justify-between items-center mb-6">
                                <h1 class="text-2xl font-bold text-gray-800">Onboarded Originators</h1>
                                <button id="addNewOriginatorBtn" class="bg-teal-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-teal-700 text-sm">Add New Originator</button>
                            </div>
                            <div class="bg-white p-5 rounded-lg border shadow-sm">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left text-gray-500">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3">Originator Name</th>
                                                <th scope="col" class="px-6 py-3">KI Score Grade</th>
                                                <th scope="col" class="px-6 py-3">PAR 90+</th>
                                                <th scope="col" class="px-6 py-3">Avg. Yield</th>
                                                <th scope="col" class="px-6 py-3">Overall AUM (KES)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="originatorsTableBody">
                                            <!-- Originator rows will be dynamically inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- Transactions Tab -->
                        <div id="transactionsTab" class="home-tab-content">
                             <div class="flex justify-between items-center mb-6">
                                <h1 class="text-2xl font-bold text-gray-800">Transactions</h1>
                                <button id="createNewTransactionBtn" class="bg-teal-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-teal-700 text-sm">Create New Transaction</button>
                            </div>
                            <div class="mb-8">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">Active Transactions</h2>
                                <div class="bg-white p-5 rounded-lg border shadow-sm">
                                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Search</label>
                                            <input type="text" placeholder="e.g., RMFB-BODA-001" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Originator</label>
                                            <select class="mt-1 block w-full rounded-md border-gray-300 py-2 shadow-sm sm:text-sm">
                                                <option>All</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Structure</label>
                                            <select class="mt-1 block w-full rounded-md border-gray-300 py-2 shadow-sm sm:text-sm">
                                                <option>All</option>
                                                <option>Term Loan</option>
                                                <option>Securitisation</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Status</label>
                                            <select class="mt-1 block w-full rounded-md border-gray-300 py-2 shadow-sm sm:text-sm">
                                                <option>All</option>
                                                <option>Active</option>
                                                <option>Covenant Setup</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-left text-gray-500">
                                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                                <tr>
                                                    <th scope="col" class="px-6 py-3">Transaction Name</th>
                                                    <th scope="col" class="px-6 py-3">Originator</th>
                                                    <th scope="col" class="px-6 py-3">Structure</th>
                                                    <th scope="col" class="px-6 py-3">KI Score Grade</th>
                                                    <th scope="col" class="px-6 py-3">Avg. Tenure</th>
                                                    <th scope="col" class="px-6 py-3">Pool Yield</th>
                                                    <th scope="col" class="px-6 py-3 text-center">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="activeTransactionsTableBody">
                                                <!-- Active transactions will be dynamically inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">Available Transactions</h2>
                                 <div class="bg-white p-5 rounded-lg border shadow-sm">
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Search</label>
                                            <input type="text" placeholder="e.g., Agri-Finance Jun 2025" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Originator</label>
                                            <select class="mt-1 block w-full rounded-md border-gray-300 py-2 shadow-sm sm:text-sm">
                                                <option>All</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Asset Class</label>
                                            <select class="mt-1 block w-full rounded-md border-gray-300 py-2 shadow-sm sm:text-sm">
                                                <option>All</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-left text-gray-500">
                                             <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                                <tr>
                                                    <th scope="col" class="px-6 py-3">Portfolio Name</th>
                                                    <th scope="col" class="px-6 py-3">Originator</th>
                                                    <th scope="col" class="px-6 py-3">Asset Class</th>
                                                    <th scope="col" class="px-6 py-3">Pool Size (KES)</th>
                                                    <th scope="col" class="px-6 py-3">Avg. Tenure</th>
                                                    <th scope="col" class="px-6 py-3">Historical PAR 90+</th>
                                                    <th scope="col" class="px-6 py-3 text-center">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="availablePortfoliosTableBody">
                                                <!-- Available portfolios will be dynamically inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Originator Onboarding Page -->
                <div id="originatorOnboardingPage" class="page-view">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-2xl font-bold text-gray-800">Originator Onboarding & Analysis</h1>
                            <button class="back-btn bg-white text-gray-700 border border-gray-300 px-5 py-2 rounded-lg font-semibold hover:bg-gray-50 text-sm">‚Üê Back</button>
                        </div>
                        <div id="originatorUpload" class="max-w-2xl mx-auto text-center">
                            <div class="p-6 border-2 border-dashed border-gray-300 rounded-lg bg-white">
                                <p class="font-semibold mb-2">Upload Files</p>
                                <p class="text-sm text-gray-500 mb-4">Drag & drop or click to upload MIS portfolio report and financial statements.</p>
                                <button id="uploadOriginatorFilesBtn" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700">Upload & Analyze</button>
                            </div>
                        </div>
                        <div id="originatorAnalyzing" class="hidden max-w-2xl mx-auto text-center">
                            <div class="p-6 border border-gray-200 bg-white rounded-lg shadow-sm">
                                <p class="font-semibold mb-4">Analyzing Uploaded Files...</p>
                                <div class="space-y-3 text-left">
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                        <span class="text-sm font-medium text-gray-700">MIS_Portfolio_Jun2025.csv</span>
                                        <span class="text-sm text-green-600 font-semibold">‚úì Uploaded</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                        <span class="text-sm font-medium text-gray-700">Audited_Financials_2024.pdf</span>
                                        <span class="text-sm text-green-600 font-semibold">‚úì Uploaded</span>
                                    </div>
                                </div>
                                <div class="flex justify-center mt-6">
                                    <div class="spinner"></div>
                                </div>
                            </div>
                        </div>
                        <div id="originatorAnalysisResult" class="hidden mt-8 space-y-8">
                             <div class="max-w-2xl mx-auto bg-white p-4 rounded-lg border mb-6 text-center shadow-sm">
                                <h3 class="text-xl font-bold text-gray-800" id="analysisOriginatorName"></h3>
                                <p class="text-sm text-gray-500" id="analysisOriginatorCategory"></p>
                            </div>
                             <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
                                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-gray-500">Total AUM</p><p id="analysisAum" class="text-xl font-bold text-gray-800">KES 5.0B</p></div>
                                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-gray-500">Avg. Loan Size</p><p class="text-xl font-bold text-gray-800">KES 125K</p></div>
                                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-gray-500">PAR 90+</p><p id="analysisPar" class="text-xl font-bold text-red-600">4.2%</p></div>
                                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-gray-500">Avg. Tenure</p><p class="text-xl font-bold text-gray-800">22 Months</p></div>
                                <div class="bg-white p-4 rounded-lg border"><p class="text-sm text-gray-500">Avg. Yield</p><p id="analysisYield" class="text-xl font-bold text-green-600">34.5%</p></div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <div class="bg-white p-4 rounded-lg border"><h3 class="font-semibold text-center mb-2">Asset-Class Distribution</h3><div class="chart-container h-48"><canvas id="assetClassDistChart"></canvas></div></div>
                                <div class="bg-white p-4 rounded-lg border"><h3 class="font-semibold text-center mb-2">Geographical Distribution</h3><div class="chart-container h-48"><canvas id="geographicalDistChart"></canvas></div></div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg border lg:col-span-1 mb-6">
                                <h3 class="font-semibold text-center mb-2">KI Score Grade</h3>
                                <div class="text-center mt-4">
                                    <p class="text-5xl font-bold text-teal-600"><button id="analysisKiScore" class="ki-score-link" data-score-type="originator" data-name=""></button></p>
                                </div>
                            </div>

                            <div id="originatorInsightsContainer" class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <!-- Insights will be injected here by JS -->
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="bg-white p-4 rounded-lg border"><h3 class="font-semibold text-center mb-2">30+ Delinquency by Asset Class</h3><div class="chart-container h-64"><canvas id="delinquencyByAssetClass30"></canvas></div></div>
                                <div class="bg-white p-4 rounded-lg border"><h3 class="font-semibold text-center mb-2">90+ Delinquency (PAR 90+) by Asset Class</h3><div class="chart-container h-64"><canvas id="delinquencyByAssetClass90"></canvas></div></div>
                                <div class="bg-white p-4 rounded-lg border"><h3 class="font-semibold text-center mb-2">Portfolio Growth (AUM)</h3><div class="chart-container h-64"><canvas id="portfolioGrowthChart"></canvas></div></div>
                                <div class="bg-white p-4 rounded-lg border"><h3 class="font-semibold text-center mb-2">Yield vs. Cost of Funds</h3><div class="chart-container h-64"><canvas id="yieldVsCofChart"></canvas></div></div>
                            </div>
                             <div class="text-center mt-8">
                                <button id="onboardOriginatorBtn" class="bg-teal-600 text-white px-8 py-2.5 rounded-lg font-semibold hover:bg-teal-700">Onboard Originator</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Transaction Type Selection Page -->
                <div id="transactionTypePage" class="page-view">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                         <div class="flex justify-between items-center mb-8">
                            <h1 class="text-2xl font-bold text-gray-800">Create New Transaction</h1>
                             <button class="back-btn bg-white text-gray-700 border border-gray-300 px-5 py-2 rounded-lg font-semibold hover:bg-gray-50 text-sm">‚Üê Back</button>
                        </div>
                        <div class="max-w-md mx-auto text-center">
                            <p class="text-gray-600 mb-8">Please select the type of transaction you would like to create.</p>
                            <div class="space-y-4">
                                <button data-tx-type="Securitisation" class="tx-type-select-btn w-full bg-teal-600 text-white p-4 rounded-lg font-semibold text-lg hover:bg-teal-700">Securitisation</button>
                                <button data-tx-type="Term Loan" class="tx-type-select-btn w-full bg-white border border-gray-300 text-gray-700 p-4 rounded-lg font-semibold text-lg hover:bg-gray-50">Term Loan</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Pool Creation Page -->
                <div id="poolCreationPage" class="page-view">
                     <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <!-- Sub-Step 2a: Pool Upload -->
                        <div id="poolUploadSubStep" class="sub-step active">
                             <div class="flex justify-between items-center mb-8">
                                <h1 class="text-2xl font-bold text-gray-800">Pool Creation: Upload & Map</h1>
                                <button class="back-btn bg-white text-gray-700 border border-gray-300 px-5 py-2 rounded-lg font-semibold hover:bg-gray-50 text-sm">‚Üê Back</button>
                            </div>
                            <div class="max-w-2xl mx-auto text-center">
                                 <p class="mt-1 text-gray-600 mb-4">Upload and map the pool file to begin the validation process.</p>
                                <div class="p-6 border-2 border-dashed border-gray-300 rounded-lg bg-white">
                                    <p class="font-semibold mb-2">Upload Pool File (.csv)</p>
                                    <div class="mt-4 flex justify-center items-center space-x-4">
                                        <select class="block rounded-md border-gray-300 shadow-sm"><option>Select Asset Class</option><option selected>Boda-Boda Loans</option><option>Agri-Finance</option></select>
                                        <button id="uploadPoolBtn" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700">Upload & Map</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Sub-Step 2b: Enhanced Pool Mapping -->
                        <div id="poolMappingSubStep" class="sub-step">
                             <div class="max-w-6xl mx-auto bg-white border border-gray-200 p-6 rounded-lg">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                <h4 class="font-bold text-gray-800 text-lg">Map Pool File Columns</h4>
                                        <p class="text-sm text-gray-600 mt-1">Map columns from your file to database fields. Modify data types and add validations as needed.</p>
                                    </div>
                                    <button id="createNewFieldBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 text-sm flex items-center space-x-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        <span>Create New Field</span>
                                    </button>
                                </div>
                                
                                <div id="mappingFieldsContainer" class="mt-4 space-y-2">
                                    <div class="grid grid-cols-12 gap-2 text-xs font-semibold text-gray-600 bg-gray-50 p-3 rounded">
                                        <span class="col-span-3">Your File Column</span>
                                        <span class="col-span-3">Database Field</span>
                                        <span class="col-span-2">Data Type</span>
                                        <span class="col-span-2">Status</span>
                                        <span class="col-span-2 text-center">Actions</span>
                                    </div>
                                    <!-- Mapping fields will be dynamically inserted here -->
                                </div>
                                
                                <div class="mt-6 flex justify-between items-center">
                                    <div class="text-sm text-gray-600">
                                        <span class="font-semibold">15</span> fields mapped | 
                                        <span class="text-green-600 font-semibold">12</span> validated | 
                                        <span class="text-blue-600 font-semibold">2</span> custom fields | 
                                        <span class="text-orange-600 font-semibold">1</span> needs attention
                                    </div>
                                    <button id="validateMappedPoolBtn" class="bg-teal-600 text-white px-8 py-2.5 rounded-lg font-semibold hover:bg-teal-700">Validate Pool</button>
                                </div>
                            </div>
                        </div>
                        <!-- Sub-Step 2c: Pool Validation Error -->
                         <div id="poolValidationErrorSubStep" class="sub-step">
                            <div class="max-w-3xl mx-auto bg-red-50 border border-red-200 p-4 rounded-lg">
                                <h4 class="font-bold text-red-800">Validation Complete: Errors Found</h4>
                                <p class="text-sm text-red-700 mt-1">15,000 loans processed. 250 loans have data errors.</p>
                                <div class="mt-2 text-xs bg-white p-2 rounded border text-red-900">
                                    <p>Row 15: Invalid disbursement date format '2025/01/15'. Expected YYYY-MM-DD.</p>
                                    <p>Row 42: Principal amount is negative (-5000).</p>
                                </div>
                                <div class="mt-4 flex space-x-4">
                                    <button class="bg-red-600 text-white px-4 py-1.5 text-sm rounded-md font-semibold">Download Full Error File</button>
                                    <button id="reuploadPoolBtn" class="border border-gray-400 text-gray-700 px-4 py-1.5 text-sm rounded-md font-semibold">Re-upload Corrected File</button>
                                </div>
                            </div>
                        </div>
                        <!-- Sub-Step 2d: Structuring -->
                        <div id="poolStructuringSubStep" class="sub-step">
                            <div class="text-center mb-8">
                                <h1 class="text-2xl font-bold text-gray-800">Pool Analysis & Structuring</h1>
                                <p class="mt-1 text-gray-600">Analyze risk cuts to identify optimal filters, then structure the deal.</p>
                            </div>

                            <!-- INITIAL RISK ANALYTICS DASHBOARD (Before Filtering) -->
                            <div id="initialRiskAnalytics" class="mb-8">
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200 mb-6">
                                    <div class="flex items-center justify-between mb-4">
                                    <div>
                                            <h3 class="text-xl font-bold text-gray-800">üìä Pre-Filter Risk Analytics</h3>
                                            <p class="text-sm text-gray-600 mt-1">Explore risk distribution across the uploaded pool to identify optimal filter criteria</p>
                                        </div>
                                        <div class="bg-white px-4 py-2 rounded-lg border border-blue-300 text-center">
                                            <p class="text-xs text-gray-500">Total Pool Size</p>
                                            <p class="text-2xl font-bold text-blue-700">10,000 loans</p>
                                            <p class="text-xs text-gray-500 mt-1">KES 1,050M</p>
                                        </div>
                                    </div>

                                    <!-- Risk Metrics Summary Cards -->
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                        <div class="bg-white p-3 rounded-lg shadow-sm border">
                                            <p class="text-xs text-gray-500">Pool WA KI Score</p>
                                            <p class="text-2xl font-bold text-teal-600">32.5</p>
                                            <p class="text-xs text-gray-500 mt-1">Lower is better</p>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg shadow-sm border">
                                            <p class="text-xs text-gray-500">PAR30 (30+ DPD)</p>
                                            <p class="text-2xl font-bold text-yellow-600">6.2%</p>
                                            <p class="text-xs text-gray-500 mt-1">620 loans</p>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg shadow-sm border">
                                            <p class="text-xs text-gray-500">PAR60 (60+ DPD)</p>
                                            <p class="text-2xl font-bold text-orange-600">2.8%</p>
                                            <p class="text-xs text-gray-500 mt-1">280 loans</p>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg shadow-sm border">
                                            <p class="text-xs text-gray-500">PAR90 (90+ DPD)</p>
                                            <p class="text-2xl font-bold text-red-600">1.4%</p>
                                            <p class="text-xs text-gray-500 mt-1">140 loans</p>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg shadow-sm border">
                                            <p class="text-xs text-gray-500">Est. Loss Rate</p>
                                            <p class="text-2xl font-bold text-red-700">5.8%</p>
                                            <p class="text-xs text-gray-500 mt-1">Unfiltered</p>
                                        </div>
                                    </div>

                                    <!-- Risk Distribution Charts -->
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                        <!-- By County -->
                                        <div class="bg-white p-4 rounded-lg shadow border">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center justify-between">
                                                <span>Risk by County</span>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">WA KI Score</span>
                                            </h4>
                                            <div class="h-64"><canvas id="riskByCountyChart"></canvas></div>
                                            <p class="text-xs text-gray-600 mt-2">üí° <strong>Insight:</strong> Nairobi, Kiambu, and Nakuru show lowest risk (KI Score 22-26)</p>
                                        </div>

                                        <!-- By Loan Amount -->
                                        <div class="bg-white p-4 rounded-lg shadow border">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center justify-between">
                                                <span>Risk by Loan Amount</span>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">WA KI Score & PAR30</span>
                                            </h4>
                                            <div class="h-64"><canvas id="riskByAmountChart"></canvas></div>
                                            <p class="text-xs text-gray-600 mt-2">üí° <strong>Insight:</strong> KES 100k-200k range has lowest risk (KI Score 24, PAR30 3.8%)</p>
                                        </div>

                                        <!-- By Tenure -->
                                        <div class="bg-white p-4 rounded-lg shadow border">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center justify-between">
                                                <span>Risk by Residual Tenure</span>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">WA KI Score & DPD 90</span>
                                            </h4>
                                            <div class="h-64"><canvas id="riskByTenureChart"></canvas></div>
                                            <p class="text-xs text-gray-600 mt-2">üí° <strong>Insight:</strong> 12-24 month tenure shows optimal risk profile</p>
                                        </div>

                                        <!-- By Loan Purpose -->
                                        <div class="bg-white p-4 rounded-lg shadow border">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center justify-between">
                                                <span>Risk by Loan Purpose</span>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">WA KI Score</span>
                                            </h4>
                                            <div class="h-64"><canvas id="riskByPurposeChart"></canvas></div>
                                            <p class="text-xs text-gray-600 mt-2">üí° <strong>Insight:</strong> Agricultural inputs and Equipment financing perform best</p>
                                        </div>

                                        <!-- By Age Group -->
                                        <div class="bg-white p-4 rounded-lg shadow border">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center justify-between">
                                                <span>Risk by Borrower Age</span>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">WA KI Score & PAR60</span>
                                            </h4>
                                            <div class="h-64"><canvas id="riskByAgeChart"></canvas></div>
                                            <p class="text-xs text-gray-600 mt-2">üí° <strong>Insight:</strong> Age 35-50 segment shows strongest performance</p>
                                        </div>

                                        <!-- By Gender -->
                                        <div class="bg-white p-4 rounded-lg shadow border">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center justify-between">
                                                <span>Risk by Gender</span>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">WA KI Score & Loss Rate</span>
                                            </h4>
                                            <div class="h-64"><canvas id="riskByGenderChart"></canvas></div>
                                            <p class="text-xs text-gray-600 mt-2">üí° <strong>Insight:</strong> Female borrowers show 15% lower default rates</p>
                                        </div>
                                    </div>

                                    <!-- Comprehensive Risk Cut Recommendation Table -->
                                    <div class="bg-white p-4 rounded-lg shadow border">
                                        <h4 class="font-semibold text-gray-800 mb-3">üìà Recommended Filter Ranges (Based on Risk Analysis)</h4>
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th class="px-4 py-2 text-left">Filter Dimension</th>
                                                        <th class="px-4 py-2 text-left">Current Range</th>
                                                        <th class="px-4 py-2 text-left">Recommended Range</th>
                                                        <th class="px-4 py-2 text-right">Avg KI Score</th>
                                                        <th class="px-4 py-2 text-right">Est. Loss</th>
                                                        <th class="px-4 py-2 text-center">Risk Rating</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y">
                                                    <tr class="hover:bg-gray-50">
                                                        <td class="px-4 py-2 font-medium">KI Score</td>
                                                        <td class="px-4 py-2 text-gray-600">1-100</td>
                                                        <td class="px-4 py-2 text-teal-700 font-semibold">1-40</td>
                                                        <td class="px-4 py-2 text-right font-bold text-teal-600">23.2</td>
                                                        <td class="px-4 py-2 text-right text-green-600">3.2%</td>
                                                        <td class="px-4 py-2 text-center"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">Low Risk</span></td>
                                                    </tr>
                                                    <tr class="hover:bg-gray-50">
                                                        <td class="px-4 py-2 font-medium">Loan Amount</td>
                                                        <td class="px-4 py-2 text-gray-600">KES 10k-250k</td>
                                                        <td class="px-4 py-2 text-teal-700 font-semibold">KES 100k-200k</td>
                                                        <td class="px-4 py-2 text-right font-bold text-teal-600">24.1</td>
                                                        <td class="px-4 py-2 text-right text-green-600">3.5%</td>
                                                        <td class="px-4 py-2 text-center"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">Low Risk</span></td>
                                                    </tr>
                                                    <tr class="hover:bg-gray-50">
                                                        <td class="px-4 py-2 font-medium">Residual Tenure</td>
                                                        <td class="px-4 py-2 text-gray-600">1-48 months</td>
                                                        <td class="px-4 py-2 text-teal-700 font-semibold">12-24 months</td>
                                                        <td class="px-4 py-2 text-right font-bold text-teal-600">25.8</td>
                                                        <td class="px-4 py-2 text-right text-green-600">3.8%</td>
                                                        <td class="px-4 py-2 text-center"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">Low Risk</span></td>
                                                    </tr>
                                                    <tr class="hover:bg-gray-50">
                                                        <td class="px-4 py-2 font-medium">Counties</td>
                                                        <td class="px-4 py-2 text-gray-600">All 47</td>
                                                        <td class="px-4 py-2 text-teal-700 font-semibold">Top 10 urban</td>
                                                        <td class="px-4 py-2 text-right font-bold text-teal-600">26.5</td>
                                                        <td class="px-4 py-2 text-right text-green-600">4.1%</td>
                                                        <td class="px-4 py-2 text-center"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">Low Risk</span></td>
                                                    </tr>
                                                    <tr class="hover:bg-gray-50">
                                                        <td class="px-4 py-2 font-medium">Loan Purpose</td>
                                                        <td class="px-4 py-2 text-gray-600">All purposes</td>
                                                        <td class="px-4 py-2 text-teal-700 font-semibold">Agri Input, Equipment</td>
                                                        <td class="px-4 py-2 text-right font-bold text-teal-600">22.7</td>
                                                        <td class="px-4 py-2 text-right text-green-600">3.0%</td>
                                                        <td class="px-4 py-2 text-center"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">Low Risk</span></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="mt-4 p-3 bg-blue-50 rounded border border-blue-200">
                                            <p class="text-sm text-blue-900">
                                                <strong>üí° Recommendation:</strong> Applying these filters will reduce pool to ~9,500 loans (95% retention) with 
                                                <strong class="text-teal-700">WA KI Score: 25.2</strong> and 
                                                <strong class="text-green-700">Est. Loss: 3.8%</strong> (34% improvement from 5.8%)
                                            </p>
                                        </div>
                                    </div>

                                    <div class="mt-6 text-center">
                                        <button id="proceedToFiltersBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 shadow-lg">
                                            ‚úì Proceed to Apply Filters
                                        </button>
                                        <p class="text-xs text-gray-500 mt-2">Based on the analysis above, configure your filter criteria</p>
                                    </div>
                                </div>
                            </div>

                            <!-- FILTER & STRUCTURING SECTION (Shows after clicking "Proceed") -->
                            <div id="filterStructuringSection" class="hidden">
                            <div class="max-w-7xl mx-auto space-y-6">
                                <div class="bg-white rounded-lg border">
                                    <button id="toggleFiltersSection" class="w-full flex items-center justify-between p-6 text-left hover:bg-gray-50">
                                        <h4 class="font-semibold text-lg text-gray-800">Pool Filters</h4>
                                        <svg id="filtersChevron" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="filtersContent" class="px-6 pb-6">
                                    <div>
                                        
                                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            <!-- Pre-defined Filters -->
                                            <div class="space-y-4">
                                                <div class="flex items-center justify-between mb-3">
                                                    <h5 class="font-semibold text-gray-700">Pre-defined Filters</h5>
                                                </div>
                                        
                                        <!-- Quick Filters -->
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">KI Score Range (1-100, lower is better): <span id="kiScoreMinLabel" class="font-bold text-teal-600">1</span> - <span id="kiScoreMaxLabel" class="font-bold text-teal-600">40</span></label>
                                                <div class="flex space-x-2"><input id="kiScoreMinSlider" type="range" min="1" max="100" value="1"><input id="kiScoreMaxSlider" type="range" min="1" max="100" value="40"></div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Loan Amount (KES): <span id="loanAmountMinLabel" class="font-bold text-teal-600">50k</span> - <span id="loanAmountMaxLabel" class="font-bold text-teal-600">200k</span></label>
                                                <div class="flex space-x-2"><input id="loanAmountMinSlider" type="range" min="10000" max="250000" step="10000" value="50000"><input id="loanAmountMaxSlider" type="range" min="10000" max="250000" step="10000" value="200000"></div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Residual Tenure (Months): <span id="tenureMinLabel" class="font-bold text-teal-600">6</span> - <span id="tenureMaxLabel" class="font-bold text-teal-600">24</span></label>
                                                <div class="flex space-x-2"><input id="tenureMinSlider" type="range" min="1" max="48" value="6"><input id="tenureMaxSlider" type="range" min="1" max="48" value="24"></div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Loan Interest Rate (%): <span id="interestRateMinLabel" class="font-bold text-teal-600">18%</span> - <span id="interestRateMaxLabel" class="font-bold text-teal-600">30%</span></label>
                                                <div class="flex space-x-2"><input id="interestRateMinSlider" type="range" min="12" max="36" value="18"><input id="interestRateMaxSlider" type="range" min="12" max="36" value="30"></div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Counties</label>
                                                <select id="countiesMultiSelect" multiple></select>
                                            </div>
                                        </div>
                                    </div>
                                            
                                            <!-- Custom Filters -->
                                        <div class="space-y-4">
                                                <div class="flex items-center justify-between mb-3">
                                                    <h5 class="font-semibold text-gray-700">Custom Filters</h5>
                                                    <button id="openCustomFilterBtn" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 font-semibold">
                                                        + Custom Filter
                                                    </button>
                                                </div>
                                                
                                                <!-- Unified Filters Display -->
                                                <div id="unifiedFiltersDisplay" class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                                    <div class="text-sm font-semibold text-blue-900 mb-3 flex items-center justify-between">
                                                        <span>Active Filters</span>
                                                        <select id="filterLogicGlobal" class="text-xs border border-blue-300 rounded px-2 py-1 bg-white">
                                                            <option value="AND">Match ALL (AND)</option>
                                                            <option value="OR">Match ANY (OR)</option>
                                                        </select>
                                            </div>
                                                    <div id="activeFiltersContainer" class="space-y-2 text-xs">
                                                        <!-- Filter chips will appear here -->
                                                        <div class="text-gray-600 italic">No filters applied. Using default ranges.</div>
                                                </div>
                                            </div>
                                                </div>
                                            </div>
                                        
                                        <div class="mt-6 pt-4 border-t">
                                            <button id="applyFiltersBtn" class="w-full bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-700 text-sm">Apply All Filters</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <div id="simulationResultsPanel" class="bg-white rounded-lg border space-y-6 hidden">
                                    <button id="toggleResultsSection" class="w-full flex items-center justify-between p-6 text-left hover:bg-gray-50">
                                        <h4 class="text-lg font-semibold text-gray-800">Filter Results</h4>
                                        <svg id="resultsChevron" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="resultsContent" class="px-6 pb-6">
                                    <p id="simulationOriginatorName" class="text-center text-sm text-gray-600 mb-4"></p>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                                        <div class="bg-gray-50 p-3 rounded-md"><p class="text-sm text-gray-500">Transaction Grade</p><p id="poolGrade" class="text-xl font-bold text-teal-600"><button class="ki-score-link" data-score-type="pool" data-name="Simulated Pool">AA-</button></p></div>
                                        <div class="bg-gray-50 p-3 rounded-md"><p class="text-sm text-gray-500">Selected Loans</p><p id="selectedLoans" class="text-xl font-bold text-teal-600">9,540</p></div>
                                        <div class="bg-gray-50 p-3 rounded-md"><p class="text-sm text-gray-500">Pool Value (KES)</p><p id="poolValue" class="text-xl font-bold text-teal-600">980M</p></div>
                                        <div class="bg-gray-50 p-3 rounded-md"><p class="text-sm text-gray-500">W.A. Tenure</p><p id="poolTenure" class="text-xl font-bold text-teal-600">18 mo</p></div>
                                        <div class="bg-gray-50 p-3 rounded-md"><p class="text-sm text-gray-500">W.A. KI Score</p><p id="poolKiScore" class="text-xl font-bold text-teal-600">25</p></div>
                                        <div class="bg-gray-50 p-3 rounded-md"><p class="text-sm text-gray-500">Estimated Loss</p><p id="estimatedLoss" class="text-xl font-bold text-red-600">4.1%</p></div>
                                    </div>
                                    <!-- Enhanced Comparison Charts -->
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                        <!-- Risk by Interest Rate (Overall vs Filtered) -->
                                        <div class="bg-white p-4 rounded-lg shadow border">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center justify-between">
                                                <span>Risk by Interest Rate</span>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">WA KI Score & PAR30</span>
                                            </h4>
                                            <div class="h-64"><canvas id="filteredRiskByInterestRateChart"></canvas></div>
                                        </div>

                                        <!-- Risk by Loan Amount (Overall vs Filtered) -->
                                        <div class="bg-white p-4 rounded-lg shadow border">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center justify-between">
                                                <span>Risk by Loan Amount</span>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">WA KI Score & PAR30</span>
                                            </h4>
                                            <div class="h-64"><canvas id="filteredRiskByAmountChart"></canvas></div>
                                        </div>

                                        <!-- Risk by Residual Tenure (Overall vs Filtered) -->
                                        <div class="bg-white p-4 rounded-lg shadow border">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center justify-between">
                                                <span>Risk by Residual Tenure</span>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">WA KI Score & PAR90</span>
                                            </h4>
                                            <div class="h-64"><canvas id="filteredRiskByTenureChart"></canvas></div>
                                        </div>

                                        <!-- Risk by Loan Purpose (Overall vs Filtered) -->
                                        <div class="bg-white p-4 rounded-lg shadow border">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center justify-between">
                                                <span>Risk by Loan Purpose</span>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">WA KI Score</span>
                                            </h4>
                                            <div class="h-64"><canvas id="filteredRiskByPurposeChart"></canvas></div>
                                        </div>

                                        <!-- Risk by Borrower Age (Overall vs Filtered) -->
                                        <div class="bg-white p-4 rounded-lg shadow border">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center justify-between">
                                                <span>Risk by Borrower Age</span>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">WA KI Score & PAR60</span>
                                            </h4>
                                            <div class="h-64"><canvas id="filteredRiskByAgeChart"></canvas></div>
                                        </div>

                                        <!-- Risk by DTI Ratio (Overall vs Filtered) -->
                                        <div class="bg-white p-4 rounded-lg shadow border">
                                            <h4 class="font-semibold text-gray-800 mb-2 flex items-center justify-between">
                                                <span>Risk by DTI Ratio</span>
                                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">WA KI Score & Loss Rate</span>
                                            </h4>
                                            <div class="h-64"><canvas id="filteredRiskByDTIChart"></canvas></div>
                                        </div>
                                    </div>
                                        
                                        <!-- Filter Comparison Table -->
                                        <div class="md:col-span-2 border-t pt-4 mt-4">
                                            <h4 class="font-semibold text-center text-gray-700 mb-4">Filter Comparison: Selected Group vs Rest of Portfolio</h4>
                                            <div class="overflow-x-auto">
                                                <table class="w-full text-sm text-left text-gray-500">
                                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                                        <tr>
                                                            <th scope="col" class="px-4 py-2">Filter</th>
                                                            <th scope="col" class="px-4 py-2">Selected Bucket</th>
                                                            <th scope="col" class="px-4 py-2 text-right">Selected Group Loss Rate</th>
                                                            <th scope="col" class="px-4 py-2 text-right">Rest of Portfolio Loss Rate</th>
                                                            <th scope="col" class="px-4 py-2 text-right">Selected Group WA KI Score</th>
                                                            <th scope="col" class="px-4 py-2 text-right">Rest of Portfolio WA KI Score</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="filterComparisonTableBody">
                                                        <!-- Rows will be dynamically generated -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="text-center mt-4 bg-gray-100 p-3 rounded-md">
                                                <p class="text-sm font-medium text-gray-600">Overall Estimated Loss for Selected Pool</p>
                                                <p id="overallEstimatedLoss" class="text-xl font-bold text-red-600"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="border-t pt-6 text-center space-x-3 px-6 pb-6">
                                        <button id="finalizePoolBtn" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700">Finalize Filtered Pool</button>
                                        <button id="downloadFilteredPoolBtn" class="border border-teal-600 text-teal-700 px-6 py-2 rounded-lg font-semibold hover:bg-teal-50 hidden">
                                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                            </svg>
                                            Download Filtered Pool (CSV)
                                        </button>
                                            </div>
                                        </div>

                                    <!-- POST-FINALIZATION: Cashflow Generation Section -->
                                    <div id="postFinalizationSection" class="hidden border-t mt-6 pt-6">
                                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-lg border border-green-200">
                                            <div class="flex items-center justify-between mb-4">
                                                <div>
                                                    <h4 class="text-lg font-bold text-gray-800 flex items-center">
                                                        <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                        Pool Finalized Successfully
                                                    </h4>
                                                    <p class="text-sm text-gray-600 mt-1">Filtered pool locked. Ready to generate expected cashflows using AI models.</p>
                                    </div>
                                                <div class="bg-white px-4 py-2 rounded-lg border border-green-300 text-center">
                                                    <p class="text-xs text-gray-500">Finalized Pool</p>
                                                    <p class="text-xl font-bold text-green-700" id="finalizedLoanCount">9,540 loans</p>
                                                    <p class="text-xs text-gray-500 mt-1">KES <span id="finalizedPoolValue">980M</span></p>
                                    </div>
                                </div>
                                            
                                            <div class="bg-white p-4 rounded-lg border border-green-200 mb-4">
                                                <h5 class="font-semibold text-gray-700 mb-3">üìã Finalized Pool Summary</h5>
                                                <div class="grid grid-cols-3 gap-4 text-sm">
                                                    <div>
                                                        <p class="text-gray-500">WA KI Score</p>
                                                        <p class="font-bold text-teal-600" id="finalizedKiScore">25</p>
                            </div>
                                                    <div>
                                                        <p class="text-gray-500">Est. Loss Rate</p>
                                                        <p class="font-bold text-red-600" id="finalizedLossRate">4.1%</p>
                                    </div>
                                                    <div>
                                                        <p class="text-gray-500">WA Tenure</p>
                                                        <p class="font-bold text-gray-700" id="finalizedTenure">18 mo</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="text-center">
                                                <button id="generateCashflowBtn" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-8 py-3 rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700 shadow-lg">
                                                    ü§ñ Generate Expected Cashflows (AI Model)
                                                </button>
                                                <p class="text-xs text-gray-600 mt-2">Module 1 (PD Model) + Module 2 (Loan-Level Cashflow Model) will run</p>
                                                <button id="downloadLoanCashflowBtn" class="mt-4 border border-green-600 text-green-700 px-6 py-2 rounded-lg font-semibold hover:bg-green-50 hidden">
                                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                    </svg>
                                                    Download Loan-Level Cashflow File (CSV)
                                                </button>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- MONTE CARLO SIMULATION SECTION -->
                                    <div id="monteCarloSection" class="hidden border-t mt-6 pt-6">
                                        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 p-6 rounded-lg border border-purple-200">
                                            <button id="toggleMonteCarloSection" class="w-full flex items-center justify-between mb-4 text-left">
                                                <h4 class="text-lg font-bold text-gray-800 flex items-center">
                                                    <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                                    </svg>
                                                    Monte Carlo Simulation & Structuring
                                                </h4>
                                                <svg id="monteCarloChevron" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </button>
                                            <div id="monteCarloContent">
                                            <p class="text-sm text-gray-600 mb-6">Configure deal structure, simulation parameters and run 10,000-path Monte Carlo to generate full risk distribution</p>
                                            
                                            <!-- Deal Structure Configuration -->
                                            <div class="bg-white p-6 rounded-lg border border-purple-300 mb-6">
                                                <h5 class="font-semibold text-gray-700 mb-4 text-sm">üèóÔ∏è Deal Structure Configuration</h5>
                                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                                    <!-- Tranche Configuration -->
                                                    <div class="space-y-4">
                                                        <div class="flex items-center justify-between">
                                                            <h6 class="font-medium text-gray-600 text-xs uppercase">Tranche Configuration</h6>
                                                            <button id="addTrancheBtn" class="text-xs bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700 font-semibold">
                                                                + Add Tranche
                                                            </button>
                                                        </div>
                                                        <div id="tranchesContainer" class="space-y-3">
                                                            <!-- Tranches will be dynamically added here -->
                                                        </div>
                                                        <div class="border rounded-lg p-3 bg-gray-50">
                                                            <label class="block text-xs font-medium text-gray-600 mb-1">Equity/Junior (Auto-calculated)</label>
                                                            <div class="text-xs text-gray-500">
                                                                <p>Size: <span id="equityTrancheSize" class="font-bold text-gray-700">8%</span></p>
                                                                <p class="text-gray-400 italic">Unrated</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Credit Enhancement -->
                                                    <div class="space-y-4">
                                                        <div class="flex items-center justify-between">
                                                            <h6 class="font-medium text-gray-600 text-xs uppercase">Credit Enhancement</h6>
                                                            <button id="addCreditEnhancementBtn" class="text-xs bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700 font-semibold">
                                                                + Add Enhancement
                                                            </button>
                                                        </div>
                                                        <div id="creditEnhancementsContainer" class="space-y-3">
                                                            <!-- Credit enhancements will be dynamically added here -->
                                                        </div>
                                                        <div class="border rounded-lg p-3 bg-gray-50 text-xs">
                                                            <p class="text-gray-600 mb-1">Total Credit Enhancement:</p>
                                                            <p class="text-lg font-bold text-purple-700" id="totalCELabel">32%</p>
                                                            <p class="text-gray-500 mt-1">(Sum of all enhancements + Subordination)</p>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Payment Structure -->
                                                    <div class="space-y-4">
                                                        <h6 class="font-medium text-gray-600 text-xs uppercase">Payment Structure</h6>
                                                        <div class="space-y-3">
                                                            <div>
                                                                <label class="block text-xs font-medium text-gray-600 mb-2">Payment Type:</label>
                                                                <select id="paymentTypeSelect" class="w-full text-sm border-gray-300 rounded-md">
                                                                    <option value="bullet" selected>Bullet (Principal at maturity)</option>
                                                                    <option value="amortizing">Amortizing (Principal over term)</option>
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <label class="block text-xs font-medium text-gray-600 mb-2">Interest Payment Frequency:</label>
                                                                <select id="interestFreqSelect" class="w-full text-sm border-gray-300 rounded-md">
                                                                    <option value="monthly" selected>Monthly</option>
                                                                    <option value="quarterly">Quarterly</option>
                                                                    <option value="semi-annual">Semi-Annual</option>
                                                                    <option value="annual">Annual</option>
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <label class="block text-xs font-medium text-gray-600 mb-2">Principal Payment Schedule:</label>
                                                                <select id="principalScheduleSelect" class="w-full text-sm border-gray-300 rounded-md">
                                                                    <option value="bullet" selected>Bullet at Maturity</option>
                                                                    <option value="pro-rata">Pro-Rata Amortization</option>
                                                                    <option value="sequential">Sequential Pay</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Simulation Parameters -->
                                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                                <!-- Macro Factors -->
                                                <div class="bg-white p-4 rounded-lg border">
                                                    <h5 class="font-semibold text-gray-700 mb-3 text-sm">üìà Macro Scenario Factors</h5>
                                                    <div class="space-y-3">
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-600 mb-1">GDP Growth Rate: <span id="gdpGrowthLabel" class="text-purple-700 font-bold">5.5%</span></label>
                                                            <input id="gdpGrowthSlider" type="range" min="-2" max="10" step="0.5" value="5.5" class="w-full h-2 bg-gray-200 rounded-lg">
                                                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                                <span>-2%</span>
                                                                <span>10%</span>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-600 mb-1">Unemployment Rate: <span id="unemploymentLabel" class="text-purple-700 font-bold">7.5%</span></label>
                                                            <input id="unemploymentSlider" type="range" min="3" max="15" step="0.5" value="7.5" class="w-full h-2 bg-gray-200 rounded-lg">
                                                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                                <span>3%</span>
                                                                <span>15%</span>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-600 mb-1">CBK Policy Rate: <span id="cbkRateLabel" class="text-purple-700 font-bold">13.0%</span></label>
                                                            <input id="cbkRateSlider" type="range" min="7" max="18" step="0.5" value="13.0" class="w-full h-2 bg-gray-200 rounded-lg">
                                                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                                <span>7%</span>
                                                                <span>18%</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Portfolio Assumptions -->
                                                <div class="bg-white p-4 rounded-lg border">
                                                    <h5 class="font-semibold text-gray-700 mb-3 text-sm">üíº Portfolio Behavior Assumptions</h5>
                                                    <div class="space-y-3">
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-600 mb-1">Prepayment Rate (CPR): <span id="prepaymentRateLabel" class="text-purple-700 font-bold">8.0%</span></label>
                                                            <input id="prepaymentRateSlider" type="range" min="0" max="25" step="0.5" value="8.0" class="w-full h-2 bg-gray-200 rounded-lg">
                                                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                                <span>0%</span>
                                                                <span>25%</span>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-600 mb-1">Expected Loss Rate: <span id="lossRateLabel" class="text-purple-700 font-bold">4.1%</span></label>
                                                            <input id="lossRateSlider" type="range" min="1" max="15" step="0.1" value="4.1" class="w-full h-2 bg-gray-200 rounded-lg">
                                                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                                <span>1%</span>
                                                                <span>15%</span>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-600 mb-1">Recovery Rate (LGD): <span id="recoveryRateLabel" class="text-purple-700 font-bold">40%</span></label>
                                                            <input id="recoveryRateSlider" type="range" min="0" max="80" step="5" value="40" class="w-full h-2 bg-gray-200 rounded-lg">
                                                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                                                <span>0%</span>
                                                                <span>80%</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Monte Carlo Settings -->
                                                <div class="bg-white p-4 rounded-lg border">
                                                    <h5 class="font-semibold text-gray-700 mb-3 text-sm">üé≤ Monte Carlo Settings</h5>
                                                    <div class="space-y-3">
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-600 mb-1">Number of Paths</label>
                                                            <select id="numPathsSelect" class="w-full text-sm border-gray-300 rounded-md">
                                                                <option value="1000">1,000 (Fast)</option>
                                                                <option value="5000">5,000 (Balanced)</option>
                                                                <option value="10000" selected>10,000 (Accurate)</option>
                                                                <option value="50000">50,000 (Very Accurate)</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-600 mb-1">Correlation Model</label>
                                                            <select id="correlationModelSelect" class="w-full text-sm border-gray-300 rounded-md">
                                                                <option value="single_factor" selected>Single Factor (Vasicek)</option>
                                                                <option value="copula">Gaussian Copula</option>
                                                                <option value="independent">Independent (No Correlation)</option>
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-600 mb-1">Time Horizon (Months)</label>
                                                            <input type="number" id="timeHorizonInput" value="36" min="12" max="60" class="w-full text-sm border-gray-300 rounded-md">
                                                        </div>
                                                        <div class="pt-2">
                                                            <button id="runMonteCarloBtn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:from-purple-700 hover:to-indigo-700 text-sm">
                                                                ‚ñ∂ Run Simulation
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Simulation Results -->
                                    <div id="simulationResults" class="hidden border-t mt-6 pt-6">
                                        <div class="bg-white rounded-lg border">
                                            <button id="toggleSimulationResultsSection" class="w-full flex items-center justify-between p-6 text-left hover:bg-gray-50">
                                                <h5 class="font-semibold text-gray-800">‚úÖ Simulation Complete</h5>
                                                <svg id="simulationResultsChevron" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </button>
                                            <div id="simulationResultsContent" class="px-6 pb-6">
                                                <div class="bg-white p-6 rounded-lg border border-purple-200 mb-6">
                                                    <div class="flex items-center justify-between mb-4">
                                                        <h5 class="font-semibold text-gray-800">Simulation Results</h5>
                                                        <div class="text-xs text-gray-600">
                                                            <span id="simulationTime">Processing time: 2.3s</span> | 
                                                            <span id="simulationPaths">10,000 paths</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Key Metrics Summary -->
                                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-3 rounded-lg border border-blue-200">
                                                            <p class="text-xs text-blue-700 font-medium">Expected Pool Cashflow</p>
                                                            <p class="text-xl font-bold text-blue-900" id="expectedCashflow">KES 1,021M</p>
                                                            <p class="text-xs text-blue-600 mt-1">Mean across paths</p>
                                                        </div>
                                                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-3 rounded-lg border border-green-200">
                                                            <p class="text-xs text-green-700 font-medium">Best Case (P95)</p>
                                                            <p class="text-xl font-bold text-green-900" id="bestCase">KES 1,089M</p>
                                                            <p class="text-xs text-green-600 mt-1">95th percentile</p>
                                                        </div>
                                                        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-3 rounded-lg border border-yellow-200">
                                                            <p class="text-xs text-yellow-700 font-medium">Base Case (P50)</p>
                                                            <p class="text-xl font-bold text-yellow-900" id="baseCase">KES 1,018M</p>
                                                            <p class="text-xs text-yellow-600 mt-1">Median</p>
                                                        </div>
                                                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-3 rounded-lg border border-orange-200">
                                                            <p class="text-xs text-orange-700 font-medium">Stressed Case (P5)</p>
                                                            <p class="text-xl font-bold text-orange-900" id="stressedCase">KES 934M</p>
                                                            <p class="text-xs text-orange-600 mt-1">5th percentile (VaR)</p>
                                                        </div>
                                                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-3 rounded-lg border border-red-200">
                                                            <p class="text-xs text-red-700 font-medium">Expected Shortfall</p>
                                                            <p class="text-xl font-bold text-red-900" id="expectedShortfall">KES 912M</p>
                                                            <p class="text-xs text-red-600 mt-1">CVaR (tail avg)</p>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Distribution Charts -->
                                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                                        <div>
                                                            <h6 class="font-semibold text-gray-700 mb-2 text-sm">Pool Cashflow Distribution</h6>
                                                            <div class="h-64"><canvas id="cashflowDistributionChart"></canvas></div>
                                                            <p class="text-xs text-gray-600 mt-2">Histogram of 10,000 simulated total pool cashflow outcomes</p>
                                                        </div>
                                                        <div>
                                                            <h6 class="font-semibold text-gray-700 mb-2 text-sm">Loss Rate Distribution</h6>
                                                            <div class="h-64"><canvas id="lossDistributionChart"></canvas></div>
                                                            <p class="text-xs text-gray-600 mt-2">Distribution of realized loss rates across scenarios</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- TRANCHE ANALYSIS (Waterfall Results) -->
                                                <div id="trancheAnalysisSection">
                                                    <h5 class="font-semibold text-gray-800 mb-4 text-lg">üí∞ Tranche-Level Analysis & Pricing</h5>
                                                    
                                                    <!-- Tranche Cards Grid -->
                                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                                        <!-- Senior Tranche -->
                                                        <div class="bg-white p-5 rounded-lg border-2 border-green-300 shadow-md">
                                                            <div class="flex items-center justify-between mb-3">
                                                                <h6 class="font-bold text-green-800">Senior Notes (Class A)</h6>
                                                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold">AAA</span>
                                                            </div>
                                                            <div class="space-y-2 text-sm">
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Size:</span>
                                                                    <span class="font-bold">KES 784M (80%)</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Expected IRR:</span>
                                                                    <span class="font-bold text-green-700" id="seniorIRR">19.2%</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">IRR Range (P5-P95):</span>
                                                                    <span class="font-semibold text-xs">18.1% - 20.5%</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">WAL (Years):</span>
                                                                    <span class="font-semibold">1.8 yrs</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Probability of Loss:</span>
                                                                    <span class="font-bold text-green-700">0.1%</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Expected Loss:</span>
                                                                    <span class="font-semibold">KES 0.8M (0.1%)</span>
                                                                </div>
                                                                <div class="flex justify-between border-t pt-2 mt-2">
                                                                    <span class="text-gray-700 font-medium">Suggested Pricing:</span>
                                                                    <span class="font-bold text-lg text-green-800">19.5%</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Mezzanine Tranche -->
                                                        <div class="bg-white p-5 rounded-lg border-2 border-blue-300 shadow-md">
                                                            <div class="flex items-center justify-between mb-3">
                                                                <h6 class="font-bold text-blue-800">Mezzanine Notes (Class B)</h6>
                                                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">AA</span>
                                                            </div>
                                                            <div class="space-y-2 text-sm">
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Size:</span>
                                                                    <span class="font-bold">KES 118M (12%)</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Expected IRR:</span>
                                                                    <span class="font-bold text-blue-700" id="mezzIRR">22.8%</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">IRR Range (P5-P95):</span>
                                                                    <span class="font-semibold text-xs">19.5% - 25.2%</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">WAL (Years):</span>
                                                                    <span class="font-semibold">1.9 yrs</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Probability of Loss:</span>
                                                                    <span class="font-bold text-blue-700">2.8%</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Expected Loss:</span>
                                                                    <span class="font-semibold">KES 3.3M (2.8%)</span>
                                                                </div>
                                                                <div class="flex justify-between border-t pt-2 mt-2">
                                                                    <span class="text-gray-700 font-medium">Suggested Pricing:</span>
                                                                    <span class="font-bold text-lg text-blue-800">23.0%</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Equity Tranche -->
                                                        <div class="bg-white p-5 rounded-lg border-2 border-purple-300 shadow-md">
                                                            <div class="flex items-center justify-between mb-3">
                                                                <h6 class="font-bold text-purple-800">Equity / Junior (Originator)</h6>
                                                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-bold">Unrated</span>
                                                            </div>
                                                            <div class="space-y-2 text-sm">
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Size:</span>
                                                                    <span class="font-bold">KES 78M (8%)</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Expected IRR:</span>
                                                                    <span class="font-bold text-purple-700" id="equityIRR">28.5%</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">IRR Range (P5-P95):</span>
                                                                    <span class="font-semibold text-xs">8.2% - 42.1%</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">WAL (Years):</span>
                                                                    <span class="font-semibold">2.1 yrs</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Probability of Loss:</span>
                                                                    <span class="font-bold text-orange-700">18.5%</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">Expected Loss:</span>
                                                                    <span class="font-semibold">KES 14.4M (18.5%)</span>
                                                                </div>
                                                                <div class="flex justify-between border-t pt-2 mt-2">
                                                                    <span class="text-gray-700 font-medium">Expected Return:</span>
                                                                    <span class="font-bold text-lg text-purple-800">28.5%</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Tranche-Level Distribution Charts -->
                                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                                        <div class="bg-white p-4 rounded-lg border">
                                                            <h6 class="font-semibold text-gray-700 mb-2 text-sm">IRR Distribution by Tranche</h6>
                                                            <div class="h-64"><canvas id="trancheIRRChart"></canvas></div>
                                                            <p class="text-xs text-gray-600 mt-2">Box plot showing IRR distributions across 10,000 paths</p>
                                                        </div>
                                                        <div class="bg-white p-4 rounded-lg border">
                                                            <h6 class="font-semibold text-gray-700 mb-2 text-sm">Waterfall Cashflow Allocation</h6>
                                                            <div class="h-64"><canvas id="waterfallAllocationChart"></canvas></div>
                                                            <p class="text-xs text-gray-600 mt-2">Mean cashflow allocation across waterfall priority</p>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Risk Metrics Table -->
                                                    <div class="bg-white p-4 rounded-lg border">
                                                        <h6 class="font-semibold text-gray-700 mb-3">Comprehensive Risk Metrics</h6>
                                                        <div class="overflow-x-auto">
                                                            <table class="w-full text-sm">
                                                                <thead class="bg-gray-50 text-xs">
                                                                    <tr>
                                                                        <th class="px-4 py-2 text-left">Tranche</th>
                                                                        <th class="px-4 py-2 text-right">Expected IRR</th>
                                                                        <th class="px-4 py-2 text-right">VaR (P5)</th>
                                                                        <th class="px-4 py-2 text-right">CVaR</th>
                                                                        <th class="px-4 py-2 text-right">Std Dev</th>
                                                                        <th class="px-4 py-2 text-right">Sharpe Ratio</th>
                                                                        <th class="px-4 py-2 text-right">Prob of Loss</th>
                                            </tr>
                                        </thead>
                                                                <tbody class="divide-y">
                                                                    <tr class="hover:bg-gray-50">
                                                                        <td class="px-4 py-2 font-medium text-green-800">Senior (Class A)</td>
                                                                        <td class="px-4 py-2 text-right font-bold">19.2%</td>
                                                                        <td class="px-4 py-2 text-right">18.1%</td>
                                                                        <td class="px-4 py-2 text-right">17.9%</td>
                                                                        <td class="px-4 py-2 text-right">0.8%</td>
                                                                        <td class="px-4 py-2 text-right font-bold text-green-700">1.15</td>
                                                                        <td class="px-4 py-2 text-right text-green-700">0.1%</td>
                                            </tr>
                                                                    <tr class="hover:bg-gray-50">
                                                                        <td class="px-4 py-2 font-medium text-blue-800">Mezzanine (Class B)</td>
                                                                        <td class="px-4 py-2 text-right font-bold">22.8%</td>
                                                                        <td class="px-4 py-2 text-right">19.5%</td>
                                                                        <td class="px-4 py-2 text-right">18.2%</td>
                                                                        <td class="px-4 py-2 text-right">2.1%</td>
                                                                        <td class="px-4 py-2 text-right font-bold text-blue-700">0.95</td>
                                                                        <td class="px-4 py-2 text-right text-blue-700">2.8%</td>
                                            </tr>
                                                                    <tr class="hover:bg-gray-50">
                                                                        <td class="px-4 py-2 font-medium text-purple-800">Equity / Junior</td>
                                                                        <td class="px-4 py-2 text-right font-bold">28.5%</td>
                                                                        <td class="px-4 py-2 text-right">8.2%</td>
                                                                        <td class="px-4 py-2 text-right">3.1%</td>
                                                                        <td class="px-4 py-2 text-right">8.5%</td>
                                                                        <td class="px-4 py-2 text-right font-bold text-purple-700">0.72</td>
                                                                        <td class="px-4 py-2 text-right text-orange-700">18.5%</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                                        <div class="mt-4 p-3 bg-gray-50 rounded text-xs">
                                                            <p class="text-gray-700">
                                                                <strong>Note:</strong> VaR (Value at Risk) = 5th percentile IRR. CVaR (Conditional Value at Risk / Expected Shortfall) = Average of outcomes below P5. 
                                                                Sharpe Ratio = (Expected Return - Risk-Free Rate) / Std Dev. Risk-Free Rate assumed at 13% (CBK Rate).
                                                            </p>
                            </div>
                                                    </div>
                                                </div>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- End Filter & Structuring Section -->
                        </div>
                    </div>
                </div>
                <!-- Pool Details Page -->
                <div id="poolDetailsPage" class="page-view">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold text-gray-800">Loan Listing for <span id="poolDetailsTitle"></span></h1>
                            <button id="poolDetailsBackBtn" class="bg-white text-gray-700 border border-gray-300 px-5 py-2 rounded-lg font-semibold hover:bg-gray-50 text-sm">‚Üê Back</button>
                        </div>
                        <div class="bg-white p-5 rounded-lg border shadow-sm">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Loan ID</th>
                                            <th scope="col" class="px-6 py-3">Principal (KES)</th>
                                            <th scope="col" class="px-6 py-3">Tenure (Mo)</th>
                                            <th scope="col" class="px-6 py-3">Location</th>
                                            <th scope="col" class="px-6 py-3">Loan Cycle</th>
                                            <th scope="col" class="px-6 py-3">Interest Rate</th>
                                            <th scope="col" class="px-6 py-3">KI Score (1-100)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="loanListingTableBody">
                                        <!-- Loan rows will be dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- KI Score Details Page -->
                <div id="kiScoreDetailsPage" class="page-view">
                     <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold text-gray-800" id="kiScoreDetailsTitle"></h1>
                            <button class="back-btn bg-white text-gray-700 border border-gray-300 px-5 py-2 rounded-lg font-semibold hover:bg-gray-50 text-sm">‚Üê Back</button>
                        </div>
                        <div class="bg-white p-6 rounded-lg border shadow-sm mb-8">
                            <h2 class="text-lg font-semibold text-gray-800 mb-3">Top Contributors to Score</h2>
                            <div id="kiScoreContributors" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <!-- Contributor cards will be inserted here -->
                            </div>
                        </div>
                        <div id="kiScoreVariables" class="space-y-6">
                           <!-- Variable cards will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="dealTrackView" class="view">
                 <div class="bg-white border-b">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                        <nav id="dealTrackNav" class="flex space-x-8 -mb-px">
                            <button data-track-view="covenantMonitoring" class="home-tab-link py-4 px-1 text-sm font-medium">Covenant Monitoring</button>
                            <button data-track-view="reports" class="home-tab-link py-4 px-1 text-sm font-medium">Reports</button>
                            <button data-track-view="insights" class="home-tab-link py-4 px-1 text-sm font-medium">Insights</button>
                            <button data-track-view="performance" class="home-tab-link py-4 px-1 text-sm font-medium">Performance</button>
                            <button data-track-view="impact" class="home-tab-link py-4 px-1 text-sm font-medium">Impact</button>
                        </nav>
                    </div>
                </div>
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Covenant Setup Page -->
                    <div id="covenantSetupPage" class="page-view">
                        <div class="max-w-4xl mx-auto">
                             <div class="flex justify-between items-center mb-8">
                                <h1 class="text-2xl font-bold text-gray-800">Covenant Setup</h1>
                                <button id="backToDealScreenBtn" class="bg-white text-gray-700 border border-gray-300 px-5 py-2 rounded-lg font-semibold hover:bg-gray-50 text-sm">‚Üê Back to DealScreen</button>
                            </div>
                            <div class="text-center">
                                <p class="mt-1 text-gray-600 mb-8">Define monitoring rules for transaction: <strong id="covenantSetupTitle"></strong></p>
                            </div>
                            <div class="bg-white p-6 rounded-lg border shadow-sm mb-6 space-y-4">
                                <h3 class="font-semibold text-lg text-gray-800 border-b pb-3">Financial Covenants</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 items-center">
                                    <span>CRAR</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&gt;=</option><option>&lt;=</option></select>
                                    <div class="relative"><input type="text" value="15" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>
                                    
                                    <span>Gross NPA</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&lt;=</option><option>&gt;=</option></select>
                                    <div class="relative"><input type="text" value="5" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>

                                    <span>Net NPA</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&lt;=</option><option>&gt;=</option></select>
                                    <div class="relative"><input type="text" value="3" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>

                                    <span>Debt-to-Equity</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&lt;=</option><option>&gt;=</option></select>
                                    <div class="relative"><input type="text" value="4" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">x</span></div>

                                    <span>Interest Coverage</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&gt;=</option><option>&lt;=</option></select>
                                    <div class="relative"><input type="text" value="2.0" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">x</span></div>

                                    <span>RoA</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&gt;=</option><option>&lt;=</option></select>
                                    <div class="relative"><input type="text" value="1.5" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>
                                    
                                    <span>Opex Ratio</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&lt;=</option><option>&gt;=</option></select>
                                    <div class="relative"><input type="text" value="6" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>

                                    <span>Collection Eff.</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&gt;=</option><option>&lt;=</option></select>
                                    <div class="relative"><input type="text" value="98" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>

                                    <span>Geographic Conc.</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>&lt;=</option><option>&gt;=</option></select>
                                    <div class="relative"><input type="text" value="30" class="block w-full rounded-md border-gray-300 shadow-sm pr-8"><span class="absolute inset-y-0 right-2 flex items-center text-gray-500">%</span></div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg border shadow-sm mb-6 space-y-4">
                                <h3 class="font-semibold text-lg text-gray-800 border-b pb-3">Document Requirements</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 items-center">
                                    <span>Audited Financials</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>Annually</option><option>Half-Yearly</option><option>Quarterly</option><option>Monthly</option></select>
                                    <input type="date" value="2026-05-30" class="block w-full rounded-md border-gray-300 shadow-sm">
                                    
                                    <span>Unaudited Financials</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>Quarterly</option><option>Annually</option><option>Half-Yearly</option><option>Monthly</option></select>
                                    <input type="date" value="2025-07-10" class="block w-full rounded-md border-gray-300 shadow-sm">

                                    <span>MIS Portfolio Report</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>Monthly</option><option>Quarterly</option><option>Annually</option><option>Half-Yearly</option></select>
                                    <input type="date" value="2025-10-01" class="block w-full rounded-md border-gray-300 shadow-sm">

                                    <span>Compliance Certificate</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>Quarterly</option><option>Monthly</option><option>Annually</option><option>Half-Yearly</option></select>
                                    <input type="date" value="2025-10-01" class="block w-full rounded-md border-gray-300 shadow-sm">

                                    <span>End-Use Certificate</span>
                                    <select class="block w-full rounded-md border-gray-300 shadow-sm"><option>Half-Yearly</option><option>Quarterly</option><option>Monthly</option><option>Annually</option></select>
                                    <input type="date" value="2026-07-01" class="block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                            </div>
                            <div class="text-center mt-8">
                                <button id="saveCovenantBtn" class="bg-teal-600 text-white px-8 py-2.5 rounded-lg font-semibold hover:bg-teal-700">Save Covenants & Activate Monitoring</button>
                            </div>
                        </div>
                    </div>

                    <!-- Covenant Monitoring Page (Updated) -->
                    <div id="covenantMonitoringPage" class="page-view">
                        <div class="max-w-7xl mx-auto">
                            <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
                                <h1 class="text-2xl font-bold text-gray-800">Covenant Monitoring</h1>
                                <div class="flex items-center space-x-2">
                                    <label for="transactionSelector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Select Transaction:</label>
                                    <select id="transactionSelector" class="w-full md:w-64 block rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        <!-- Options will be populated by JS -->
                                    </select>
                                </div>
                            </div>

                            <!-- Covenant Status Table -->
                            <div class="bg-white p-6 rounded-lg border shadow-sm mb-8">
                                <h3 class="font-semibold text-lg text-gray-800 mb-4">Covenant Status</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left text-gray-500">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2">Covenant</th>
                                                <th class="px-4 py-2">Condition</th>
                                                <th class="px-4 py-2">Required</th>
                                                <th class="px-4 py-2">Actual</th>
                                                <th class="px-4 py-2">Status</th>
                                                <th class="px-4 py-2 text-center">Trend (3 Mo)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="covenantStatusTableBody">
                                            <!-- Rows populated by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                             <!-- Document Status Table -->
                            <div class="bg-white p-6 rounded-lg border shadow-sm mb-8">
                                <h3 class="font-semibold text-lg text-gray-800 mb-4">Document Status</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left text-gray-500">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2">Document</th>
                                                <th class="px-4 py-2">Frequency</th>
                                                <th class="px-4 py-2">Next Due Date</th>
                                                <th class="px-4 py-2">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="documentStatusTableBody">
                                            <!-- Rows populated by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                             <!-- Early Warning System Charts -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="bg-white p-4 rounded-lg border shadow-sm">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-semibold text-center">PAR 90+ Movement</h3>
                                        <span id="par90EWS" class="text-xs font-bold"></span>
                                    </div>
                                    <div class="chart-container h-64"><canvas id="par90Chart"></canvas></div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-semibold text-center">Collection Efficiency</h3>
                                        <span id="collectionEffEWS" class="text-xs font-bold"></span>
                                    </div>
                                    <div class="chart-container h-64"><canvas id="collectionEffChart"></canvas></div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-semibold text-center">CRAR Movement</h3>
                                        <span id="crarEWS" class="text-xs font-bold"></span>
                                    </div>
                                    <div class="chart-container h-64"><canvas id="crarChart"></canvas></div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-semibold text-center">Portfolio Yield</h3>
                                        <span id="yieldEWS" class="text-xs font-bold"></span>
                                    </div>
                                    <div class="chart-container h-64"><canvas id="yieldChart"></canvas></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Page -->
                    <div id="reportsPage" class="page-view">
                        <div class="max-w-7xl mx-auto">
                            <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
                                <h1 class="text-2xl font-bold text-gray-800">Compliance & Dynamic Reporting</h1>
                                <div class="flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-4">
                                    <div class="flex items-center space-x-2">
                                        <label for="reportMonthSelector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Report Month:</label>
                                        <input type="month" id="reportMonthSelector" class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm" value="2025-11" />
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <label for="reportsTransactionSelector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Transaction:</label>
                                        <select id="reportsTransactionSelector" class="border border-gray-300 rounded-lg px-4 py-1.5 text-sm"></select>
                                    </div>
                                </div>
                            </div>

                            <!-- Date Information Banner -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <p class="text-xs font-semibold text-blue-700 uppercase mb-1">Report Period</p>
                                        <p id="reportPeriodDisplay" class="text-sm font-medium text-gray-800">November 2025</p>
                                    </div>
                                    <div>
                                        <p class="text-xs font-semibold text-blue-700 uppercase mb-1">Collection Period</p>
                                        <p id="collectionPeriodDisplay" class="text-sm font-medium text-gray-800">01-Nov-2025 to 30-Nov-2025</p>
                                    </div>
                                    <div>
                                        <p class="text-xs font-semibold text-blue-700 uppercase mb-1">Payment Date</p>
                                        <p id="paymentDateDisplay" class="text-sm font-medium text-gray-800">01-Dec-2025</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Standard Reports Section -->
                            <div class="bg-white p-6 rounded-lg border shadow-sm mb-8">
                                <h3 class="font-semibold text-lg text-gray-800 mb-6">Compliance Reports</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- PMA Report -->
                                    <div class="border rounded-lg p-5 hover:shadow-md transition-shadow">
                                        <div class="flex items-start justify-between mb-3">
                                            <div class="flex items-center space-x-3">
                                                <div class="bg-teal-100 p-2 rounded-lg">
                                                    <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <h4 class="font-semibold text-gray-800">Portfolio Monitoring Agent Report</h4>
                                                    <p class="text-sm text-gray-500">Monthly PMA Report</p>
                                                </div>
                                            </div>
                                            <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded">Required</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-3">Official PMA Letter covering:</p>
                                        <ul class="text-xs text-gray-600 space-y-1 mb-4 ml-4">
                                            <li>‚úì Tested Eligibility Criteria verification</li>
                                            <li>‚úì Collection Efficiency and Shortfall calculations</li>
                                            <li>‚úì Portfolio Concentration Limits confirmation</li>
                                            <li>‚úì Discounted Balance & Collections reconciliation</li>
                                            <li>‚úì Manifest errors identification</li>
                                        </ul>
                                        <div class="flex space-x-2">
                                            <button id="downloadPMAReport" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-teal-700 text-sm flex items-center justify-center space-x-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                </svg>
                                                <span>Download PDF</span>
                                            </button>
                                            <button id="previewPMAReport" class="px-4 py-2 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50 text-sm text-gray-700">Preview</button>
                                        </div>
                                        <div class="mt-3 text-xs text-gray-500">
                                            <span>Due: 2 Business Days after Servicer Report</span>
                                        </div>
                                    </div>

                                    <!-- Cash Manager Report -->
                                    <div class="border rounded-lg p-5 hover:shadow-md transition-shadow">
                                        <div class="flex items-start justify-between mb-3">
                                            <div class="flex items-center space-x-3">
                                                <div class="bg-blue-100 p-2 rounded-lg">
                                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <h4 class="font-semibold text-gray-800">Cash Manager Investor Report</h4>
                                                    <p class="text-sm text-gray-500">Monthly Cash Flow Report</p>
                                                </div>
                                            </div>
                                            <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded">Required</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-3">Monthly Investor Report including:</p>
                                        <ul class="text-xs text-gray-600 space-y-1 mb-4 ml-4">
                                            <li>‚úì Receivables Portfolio Summary</li>
                                            <li>‚úì Senior/Mezzanine/Junior Notes balances</li>
                                            <li>‚úì Tests: Collection Efficiency, Shortfall thresholds</li>
                                            <li>‚úì Priority of Payments waterfall</li>
                                            <li>‚úì Available Receipts breakdown</li>
                                        </ul>
                                        <div class="flex space-x-2">
                                            <button id="downloadCashReport" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-teal-700 text-sm flex items-center justify-center space-x-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                </svg>
                                                <span>Download PDF</span>
                                            </button>
                                            <button id="previewCashReport" class="px-4 py-2 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50 text-sm text-gray-700">Preview</button>
                                        </div>
                                        <div class="mt-3 text-xs text-gray-500">
                                            <span>Due: 5 Business Days before Payment Date</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Dynamic Reporting Dashboards -->
                            <div class="bg-white p-6 rounded-lg border shadow-sm mb-8">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-semibold text-lg text-gray-800">Dynamic Reporting & Analytics</h3>
                                    <button class="text-teal-600 hover:text-teal-700 text-sm font-semibold">Export All Data</button>
                                </div>
                                
                                <!-- Collection Efficiency Explanation -->
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                    <h4 class="font-semibold text-blue-800 mb-2">Understanding Collection Efficiency Metrics</h4>
                                    <div class="text-sm text-blue-700 space-y-1">
                                        <p><strong>Unadjusted Collection Efficiency:</strong> Shows actual collections as a percentage of projected collections. Can exceed 100% when over-collection occurs (actual collections exceed projected).</p>
                                        <p><strong>Adjusted Collection Efficiency:</strong> Caps collection efficiency at 100%, treating any over-collection as perfect collection (100%). This provides a conservative view that doesn't credit over-collection beyond the projected amount.</p>
                                    </div>
                                </div>

                                <!-- Key Metrics Summary -->
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                                    <div class="bg-gray-50 p-4 rounded-lg border">
                                        <p class="text-xs text-gray-500 uppercase">Pool Size</p>
                                        <p id="reportPoolSize" class="text-2xl font-bold text-gray-800">KES 234.5M</p>
                                        <p class="text-xs text-green-600 mt-1">‚ñ≤ 2.1% from last month</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg border">
                                        <p class="text-xs text-gray-500 uppercase">Total Loans</p>
                                        <p id="reportTotalLoans" class="text-2xl font-bold text-gray-800">4,850</p>
                                        <p class="text-xs text-gray-600 mt-1">Active accounts</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg border">
                                        <p class="text-xs text-gray-500 uppercase">Current Month CE (Unadjusted)</p>
                                        <p id="reportCurrentMonthCEUnadjusted" class="text-2xl font-bold text-gray-800">98.8%</p>
                                        <p class="text-xs text-green-600 mt-1">vs projected</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg border">
                                        <p class="text-xs text-gray-500 uppercase">Current Month CE (Adjusted)</p>
                                        <p id="reportCurrentMonthCEAdjusted" class="text-2xl font-bold text-gray-800">98.8%</p>
                                        <p class="text-xs text-green-600 mt-1">capped at 100%</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg border">
                                        <p class="text-xs text-gray-500 uppercase">Cumulative CE (Unadjusted)</p>
                                        <p id="reportCumulativeCEUnadjusted" class="text-2xl font-bold text-gray-800">97.5%</p>
                                        <p class="text-xs text-gray-600 mt-1">Since inception</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg border">
                                        <p class="text-xs text-gray-500 uppercase">Cumulative CE (Adjusted)</p>
                                        <p id="reportCumulativeCEAdjusted" class="text-2xl font-bold text-gray-800">97.5%</p>
                                        <p class="text-xs text-gray-600 mt-1">Since inception</p>
                                    </div>
                                </div>

                                <!-- Collection Efficiency Charts (Unadjusted & Adjusted) -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                    <div>
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="font-semibold text-gray-800">Collection Efficiency Trend (Unadjusted)</h4>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">View:</label>
                                                <select id="collectionEfficiencyViewToggle" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="current">Current Month</option>
                                                    <option value="cumulative">Cumulative</option>
                                                    <option value="both">Both</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportCollectionChart"></canvas></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="font-semibold text-gray-800">Collection Efficiency Trend (Adjusted)</h4>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">View:</label>
                                                <select id="adjustedCollectionEfficiencyViewToggle" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="current">Current Month</option>
                                                    <option value="cumulative">Cumulative</option>
                                                    <option value="both">Both</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportAdjustedCollectionChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cash Flow Waterfall & Shortfall Distribution -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                    <div>
                                        <h4 class="font-semibold text-gray-800 mb-3">Cash Flow Waterfall (This Month)</h4>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportWaterfallChart"></canvas></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="font-semibold text-gray-800">Shortfall Bucket Distribution</h4>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">View:</label>
                                                <select id="shortfallViewToggle" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="current">Current Month</option>
                                                    <option value="cumulative">Cumulative</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportShortfallChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>


                                <!-- Portfolio Composition & Geographic Analysis -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                    <div>
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="font-semibold text-gray-800">Portfolio by Bundle Choice</h4>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">Adjusted:</label>
                                                <select id="compositionAdjustedToggle" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="false">No</option>
                                                    <option value="true">Yes</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportCompositionChart"></canvas></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="font-semibold text-gray-800">Geographic Concentration</h4>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">Adjusted:</label>
                                                <select id="geoAdjustedToggle" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="false">No</option>
                                                    <option value="true">Yes</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportGeoChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Origination & Maturity Cohort Analysis -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                    <div>
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="font-semibold text-gray-800">Origination Cohort Analysis (Quarterly)</h4>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">View:</label>
                                                <select id="vintageViewToggle" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="current">Current Month</option>
                                                    <option value="cumulative">Cumulative</option>
                                                </select>
                                                <label class="text-xs text-gray-600 ml-2">Adjusted:</label>
                                                <select id="vintageAdjustedToggle" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="false">No</option>
                                                    <option value="true">Yes</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportVintageChart"></canvas></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="font-semibold text-gray-800">Maturity Cohort Analysis</h4>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-600">View:</label>
                                                <select id="maturityViewToggle" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="current">Current Month</option>
                                                    <option value="cumulative">Cumulative</option>
                                                </select>
                                                <label class="text-xs text-gray-600 ml-2">Adjusted:</label>
                                                <select id="maturityAdjustedToggle" class="text-xs border border-gray-300 rounded px-2 py-1">
                                                    <option value="false">No</option>
                                                    <option value="true">Yes</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportMaturityCohortChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Additional Risk Cuts -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                    <div>
                                        <h4 class="font-semibold text-gray-800 mb-3">Risk by Gender</h4>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportGenderChart"></canvas></div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800 mb-3">Risk by Liability Bucket</h4>
                                        <div class="bg-white border rounded-lg p-4">
                                            <div class="chart-container h-64"><canvas id="reportLiabilityBucketChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-8">
                                    <h4 class="font-semibold text-gray-800 mb-3">Risk by Renewal Status</h4>
                                    <div class="bg-white border rounded-lg p-4">
                                        <div class="chart-container h-64"><canvas id="reportRenewalChart"></canvas></div>
                                    </div>
                                </div>

                                <!-- Tranche Cashflow Comparison (Cumulative) -->
                                <div class="mb-8">
                                    <h4 class="font-semibold text-gray-800 mb-3">Tranche Cashflow: Projected vs Actual (Cumulative)</h4>
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div>
                                            <h5 class="text-sm font-medium text-gray-700 mb-2">Senior Tranche (Class A)</h5>
                                            <div class="bg-white border rounded-lg p-4">
                                                <div class="chart-container h-64"><canvas id="reportSeniorTrancheCashflowChart"></canvas></div>
                                            </div>
                                        </div>
                                        <div>
                                            <h5 class="text-sm font-medium text-gray-700 mb-2">Mezzanine Tranche (Class B)</h5>
                                            <div class="bg-white border rounded-lg p-4">
                                                <div class="chart-container h-64"><canvas id="reportMezzanineTrancheCashflowChart"></canvas></div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-2">Cumulative cashflow from Day 0 to current month</p>
                                </div>

                                <!-- 3-Way Comparison: Actual vs Day 0 vs Demand -->
                                <div class="mb-8">
                                    <h4 class="font-semibold text-gray-800 mb-3">Collections: 3-Way Comparison</h4>
                                    <div class="bg-white border rounded-lg p-4">
                                        <div class="chart-container h-80"><canvas id="reportThreeWayComparisonChart"></canvas></div>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-2">Comparing Actual vs Day 0 Projections vs Contractual Demands across months</p>
                                </div>

                                <!-- Available Credit Enhancement (Time Series) -->
                                <div class="mb-8">
                                    <h4 class="font-semibold text-gray-800 mb-3">Available Credit Enhancement Over Time</h4>
                                    <div class="bg-white border rounded-lg p-4">
                                        <div class="chart-container h-64"><canvas id="reportAvailableCEChart"></canvas></div>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-2">Shows available credit enhancement decreasing as it gets utilized. Includes Overcollateralization (OC) and Junior Liquidity Facility (JLF).</p>
                                </div>

                            </div>

                        </div>
                    </div>
                        </div>
                    </div>

                    <div id="insightsPage" class="page-view">
                         <div class="text-center mb-8">
                            <h1 class="text-2xl font-bold text-gray-800">Performance Insights</h1>
                             <p class="mt-1 text-gray-600 max-w-3xl mx-auto">Key observations for transaction: <strong>RMFB-BODA-001</strong></p>
                        </div>
                        <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Positive Insight 1 -->
                            <div class="bg-green-50 border border-green-200 p-6 rounded-lg flex items-start space-x-4">
                                <div class="w-8 h-8 flex-shrink-0 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-green-800">Strong Segment Performance</h4>
                                    <p class="text-green-800 text-sm font-medium mt-1">The Boda-Boda loan portfolio continues to be the bedrock of performance, with PAR30+ consistently below 4.5%. High repayment rates in this core segment are driving overall portfolio stability and cash flow predictability.</p>
                                </div>
                            </div>
                            <!-- Negative Insight 1 -->
                            <div class="bg-red-50 border border-red-200 p-6 rounded-lg flex items-start space-x-4">
                                <div class="w-8 h-8 flex-shrink-0 bg-red-500 rounded-full flex items-center justify-center">
                                     <svg class="w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-red-800">Geographic Stress in Key Area</h4>
                                    <p class="text-red-800 text-sm font-medium mt-1">Kisumu county, the third-highest AUM contributor, has a PAR60 above 8% with collection efficiency less than 95%. This indicates rising stress in a key geographical area, posing a concentration risk that requires targeted intervention.</p>
                                </div>
                            </div>
                            <!-- Positive Insight 2 -->
                             <div class="bg-green-50 border border-green-200 p-6 rounded-lg flex items-start space-x-4">
                                <div class="w-8 h-8 flex-shrink-0 bg-green-500 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-green-800">Effective Underwriting Vintage</h4>
                                    <p class="text-green-800 text-sm font-medium mt-1">Vintage analysis of loans originated in Q4 2024 shows the lowest early-stage delinquency. This strongly suggests that recent underwriting policy improvements are effective and should be maintained or expanded.</p>
                                </div>
                            </div>
                             <!-- Negative Insight 2 -->
                            <div class="bg-red-50 border border-red-200 p-6 rounded-lg flex items-start space-x-4">
                                <div class="w-8 h-8 flex-shrink-0 bg-red-500 rounded-full flex items-center justify-center">
                                     <svg class="w-5 h-8 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-red-800">Risk from First-Cycle Borrowers</h4>
                                    <p class="text-red-800 text-sm font-medium mt-1">First-cycle borrowers now account for 65% of all new delinquencies in the past 90 days. This highlights a significant risk concentration in the new customer onboarding process, suggesting a need for tighter initial criteria.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="performancePage" class="page-view">
                        <div class="max-w-7xl mx-auto">
                             <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                                <h1 class="text-2xl font-bold text-gray-800">Portfolio Performance</h1>
                                <div class="flex items-center space-x-2">
                                    <label for="perfTransactionSelector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Select Transaction:</label>
                                    <select id="perfTransactionSelector" class="w-full md:w-64 block rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        <!-- Options will be populated by JS -->
                                    </select>
                                </div>
                            </div>

                            <!-- Summary Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center">
                                    <p class="text-sm text-gray-500">Principal Outstanding (POS)</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-1">KES 955M</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center">
                                    <p class="text-sm text-gray-500">Overall Collection Efficiency</p>
                                    <p class="text-3xl font-bold text-green-600 mt-1">98.2%</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center">
                                    <p class="text-sm text-gray-500">Live Portfolio Count</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-1">9,450</p>
                                </div>
                            </div>

                             <!-- Portfolio Composition -->
                            <div class="mb-8">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">Portfolio Composition</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="bg-white p-4 rounded-lg border shadow-sm"><h3 class="font-semibold text-center mb-2">POS by Loan Purpose</h3><div class="chart-container h-64"><canvas id="posByLoanPurposeChart"></canvas></div></div>
                                    <div class="bg-white p-4 rounded-lg border shadow-sm"><h3 class="font-semibold text-center mb-2">POS by County</h3><div class="chart-container h-64"><canvas id="posByCountyChart"></canvas></div></div>
                                </div>
                            </div>

                             <!-- Delinquency Analysis -->
                            <div class="mb-8">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">Delinquency Analysis (PAR 30+)</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="bg-white p-4 rounded-lg border shadow-sm"><h3 class="font-semibold text-center mb-2">by Loan Purpose</h3><div class="chart-container h-64"><canvas id="parByLoanPurposeChart"></canvas></div></div>
                                    <div class="bg-white p-4 rounded-lg border shadow-sm"><h3 class="font-semibold text-center mb-2">by County</h3><div class="chart-container h-64"><canvas id="parByCountyChart"></canvas></div></div>
                                    <div class="bg-white p-4 rounded-lg border shadow-sm"><h3 class="font-semibold text-center mb-2">by Loan Cycle</h3><div class="chart-container h-64"><canvas id="parByLoanCycleChart"></canvas></div></div>
                                    <div class="bg-white p-4 rounded-lg border shadow-sm"><h3 class="font-semibold text-center mb-2">by KI Score Band</h3><div class="chart-container h-64"><canvas id="parByKiScoreChart"></canvas></div></div>
                                </div>
                            </div>
                            
                            <!-- Vintage Analysis -->
                             <div>
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">Vintage Analysis</h2>
                                <div class="bg-white p-4 rounded-lg border shadow-sm">
                                    <h3 class="font-semibold text-center mb-2">PAR 90+ by Origination Quarter</h3>
                                    <div class="chart-container h-72"><canvas id="vintageAnalysisChart"></canvas></div>
                                </div>
                            </div>

                        </div>
                    </div>
                     <div id="impactPage" class="page-view">
                        <div class="max-w-7xl mx-auto">
                             <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                                <h1 class="text-2xl font-bold text-gray-800">Impact Analysis</h1>
                                <div class="flex items-center space-x-2">
                                    <label for="impactTransactionSelector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Select Transaction:</label>
                                    <select id="impactTransactionSelector" class="w-full md:w-64 block rounded-md border-gray-300 shadow-sm sm:text-sm">
                                        <!-- Options will be populated by JS -->
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Top Level KPIs -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center"><p class="text-sm text-gray-500">Female Borrowers</p><p class="text-2xl font-bold text-teal-600 mt-1">4,158 (44%)</p></div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center"><p class="text-sm text-gray-500">Rural Outreach</p><p class="text-2xl font-bold text-teal-600 mt-1">5,197 (55%)</p></div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center"><p class="text-sm text-gray-500">First-Time Borrowers</p><p class="text-2xl font-bold text-teal-600 mt-1">2,835 (30%)</p></div>
                                <div class="bg-white p-4 rounded-lg border shadow-sm text-center"><p class="text-sm text-gray-500">Youth Borrowers (&lt;35)</p><p class="text-2xl font-bold text-teal-600 mt-1">3,780 (40%)</p></div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- Left Column -->
                                <div class="lg:col-span-1 space-y-8">
                                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                                        <h3 class="font-semibold text-gray-800 mb-3">Gender & Social Lens</h3>
                                        <div class="space-y-3 text-sm">
                                            <div class="flex justify-between"><span>Value to Women (KES):</span><span class="font-bold">410M</span></div>
                                            <div class="flex justify-between"><span>Avg. Loan to Women (KES):</span><span class="font-bold">98,600</span></div>
                                            <div class="flex justify-between"><span>Avg. Loan to Men (KES):</span><span class="font-bold">103,000</span></div>
                                        </div>
                                        <div class="chart-container h-48 mt-4"><canvas id="genderPerformanceChart"></canvas></div>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                                        <h3 class="font-semibold text-gray-800 mb-3">Geographic Outreach</h3>
                                        <div class="chart-container h-56"><canvas id="ruralUrbanChart"></canvas></div>
                                    </div>
                                </div>
                                
                                <!-- Right Column -->
                                <div class="lg:col-span-2 space-y-8">
                                    <div class="bg-white p-6 rounded-lg border shadow-sm">
                                        <h3 class="font-semibold text-gray-800 mb-4">End-Use & SDG Alignment</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <h4 class="font-medium text-center text-sm mb-2">End-Use Sector</h4>
                                                <div class="chart-container h-48"><canvas id="sectorDoughnutChart"></canvas></div>
                                            </div>
                                             <div>
                                                <h4 class="font-medium text-center text-sm mb-2">SDG Alignment</h4>
                                                <div class="chart-container h-48"><canvas id="sdgDoughnutChart"></canvas></div>
                                                <div class="text-xs space-y-1 mt-2 text-center">
                                                    <p><span class="font-bold text-teal-600">48%</span> No Poverty (SDG 1)</p>
                                                    <p><span class="font-bold text-teal-600">32%</span> Decent Work & Econ. Growth (SDG 8)</p>
                                                    <p><span class="font-bold text-teal-600">20%</span> Reduced Inequality (SDG 10)</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bg-white p-6 rounded-lg border shadow-sm">
                                        <h3 class="font-semibold text-gray-800 mb-4">Economic Opportunity</h3>
                                         <div class="chart-container h-64"><canvas id="borrowerProfileChart"></canvas></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Report Preview Modal -->
    <div id="reportPreviewModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-5xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 class="text-xl font-bold text-gray-900" id="previewModalTitle">Report Preview</h3>
                <button id="closePreviewModalX" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div class="mt-4 max-h-[70vh] overflow-y-auto">
                <div id="reportPreviewContent" class="prose prose-sm max-w-none p-6 bg-gray-50 rounded-lg font-mono text-xs"></div>
            </div>
            <div class="flex justify-end items-center pt-4 border-t gap-3">
                <button id="closePreviewModalBtn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-semibold">Close</button>
                <button id="downloadFromPreview" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-semibold flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span>Download PDF</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Create New Field Modal -->
    <div id="createFieldModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 class="text-xl font-bold text-gray-900">Create New Field</h3>
                <button id="closeCreateFieldModal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div class="mt-4 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Field Name</label>
                    <input type="text" id="newFieldName" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="e.g., customer_segment">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Display Label</label>
                    <input type="text" id="newFieldLabel" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="e.g., Customer Segment">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Data Type</label>
                    <select id="newFieldType" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        <option value="text">Text / String</option>
                        <option value="numeric">Numeric (Integer)</option>
                        <option value="decimal">Decimal / Float</option>
                        <option value="date">Date</option>
                        <option value="boolean">Boolean (True/False)</option>
                        <option value="currency">Currency</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Description (Optional)</label>
                    <textarea id="newFieldDescription" class="w-full border border-gray-300 rounded-lg px-3 py-2" rows="2" placeholder="Describe what this field represents..."></textarea>
                </div>
            </div>
            <div class="flex justify-end items-center pt-4 border-t gap-3 mt-4">
                <button id="cancelCreateField" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-semibold">Cancel</button>
                <button id="saveNewField" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Create Field</button>
            </div>
        </div>
    </div>

    <!-- Add Validation Rules Modal -->
    <div id="validationModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 class="text-xl font-bold text-gray-900">Add Validation Rules</h3>
                <button id="closeValidationModal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div class="mt-4">
                <div class="bg-blue-50 p-3 rounded mb-4">
                    <p class="text-sm text-blue-800"><strong>Field:</strong> <span id="validationFieldName"></span> (<span id="validationFieldType"></span>)</p>
                </div>
                
                <div id="validationRulesContainer" class="space-y-3">
                    <!-- Validation rules will be added here -->
                </div>
                
                <button id="addValidationRule" class="mt-3 text-sm bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-semibold">
                    + Add Rule
                </button>
            </div>
            <div class="flex justify-end items-center pt-4 border-t gap-3 mt-4">
                <button id="cancelValidation" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-semibold">Cancel</button>
                <button id="saveValidation" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-semibold">Save Validations</button>
            </div>
        </div>
    </div>

    <!-- Custom Filter Builder Modal -->
    <div id="customFilterModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 class="text-xl font-bold text-gray-900">Custom Filter Builder</h3>
                <button id="closeCustomFilterModal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div class="mt-4">
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Combine Rules Using:</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="filterLogic" value="AND" checked class="mr-2">
                            <span class="text-sm">AND (all rules must match)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="filterLogic" value="OR" class="mr-2">
                            <span class="text-sm">OR (any rule can match)</span>
                        </label>
                    </div>
                </div>
                
                <div id="customFilterRulesContainer" class="space-y-3 mb-4">
                    <!-- Filter rules will be added here -->
                </div>
                
                <button id="addFilterRule" class="text-sm bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-semibold">
                    + Add Filter Rule
                </button>
            </div>
            <div class="flex justify-between items-center pt-4 border-t mt-4">
                <div class="text-sm text-gray-600">
                    <span id="filterPreview" class="font-mono bg-gray-100 px-2 py-1 rounded"></span>
                </div>
                <div class="flex gap-3">
                    <button id="cancelCustomFilter" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-semibold">Cancel</button>
                    <button id="applyCustomFilter" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-semibold">Apply Filter</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // State Management
            const state = { currentView: 'dealScreen', currentPage: 'dealScreenHomePage', previousPage: null, charts: {}, transactions: [], originators: [], availablePortfolios: [], currentTransactionId: null, covenantData: {}, simulationBaseCase: {}, customFields: [], fieldValidations: {}, customFilters: [], tranches: [], creditEnhancements: [] };

            // Selectors
            const app = document.getElementById('app');
            const dealScreenBtn = document.getElementById('dealScreenBtn');
            const dealTrackBtn = document.getElementById('dealTrackBtn');
            const dealScreenView = document.getElementById('dealScreenView');
            const dealTrackView = document.getElementById('dealTrackView');
            const pageViews = document.querySelectorAll('.page-view');
            const homeBtn = document.getElementById('homeBtn');
            
            // Home Page Selectors
            const homeTabsNav = document.getElementById('homeTabsNav');
            const homeTabContents = document.querySelectorAll('.home-tab-content');
            const addNewOriginatorBtn = document.getElementById('addNewOriginatorBtn');
            const createNewTransactionBtn = document.getElementById('createNewTransactionBtn');
            
            // Originator Onboarding Selectors
            const uploadOriginatorFilesBtn = document.getElementById('uploadOriginatorFilesBtn');
            const originatorUpload = document.getElementById('originatorUpload');
            const originatorAnalyzing = document.getElementById('originatorAnalyzing');
            const originatorAnalysisResult = document.getElementById('originatorAnalysisResult');
            const onboardOriginatorBtn = document.getElementById('onboardOriginatorBtn');
            const analysisOriginatorName = document.getElementById('analysisOriginatorName');
            const analysisOriginatorCategory = document.getElementById('analysisOriginatorCategory');
            const originatorInsightsContainer = document.getElementById('originatorInsightsContainer');

            // Pool Creation Selectors
            const poolSubSteps = document.querySelectorAll('#poolCreationPage .sub-step');
            const uploadPoolBtn = document.getElementById('uploadPoolBtn');
            const validateMappedPoolBtn = document.getElementById('validateMappedPoolBtn');
            const reuploadPoolBtn = document.getElementById('reuploadPoolBtn');
            const finalizePoolBtn = document.getElementById('finalizePoolBtn');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const simulationResultsPanel = document.getElementById('simulationResultsPanel');
            const simulationOriginatorName = document.getElementById('simulationOriginatorName');
            
            // Pool Details Page Selectors
            const poolDetailsTitle = document.getElementById('poolDetailsTitle');
            const loanListingTableBody = document.getElementById('loanListingTableBody');

            // KI Score Details Page Selectors
            const kiScoreDetailsPage = document.getElementById('kiScoreDetailsPage');
            const kiScoreDetailsTitle = document.getElementById('kiScoreDetailsTitle');
            const kiScoreVariables = document.getElementById('kiScoreVariables');
            const kiScoreContributors = document.getElementById('kiScoreContributors');

            // Structuring Sliders & Labels
            const kiScoreMinSlider = document.getElementById('kiScoreMinSlider');
            const kiScoreMaxSlider = document.getElementById('kiScoreMaxSlider');
            const kiScoreMinLabel = document.getElementById('kiScoreMinLabel');
            const kiScoreMaxLabel = document.getElementById('kiScoreMaxLabel');

            const loanAmountMinSlider = document.getElementById('loanAmountMinSlider');
            const loanAmountMaxSlider = document.getElementById('loanAmountMaxSlider');
            const loanAmountMinLabel = document.getElementById('loanAmountMinLabel');
            const loanAmountMaxLabel = document.getElementById('loanAmountMaxLabel');

            const tenureMinSlider = document.getElementById('tenureMinSlider');
            const tenureMaxSlider = document.getElementById('tenureMaxSlider');
            const tenureMinLabel = document.getElementById('tenureMinLabel');
            const tenureMaxLabel = document.getElementById('tenureMaxLabel');

            const interestRateMinSlider = document.getElementById('interestRateMinSlider');
            const interestRateMaxSlider = document.getElementById('interestRateMaxSlider');
            const interestRateMinLabel = document.getElementById('interestRateMinLabel');
            const interestRateMaxLabel = document.getElementById('interestRateMaxLabel');
            
            // DealTrack Selectors
            const dealTrackNav = document.getElementById('dealTrackNav');
            const dealTrackPages = document.querySelectorAll('#dealTrackView .page-view');
            const covenantSetupTitle = document.getElementById('covenantSetupTitle');
            const saveCovenantBtn = document.getElementById('saveCovenantBtn');
            const activeTransactionsTableBody = document.getElementById('activeTransactionsTableBody');
            const originatorsTableBody = document.getElementById('originatorsTableBody');
            const availablePortfoliosTableBody = document.getElementById('availablePortfoliosTableBody');
            
            // Covenant Monitoring Page Selectors
            const transactionSelector = document.getElementById('transactionSelector');
            const perfTransactionSelector = document.getElementById('perfTransactionSelector');
            const impactTransactionSelector = document.getElementById('impactTransactionSelector');
            const covenantStatusTableBody = document.getElementById('covenantStatusTableBody');
            const documentStatusTableBody = document.getElementById('documentStatusTableBody');
            const ewsPar90 = document.getElementById('par90EWS');
            const ewsCollectionEff = document.getElementById('collectionEffEWS');
            const ewsCrar = document.getElementById('crarEWS');
            const ewsYield = document.getElementById('yieldEWS');

            // Transaction Type Page
            const transactionTypePage = document.getElementById('transactionTypePage');

            // Finalize Pool Modal
            const finalizePoolModal = document.createElement('div');
            finalizePoolModal.id = 'finalizePoolModal';
            finalizePoolModal.className = 'modal fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50';
            finalizePoolModal.style.display = 'none'; // Ensure it's hidden by default
            finalizePoolModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
                    <h3 class="text-lg font-bold mb-4">‚úÖ Finalize Filtered Pool</h3>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                        <p class="text-sm text-blue-900 mb-2"><strong>What happens when you finalize?</strong></p>
                        <ul class="text-xs text-blue-800 space-y-1 list-disc list-inside">
                            <li>The current filter selection will be <strong>locked</strong></li>
                            <li>A filtered loan file (CSV) will be generated for download</li>
                            <li>The pool will be ready for AI cashflow generation</li>
                        </ul>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Name</label>
                    <input type="text" id="newTransactionName" placeholder="e.g., RMFB-BODA-002" class="w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Comments (Optional)</label>
                        <textarea id="finalizeComments" placeholder="Notes about this finalization..." rows="2" class="w-full border-gray-300 rounded-md shadow-sm text-sm"></textarea>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="cancelFinalizeBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                        <button id="saveTransactionBtn" class="px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 font-semibold">Finalize & Lock Pool</button>
                    </div>
                </div>
            `;
            document.body.appendChild(finalizePoolModal);

            const finalizeTransactionNameInput = document.getElementById('newTransactionName');
            const cancelFinalizeBtn = document.getElementById('cancelFinalizeBtn');
            const saveTransactionBtn = document.getElementById('saveTransactionBtn');

            let countiesMultiSelect;


            function initializeData() {
                try {
                state.originators = [
                    { id: 'mc', name: 'Acacia Finance Ltd', score: 'BBB', par: '5.5%', yield: '36.0%', aum: '3.2B' },
                    { id: 'ak', name: 'Baobab Micro Bank', score: 'AA-', par: '3.8%', yield: '32.5%', aum: '6.8B' },
                    { id: 'faulu', name: 'Cedar Credit Bank', score: 'A', par: '4.8%', yield: '31.5%', aum: '4.5B' },
                    { id: 'uwezo', name: 'Doum Palm MFB', score: 'BB', par: '6.2%', yield: '37.0%', aum: '2.1B' },
                    { id: 'smep', name: 'Ebony Microfinance', score: 'A-', par: '4.5%', yield: '33.0%', aum: '3.9B' },
                    { id: 'juhudi', name: 'Fig Tree Finance', score: 'A+', par: '4.0%', yield: '34.0%', aum: '5.5B' },
                    { id: 'mogo', name: 'Grassland Credit', score: 'BBB+', par: '5.1%', yield: '38.0%', aum: '4.1B' },
                    { id: 'platcorp', name: 'Hibiscus Finance Group', score: 'A', par: '4.3%', yield: '35.5%', aum: '6.2B' },
                    { id: 'izwe', name: 'Ivory Financial Services', score: 'BBB', par: '5.8%', yield: '36.5%', aum: '2.8B' }
                ];

                state.transactions = [
                    { id: 'MC-AGRI-003', name: 'MC-AGRI-003', originator: 'Acacia Finance Ltd', structure: 'Securitisation', grade: 'A+', tenure: '24 Months', yield: '19.5%', covenantsSet: false },
                    { id: 'ASA-SME-005', name: 'ASA-SME-005', originator: 'Baobab Micro Bank', structure: 'Securitisation', grade: 'AA', tenure: '36 Months', yield: '18.0%', covenantsSet: true },
                    { id: 'RMFB-BODA-001', name: 'RMFB-BODA-001', originator: 'Jacaranda MFB', structure: 'Term Loan', grade: 'AA-', tenure: '18 Months', yield: '21.0%', covenantsSet: true },
                    { id: 'MC-VEHICLE-001', name: 'MC-VEHICLE-001', originator: 'Acacia Finance Ltd', structure: 'Term Loan', grade: 'A', tenure: '24 Months', yield: '22.5%', covenantsSet: true },
                    { id: 'PLAT-SAL-012', name: 'PLAT-SAL-012', originator: 'Hibiscus Finance Group', structure: 'Securitisation', grade: 'A+', tenure: '30 Months', yield: '20.0%', covenantsSet: true },
                    { id: 'FAULU-BIZ-008', name: 'FAULU-BIZ-008', originator: 'Cedar Credit Bank', structure: 'Term Loan', grade: 'A', tenure: '24 Months', yield: '19.8%', covenantsSet: false },
                    { id: 'JUHUDI-AGRI-021', name: 'JUHUDI-AGRI-021', originator: 'Fig Tree Finance', structure: 'Securitisation', grade: 'AA-', tenure: '36 Months', yield: '18.5%', covenantsSet: true },
                    { id: 'MOGO-LOGBOOK-050', name: 'MOGO-LOGBOOK-050', originator: 'Grassland Credit', structure: 'Term Loan', grade: 'BBB+', tenure: '18 Months', yield: '24.0%', covenantsSet: true },
                    { id: 'IZWE-PERS-015', name: 'IZWE-PERS-015', originator: 'Ivory Financial Services', structure: 'Term Loan', grade: 'BBB', tenure: '20 Months', yield: '23.0%', covenantsSet: false },
                    { id: 'SMEP-EDU-004', name: 'SMEP-EDU-004', originator: 'Ebony Microfinance', structure: 'Securitisation', grade: 'A-', tenure: '12 Months', yield: '19.0%', covenantsSet: true },
                ];
                
                state.availablePortfolios = [
                     { id: 'rmfb-agri-25', name: 'Agri-Finance Jun 2025', originator: 'Jacaranda MFB', assetClass: 'Agri-Finance', size: '750M', tenure: '24 Months', par: '3.5%' },
                     { id: 'ak-sme-25', name: 'SME Capital Jun 2025', originator: 'Baobab Micro Bank', assetClass: 'SME Capital', size: '1.5B', tenure: '36 Months', par: '3.1%' },
                     { id: 'mc-boda-25', name: 'Boda-Boda May 2025', originator: 'Acacia Finance Ltd', assetClass: 'Boda-Boda', size: '450M', tenure: '18 Months', par: '5.2%' },
                     { id: 'plat-checkoff-25', name: 'Checkoff Jul 2025', originator: 'Hibiscus Finance Group', assetClass: 'Checkoff', size: '2.0B', tenure: '48 Months', par: '2.9%' },
                     { id: 'faulu-group-25', name: 'Group Loans Jul 2025', originator: 'Cedar Credit Bank', assetClass: 'Group Loans', size: '600M', tenure: '12 Months', par: '4.1%' },
                ];

                initializeCovenantData();
                renderOriginators();
                renderActiveTransactions();
                renderAvailablePortfolios();
                } catch (e) {
                    console.error('Error in initializeData:', e);
                    // Ensure at least originators array is initialized
                    if (!state.originators) state.originators = [];
                    if (!state.transactions) state.transactions = [];
                    if (!state.availablePortfolios) state.availablePortfolios = [];
                }
            }

            function initializeCovenantData() {
                const generateChartData = (start, trend, volatility, breach, isUpwardBreach, willBreach, ensureNoHistoricalBreach = false, trailingTrendPoints = 0) => {
                    const data = { actuals: [], estimates: [], labels: [], breachLine: [], predictedBreach: false };
                    let currentValue = start;
                    const today = new Date('2025-07-01');

                    for (let i = -12; i <= 0; i++) {
                        const monthDate = new Date(today);
                        monthDate.setMonth(today.getMonth() + i);
                        data.labels.push(monthDate);
                        data.breachLine.push(breach);
                        
                        let currentTrend = (i > -trailingTrendPoints -1) ? trend : trend / 3;
                        let nextValue = currentValue + currentTrend + (Math.random() - 0.5) * volatility;

                        if (ensureNoHistoricalBreach) {
                            if (!isUpwardBreach) nextValue = Math.max(nextValue, breach * 1.01);
                            else nextValue = Math.min(nextValue, breach * 0.99);
                        }
                        data.actuals.push(nextValue);
                        currentValue = nextValue;
                    }
                    
                    data.estimates = new Array(data.actuals.length - 1).fill(null);
                    data.estimates.push(data.actuals[data.actuals.length - 1]);

                    let forecastValue = data.actuals[data.actuals.length - 1];
                    for (let i = 1; i <= 6; i++) {
                        const monthDate = new Date(today);
                        monthDate.setMonth(today.getMonth() + i);
                        data.labels.push(monthDate);
                        data.breachLine.push(breach);
                        
                        const forecastTrend = willBreach ? trend * 2.5 : trend;
                        forecastValue += forecastTrend;
                        data.estimates.push(forecastValue);

                        if (!data.predictedBreach && willBreach) {
                            if (isUpwardBreach && forecastValue > breach) data.predictedBreach = true;
                            if (!isUpwardBreach && forecastValue < breach) data.predictedBreach = true;
                        }
                    }
                    return data;
                };
                
                state.transactions.filter(t => t.covenantsSet).forEach(tx => {
                    state.covenantData[tx.id] = {
                        covenants: [
                            { name: 'CRAR', condition: '>=', required: '15.0%', actual: '15.2%', status: 'at_risk', trend: '‚Üò' },
                            { name: 'Gross NPA', condition: '<=', required: '5.0%', actual: '4.8%', status: 'compliant', trend: '‚Üí' },
                            { name: 'Interest Coverage', condition: '>=', required: '2.0x', actual: '2.1x', status: 'compliant', trend: '‚Üí' },
                            { name: 'Net NPA', condition: '<=', required: '3.0%', actual: '2.8%', status: 'compliant', trend: '‚Üí' },
                            { name: 'Collection Efficiency', condition: '>=', required: '98%', actual: '98.2%', status: 'compliant', trend: '‚Üí' },
                            { name: 'PAR 90+', condition: '<=', required: '4.0%', actual: '3.8%', status: 'compliant', trend: '‚Üí' },
                        ],
                        documents: [
                            { name: 'MIS Portfolio Report', frequency: 'Monthly', nextDue: '31-Jul-2025', status: 'submitted' },
                            { name: 'Unaudited Financials', frequency: 'Quarterly', nextDue: '15-Aug-2025', status: 'submitted' },
                            { name: 'Audited Financials', frequency: 'Annually', nextDue: '30-May-2026', status: 'submitted' },
                        ],
                        charts: {
                            par90: { ...generateChartData(3.2, -0.01, 0.1, 4.0, true, false) },
                            collectionEff: { ...generateChartData(99.2, 0.01, 0.2, 98.0, false, false) },
                            crar: { ...generateChartData(15.8, -0.1, 0.2, 15.0, false, true, true, 3) },
                            yield: { ...generateChartData(21.0, 0, 0.1, 19.0, false, false) }
                        }
                    };
                });
            }

            function renderOriginators() {
                if (!originatorsTableBody) return;
                if (!state.originators || state.originators.length === 0) return;
                originatorsTableBody.innerHTML = '';
                state.originators.forEach(o => {
                    const row = `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium text-gray-900">${o.name}</td>
                            <td class="px-6 py-4 font-semibold text-teal-600"><button class="ki-score-link" data-score-type="originator" data-name="${o.name}">${o.score}</button></td>
                            <td class="px-6 py-4 font-medium text-red-600">${o.par}</td>
                            <td class="px-6 py-4 font-medium text-green-600">${o.yield}</td>
                            <td class="px-6 py-4 font-bold text-gray-800">${o.aum}</td>
                        </tr>
                    `;
                    originatorsTableBody.innerHTML += row;
                });
            }

            function renderActiveTransactions() {
                if (!activeTransactionsTableBody) return;
                if (!state.transactions || state.transactions.length === 0) return;
                try {
                activeTransactionsTableBody.innerHTML = '';
                state.transactions.forEach(tx => {
                    const actionButton = tx.covenantsSet 
                        ? `<button class="view-performance-btn font-medium text-teal-600 hover:underline" data-tx-id="${tx.id}">View Performance</button>`
                        : `<button class="setup-covenant-btn font-medium text-orange-600 hover:underline" data-tx-id="${tx.id}">Setup Covenant</button>`;

                    const row = `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium text-gray-900"><button class="pool-details-link text-teal-600 hover:underline" data-pool-name="${tx.name}">${tx.name}</button></td>
                            <td class="px-6 py-4">${tx.originator}</td>
                            <td class="px-6 py-4">${tx.structure}</td>
                            <td class="px-6 py-4 font-semibold text-green-500"><button class="ki-score-link" data-score-type="pool" data-name="${tx.name}">${tx.grade}</button></td>
                            <td class="px-6 py-4">${tx.tenure}</td>
                            <td class="px-6 py-4">${tx.yield}</td>
                            <td class="px-6 py-4 text-center">${actionButton}</td>
                        </tr>
                    `;
                    activeTransactionsTableBody.innerHTML += row;
                });
                } catch (e) {
                    console.error('Error rendering active transactions:', e);
                }
            }

            function renderAvailablePortfolios() {
                if (!availablePortfoliosTableBody) return;
                if (!state.availablePortfolios || state.availablePortfolios.length === 0) return;
                try {
                availablePortfoliosTableBody.innerHTML = '';
                state.availablePortfolios.forEach(p => {
                    const row = `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium text-gray-900">${p.name}</td>
                            <td class="px-6 py-4">${p.originator}</td>
                            <td class="px-6 py-4">${p.assetClass}</td>
                            <td class="px-6 py-4">${p.size}</td>
                            <td class="px-6 py-4">${p.tenure}</td>
                            <td class="px-6 py-4">${p.par}</td>
                            <td class="px-6 py-4 text-center"><button class="font-medium text-teal-600 hover:underline">Structure Deal</button></td>
                        </tr>
                    `;
                    availablePortfoliosTableBody.innerHTML += row;
                });
                } catch (e) {
                    console.error('Error rendering available portfolios:', e);
                }
            }

            function updateMainView(targetView, txId = null) {
                state.currentView = targetView;
                dealScreenView.classList.toggle('active', state.currentView === 'dealScreen');
                dealTrackView.classList.toggle('active', state.currentView === 'dealTrack');
                dealScreenBtn.classList.toggle('active', state.currentView === 'dealScreen');
                dealTrackBtn.classList.toggle('active', state.currentView === 'dealTrack');

                if(targetView === 'dealTrack') {
                    populateTransactionSelector(txId);
                }
            }

            function showPage(pageId) {
                state.previousPage = state.currentPage;
                state.currentPage = pageId;
                pageViews.forEach(page => page.classList.toggle('active', page.id === pageId));
            }
            
            function updateDealTrackPage(pageId, txId = null) {
                // First, hide all pages
                dealTrackPages.forEach(page => page.classList.remove('active'));
                // Then show only the selected page
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                }
                
                // Get transaction ID based on which page we're on
                let currentTxId = txId;
                if (!currentTxId) {
                    if (pageId === 'performancePage' && perfTransactionSelector) {
                        currentTxId = perfTransactionSelector.value;
                    } else if (pageId === 'impactPage' && impactTransactionSelector) {
                        currentTxId = impactTransactionSelector.value;
                    } else if (transactionSelector) {
                        currentTxId = transactionSelector.value;
                    }
                }
                
                if (pageId === 'covenantMonitoringPage') {
                    renderCovenantMonitoringPage(currentTxId);
                } else if (pageId === 'reportsPage') {
                    renderReportsPage(currentTxId);
                } else if (pageId === 'insightsPage') {
                    renderInsightsPage(currentTxId);
                } else if (pageId === 'performancePage') {
                    renderPerformancePage(currentTxId);
                } else if (pageId === 'impactPage') {
                    renderImpactPage(currentTxId);
                }
            }
            
            function renderInsightsPage(txId) {
                try {
                    const insightsPage = document.getElementById('insightsPage');
                    if (!insightsPage) {
                        console.warn('Insights page not found');
                        return;
                    }
                    
                    // Ensure page is visible
                    insightsPage.classList.add('active');
                    
                    // Update transaction name if needed
                    const txName = state.transactions.find(t => t.id === txId)?.name || (txId || 'Transaction');
                    const txNameEl = insightsPage.querySelector('strong');
                    if (txNameEl) {
                        txNameEl.textContent = txName;
                    }
                    
                    // The content is static HTML, no additional rendering needed
                    console.log('Insights page rendered for transaction:', txName);
                } catch (e) {
                    console.error('Error rendering insights page:', e);
                }
            }

            function goBack() {
                if (state.previousPage) {
                    showPage(state.previousPage);
                } else {
                    showPage('dealScreenHomePage');
                }
            }

            function updateHomeTab(targetTab) {
                homeTabsNav.querySelectorAll('button').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === targetTab));
                homeTabContents.forEach(content => content.classList.toggle('active', content.id === `${targetTab}Tab`));
            }
            
            function updatePoolSubStep(targetSubStepId) {
                poolSubSteps.forEach(sub => sub.classList.remove('active'));
                document.getElementById(targetSubStepId)?.classList.add('active');
                
                // If navigating to pool structuring, render initial risk analytics
                if (targetSubStepId === 'poolStructuringSubStep') {
                    setTimeout(() => renderInitialRiskAnalytics(), 100);
                }
            }

            function createOrUpdateChart(chartId, typeOrConfig, dataOrOptions, optionsParam) {
                const ctx = document.getElementById(chartId)?.getContext('2d');
                if (!ctx) return;
                if (state.charts[chartId]) state.charts[chartId].destroy();
                
                // Support both old signature (chartId, config) and new signature (chartId, type, data, options)
                let config;
                if (typeof typeOrConfig === 'string') {
                    // New signature: type, data, options
                    config = {
                        type: typeOrConfig,
                        data: dataOrOptions,
                        options: optionsParam || {}
                    };
                } else {
                    // Old signature: config object
                    config = typeOrConfig;
                }
                
                state.charts[chartId] = new Chart(ctx, config);
            }
            
            function renderVariables(container, title, variables) {
                let html = `<div class="bg-white p-5 rounded-lg border shadow-sm"><h3 class="text-md font-semibold text-gray-700 mb-4 border-b pb-2">${title}</h3><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">`;
                variables.forEach(v => {
                    html += `<div><p class="text-xs text-gray-500">${v.label}</p><p class="text-sm font-medium text-gray-800">${v.value}</p></div>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            }

            function showKiScoreDetails(type, name, id) {
                const scoreData = {
                    originator: {
                        title: `KI Score Grade Details for ${name}`,
                        contributors: [
                            { label: 'Strong Capitalization', value: 'CRAR: 18.5%', icon: '‚úÖ' },
                            { label: 'Low NPAs', value: 'PAR 90+: 4.2%', icon: '‚úÖ' },
                            { label: 'Diversified Portfolio', value: 'Top 3 products < 60%', icon: '‚úÖ' }
                        ],
                        cards: [
                            { title: 'Financial Health', variables: [
                                { label: 'CRAR', value: '18.5%' }, { label: 'Debt-to-Equity', value: '2.1' }, { label: 'Return on Assets (RoA)', value: '2.8%' }, { label: 'Return on Equity (RoE)', value: '15.2%' }, { label: 'Net Interest Margin', value: '8.1%' }, { label: 'Cost-to-Income Ratio', value: '45%' }, { label: 'Liquidity Ratio', value: '1.5' }, { label: 'Portfolio Growth (YoY)', value: '15%' }, { label: 'Operating Expense Ratio', value: '4.5%' }, { label: 'Provision Coverage Ratio', value: '75%' }
                            ]},
                            { title: 'Portfolio Quality', variables: [
                                { label: '90+ DPD % (PAR 90+)', value: '4.2%' }, { label: 'Write-off Ratio', value: '1.1%' }, { label: 'Collection Efficiency', value: '98.5%' }, { label: '30+ DPD %', value: '5.1%' }, { label: 'Avg. Seasoning', value: '14 Months' }, { label: 'NPA by 2023 Vintage', value: '3.8%' }, { label: 'Geographic Diversification', value: 'High (8 regions)' }, { label: 'Product Diversification', value: 'High (5+ products)' }
                            ]}
                        ]
                    },
                    pool: {
                        title: `KI Score Grading Details for ${name}`,
                        contributors: [
                            { label: 'High Avg. Loan Score', value: 'Avg. Score: 25', icon: 'üëç' },
                            { label: 'Low Geographic Risk', value: 'Top County < 25%', icon: 'üëç' },
                            { label: 'Short Avg. Tenure', value: 'W.A. Tenure: 18 Mo', icon: 'üëç' }
                        ],
                        cards: [
                           { title: 'Pool Composition', variables: [
                                { label: 'W.A. KI Score (1-100)', value: '25' }, { label: 'W.A. Tenure', value: '18 Months' }, { label: 'W.A. Interest Rate', value: '24.5%' }, { label: 'Loan Count', value: '9,540' }, { label: 'Total Pool Value', value: 'KES 980M' }, { label: 'Standard Deviation of Scores', value: '15.2' }, { label: 'W.A. LTV', value: '78%' }, { label: 'W.A. DTI Ratio', value: '0.45' }
                            ]},
                            { title: 'Risk Metrics', variables: [
                               { label: 'Top County Concentration', value: 'Nairobi (22%)' }, { label: 'Top 3 County Concentration', value: '45%' }, { label: 'Product Concentration', value: 'Boda-Boda (100%)' }, { label: 'Expected Loss (EL)', value: '4.1%' }, { label: 'Predicted Default Rate', value: '5.5%' }, { label: 'Predicted Prepayment Rate', value: '8.0%' }
                            ]},
                            { title: 'Eligibility Criteria', variables: [
                               { label: 'Max KI Score', value: '40' }, { label: 'Max Loan Amount', value: 'KES 250,000' }, { label: 'Max Residual Tenure', value: '24 Months' }, { label: 'Min Credit History', value: '12 Months' }, { label: 'Excluded Geographies', value: 'None' }, { label: 'Loan Cycle', value: '> 1' }
                            ]}
                        ]
                    },
                    loan: {
                        title: `KI Score Details for Loan #${id}`,
                        contributors: [
                            { label: 'Excellent Repayment', value: '0 defaults on record', icon: 'üíØ' },
                            { label: 'Long Credit History', value: '36 Months', icon: 'üíØ' },
                            { label: 'Low DTI Ratio', value: '0.4', icon: 'üíØ' }
                        ],
                        cards: [
                             { title: 'Score Explanation', variables: [{label: 'KI Score (1-100)', value: 'A lower score indicates lower risk.'}] },
                            { title: 'Customer Bureau Data', variables: [
                                { label: 'Credit Bureau Score', value: '720' }, { label: 'Inquiries (Last 6 Mo)', value: '1' }, { label: 'Total Active Tradelines', value: '4' }, { label: 'Credit Utilization Ratio', value: '35%' }, { label: 'Age of Oldest Credit Line', value: '48 Months' }, { label: 'Delinquent Accounts', value: '0' }
                            ]},
                            { title: 'Customer Financials & Stability', variables: [
                                { label: 'Stated Monthly Income', value: 'KES 80,000' }, { label: 'Debt-to-Income (DTI) Ratio', value: '0.4' }, { label: 'Bank Acct. Balance Trend', value: 'Increasing' }, { label: 'Avg. Monthly Transactions', value: '25' }, { label: 'Customer Vintage', value: '4 Years' }, { label: 'Employment Status', value: 'Salaried' }
                            ]},
                            { title: 'Loan & Behavioral Data', variables: [
                                { label: 'Loan Amount', value: 'KES 150,000' }, { label: 'Interest Rate', value: '25%' }, { label: 'Tenure', value: '24 Months' }, { label: 'Loan-to-Value (LTV)', value: '80%' }, { label: 'Loan Cycle with Lender', value: '3' }, { label: 'Repayment History', value: 'No Missed Payments' }, { label: 'Loan Purpose', value: 'Business Expansion' }
                            ]}
                        ]
                    }
                };

                const data = scoreData[type];
                if (!data) return;

                kiScoreDetailsTitle.textContent = data.title;
                kiScoreContributors.innerHTML = data.contributors.map(c => `<div class="bg-gray-100 p-3 rounded-lg"><p class="text-3xl">${c.icon}</p><p class="text-sm font-semibold text-gray-800 mt-1">${c.label}</p><p class="text-xs text-gray-500">${c.value}</p></div>`).join('');
                kiScoreVariables.innerHTML = '';
                data.cards.forEach(card => renderVariables(kiScoreVariables, card.title, card.variables));
                
                showPage('kiScoreDetailsPage');
            }

            function showPoolDetails(poolName) {
                poolDetailsTitle.textContent = poolName;
                loanListingTableBody.innerHTML = ''; // Clear previous results
                
                const locations = ['Nairobi', 'Mombasa', 'Kisumu', 'Nakuru', 'Eldoret'];

                for (let i = 1; i <= 20; i++) {
                    const loanId = 'LAN' + String(1000 + i).padStart(4, '0');
                    const principal = (Math.floor(Math.random() * 20) + 5) * 10000;
                    const tenure = Math.floor(Math.random() * 18) + 6;
                    const score = Math.floor(Math.random() * 60) + 5; // Score between 5 and 65
                    const location = locations[i % locations.length];
                    const cycle = Math.floor(i / 5) + 1;
                    const interestRate = (Math.random() * 12 + 18).toFixed(1);
                    
                    const row = `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium text-gray-900">${loanId}</td>
                            <td class="px-6 py-4">${principal.toLocaleString()}</td>
                            <td class="px-6 py-4">${tenure}</td>
                            <td class="px-6 py-4">${location}</td>
                            <td class="px-6 py-4">${cycle}</td>
                            <td class="px-6 py-4">${interestRate}%</td>
                            <td class="px-6 py-4 font-semibold text-teal-600">
                                <button class="ki-score-link" data-score-type="loan" data-name="${loanId}" data-id="${loanId}">${score}</button>
                            </td>
                        </tr>
                    `;
                    loanListingTableBody.innerHTML += row;
                }
                showPage('poolDetailsPage');
            }


            // --- Event Listeners ---
            app.addEventListener('click', (e) => {
                const backBtn = e.target.closest('.back-btn');
                if(backBtn) {
                    goBack();
                    return;
                }

                if (e.target.closest('#poolDetailsBackBtn')) {
                    showPage('dealScreenHomePage');
                    updateHomeTab('transactions');
                    return;
                }

                const kiScoreLink = e.target.closest('.ki-score-link');
                if (kiScoreLink) {
                    const type = kiScoreLink.dataset.scoreType;
                    const name = kiScoreLink.dataset.name;
                    const id = kiScoreLink.dataset.id;
                    showKiScoreDetails(type, name, id);
                    return;
                }

                const poolDetailsLink = e.target.closest('.pool-details-link');
                if (poolDetailsLink) {
                    const poolName = poolDetailsLink.dataset.poolName;
                    showPoolDetails(poolName);
                    return;
                }
                
                const setupCovenantBtn = e.target.closest('.setup-covenant-btn');
                if(setupCovenantBtn) {
                    const txId = setupCovenantBtn.dataset.txId;
                    state.currentTransactionId = txId;
                    covenantSetupTitle.textContent = txId;
                    updateMainView('dealTrack');
                    updateDealTrackPage('covenantSetupPage');
                    dealTrackNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    return;
                }

                const viewPerformanceBtn = e.target.closest('.view-performance-btn');
                if (viewPerformanceBtn) {
                    const txId = viewPerformanceBtn.dataset.txId;
                    state.currentTransactionId = txId;
                    updateMainView('dealTrack', txId);
                    dealTrackNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    const monitoringTab = dealTrackNav.querySelector('[data-track-view="covenantMonitoring"]');
                    if(monitoringTab) monitoringTab.classList.add('active');
                    updateDealTrackPage('covenantMonitoringPage', txId);
                    return;
                }

                const txTypeBtn = e.target.closest('.tx-type-select-btn');
                if(txTypeBtn) {
                    const type = txTypeBtn.dataset.txType;
                    if (type === 'Securitisation') {
                        showPage('poolCreationPage');
                        updatePoolSubStep('poolUploadSubStep');
                    }
                    return;
                }
            });

            // Main View Navigation
            dealScreenBtn.addEventListener('click', () => updateMainView('dealScreen'));
            dealTrackBtn.addEventListener('click', () => {
                updateMainView('dealTrack');
                dealTrackNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                const firstTab = dealTrackNav.querySelector('button');
                if (firstTab) {
                    firstTab.classList.add('active');
                    const firstTxId = state.transactions.find(t => t.covenantsSet)?.id;
                    updateDealTrackPage(firstTab.dataset.trackView + 'Page', firstTxId);
                }
            });
            homeBtn.addEventListener('click', () => {
                window.location.href = '../home/';
            });
            
            document.getElementById('backToDealScreenBtn').addEventListener('click', () => {
                updateMainView('dealScreen');
                showPage('dealScreenHomePage');
            });
            
            // Home Page Tabs
            homeTabsNav.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    updateHomeTab(e.target.dataset.tab);
                }
            });

            // Workflow Initiation
            addNewOriginatorBtn.addEventListener('click', () => showPage('originatorOnboardingPage'));
            createNewTransactionBtn.addEventListener('click', () => {
                showPage('transactionTypePage');
            });
            
            function renderOriginatorInsights() {
                 originatorInsightsContainer.innerHTML = `
                    <div class="bg-green-50 border border-green-200 p-4 rounded-lg flex items-start space-x-4">
                        <div class="w-8 h-8 flex-shrink-0 bg-green-500 rounded-full flex items-center justify-center text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                        </div>
                        <div>
                            <h4 class="font-bold text-green-800">High-Performing Asset Class</h4>
                            <p class="text-sm text-green-700 mt-1">The Agri-Finance portfolio is a standout performer, showing the lowest PAR 90+ (3.5%) and presenting a strong case for securitization or targeted term loan financing.</p>
                        </div>
                    </div>
                     <div class="bg-green-50 border border-green-200 p-4 rounded-lg flex items-start space-x-4">
                        <div class="w-8 h-8 flex-shrink-0 bg-green-500 rounded-full flex items-center justify-center text-white">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                        </div>
                        <div>
                            <h4 class="font-bold text-green-800">Robust Growth & Capitalization</h4>
                            <p class="text-sm text-green-700 mt-1">Consistent portfolio growth (AUM up 15% YoY) combined with a strong CRAR of 18.5% underpins the A+ KI Score, indicating solid financial health and expansion capacity.</p>
                        </div>
                    </div>
                     <div class="bg-red-50 border border-red-200 p-4 rounded-lg flex items-start space-x-4">
                        <div class="w-8 h-8 flex-shrink-0 bg-red-500 rounded-full flex items-center justify-center text-white">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </div>
                        <div>
                            <h4 class="font-bold text-red-800">Risk in Digital Loans</h4>
                            <p class="text-sm text-red-700 mt-1">The Digital Loans portfolio, while small, shows a worrying trend with the highest and rising delinquency (6.8% PAR 30+), suggesting a need for immediate underwriting policy review.</p>
                        </div>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg flex items-start space-x-4">
                        <div class="w-8 h-8 flex-shrink-0 bg-orange-500 rounded-full flex items-center justify-center text-white">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a2 2 0 00-.266 1.4z" /></svg>
                        </div>
                         <div>
                            <h4 class="font-bold text-orange-800">Potential Margin Pressure</h4>
                            <p class="text-sm text-orange-700 mt-1">The narrowing spread between portfolio yield (34.5%) and cost of funds (20.5%) indicates potential margin pressure. This could be mitigated by focusing growth on higher-quality, lower-risk segments.</p>
                        </div>
                    </div>
                `;
            }

            // Originator Onboarding Workflow
            uploadOriginatorFilesBtn.addEventListener('click', () => {
                originatorUpload.classList.add('hidden');
                originatorAnalyzing.classList.remove('hidden');
                setTimeout(() => {
                    originatorAnalyzing.classList.add('hidden');
                    originatorAnalysisResult.classList.remove('hidden');
                    
                    const extractedName = "Rafiki Microfinance Bank";
                    const extractedCategory = "Microfinance Bank (MFB)";
                    const extractedScore = "A+";

                    analysisOriginatorName.textContent = extractedName;
                    analysisOriginatorCategory.textContent = extractedCategory;
                    const analysisKiScoreBtn = document.getElementById('analysisKiScore');
                    analysisKiScoreBtn.dataset.name = extractedName;
                    analysisKiScoreBtn.textContent = extractedScore;
                    
                    renderOriginatorInsights();

                    createOrUpdateChart('assetClassDistChart', { type: 'doughnut', data: { labels: ['Boda-Boda', 'Agri-Finance', 'SME Capital', 'Digital Loans'], datasets: [{ data: [35, 25, 20, 20], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#0f766e'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });
                    createOrUpdateChart('geographicalDistChart', { type: 'doughnut', data: { labels: ['Nairobi', 'Rift Valley', 'Coast', 'Nyanza', 'Other'], datasets: [{ data: [45, 25, 15, 10, 5], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#0f766e', '#99f6e4'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });
                    createOrUpdateChart('delinquencyByAssetClass30', { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Boda-Boda', data: [4.1,4.2,4.5,4.3,4.6,4.5], borderColor: '#14b8a6' }, { label: 'Agri-Finance', data: [3.1,3.2,3.5,3.3,3.6,3.5], borderColor: '#84cc16' }, { label: 'SME Capital', data: [5.1,5.2,5.5,5.3,5.6,5.5], borderColor: '#f97316' }, { label: 'Digital Loans', data: [6.1,6.2,6.5,6.3,6.6,6.8], borderColor: '#ef4444' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
                    createOrUpdateChart('delinquencyByAssetClass90', { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Boda-Boda', data: [1.8,1.9,2.1,2.0,2.2,2.1], borderColor: '#14b8a6' }, { label: 'Agri-Finance', data: [0.8,0.9,0.9,0.8,0.9,0.9], borderColor: '#84cc16' }, { label: 'SME Capital', data: [2.8,2.9,3.1,3.0,3.2,3.1], borderColor: '#f97316' }, { label: 'Digital Loans', data: [3.8,3.9,4.1,4.0,4.2,4.2], borderColor: '#ef4444' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
                    createOrUpdateChart('portfolioGrowthChart', { type: 'bar', data: { labels: ['Q1 24', 'Q2 24', 'Q3 24', 'Q4 24', 'Q1 25', 'Q2 25'], datasets: [{ label: 'AUM (KES Billions)', data: [4.1, 4.3, 4.4, 4.6, 4.8, 5.0], backgroundColor: '#14b8a6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                    createOrUpdateChart('yieldVsCofChart', { type: 'line', data: { labels: ['Q1 24', 'Q2 24', 'Q3 24', 'Q4 24', 'Q1 25', 'Q2 25'], datasets: [{ label: 'Portfolio Yield', data: [35.1, 35.3, 35.0, 34.8, 34.6, 34.5], borderColor: '#14b8a6' }, { label: 'Cost of Funds', data: [19.1, 19.3, 19.5, 19.8, 20.0, 20.5], borderColor: '#f97316' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
                }, 2000);
            });
            onboardOriginatorBtn.addEventListener('click', () => {
                const kiScoreButton = document.getElementById('analysisKiScore');
                const newOriginator = {
                    id: analysisOriginatorName.textContent.toLowerCase().replace(/\s/g, ''),
                    name: analysisOriginatorName.textContent,
                    score: kiScoreButton.textContent,
                    par: document.getElementById('analysisPar').textContent,
                    yield: document.getElementById('analysisYield').textContent,
                    aum: document.getElementById('analysisAum').textContent.replace('KES ', '')
                };
                state.originators.push(newOriginator);
                renderOriginators();
                showPage('dealScreenHomePage');
                updateHomeTab('originators');
                originatorAnalysisResult.classList.add('hidden');
                originatorUpload.classList.remove('hidden');
            });

            // Pool Creation Workflow
            // Database Fields Definition
            // Comprehensive Data Dictionary with 100+ fields across 6 categories
            // allowed_types: restricts which data types are valid for this field
            const databaseFields = [
                // === CATEGORY 1: CUSTOMER LEVEL (Demographics & KYC) ===
                { name: 'customer_id', label: 'Customer ID', type: 'text', category: 'customer', required: true, allowed_types: ['text'] },
                { name: 'cust_first_name', label: 'First Name', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'cust_last_name', label: 'Last Name', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'dob', label: 'Date of Birth', type: 'date', category: 'customer', required: false, allowed_types: ['date'] },
                { name: 'national_id', label: 'National ID / KRA PIN', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'gender', label: 'Gender', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'marital_status', label: 'Marital Status', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'num_dependents', label: 'Number of Dependents', type: 'numeric', category: 'customer', required: false, allowed_types: ['numeric'] },
                { name: 'education_level', label: 'Education Level', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'residential_status', label: 'Residential Status', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'curr_address_line1', label: 'Address Line 1', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'curr_city', label: 'City / Town', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'curr_county', label: 'County / Region', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'curr_postal_code', label: 'Postal Code', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'months_at_residence', label: 'Months at Residence', type: 'numeric', category: 'customer', required: false, allowed_types: ['numeric'] },
                { name: 'phone_mobile', label: 'Mobile Phone (M-Pesa)', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'email_address', label: 'Email Address', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'employment_status', label: 'Employment Status', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'employer_name', label: 'Employer Name', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'years_at_employer', label: 'Years at Employer', type: 'decimal', category: 'customer', required: false, allowed_types: ['numeric', 'decimal'] },
                { name: 'annual_income', label: 'Annual Income (KES)', type: 'currency', category: 'customer', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'income_source', label: 'Income Source', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'mpesa_active', label: 'M-Pesa Active', type: 'boolean', category: 'customer', required: false, allowed_types: ['boolean'] },
                { name: 'mobile_money_tenure', label: 'Mobile Money Tenure (Months)', type: 'numeric', category: 'customer', required: false, allowed_types: ['numeric'] },
                { name: 'customer_segment', label: 'Customer Segment', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'citizenship_country', label: 'Citizenship Country', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'id_type', label: 'ID Type', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                { name: 'kyc_status', label: 'KYC Status', type: 'text', category: 'customer', required: false, allowed_types: ['text'] },
                
                // === CATEGORY 2: LOAN LEVEL (Origination & Structure) ===
                { name: 'loan_id', label: 'Loan ID', type: 'text', category: 'loan', required: true, allowed_types: ['text', 'numeric'] },
                { name: 'application_id', label: 'Application ID', type: 'text', category: 'loan', required: false, allowed_types: ['text', 'numeric'] },
                { name: 'product_type', label: 'Product Type', type: 'text', category: 'loan', required: false, allowed_types: ['text'] },
                { name: 'loan_purpose', label: 'Loan Purpose', type: 'text', category: 'loan', required: false, allowed_types: ['text'] },
                { name: 'loan_amount_requested', label: 'Loan Amount Requested (KES)', type: 'currency', category: 'loan', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'loan_amount_approved', label: 'Loan Amount Approved (KES)', type: 'currency', category: 'loan', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'loan_amount', label: 'Loan Amount Disbursed (KES)', type: 'currency', category: 'loan', required: true, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'currency', label: 'Currency', type: 'text', category: 'loan', required: false, allowed_types: ['text'] },
                { name: 'origination_date', label: 'Origination Date', type: 'date', category: 'loan', required: false, allowed_types: ['date'] },
                { name: 'disbursement_date', label: 'Disbursement Date', type: 'date', category: 'loan', required: true, allowed_types: ['date'] },
                { name: 'maturity_date', label: 'Maturity Date', type: 'date', category: 'loan', required: true, allowed_types: ['date'] },
                { name: 'original_term', label: 'Original Term (Months)', type: 'numeric', category: 'loan', required: false, allowed_types: ['numeric'] },
                { name: 'remaining_tenor', label: 'Remaining Tenor (Months)', type: 'numeric', category: 'loan', required: false, allowed_types: ['numeric'] },
                { name: 'interest_rate', label: 'Interest Rate (% p.a.)', type: 'decimal', category: 'loan', required: true, allowed_types: ['numeric', 'decimal'] },
                { name: 'flat_rate', label: 'Flat Rate (%)', type: 'decimal', category: 'loan', required: false, allowed_types: ['numeric', 'decimal'] },
                { name: 'interest_type', label: 'Interest Type', type: 'text', category: 'loan', required: false, allowed_types: ['text'] },
                { name: 'cbk_rate', label: 'CBK Rate (Benchmark)', type: 'decimal', category: 'loan', required: false, allowed_types: ['numeric', 'decimal'] },
                { name: 'spread', label: 'Spread (%)', type: 'decimal', category: 'loan', required: false, allowed_types: ['numeric', 'decimal'] },
                { name: 'installment_amount', label: 'Installment Amount (KES)', type: 'currency', category: 'loan', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'emi_amount', label: 'EMI Amount (KES)', type: 'currency', category: 'loan', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'payment_frequency', label: 'Payment Frequency', type: 'text', category: 'loan', required: false, allowed_types: ['text'] },
                { name: 'disbursement_channel', label: 'Disbursement Channel', type: 'text', category: 'loan', required: false, allowed_types: ['text'] },
                { name: 'officer_id', label: 'Loan Officer ID', type: 'text', category: 'loan', required: false, allowed_types: ['text'] },
                { name: 'app_score', label: 'Application Score', type: 'numeric', category: 'loan', required: false, allowed_types: ['numeric'] },
                { name: 'dti_ratio', label: 'DTI Ratio', type: 'decimal', category: 'loan', required: false, allowed_types: ['numeric', 'decimal'] },
                { name: 'pti_ratio', label: 'PTI Ratio', type: 'decimal', category: 'loan', required: false, allowed_types: ['numeric', 'decimal'] },
                { name: 'ltv_ratio', label: 'LTV Ratio', type: 'decimal', category: 'loan', required: false, allowed_types: ['numeric', 'decimal'] },
                { name: 'down_payment', label: 'Down Payment', type: 'currency', category: 'loan', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'origination_fee', label: 'Origination Fee', type: 'currency', category: 'loan', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'application_date', label: 'Application Date', type: 'date', category: 'loan', required: false, allowed_types: ['date'] },
                { name: 'approval_date', label: 'Approval Date', type: 'date', category: 'loan', required: false, allowed_types: ['date'] },
                { name: 'promo_code', label: 'Promo Code', type: 'text', category: 'loan', required: false, allowed_types: ['text'] },
                { name: 'auto_pay_enroll', label: 'Auto Pay Enrolled', type: 'boolean', category: 'loan', required: false, allowed_types: ['boolean'] },
                
                // === CATEGORY 3: COLLATERAL LEVEL ===
                { name: 'collateral_id', label: 'Collateral ID', type: 'text', category: 'collateral', required: false, allowed_types: ['text'] },
                { name: 'collateral_type', label: 'Collateral Type', type: 'text', category: 'collateral', required: false, allowed_types: ['text'] },
                { name: 'asset_value', label: 'Asset Value (KES)', type: 'currency', category: 'collateral', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'valuation_date', label: 'Valuation Date', type: 'date', category: 'collateral', required: false, allowed_types: ['date'] },
                { name: 'valuation_method', label: 'Valuation Method', type: 'text', category: 'collateral', required: false, allowed_types: ['text'] },
                { name: 'lien_position', label: 'Lien Position', type: 'numeric', category: 'collateral', required: false, allowed_types: ['numeric'] },
                { name: 'property_type', label: 'Property Type', type: 'text', category: 'collateral', required: false, allowed_types: ['text'] },
                { name: 'prop_address_county', label: 'Property County', type: 'text', category: 'collateral', required: false, allowed_types: ['text'] },
                { name: 'year_built', label: 'Year Built', type: 'numeric', category: 'collateral', required: false, allowed_types: ['numeric'] },
                { name: 'square_meters', label: 'Square Meters', type: 'numeric', category: 'collateral', required: false, allowed_types: ['numeric'] },
                { name: 'occupancy_type', label: 'Occupancy Type', type: 'text', category: 'collateral', required: false, allowed_types: ['text'] },
                { name: 'vehicle_reg_no', label: 'Vehicle Registration Number', type: 'text', category: 'collateral', required: false, allowed_types: ['text'] },
                { name: 'vehicle_make', label: 'Vehicle Make', type: 'text', category: 'collateral', required: false, allowed_types: ['text'] },
                { name: 'vehicle_model', label: 'Vehicle Model', type: 'text', category: 'collateral', required: false, allowed_types: ['text'] },
                { name: 'vehicle_year', label: 'Vehicle Year', type: 'numeric', category: 'collateral', required: false, allowed_types: ['numeric'] },
                { name: 'vehicle_mileage', label: 'Vehicle Mileage (KM)', type: 'numeric', category: 'collateral', required: false, allowed_types: ['numeric'] },
                { name: 'vehicle_condition', label: 'Vehicle Condition', type: 'text', category: 'collateral', required: false, allowed_types: ['text'] },
                
                // === CATEGORY 4: PERFORMANCE & SERVICING ===
                { name: 'account_status', label: 'Account Status', type: 'text', category: 'performance', required: false, allowed_types: ['text'] },
                { name: 'current_balance', label: 'Current Balance (KES)', type: 'currency', category: 'performance', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'outstanding_balance', label: 'Outstanding Balance (KES)', type: 'currency', category: 'performance', required: true, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'principal_paid_todate', label: 'Principal Paid to Date (KES)', type: 'currency', category: 'performance', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'interest_paid_todate', label: 'Interest Paid to Date (KES)', type: 'currency', category: 'performance', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'late_fees_paid_todate', label: 'Late Fees Paid to Date (KES)', type: 'currency', category: 'performance', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'last_payment_date', label: 'Last Payment Date', type: 'date', category: 'performance', required: false, allowed_types: ['date'] },
                { name: 'last_payment_amount', label: 'Last Payment Amount (KES)', type: 'currency', category: 'performance', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'next_payment_due_date', label: 'Next Payment Due Date', type: 'date', category: 'performance', required: false, allowed_types: ['date'] },
                { name: 'days_past_due_curr', label: 'Days Past Due (Current)', type: 'numeric', category: 'performance', required: false, allowed_types: ['numeric'] },
                { name: 'dpd', label: 'Days Past Due', type: 'numeric', category: 'performance', required: true, allowed_types: ['numeric'] },
                { name: 'delinquency_bucket', label: 'Delinquency Bucket', type: 'text', category: 'performance', required: false, allowed_types: ['text'] },
                { name: 'times_delinq_30_curr_loan', label: 'Times 30+ DPD (This Loan)', type: 'numeric', category: 'performance', required: false, allowed_types: ['numeric'] },
                { name: 'times_delinq_60_curr_loan', label: 'Times 60+ DPD (This Loan)', type: 'numeric', category: 'performance', required: false, allowed_types: ['numeric'] },
                { name: 'modification_flag', label: 'Modification Flag', type: 'boolean', category: 'performance', required: false, allowed_types: ['boolean'] },
                { name: 'restructured_date', label: 'Restructured Date', type: 'date', category: 'performance', required: false, allowed_types: ['date'] },
                { name: 'charge_off_date', label: 'Charge-off Date', type: 'date', category: 'performance', required: false, allowed_types: ['date'] },
                { name: 'charge_off_amount', label: 'Charge-off Amount', type: 'currency', category: 'performance', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'recovery_amount', label: 'Recovery Amount', type: 'currency', category: 'performance', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'early_settlement_flag', label: 'Early Settlement Flag', type: 'boolean', category: 'performance', required: false, allowed_types: ['boolean'] },
                { name: 'prepayment_penalty', label: 'Prepayment Penalty', type: 'currency', category: 'performance', required: false, allowed_types: ['numeric', 'decimal', 'currency'] },
                { name: 'variable_rate_update_dt', label: 'Variable Rate Update Date', type: 'date', category: 'performance', required: false, allowed_types: ['date'] },
                { name: 'is_active', label: 'Is Active', type: 'boolean', category: 'performance', required: false, allowed_types: ['boolean'] },
                { name: 'ki_score', label: 'KI Score', type: 'numeric', category: 'performance', required: false, allowed_types: ['numeric'] },
                { name: 'county', label: 'County / Region', type: 'text', category: 'performance', required: false, allowed_types: ['text'] }
            ];
            
            // Bureau & Credit History Fields (NOT in CSV upload, available for filtering only)
            // These are generated by DS team code from CRB Kenya (Metropol, TransUnion, Creditinfo)
            const bureauFields = [
                { name: 'bureau_report_xml', label: 'CRB Report (XML/JSON)', type: 'text', category: 'bureau', required: false, allowed_types: ['text'], csv_upload: true },
                { name: 'crb_score', label: 'CRB Score', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'metropol_score', label: 'Metropol Score', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'transunion_score', label: 'TransUnion Kenya Score', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'total_tradelines', label: 'Total Credit Accounts', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'open_tradelines', label: 'Open Tradelines', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'closed_tradelines', label: 'Closed Tradelines', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'oldest_trade_date', label: 'Oldest Trade Date', type: 'date', category: 'bureau', required: false, allowed_types: ['date'], csv_upload: false },
                { name: 'credit_history_length_months', label: 'Credit History Length (Months)', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'total_inquiries_6m', label: 'Credit Inquiries (6M)', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'total_inquiries_12m', label: 'Credit Inquiries (12M)', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'num_bank_loans', label: 'Bank Loan Accounts', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'num_mfi_loans', label: 'MFI/Sacco Loan Accounts', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'num_mobile_loans', label: 'Mobile Loan Accounts', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'num_digital_loans', label: 'Digital Loan Accounts', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'total_credit_limit', label: 'Total Credit Limit (KES)', type: 'currency', category: 'bureau', required: false, allowed_types: ['numeric', 'decimal', 'currency'], csv_upload: false },
                { name: 'total_outstanding_balance', label: 'Total Outstanding Balance (KES)', type: 'currency', category: 'bureau', required: false, allowed_types: ['numeric', 'decimal', 'currency'], csv_upload: false },
                { name: 'credit_utilization_rate', label: 'Credit Utilization Rate (%)', type: 'decimal', category: 'bureau', required: false, allowed_types: ['numeric', 'decimal'], csv_upload: false },
                { name: 'total_loan_balance', label: 'Total Loan Balance (KES)', type: 'currency', category: 'bureau', required: false, allowed_types: ['numeric', 'decimal', 'currency'], csv_upload: false },
                { name: 'max_loan_amount', label: 'Max Loan Amount (KES)', type: 'currency', category: 'bureau', required: false, allowed_types: ['numeric', 'decimal', 'currency'], csv_upload: false },
                { name: 'ever_dpd_30', label: 'Ever 30+ DPD', type: 'boolean', category: 'bureau', required: false, allowed_types: ['boolean'], csv_upload: false },
                { name: 'ever_dpd_60', label: 'Ever 60+ DPD', type: 'boolean', category: 'bureau', required: false, allowed_types: ['boolean'], csv_upload: false },
                { name: 'ever_dpd_90', label: 'Ever 90+ DPD', type: 'boolean', category: 'bureau', required: false, allowed_types: ['boolean'], csv_upload: false },
                { name: 'num_dpd_30_6m', label: '30+ DPD Count (6M)', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'num_dpd_30_12m', label: '30+ DPD Count (12M)', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'num_dpd_30_24m', label: '30+ DPD Count (24M)', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'num_dpd_60_6m', label: '60+ DPD Count (6M)', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'num_dpd_60_12m', label: '60+ DPD Count (12M)', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'num_dpd_60_24m', label: '60+ DPD Count (24M)', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'num_dpd_90_6m', label: '90+ DPD Count (6M)', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'num_dpd_90_12m', label: '90+ DPD Count (12M)', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'num_dpd_90_ever', label: '90+ DPD Count (Ever)', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'months_since_last_dpd_30', label: 'Months Since Last 30+ DPD', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'months_since_last_dpd_90', label: 'Months Since Last 90+ DPD', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'worst_status_ever', label: 'Worst Payment Status Ever', type: 'text', category: 'bureau', required: false, allowed_types: ['text'], csv_upload: false },
                { name: 'worst_status_12m', label: 'Worst Status (12M)', type: 'text', category: 'bureau', required: false, allowed_types: ['text'], csv_upload: false },
                { name: 'num_accounts_past_due', label: 'Accounts Currently Past Due', type: 'numeric', category: 'bureau', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'amt_past_due', label: 'Amount Past Due (KES)', type: 'currency', category: 'bureau', required: false, allowed_types: ['numeric', 'decimal', 'currency'], csv_upload: false },
                { name: 'crb_adverse_listing', label: 'CRB Adverse Listing', type: 'boolean', category: 'bureau', required: false, allowed_types: ['boolean'], csv_upload: false },
                { name: 'adverse_listing_date', label: 'Adverse Listing Date', type: 'date', category: 'bureau', required: false, allowed_types: ['date'], csv_upload: false },
                { name: 'court_judgement_flag', label: 'Court Judgement Flag', type: 'boolean', category: 'bureau', required: false, allowed_types: ['boolean'], csv_upload: false },
                { name: 'kra_compliance_flag', label: 'KRA Tax Compliance', type: 'boolean', category: 'bureau', required: false, allowed_types: ['boolean'], csv_upload: false },
                { name: 'collections_balance', label: 'Collections Balance (KES)', type: 'currency', category: 'bureau', required: false, allowed_types: ['numeric', 'decimal', 'currency'], csv_upload: false }
            ];
            
            // Derived / Calculated Fields (Generated by DS team, available for filtering only)
            const derivedFields = [
                { name: 'credit_utilization_change_6m', label: 'Credit Utilization Change (6M)', type: 'decimal', category: 'derived', required: false, allowed_types: ['numeric', 'decimal'], csv_upload: false },
                { name: 'inquiry_velocity', label: 'Credit Inquiry Velocity', type: 'decimal', category: 'derived', required: false, allowed_types: ['numeric', 'decimal'], csv_upload: false },
                { name: 'payment_consistency_score', label: 'Payment Consistency Score', type: 'decimal', category: 'derived', required: false, allowed_types: ['numeric', 'decimal'], csv_upload: false },
                { name: 'debt_burden_ratio', label: 'Debt Burden Ratio', type: 'decimal', category: 'derived', required: false, allowed_types: ['numeric', 'decimal'], csv_upload: false },
                { name: 'income_verification_flag', label: 'Income Verified', type: 'boolean', category: 'derived', required: false, allowed_types: ['boolean'], csv_upload: false },
                { name: 'mpesa_transaction_velocity', label: 'M-Pesa Transaction Velocity', type: 'decimal', category: 'derived', required: false, allowed_types: ['numeric', 'decimal'], csv_upload: false },
                { name: 'mobile_money_balance_avg', label: 'Mobile Money Avg Balance (KES)', type: 'currency', category: 'derived', required: false, allowed_types: ['numeric', 'decimal', 'currency'], csv_upload: false },
                { name: 'digital_footprint_score', label: 'Digital Footprint Score', type: 'numeric', category: 'derived', required: false, allowed_types: ['numeric'], csv_upload: false },
                { name: 'credit_relationship_months', label: 'Credit Relationship (Months)', type: 'numeric', category: 'derived', required: false, allowed_types: ['numeric'], csv_upload: false }
            ];
            
            // Combine all fields for filtering (but only databaseFields for CSV mapping)
            const allFieldsForFiltering = [...databaseFields, ...bureauFields, ...derivedFields];

            // Sample file columns (simulating uploaded CSV)
            const uploadedFileColumns = [
                'LoanID', 'CustomerID', 'Name', 'PrincipalAmount', 'Balance', 
                'Rate', 'DisbursedOn', 'MaturityDate', 'Tenure', 'DPD', 
                'Score', 'Location', 'Purpose', 'Collateral', 'EMI'
            ];

            uploadPoolBtn.addEventListener('click', () => {
                populateMappingFields();
                updatePoolSubStep('poolMappingSubStep');
            });
            
            function populateMappingFields() {
                const container = document.getElementById('mappingFieldsContainer');
                const headerRow = container.querySelector('.grid');
                container.innerHTML = '';
                container.appendChild(headerRow);
                
                // Create initial mappings
                const initialMappings = [
                    { fileCol: 'LoanID', dbField: 'loan_id', type: 'text', status: 'validated' },
                    { fileCol: 'CustomerID', dbField: 'customer_id', type: 'text', status: 'validated' },
                    { fileCol: 'Name', dbField: 'customer_name', type: 'text', status: 'validated' },
                    { fileCol: 'PrincipalAmount', dbField: 'loan_amount', type: 'currency', status: 'validated' },
                    { fileCol: 'Balance', dbField: 'outstanding_balance', type: 'currency', status: 'validated' },
                    { fileCol: 'Rate', dbField: 'interest_rate', type: 'decimal', status: 'validated' },
                    { fileCol: 'DisbursedOn', dbField: 'disbursement_date', type: 'date', status: 'validated' },
                    { fileCol: 'MaturityDate', dbField: 'maturity_date', type: 'date', status: 'validated' },
                    { fileCol: 'Tenure', dbField: 'remaining_tenor', type: 'numeric', status: 'validated' },
                    { fileCol: 'DPD', dbField: 'dpd', type: 'numeric', status: 'validated' },
                    { fileCol: 'Score', dbField: 'ki_score', type: 'numeric', status: 'validated' },
                    { fileCol: 'Location', dbField: 'county', type: 'text', status: 'validated' },
                    { fileCol: 'Purpose', dbField: 'loan_purpose', type: 'text', status: 'validated' },
                    { fileCol: 'Collateral', dbField: 'collateral_type', type: 'text', status: 'validated' },
                    { fileCol: 'EMI', dbField: 'emi_amount', type: 'currency', status: 'validated' }
                ];
                
                initialMappings.forEach((mapping, index) => {
                    const row = createMappingRow(mapping, index);
                    container.appendChild(row);
                });
            }
            
            function createMappingRow(mapping, index) {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-2 text-sm p-3 bg-white border rounded hover:bg-gray-50';
                row.dataset.index = index;
                
                const statusColor = mapping.status === 'validated' ? 'text-green-600' : 'text-orange-600';
                const statusIcon = mapping.status === 'validated' ? '‚úì' : '‚ö†';
                
                // Get allowed types for the selected field
                const selectedField = databaseFields.find(f => f.name === mapping.dbField);
                const allowedTypes = selectedField?.allowed_types || ['text', 'numeric', 'decimal', 'date', 'boolean', 'currency'];
                
                // Generate data type options based on allowed types
                const typeOptions = allowedTypes.map(type => {
                    const typeLabels = {
                        'text': 'Text',
                        'numeric': 'Numeric',
                        'decimal': 'Decimal',
                        'date': 'Date',
                        'boolean': 'Boolean',
                        'currency': 'Currency'
                    };
                    return `<option value="${type}" ${mapping.type === type ? 'selected' : ''}>${typeLabels[type]}</option>`;
                }).join('');
                
                row.innerHTML = `
                    <span class="col-span-3 font-medium text-gray-700">${mapping.fileCol}</span>
                    <select class="col-span-3 border border-gray-300 rounded px-2 py-1 text-sm db-field-select" data-index="${index}">
                        ${databaseFields.map(f => `<option value="${f.name}" ${f.name === mapping.dbField ? 'selected' : ''}>${f.label} (${f.category})</option>`).join('')}
                    </select>
                    <select class="col-span-2 border border-gray-300 rounded px-2 py-1 text-sm type-select" data-index="${index}">
                        ${typeOptions}
                    </select>
                    <span class="col-span-2 ${statusColor} font-semibold flex items-center">
                        ${statusIcon} ${mapping.status === 'validated' ? 'Valid' : 'Check'}
                    </span>
                    <div class="col-span-2 flex justify-center space-x-1">
                        <button class="add-validation-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200" data-index="${index}" title="Add Validation">
                            <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </button>
                        <button class="delete-mapping-btn text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200" data-index="${index}" title="Delete">
                            <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                // Add event listener to update data type options when database field changes
                const dbFieldSelect = row.querySelector('.db-field-select');
                const typeSelect = row.querySelector('.type-select');
                dbFieldSelect.addEventListener('change', (e) => {
                    const field = databaseFields.find(f => f.name === e.target.value);
                    if (field) {
                        const allowed = field.allowed_types || ['text', 'numeric', 'decimal', 'date', 'boolean', 'currency'];
                        const typeLabels = {
                            'text': 'Text',
                            'numeric': 'Numeric',
                            'decimal': 'Decimal',
                            'date': 'Date',
                            'boolean': 'Boolean',
                            'currency': 'Currency'
                        };
                        typeSelect.innerHTML = allowed.map(type => 
                            `<option value="${type}">${typeLabels[type]}</option>`
                        ).join('');
                        // Set to field's default type
                        typeSelect.value = field.type;
                    }
                });
                
                return row;
            }
            
            // Event delegation for mapping actions
            document.getElementById('mappingFieldsContainer').addEventListener('click', (e) => {
                if (e.target.closest('.add-validation-btn')) {
                    const index = e.target.closest('.add-validation-btn').dataset.index;
                    const row = document.querySelector(`[data-index="${index}"]`);
                    const dbField = row.querySelector('.db-field-select').value;
                    const fieldType = row.querySelector('.type-select').value;
                    const field = databaseFields.find(f => f.name === dbField);
                    openValidationModal(field || { name: dbField, label: dbField, type: fieldType });
                }
                
                if (e.target.closest('.delete-mapping-btn')) {
                    if (confirm('Delete this field mapping?')) {
                        e.target.closest('[data-index]').remove();
                    }
                }
            });
            
            // Create New Field Modal
            document.getElementById('createNewFieldBtn')?.addEventListener('click', () => {
                document.getElementById('createFieldModal').classList.add('active');
            });
            
            document.getElementById('closeCreateFieldModal')?.addEventListener('click', () => {
                document.getElementById('createFieldModal').classList.remove('active');
            });
            
            document.getElementById('cancelCreateField')?.addEventListener('click', () => {
                document.getElementById('createFieldModal').classList.remove('active');
            });
            
            document.getElementById('saveNewField')?.addEventListener('click', () => {
                const fieldName = document.getElementById('newFieldName').value.trim();
                const fieldLabel = document.getElementById('newFieldLabel').value.trim();
                const fieldType = document.getElementById('newFieldType').value;
                const fieldDesc = document.getElementById('newFieldDescription').value.trim();
                
                if (!fieldName || !fieldLabel) {
                    alert('Please provide both field name and display label');
                    return;
                }
                
                // Add to database fields
                const newField = { name: fieldName, label: fieldLabel, type: fieldType, required: false, custom: true };
                databaseFields.push(newField);
                state.customFields.push(newField);
                
                // Add to mapping
                const container = document.getElementById('mappingFieldsContainer');
                const newMapping = { fileCol: fieldLabel, dbField: fieldName, type: fieldType, status: 'validated' };
                const row = createMappingRow(newMapping, databaseFields.length - 1);
                container.appendChild(row);
                
                // Clear and close modal
                document.getElementById('newFieldName').value = '';
                document.getElementById('newFieldLabel').value = '';
                document.getElementById('newFieldDescription').value = '';
                document.getElementById('createFieldModal').classList.remove('active');
                
                alert(`Custom field "${fieldLabel}" created successfully!`);
            });
            
            // Validation Modal
            function openValidationModal(field) {
                document.getElementById('validationFieldName').textContent = field.label;
                document.getElementById('validationFieldType').textContent = field.type;
                document.getElementById('validationModal').classList.add('active');
                
                // Clear previous rules
                const container = document.getElementById('validationRulesContainer');
                container.innerHTML = '';
                
                // Add initial rule
                addValidationRule(field.type);
            }
            
            document.getElementById('closeValidationModal')?.addEventListener('click', () => {
                document.getElementById('validationModal').classList.remove('active');
            });
            
            document.getElementById('cancelValidation')?.addEventListener('click', () => {
                document.getElementById('validationModal').classList.remove('active');
            });
            
            document.getElementById('addValidationRule')?.addEventListener('click', () => {
                const fieldType = document.getElementById('validationFieldType').textContent;
                addValidationRule(fieldType);
            });
            
            function addValidationRule(fieldType) {
                const container = document.getElementById('validationRulesContainer');
                const ruleDiv = document.createElement('div');
                ruleDiv.className = 'border rounded p-3 bg-gray-50';
                
                let operatorOptions = '';
                if (fieldType === 'numeric' || fieldType === 'decimal' || fieldType === 'currency') {
                    operatorOptions = `
                        <option value="min">Minimum value</option>
                        <option value="max">Maximum value</option>
                        <option value="range">Range (min-max)</option>
                        <option value="gt_field">Greater than field</option>
                        <option value="lt_field">Less than field</option>
                        <option value="gte_field">Greater than or equal to field</option>
                        <option value="lte_field">Less than or equal to field</option>
                        <option value="gt_formula">Greater than formula</option>
                        <option value="lt_formula">Less than formula</option>
                        <option value="gte_formula">Greater than or equal to formula</option>
                        <option value="lte_formula">Less than or equal to formula</option>
                    `;
                } else if (fieldType === 'date') {
                    operatorOptions = `
                        <option value="after">After date</option>
                        <option value="before">Before date</option>
                        <option value="range">Date range</option>
                        <option value="after_field">After field</option>
                        <option value="before_field">Before field</option>
                    `;
                } else if (fieldType === 'text') {
                    operatorOptions = `
                        <option value="required">Required (not empty)</option>
                        <option value="min_length">Minimum length</option>
                        <option value="max_length">Maximum length</option>
                        <option value="regex">Regex pattern</option>
                        <option value="in_list">Must be in list</option>
                    `;
                } else if (fieldType === 'boolean') {
                    operatorOptions = `
                        <option value="must_be_true">Must be true</option>
                        <option value="must_be_false">Must be false</option>
                    `;
                }
                
                // Get all numeric/currency fields for field comparison dropdowns
                const numericFields = databaseFields.filter(f => 
                    f.type === 'numeric' || f.type === 'decimal' || f.type === 'currency'
                );
                const fieldOptions = numericFields.map(f => 
                    `<option value="${f.name}">${f.label}</option>`
                ).join('');
                
                ruleDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <select class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm validation-operator">
                                ${operatorOptions}
                            </select>
                            <button class="remove-validation-rule text-red-600 hover:text-red-800">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="validation-value-container">
                            <input type="text" class="w-full border border-gray-300 rounded px-2 py-1 text-sm validation-value" placeholder="Value">
                        </div>
                    </div>
                `;
                
                const operatorSelect = ruleDiv.querySelector('.validation-operator');
                const valueContainer = ruleDiv.querySelector('.validation-value-container');
                
                // Update value input based on operator selection
                operatorSelect.addEventListener('change', (e) => {
                    const operator = e.target.value;
                    
                    if (operator === 'gt_field' || operator === 'lt_field' || operator === 'gte_field' || operator === 'lte_field') {
                        // Show field selector
                        valueContainer.innerHTML = `
                            <select class="w-full border border-gray-300 rounded px-2 py-1 text-sm validation-value">
                                <option value="">Select field...</option>
                                ${fieldOptions}
                            </select>
                        `;
                    } else if (operator === 'gt_formula' || operator === 'lt_formula' || operator === 'gte_formula' || operator === 'lte_formula') {
                        // Show formula input with helper text
                        valueContainer.innerHTML = `
                            <input type="text" class="w-full border border-gray-300 rounded px-2 py-1 text-sm validation-value" placeholder="e.g., 0.8 * field_name or field1 + field2">
                            <p class="text-xs text-gray-600 mt-1">Formula examples: <code>0.8 * loan_amount</code>, <code>outstanding_balance + 1000</code>, <code>field1 * 0.5 + field2</code></p>
                            <p class="text-xs text-blue-600 mt-1">Operators: +, -, *, /, ( ). Use field names from dropdown.</p>
                        `;
                    } else if (operator === 'range') {
                        // Show two inputs for range
                        valueContainer.innerHTML = `
                            <div class="flex space-x-2">
                                <input type="text" class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm validation-value-min" placeholder="Min">
                                <input type="text" class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm validation-value-max" placeholder="Max">
                            </div>
                        `;
                    } else {
                        // Show regular input
                        valueContainer.innerHTML = `
                            <input type="text" class="w-full border border-gray-300 rounded px-2 py-1 text-sm validation-value" placeholder="Value">
                        `;
                    }
                });
                
                ruleDiv.querySelector('.remove-validation-rule').addEventListener('click', () => {
                    ruleDiv.remove();
                });
                
                container.appendChild(ruleDiv);
            }
            
            document.getElementById('saveValidation')?.addEventListener('click', () => {
                const fieldName = document.getElementById('validationFieldName').textContent;
                const rules = [];
                document.querySelectorAll('#validationRulesContainer > div').forEach(ruleDiv => {
                    const operator = ruleDiv.querySelector('.validation-operator').value;
                    let value;
                    
                    // Handle different input types based on operator
                    if (operator === 'range') {
                        const min = ruleDiv.querySelector('.validation-value-min')?.value;
                        const max = ruleDiv.querySelector('.validation-value-max')?.value;
                        value = { min, max };
                    } else {
                        value = ruleDiv.querySelector('.validation-value')?.value || '';
                    }
                    
                    rules.push({ operator, value });
                });
                
                state.fieldValidations[fieldName] = rules;
                document.getElementById('validationModal').classList.remove('active');
                alert(`${rules.length} validation rule(s) added for ${fieldName}`);
            });
            
            // Custom Filter Modal
            document.getElementById('openCustomFilterBtn')?.addEventListener('click', () => {
                document.getElementById('customFilterModal').classList.add('active');
                const container = document.getElementById('customFilterRulesContainer');
                container.innerHTML = '';
                addFilterRule();
            });
            
            document.getElementById('closeCustomFilterModal')?.addEventListener('click', () => {
                document.getElementById('customFilterModal').classList.remove('active');
            });
            
            document.getElementById('cancelCustomFilter')?.addEventListener('click', () => {
                document.getElementById('customFilterModal').classList.remove('active');
            });
            
            document.getElementById('addFilterRule')?.addEventListener('click', () => {
                addFilterRule();
            });
            
            function addFilterRule() {
                const container = document.getElementById('customFilterRulesContainer');
                const ruleDiv = document.createElement('div');
                ruleDiv.className = 'border rounded p-3 bg-gray-50';
                
                // Group fields by category for better organization
                const fieldsByCategory = {
                    'customer': allFieldsForFiltering.filter(f => f.category === 'customer'),
                    'loan': allFieldsForFiltering.filter(f => f.category === 'loan'),
                    'collateral': allFieldsForFiltering.filter(f => f.category === 'collateral'),
                    'performance': allFieldsForFiltering.filter(f => f.category === 'performance'),
                    'bureau': allFieldsForFiltering.filter(f => f.category === 'bureau'),
                    'derived': allFieldsForFiltering.filter(f => f.category === 'derived')
                };
                
                const categoryLabels = {
                    'customer': 'Customer Demographics & KYC',
                    'loan': 'Loan Origination & Structure',
                    'collateral': 'Collateral',
                    'performance': 'Performance & Servicing',
                    'bureau': 'Bureau & Credit History',
                    'derived': 'Derived / Calculated Fields'
                };
                
                let fieldOptionsHTML = '';
                for (const [category, fields] of Object.entries(fieldsByCategory)) {
                    if (fields.length > 0) {
                        fieldOptionsHTML += `<optgroup label="${categoryLabels[category]}">`;
                        fieldOptionsHTML += fields.map(f => 
                            `<option value="${f.name}" data-type="${f.type}">${f.label}</option>`
                        ).join('');
                        fieldOptionsHTML += `</optgroup>`;
                    }
                }
                
                ruleDiv.innerHTML = `
                    <div class="grid grid-cols-12 gap-2 items-center">
                        <select class="col-span-4 border border-gray-300 rounded px-2 py-1 text-sm filter-field">
                            ${fieldOptionsHTML}
                        </select>
                        <select class="col-span-3 border border-gray-300 rounded px-2 py-1 text-sm filter-operator">
                            <option value="=">=</option>
                            <option value="!=">!=</option>
                            <option value=">">></option>
                            <option value="<"><</option>
                            <option value=">=">>=</option>
                            <option value="<="><=</option>
                            <option value="LIKE">LIKE</option>
                            <option value="IN">IN</option>
                            <option value="NOT IN">NOT IN</option>
                        </select>
                        <input type="text" class="col-span-4 border border-gray-300 rounded px-2 py-1 text-sm filter-value" placeholder="Value">
                        <button class="col-span-1 remove-filter-rule text-red-600 hover:text-red-800">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                // Update operators based on field type
                const fieldSelect = ruleDiv.querySelector('.filter-field');
                const operatorSelect = ruleDiv.querySelector('.filter-operator');
                
                // Initialize with correct operators for first field
                const initialFieldType = fieldSelect.options[0].dataset.type;
                updateOperatorsForType(operatorSelect, initialFieldType);
                
                fieldSelect.addEventListener('change', () => {
                    const selectedOption = fieldSelect.options[fieldSelect.selectedIndex];
                    const fieldType = selectedOption.dataset.type;
                    updateOperatorsForType(operatorSelect, fieldType);
                });
                
                ruleDiv.querySelector('.remove-filter-rule').addEventListener('click', () => {
                    ruleDiv.remove();
                    updateFilterPreview();
                });
                
                container.appendChild(ruleDiv);
                updateFilterPreview();
            }
            
            function updateOperatorsForType(operatorSelect, fieldType) {
                if (fieldType === 'numeric' || fieldType === 'decimal' || fieldType === 'currency') {
                    operatorSelect.innerHTML = `
                        <option value="=">=</option>
                        <option value="!=">!=</option>
                        <option value=">">></option>
                        <option value="<"><</option>
                        <option value=">=">>=</option>
                        <option value="<="><=</option>
                        <option value="BETWEEN">BETWEEN</option>
                    `;
                } else if (fieldType === 'date') {
                    operatorSelect.innerHTML = `
                        <option value="=">=</option>
                        <option value="!=">!=</option>
                        <option value=">">After</option>
                        <option value="<">Before</option>
                        <option value=">=">On or After</option>
                        <option value="<=">On or Before</option>
                        <option value="BETWEEN">Between</option>
                    `;
                } else if (fieldType === 'text') {
                    operatorSelect.innerHTML = `
                        <option value="=">=</option>
                        <option value="!=">!=</option>
                        <option value="LIKE">LIKE</option>
                        <option value="NOT LIKE">NOT LIKE</option>
                        <option value="IN">IN</option>
                        <option value="NOT IN">NOT IN</option>
                    `;
                } else if (fieldType === 'boolean') {
                    operatorSelect.innerHTML = `
                        <option value="=">IS</option>
                        <option value="!=">IS NOT</option>
                    `;
                }
            }
            
            function updateFilterPreview() {
                const logic = document.querySelector('input[name="filterLogic"]:checked')?.value || 'AND';
                const rules = [];
                
                document.querySelectorAll('#customFilterRulesContainer > div').forEach(ruleDiv => {
                    const field = ruleDiv.querySelector('.filter-field').selectedOptions[0].text;
                    const operator = ruleDiv.querySelector('.filter-operator').value;
                    const value = ruleDiv.querySelector('.filter-value').value || '?';
                    rules.push(`${field} ${operator} ${value}`);
                });
                
                const preview = rules.join(` ${logic} `);
                document.getElementById('filterPreview').textContent = preview || 'No rules added';
            }
            
            // Update preview on logic change
            document.querySelectorAll('input[name="filterLogic"]').forEach(radio => {
                radio.addEventListener('change', updateFilterPreview);
            });
            
            // Function to update unified filters display
            function updateUnifiedFiltersDisplay() {
                const container = document.getElementById('activeFiltersContainer');
                const logic = document.getElementById('filterLogicGlobal')?.value || 'AND';
                
                const allFilters = [];
                
                // Add quick filters (if not at default values)
                const kiScoreMin = document.getElementById('kiScoreMinSlider')?.value || 1;
                const kiScoreMax = document.getElementById('kiScoreMaxSlider')?.value || 40;
                if (kiScoreMin != 1 || kiScoreMax != 40) {
                    allFilters.push({ type: 'quick', label: `KI Score: ${kiScoreMin}-${kiScoreMax}`, category: 'Quick Filter' });
                }
                
                const loanAmountMin = document.getElementById('loanAmountMinSlider')?.value || 50000;
                const loanAmountMax = document.getElementById('loanAmountMaxSlider')?.value || 200000;
                if (loanAmountMin != 50000 || loanAmountMax != 200000) {
                    allFilters.push({ type: 'quick', label: `Loan Amount: ${loanAmountMin/1000}k-${loanAmountMax/1000}k`, category: 'Quick Filter' });
                }
                
                const tenureMin = document.getElementById('tenureMinSlider')?.value || 6;
                const tenureMax = document.getElementById('tenureMaxSlider')?.value || 24;
                if (tenureMin != 6 || tenureMax != 24) {
                    allFilters.push({ type: 'quick', label: `Tenure: ${tenureMin}-${tenureMax} months`, category: 'Quick Filter' });
                }
                
                const interestMin = document.getElementById('interestRateMinSlider')?.value || 18;
                const interestMax = document.getElementById('interestRateMaxSlider')?.value || 30;
                if (interestMin != 18 || interestMax != 30) {
                    allFilters.push({ type: 'quick', label: `Interest Rate: ${interestMin}%-${interestMax}%`, category: 'Quick Filter' });
                }
                
                // Add custom filters
                state.customFilters.forEach((customFilter, index) => {
                    customFilter.rules.forEach(rule => {
                        const field = allFieldsForFiltering.find(f => f.name === rule.field);
                        const fieldLabel = field ? field.label : rule.field;
                        const categoryLabel = field ? field.category.charAt(0).toUpperCase() + field.category.slice(1) : 'Custom';
                        allFilters.push({ 
                            type: 'custom', 
                            label: `${fieldLabel} ${rule.operator} ${rule.value}`, 
                            category: categoryLabel,
                            filterIndex: index 
                        });
                    });
                });
                
                // Render filters
                if (allFilters.length === 0) {
                    container.innerHTML = '<div class="text-gray-600 italic">No filters applied. Using default ranges.</div>';
                } else {
                    container.innerHTML = `
                        <div class="text-xs text-gray-700 mb-2">
                            <span class="font-semibold">${allFilters.length} filter(s) active</span> 
                            <span class="text-gray-600">(combined with ${logic})</span>
                        </div>
                        ${allFilters.map((filter, idx) => `
                            <div class="flex items-center justify-between bg-white border border-blue-200 rounded px-2 py-1">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold text-blue-700">${filter.category}:</span>
                                    <span class="text-xs text-gray-800">${filter.label}</span>
                                </div>
                                ${filter.type === 'custom' ? `
                                    <button class="remove-custom-filter text-red-600 hover:text-red-800 text-xs font-bold" data-index="${filter.filterIndex}">√ó</button>
                                ` : ''}
                            </div>
                        `).join('')}
                    `;
                    
                    // Add event listeners for remove buttons
                    container.querySelectorAll('.remove-custom-filter').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.dataset.index);
                            state.customFilters.splice(index, 1);
                            updateUnifiedFiltersDisplay();
                        });
                    });
                }
            }
            
            // Update display when filter logic changes
            document.getElementById('filterLogicGlobal')?.addEventListener('change', updateUnifiedFiltersDisplay);
            
            document.getElementById('applyCustomFilter')?.addEventListener('click', () => {
                const logic = document.querySelector('input[name="filterLogic"]:checked')?.value || 'AND';
                const rules = [];
                
                document.querySelectorAll('#customFilterRulesContainer > div').forEach(ruleDiv => {
                    const field = ruleDiv.querySelector('.filter-field').value;
                    const operator = ruleDiv.querySelector('.filter-operator').value;
                    const value = ruleDiv.querySelector('.filter-value').value;
                    if (value) {
                        rules.push({ field, operator, value });
                    }
                });
                
                if (rules.length === 0) {
                    alert('Please add at least one filter rule with a value');
                    return;
                }
                
                state.customFilters.push({ logic, rules });
                
                // Update unified display
                updateUnifiedFiltersDisplay();
                
                // Close modal
                document.getElementById('customFilterModal').classList.remove('active');
                alert(`Custom filter with ${rules.length} rule(s) added successfully!`);
            });
            
            // Add event listeners to quick filter sliders to update unified display
            ['kiScoreMinSlider', 'kiScoreMaxSlider', 'loanAmountMinSlider', 'loanAmountMaxSlider', 
             'tenureMinSlider', 'tenureMaxSlider', 'interestRateMinSlider', 'interestRateMaxSlider'].forEach(id => {
                document.getElementById(id)?.addEventListener('change', updateUnifiedFiltersDisplay);
            });

            validateMappedPoolBtn.addEventListener('click', () => updatePoolSubStep('poolValidationErrorSubStep'));
            reuploadPoolBtn.addEventListener('click', () => {
                updatePoolSubStep('poolStructuringSubStep');
            });

            function calculateWaterfall(poolValue, lossRate) {
                const totalPrincipal = poolValue * 0.85;
                const totalInterest = poolValue * 0.15;
                const totalCashflow = totalPrincipal + totalInterest;

                const seniorPrincipalDue = totalPrincipal * 0.8;
                const seniorInterestDue = totalInterest * 0.8; 
                const mezzPrincipalDue = totalPrincipal * 0.12;
                const mezzInterestDue = totalInterest * 0.12;

                const totalLoss = poolValue * (lossRate / 100);
                const availableCashflow = totalCashflow - totalLoss;
                
                const seniorPayout = Math.min(availableCashflow, seniorPrincipalDue + seniorInterestDue);
                const cashAfterSenior = availableCashflow - seniorPayout;
                
                const mezzPayout = Math.min(cashAfterSenior, mezzPrincipalDue + mezzInterestDue);
                const cashAfterMezz = cashAfterSenior - mezzPayout;

                const equityPayout = Math.max(0, cashAfterMezz);

                // Split payouts into principal and interest for charting
                // Assume an 85/15 split for payouts, which is a simplification but visually works
                const split = (payout) => ({
                    principal: payout * 0.85,
                    interest: payout * 0.15
                });
                
                return {
                    senior: split(seniorPayout),
                    mezz: split(mezzPayout),
                    equity: split(equityPayout)
                };
            }

            // ===== INITIAL RISK ANALYTICS FUNCTIONS =====
            
            function renderInitialRiskAnalytics() {
                // Risk by County - Bar chart showing WA KI Score by county
                createOrUpdateChart('riskByCountyChart', 'bar', {
                    labels: ['Nairobi', 'Kiambu', 'Nakuru', 'Mombasa', 'Kisumu', 'Uasin Gishu', 'Machakos', 'Kajiado', 'Meru', 'Nyeri'],
                    datasets: [{
                        label: 'WA KI Score',
                        data: [22.3, 24.1, 25.8, 28.5, 31.2, 33.7, 35.4, 36.8, 38.2, 39.5],
                        backgroundColor: 'rgba(20, 184, 166, 0.7)',
                        borderColor: 'rgba(20, 184, 166, 1)',
                        borderWidth: 1
                    }]
                }, {
                    indexAxis: 'y',
                    scales: {
                        x: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'WA KI Score (Lower is Better)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                });

                // Risk by Loan Amount - Combo chart with KI Score and PAR30
                createOrUpdateChart('riskByAmountChart', 'bar', {
                    labels: ['<50k', '50k-100k', '100k-150k', '150k-200k', '200k-250k', '>250k'],
                    datasets: [{
                        label: 'WA KI Score',
                        data: [42.5, 31.2, 24.0, 25.3, 33.8, 38.5],
                        backgroundColor: 'rgba(20, 184, 166, 0.7)',
                        borderColor: 'rgba(20, 184, 166, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'PAR30 (%)',
                        data: [9.2, 5.8, 3.8, 4.2, 7.1, 8.5],
                        backgroundColor: 'rgba(251, 146, 60, 0.7)',
                        borderColor: 'rgba(251, 146, 60, 1)',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }]
                }, {
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'WA KI Score' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'PAR30 (%)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                });

                // Risk by Tenure - Combo chart with KI Score and PAR90
                createOrUpdateChart('riskByTenureChart', 'bar', {
                    labels: ['1-6 mo', '6-12 mo', '12-18 mo', '18-24 mo', '24-36 mo', '>36 mo'],
                    datasets: [{
                        label: 'WA KI Score',
                        data: [38.2, 28.5, 25.2, 26.8, 32.5, 41.3],
                        backgroundColor: 'rgba(20, 184, 166, 0.7)',
                        yAxisID: 'y'
                    }, {
                        label: 'PAR90 (%)',
                        data: [3.2, 1.8, 0.9, 1.2, 2.4, 3.8],
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        yAxisID: 'y1'
                    }]
                }, {
                    scales: {
                        y: {
                            position: 'left',
                            title: { display: true, text: 'WA KI Score' }
                        },
                        y1: {
                            position: 'right',
                            title: { display: true, text: 'PAR90 (%)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                });

                // Risk by Loan Purpose - Horizontal bar
                createOrUpdateChart('riskByPurposeChart', 'bar', {
                    labels: ['Agri Inputs', 'Equipment', 'Inventory', 'Working Capital', 'Home Improvement', 'Debt Consolidation'],
                    datasets: [{
                        label: 'WA KI Score',
                        data: [21.5, 23.8, 28.4, 32.1, 36.5, 42.3],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.7)',
                            'rgba(59, 130, 246, 0.7)',
                            'rgba(168, 85, 247, 0.7)',
                            'rgba(251, 146, 60, 0.7)',
                            'rgba(239, 68, 68, 0.7)',
                            'rgba(156, 163, 175, 0.7)'
                        ]
                    }]
                }, {
                    indexAxis: 'y',
                    scales: {
                        x: { 
                            beginAtZero: true,
                            title: { display: true, text: 'WA KI Score' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                });

                // Risk by Age Group - Combo chart
                createOrUpdateChart('riskByAgeChart', 'bar', {
                    labels: ['18-25', '25-35', '35-45', '45-55', '55-65', '65+'],
                    datasets: [{
                        label: 'WA KI Score',
                        data: [45.2, 32.8, 24.5, 25.8, 33.2, 41.5],
                        backgroundColor: 'rgba(20, 184, 166, 0.7)',
                        yAxisID: 'y'
                    }, {
                        label: 'PAR60 (%)',
                        data: [5.8, 3.2, 1.8, 2.1, 4.2, 6.5],
                        backgroundColor: 'rgba(251, 146, 60, 0.7)',
                        yAxisID: 'y1'
                    }]
                }, {
                    scales: {
                        y: {
                            position: 'left',
                            title: { display: true, text: 'WA KI Score' }
                        },
                        y1: {
                            position: 'right',
                            title: { display: true, text: 'PAR60 (%)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                });

                // Risk by Gender - Doughnut chart
                createOrUpdateChart('riskByGenderChart', 'doughnut', {
                    labels: ['Female (Low Risk)', 'Male (Medium Risk)'],
                    datasets: [{
                        label: 'Est. Loss Rate',
                        data: [3.2, 5.8],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.7)',
                            'rgba(251, 146, 60, 0.7)'
                        ],
                        borderWidth: 2
                    }]
                }, {
                    plugins: {
                        legend: { position: 'bottom' },
                        title: {
                            display: true,
                            text: 'Female: 3.2% Loss | Male: 5.8% Loss'
                        }
                    }
                });
            }

            // "Proceed to Filters" button - show filter section
            document.getElementById('proceedToFiltersBtn')?.addEventListener('click', () => {
                document.getElementById('initialRiskAnalytics').classList.add('hidden');
                document.getElementById('filterStructuringSection').classList.remove('hidden');
            });

            function applyFilters() {
                try {
                    if (!simulationResultsPanel) return;
                    simulationResultsPanel.classList.remove('hidden');
                    if (simulationOriginatorName) {
                        simulationOriginatorName.textContent = 'Filtered Pool Results';
                    }
                    
                    // Get filter values with null checks
                    const kiScoreMin = parseInt(kiScoreMinSlider?.value || 1);
                    const kiScoreMax = parseInt(kiScoreMaxSlider?.value || 100);
                    const loanAmountMin = parseInt(loanAmountMinSlider?.value || 10000);
                    const loanAmountMax = parseInt(loanAmountMaxSlider?.value || 250000);
                    const tenureMin = parseInt(tenureMinSlider?.value || 1);
                    const tenureMax = parseInt(tenureMaxSlider?.value || 48);
                    const interestMin = parseInt(interestRateMinSlider?.value || 12);
                    const interestMax = parseInt(interestRateMaxSlider?.value || 36);
                
                // Calculate filtered pool metrics (mock data)
                const filteredLoanCount = 7540;
                const filteredPoolValue = 780;
                const filteredWAKiScore = 22;
                const filteredWATenure = 16;
                const filteredLossRate = 3.8;
                
                // Overall portfolio metrics (mock data)
                const overallLoanCount = 10000;
                const overallPoolValue = 1050;
                const overallWAKiScore = 28;
                const overallWATenure = 20;
                const overallLossRate = 4.5;
                
                // Update summary cards
                document.getElementById('selectedLoans').textContent = filteredLoanCount.toLocaleString();
                document.getElementById('poolValue').textContent = `${filteredPoolValue}M`;
                document.getElementById('poolTenure').textContent = `${filteredWATenure} mo`;
                document.getElementById('poolKiScore').textContent = filteredWAKiScore;
                document.getElementById('estimatedLoss').textContent = `${filteredLossRate.toFixed(1)}%`;
                
                document.getElementById('overallEstimatedLoss').textContent = `${filteredLossRate.toFixed(1)}%`;
                
                // Store base case for later use
                const baseCase = calculateWaterfall(filteredPoolValue, filteredLossRate);
                state.simulationBaseCase = { ...baseCase, lossRate: filteredLossRate };
                
                // Generate enhanced comparison charts based on ACTUAL filter values
                // Risk by Interest Rate - Comparison Chart (Bins aligned with filter)
                // Note: interestMin and interestMax are already declared above
                let interestLabels = [];
                let interestSelectedKi = [];
                let interestRestKi = [];
                let interestSelectedPar = [];
                let interestRestPar = [];
                
                // Create bins based on filter range
                if (interestMin > 12 || interestMax < 36) {
                    // Filter is applied, create bins: <min%, min%-max% (selected), >max%
                    if (interestMin > 12) {
                        interestLabels.push(`<${interestMin}%`);
                        interestSelectedKi.push(null); // No selected loans below min
                        interestRestKi.push(overallWAKiScore + 4);
                        interestSelectedPar.push(null);
                        interestRestPar.push(7.5 + Math.random() * 2.0);
                    }
                    interestLabels.push(`${interestMin}%-${interestMax}% (Selected)`);
                    interestSelectedKi.push(filteredWAKiScore);
                    interestRestKi.push(null); // No rest loans in selected range
                    interestSelectedPar.push(3.5 + Math.random() * 1.0);
                    interestRestPar.push(null);
                    if (interestMax < 36) {
                        interestLabels.push(`>${interestMax}%`);
                        interestSelectedKi.push(null);
                        interestRestKi.push(overallWAKiScore + 5);
                        interestSelectedPar.push(null);
                        interestRestPar.push(8.0 + Math.random() * 2.0);
                    }
                } else {
                    // No filter, show standard bins
                    interestLabels = ['<15%', '15-20%', '20-25%', '25-30%', '30-35%', '>35%'];
                    interestSelectedKi = [35, 28, 25, 30, 38, 42];
                    interestRestKi = [38, 32, 29, 34, 42, 45];
                    interestSelectedPar = [5.5, 4.2, 3.8, 4.5, 6.0, 7.5];
                    interestRestPar = [6.5, 5.2, 4.8, 5.5, 7.0, 8.5];
                }
                
                createOrUpdateChart('filteredRiskByInterestRateChart', 'bar', {
                    labels: interestLabels,
                        datasets: [{
                        label: 'Selected Group WA KI Score',
                        data: interestSelectedKi,
                        backgroundColor: 'rgba(20, 184, 166, 0.7)'
                    }, {
                        label: 'Rest of Portfolio WA KI Score',
                        data: interestRestKi,
                        backgroundColor: 'rgba(156, 163, 175, 0.7)'
                    }, {
                        label: 'Selected Group PAR30',
                        data: interestSelectedPar,
                        backgroundColor: 'rgba(251, 146, 60, 0.8)',
                        yAxisID: 'y1'
                    }, {
                        label: 'Rest of Portfolio PAR30',
                        data: interestRestPar,
                        backgroundColor: 'rgba(251, 146, 60, 0.5)',
                        yAxisID: 'y1'
                    }]
                }, {
                    scales: {
                        y: { position: 'left', title: { display: true, text: 'WA KI Score' } },
                        y1: { position: 'right', title: { display: true, text: 'PAR30 (%)' }, grid: { drawOnChartArea: false } }
                    },
                    plugins: { legend: { display: true, position: 'top' } }
                });
                
                // Risk by Loan Amount - Comparison Chart (Bins aligned with filter)
                const amountMinK = loanAmountMin / 1000;
                const amountMaxK = loanAmountMax / 1000;
                let amountLabels = [];
                let amountSelectedKi = [];
                let amountRestKi = [];
                let amountSelectedPar = [];
                let amountRestPar = [];
                
                // Create bins based on filter range
                if (loanAmountMin > 10000 || loanAmountMax < 250000) {
                    // Filter is applied, create bins: <min, min-max (selected), >max
                    if (loanAmountMin > 10000) {
                        amountLabels.push(`<${amountMinK}K`);
                        amountSelectedKi.push(null); // No selected loans below min
                        amountRestKi.push(overallWAKiScore + 5);
                        amountSelectedPar.push(null);
                        amountRestPar.push(8.0 + Math.random() * 2.0);
                    }
                    amountLabels.push(`${amountMinK}K-${amountMaxK}K (Selected)`);
                    amountSelectedKi.push(filteredWAKiScore);
                    amountRestKi.push(null); // No rest loans in selected range
                    amountSelectedPar.push(3.5 + Math.random() * 1.0);
                    amountRestPar.push(null);
                    if (loanAmountMax < 250000) {
                        amountLabels.push(`>${amountMaxK}K`);
                        amountSelectedKi.push(null);
                        amountRestKi.push(overallWAKiScore + 3);
                        amountSelectedPar.push(null);
                        amountRestPar.push(7.0 + Math.random() * 2.0);
                    }
                } else {
                    // No filter, show standard bins
                    amountLabels = ['<50K', '50K-100K', '100K-150K', '150K-200K', '200K-250K', '>250K'];
                    amountSelectedKi = [38, 32, 28, 25, 30, 35];
                    amountRestKi = [42, 36, 32, 29, 34, 39];
                    amountSelectedPar = [8.5, 6.2, 5.0, 4.2, 5.5, 7.0];
                    amountRestPar = [9.5, 7.2, 6.0, 5.2, 6.5, 8.0];
                }
                
                createOrUpdateChart('filteredRiskByAmountChart', 'bar', {
                    labels: amountLabels,
                    datasets: [{
                        label: 'Selected Group WA KI Score',
                        data: amountSelectedKi,
                        backgroundColor: 'rgba(20, 184, 166, 0.7)'
                    }, {
                        label: 'Rest of Portfolio WA KI Score',
                        data: amountRestKi,
                        backgroundColor: 'rgba(156, 163, 175, 0.7)'
                    }, {
                        label: 'Selected Group PAR30',
                        data: amountSelectedPar,
                        backgroundColor: 'rgba(251, 146, 60, 0.8)',
                        yAxisID: 'y1'
                    }, {
                        label: 'Rest of Portfolio PAR30',
                        data: amountRestPar,
                        backgroundColor: 'rgba(251, 146, 60, 0.5)',
                        yAxisID: 'y1'
                    }]
                }, {
                        scales: {
                        y: { position: 'left', title: { display: true, text: 'WA KI Score' } },
                        y1: { position: 'right', title: { display: true, text: 'PAR30 (%)' }, grid: { drawOnChartArea: false } }
                    },
                    plugins: { legend: { display: true, position: 'top' } }
                });
                
                // Risk by Residual Tenure - Comparison Chart (Bins aligned with filter)
                let tenureLabels = [];
                let tenureSelectedKi = [];
                let tenureRestKi = [];
                let tenureSelectedPar = [];
                let tenureRestPar = [];
                
                // Create bins based on filter range
                if (tenureMin > 1 || tenureMax < 48) {
                    // Filter is applied, create bins: <min, min-max (selected), >max
                    if (tenureMin > 1) {
                        tenureLabels.push(`<${tenureMin}M`);
                        tenureSelectedKi.push(null);
                        tenureRestKi.push(overallWAKiScore + 6);
                        tenureSelectedPar.push(null);
                        tenureRestPar.push(2.8 + Math.random() * 1.0);
                    }
                    tenureLabels.push(`${tenureMin}-${tenureMax}M (Selected)`);
                    tenureSelectedKi.push(filteredWAKiScore);
                    tenureRestKi.push(null);
                    tenureSelectedPar.push(1.0 + Math.random() * 0.8);
                    tenureRestPar.push(null);
                    if (tenureMax < 48) {
                        tenureLabels.push(`>${tenureMax}M`);
                        tenureSelectedKi.push(null);
                        tenureRestKi.push(overallWAKiScore + 4);
                        tenureSelectedPar.push(null);
                        tenureRestPar.push(2.2 + Math.random() * 1.0);
                    }
                } else {
                    // No filter, show standard bins
                    tenureLabels = ['<6M', '6-12M', '12-18M', '18-24M', '24-36M', '>36M'];
                    tenureSelectedKi = [42, 35, 28, 26, 30, 38];
                    tenureRestKi = [46, 39, 32, 30, 34, 42];
                    tenureSelectedPar = [2.5, 1.8, 1.2, 1.0, 1.5, 2.2];
                    tenureRestPar = [3.0, 2.3, 1.7, 1.5, 2.0, 2.7];
                }
                
                createOrUpdateChart('filteredRiskByTenureChart', 'bar', {
                    labels: tenureLabels,
                    datasets: [{
                        label: 'Selected Group WA KI Score',
                        data: tenureSelectedKi,
                        backgroundColor: 'rgba(20, 184, 166, 0.7)'
                    }, {
                        label: 'Rest of Portfolio WA KI Score',
                        data: tenureRestKi,
                        backgroundColor: 'rgba(156, 163, 175, 0.7)'
                    }, {
                        label: 'Selected Group PAR90',
                        data: tenureSelectedPar,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        yAxisID: 'y1'
                    }, {
                        label: 'Rest of Portfolio PAR90',
                        data: tenureRestPar,
                        backgroundColor: 'rgba(239, 68, 68, 0.5)',
                        yAxisID: 'y1'
                    }]
                }, {
                    scales: {
                        y: { position: 'left', title: { display: true, text: 'WA KI Score' } },
                        y1: { position: 'right', title: { display: true, text: 'PAR90 (%)' }, grid: { drawOnChartArea: false } }
                    },
                    plugins: { legend: { display: true, position: 'top' } }
                });
                
                // Risk by Loan Purpose - Comparison Chart (Selected vs Rest)
                const purposeLabels = ['Agriculture', 'Business', 'Education', 'Medical', 'Personal', 'Other'];
                const purposeSelectedKi = purposeLabels.map(() => filteredWAKiScore + (Math.random() * 6 - 3));
                const purposeRestKi = purposeLabels.map(() => overallWAKiScore + (Math.random() * 6));
                
                createOrUpdateChart('filteredRiskByPurposeChart', 'bar', {
                    labels: purposeLabels,
                    datasets: [{
                        label: 'Selected Group WA KI Score',
                        data: purposeSelectedKi,
                        backgroundColor: 'rgba(20, 184, 166, 0.7)'
                    }, {
                        label: 'Rest of Portfolio WA KI Score',
                        data: purposeRestKi,
                        backgroundColor: 'rgba(156, 163, 175, 0.7)'
                    }]
                }, {
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'WA KI Score' } }
                    },
                    plugins: { legend: { display: true, position: 'top' } }
                });
                
                // Risk by Borrower Age - Comparison Chart (Selected vs Rest)
                const ageLabels = ['<25', '25-35', '35-45', '45-55', '55-65', '>65'];
                const ageSelectedKi = ageLabels.map(() => filteredWAKiScore + (Math.random() * 8 - 4));
                const ageRestKi = ageLabels.map(() => overallWAKiScore + (Math.random() * 8));
                const ageSelectedPar = ageLabels.map(() => 2.0 + Math.random() * 3.0);
                const ageRestPar = ageLabels.map(() => 4.0 + Math.random() * 4.0);
                
                createOrUpdateChart('filteredRiskByAgeChart', 'bar', {
                    labels: ageLabels,
                    datasets: [{
                        label: 'Selected Group WA KI Score',
                        data: ageSelectedKi,
                        backgroundColor: 'rgba(20, 184, 166, 0.7)'
                    }, {
                        label: 'Rest of Portfolio WA KI Score',
                        data: ageRestKi,
                        backgroundColor: 'rgba(156, 163, 175, 0.7)'
                    }, {
                        label: 'Selected Group PAR60',
                        data: ageSelectedPar,
                        backgroundColor: 'rgba(251, 146, 60, 0.8)',
                        yAxisID: 'y1'
                    }, {
                        label: 'Rest of Portfolio PAR60',
                        data: ageRestPar,
                        backgroundColor: 'rgba(251, 146, 60, 0.5)',
                        yAxisID: 'y1'
                    }]
                }, {
                    scales: {
                        y: { position: 'left', title: { display: true, text: 'WA KI Score' } },
                        y1: { position: 'right', title: { display: true, text: 'PAR60 (%)' }, grid: { drawOnChartArea: false } }
                    },
                    plugins: { legend: { display: true, position: 'top' } }
                });
                
                // Risk by DTI Ratio - Comparison Chart (Selected vs Rest)
                const dtiLabels = ['<0.3', '0.3-0.5', '0.5-0.7', '0.7-0.9', '>0.9'];
                const dtiSelectedKi = dtiLabels.map((_, idx) => {
                    // Lower DTI = better KI score, higher DTI = worse KI score
                    const baseScore = filteredWAKiScore;
                    const offset = (idx - 1) * 3; // Center around 0.3-0.5 range
                    return baseScore + offset;
                });
                const dtiRestKi = dtiLabels.map((_, idx) => {
                    const baseScore = overallWAKiScore;
                    const offset = (idx - 1) * 4;
                    return baseScore + offset;
                });
                const dtiSelectedLoss = dtiLabels.map((_, idx) => {
                    // Lower DTI = lower loss rate, higher DTI = higher loss rate
                    const baseRate = filteredLossRate;
                    const offset = (idx - 1) * 0.8;
                    return Math.max(0, baseRate + offset);
                });
                const dtiRestLoss = dtiLabels.map((_, idx) => {
                    const baseRate = overallLossRate;
                    const offset = (idx - 1) * 1.2;
                    return Math.max(0, baseRate + offset);
                });
                
                createOrUpdateChart('filteredRiskByDTIChart', 'bar', {
                    labels: dtiLabels,
                    datasets: [{
                        label: 'Selected Group WA KI Score',
                        data: dtiSelectedKi,
                        backgroundColor: 'rgba(20, 184, 166, 0.7)'
                    }, {
                        label: 'Rest of Portfolio WA KI Score',
                        data: dtiRestKi,
                        backgroundColor: 'rgba(156, 163, 175, 0.7)'
                    }, {
                        label: 'Selected Group Loss Rate',
                        data: dtiSelectedLoss,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        yAxisID: 'y1'
                    }, {
                        label: 'Rest of Portfolio Loss Rate',
                        data: dtiRestLoss,
                        backgroundColor: 'rgba(239, 68, 68, 0.5)',
                        yAxisID: 'y1'
                    }]
                }, {
                    scales: {
                        y: { position: 'left', title: { display: true, text: 'WA KI Score' } },
                        y1: { position: 'right', title: { display: true, text: 'Loss Rate (%)' }, grid: { drawOnChartArea: false } }
                    },
                    plugins: { legend: { display: true, position: 'top' } }
                });
                
                // Generate comprehensive filter comparison table (Selected Group vs Rest of Portfolio)
                try {
                    const tableBody = document.getElementById('filterComparisonTableBody');
                    if (tableBody) {
                        tableBody.innerHTML = '';
                        
                        // Get selected counties
                        const selectedCounties = countiesMultiSelect ? countiesMultiSelect.getValue() : [];
                        const countiesText = selectedCounties.length > 0 ? selectedCounties.join(', ') : 'All Counties';
                        
                        const amountMinK = loanAmountMin / 1000;
                        const amountMaxK = loanAmountMax / 1000;
                        
                        // Helper function to calculate metrics for selected vs rest
                        function calculateFilterMetrics(selectedGroupLossRate, selectedGroupKiScore, restLossRate, restKiScore) {
                            return {
                                selected: { lossRate: selectedGroupLossRate, kiScore: selectedGroupKiScore },
                                rest: { lossRate: restLossRate, kiScore: restKiScore }
                            };
                        }
                        
                        // Build filter rows with proper selected vs rest calculations
                        const filters = [];
                        
                        // KI Score Filter
                        if (kiScoreMin !== 1 || kiScoreMax !== 100) {
                            const selectedKiLossRate = filteredLossRate; // Selected group (within range)
                            const selectedKiScore = filteredWAKiScore;
                            const restKiLossRate = overallLossRate + 0.5; // Rest of portfolio (outside range) - slightly worse
                            const restKiScore = overallWAKiScore + 3;
                            filters.push({
                                name: 'KI Score',
                                bucket: `${kiScoreMin} - ${kiScoreMax}`,
                                ...calculateFilterMetrics(selectedKiLossRate, selectedKiScore, restKiLossRate, restKiScore)
                            });
                        }
                        
                        // Loan Amount Filter
                        if (loanAmountMin !== 10000 || loanAmountMax !== 250000) {
                            const selectedAmountLossRate = filteredLossRate;
                            const selectedAmountKiScore = filteredWAKiScore;
                            const restAmountLossRate = overallLossRate + 0.3;
                            const restAmountKiScore = overallWAKiScore + 2;
                            filters.push({
                                name: 'Loan Amount',
                                bucket: `KES ${amountMinK}k - ${amountMaxK}k`,
                                ...calculateFilterMetrics(selectedAmountLossRate, selectedAmountKiScore, restAmountLossRate, restAmountKiScore)
                            });
                        }
                        
                        // Residual Tenure Filter
                        if (tenureMin !== 1 || tenureMax !== 48) {
                            const selectedTenureLossRate = filteredLossRate;
                            const selectedTenureKiScore = filteredWAKiScore;
                            const restTenureLossRate = overallLossRate + 0.4;
                            const restTenureKiScore = overallWAKiScore + 2.5;
                            filters.push({
                                name: 'Residual Tenure',
                                bucket: `${tenureMin} - ${tenureMax} months`,
                                ...calculateFilterMetrics(selectedTenureLossRate, selectedTenureKiScore, restTenureLossRate, restTenureKiScore)
                            });
                        }
                        
                        // Interest Rate Filter
                        if (interestMin !== 12 || interestMax !== 36) {
                            const selectedInterestLossRate = filteredLossRate;
                            const selectedInterestKiScore = filteredWAKiScore;
                            const restInterestLossRate = overallLossRate + 0.2;
                            const restInterestKiScore = overallWAKiScore + 1.5;
                            filters.push({
                                name: 'Interest Rate',
                                bucket: `${interestMin}% - ${interestMax}%`,
                                ...calculateFilterMetrics(selectedInterestLossRate, selectedInterestKiScore, restInterestLossRate, restInterestKiScore)
                            });
                        }
                        
                        // Counties Filter
                        if (selectedCounties.length > 0) {
                            const selectedCountiesLossRate = filteredLossRate;
                            const selectedCountiesKiScore = filteredWAKiScore;
                            const restCountiesLossRate = overallLossRate + 0.6; // Other counties typically worse
                            const restCountiesKiScore = overallWAKiScore + 4;
                            filters.push({
                                name: 'Counties',
                                bucket: countiesText,
                                ...calculateFilterMetrics(selectedCountiesLossRate, selectedCountiesKiScore, restCountiesLossRate, restCountiesKiScore)
                            });
                        }
                        
                        // Add custom filters if any
                        if (state.customFilters && state.customFilters.length > 0) {
                            state.customFilters.forEach((customFilter, idx) => {
                                const customLossRate = filteredLossRate;
                                const customKiScore = filteredWAKiScore;
                                const restCustomLossRate = overallLossRate + 0.3;
                                const restCustomKiScore = overallWAKiScore + 2;
                                filters.push({
                                    name: `Custom Filter ${idx + 1}`,
                                    bucket: customFilter.rules.map(r => `${r.field} ${r.operator} ${r.value}`).join(' AND '),
                                    ...calculateFilterMetrics(customLossRate, customKiScore, restCustomLossRate, restCustomKiScore)
                                });
                            });
                        }
                        
                        // Populate table with calculated metrics
                        filters.forEach(filter => {
                            const row = document.createElement('tr');
                            row.className = 'bg-white border-b';
                            row.innerHTML = `
                                <td class="px-4 py-2 font-medium text-gray-900">${filter.name}</td>
                                <td class="px-4 py-2">${filter.bucket}</td>
                                <td class="px-4 py-2 text-right font-semibold text-green-600">${filter.selected.lossRate.toFixed(2)}%</td>
                                <td class="px-4 py-2 text-right">${filter.rest.lossRate.toFixed(2)}%</td>
                                <td class="px-4 py-2 text-right font-semibold text-teal-600">${filter.selected.kiScore}</td>
                                <td class="px-4 py-2 text-right">${filter.rest.kiScore}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                        
                        // If no filters applied, show message
                        if (filters.length === 0) {
                            const row = document.createElement('tr');
                            row.className = 'bg-white border-b';
                            row.innerHTML = `
                                <td colspan="6" class="px-4 py-4 text-center text-gray-500 italic">No filters applied. Using default ranges for all criteria.</td>
                            `;
                            tableBody.appendChild(row);
                        }
                    }
                } catch (e) {
                    console.warn('Error generating filter comparison table:', e);
                }
                } catch (e) {
                    console.error('Error in applyFilters:', e);
                }
            }


            applyFiltersBtn.addEventListener('click', applyFilters);

            finalizePoolBtn.addEventListener('click', () => {
                finalizePoolModal.classList.add('active');
                finalizePoolModal.style.display = 'flex';
            });
            
            cancelFinalizeBtn.addEventListener('click', () => {
                finalizePoolModal.classList.remove('active');
                finalizePoolModal.style.display = 'none';
            });
            
            saveTransactionBtn.addEventListener('click', () => {
                const name = finalizeTransactionNameInput.value.trim();
                const comments = document.getElementById('finalizeComments').value.trim();
                
                if (name) {
                    const newTransaction = {
                        id: name.toUpperCase().replace(/\s/g, '-'),
                        name: name,
                        originator: 'Rafiki MFB',
                        structure: 'Securitisation',
                        grade: document.getElementById('poolGrade')?.textContent || 'AA-',
                        tenure: document.getElementById('poolTenure')?.textContent || '18 mo',
                        yield: 'N/A',
                        covenantsSet: false,
                        finalizedAt: new Date().toISOString(),
                        comments: comments
                    };
                    
                    state.transactions.unshift(newTransaction);
                    renderActiveTransactions();
                    
                    // Update finalized pool display
                    document.getElementById('finalizedLoanCount').textContent = document.getElementById('selectedLoans')?.textContent || '9,540 loans';
                    document.getElementById('finalizedPoolValue').textContent = document.getElementById('poolValue')?.textContent || '980M';
                    document.getElementById('finalizedKiScore').textContent = document.getElementById('poolKiScore')?.textContent || '25';
                    document.getElementById('finalizedLossRate').textContent = document.getElementById('estimatedLoss')?.textContent || '4.1%';
                    document.getElementById('finalizedTenure').textContent = document.getElementById('poolTenure')?.textContent || '18 mo';
                    
                    // Show post-finalization section and download button
                    document.getElementById('postFinalizationSection').classList.remove('hidden');
                    document.getElementById('downloadFilteredPoolBtn').classList.remove('hidden');
                    document.getElementById('finalizePoolBtn').classList.add('hidden');
                    
                    // Close modal
                    finalizePoolModal.classList.remove('active');
                    finalizePoolModal.style.display = 'none';
                    finalizeTransactionNameInput.value = '';
                    document.getElementById('finalizeComments').value = '';
                    
                    // Show success message
                    alert('‚úÖ Pool finalized successfully! You can now download the filtered loan file or proceed to generate cashflows.');
                }
            });
            
            // Download Filtered Pool CSV
            document.getElementById('downloadFilteredPoolBtn')?.addEventListener('click', () => {
                // Generate mock filtered loan file
                const csvContent = generateFilteredLoanCSV();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `filtered_pool_${Date.now()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            function generateFilteredLoanCSV() {
                // Mock CSV with filtered loans (demo data)
                let csv = 'loan_id,customer_name,loan_amount,ki_score,residual_tenure,interest_rate,county,purpose,gender,age,current_dpd\n';
                
                // Generate 9,540 mock loan records
                const counties = ['Nairobi', 'Kiambu', 'Nakuru', 'Mombasa', 'Kisumu'];
                const purposes = ['Agri Inputs', 'Equipment', 'Inventory', 'Working Capital'];
                const genders = ['Male', 'Female'];
                
                for (let i = 1; i <= 9540; i++) {
                    const loanId = `LN${String(i).padStart(6, '0')}`;
                    const customerName = `Customer_${i}`;
                    const loanAmount = Math.floor(Math.random() * 150000) + 50000; // 50k-200k
                    const kiScore = Math.floor(Math.random() * 20) + 20; // 20-40
                    const tenure = Math.floor(Math.random() * 13) + 12; // 12-24 months
                    const interestRate = (Math.random() * 12 + 18).toFixed(1); // 18-30%
                    const county = counties[Math.floor(Math.random() * counties.length)];
                    const purpose = purposes[Math.floor(Math.random() * purposes.length)];
                    const gender = genders[Math.floor(Math.random() * genders.length)];
                    const age = Math.floor(Math.random() * 30) + 30; // 30-60
                    const dpd = Math.random() < 0.95 ? 0 : Math.floor(Math.random() * 30); // 95% current
                    
                    csv += `${loanId},${customerName},${loanAmount},${kiScore},${tenure},${interestRate},${county},${purpose},${gender},${age},${dpd}\n`;
                }
                
                return csv;
            }
            
            // ===== MONTE CARLO SIMULATION & CASHFLOW GENERATION =====
            
            // Generate Cashflow Button - Show Monte Carlo Section
            document.getElementById('generateCashflowBtn')?.addEventListener('click', () => {
                // Simulate AI model processing
                document.getElementById('generateCashflowBtn').disabled = true;
                document.getElementById('generateCashflowBtn').innerHTML = '‚è≥ Generating Cashflows...';
                
                setTimeout(() => {
                    document.getElementById('generateCashflowBtn').innerHTML = '‚úì Cashflows Generated';
                    document.getElementById('monteCarloSection').classList.remove('hidden');
                    document.getElementById('downloadLoanCashflowBtn').classList.remove('hidden');
                    
                    // Scroll to Monte Carlo section
                    document.getElementById('monteCarloSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 2000); // Simulate 2s processing time
            });
            
            // Download Loan-Level Cashflow CSV
            document.getElementById('downloadLoanCashflowBtn')?.addEventListener('click', () => {
                const csvContent = generateLoanLevelCashflowCSV();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `loan_level_cashflow_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            function generateLoanLevelCashflowCSV() {
                try {
                    // Get finalized pool data
                    const loanCount = parseInt(document.getElementById('finalizedLoanCount')?.textContent.replace(/\D/g, '') || '7540');
                    const maxTenure = parseInt(document.getElementById('finalizedTenure')?.textContent.replace(/\D/g, '') || '18');
                    
                    // Generate loan data first to determine max tenure
                    const loans = [];
                    let actualMaxTenure = 0;
                    
                    for (let loanIdx = 1; loanIdx <= Math.min(loanCount, 1000); loanIdx++) { // Limit to 1000 for demo
                        const loanId = `LOAN-${String(loanIdx).padStart(6, '0')}`;
                        const loanTenure = Math.floor(Math.random() * (maxTenure - 6)) + 6; // 6 to maxTenure months
                        const monthlyPayment = 5000 + Math.random() * 45000; // KES 5k to 50k
                        
                        const loanData = {
                            id: loanId,
                            tenure: loanTenure,
                            payments: []
                        };
                        
                        // Generate cashflow for each period until maturity
                        for (let period = 1; period <= loanTenure; period++) {
                            // Actual demand (contractual payment)
                            const actualDemand = monthlyPayment;
                            
                            // Estimated cashflow (with some variance for prepayment, default, etc.)
                            let estimatedCashflow = monthlyPayment;
                            if (Math.random() < 0.05) { // 5% chance of prepayment
                                estimatedCashflow = monthlyPayment * (1 + Math.random() * 0.5); // 100-150% for prepayment
                            } else if (Math.random() < 0.08) { // 8% chance of partial payment
                                estimatedCashflow = monthlyPayment * (0.3 + Math.random() * 0.5); // 30-80% for partial
                            } else if (Math.random() < 0.02) { // 2% chance of default
                                estimatedCashflow = 0; // No payment on default
                            }
                            
                            loanData.payments.push({
                                period,
                                actualDemand,
                                estimatedCashflow
                            });
                        }
                        
                        loans.push(loanData);
                        actualMaxTenure = Math.max(actualMaxTenure, loanTenure);
                    }
                    
                    // Build CSV header with columns for each month
                    let csv = 'Loan ID';
                    for (let period = 1; period <= actualMaxTenure; period++) {
                        csv += `,Month ${period} Actual Demand,Month ${period} Estimated Cashflow`;
                    }
                    csv += '\n';
                    
                    // Add data rows
                    for (const loan of loans) {
                        csv += loan.id;
                        for (let period = 1; period <= actualMaxTenure; period++) {
                            const payment = loan.payments.find(p => p.period === period);
                            if (payment) {
                                csv += `,${payment.actualDemand.toFixed(2)},${payment.estimatedCashflow.toFixed(2)}`;
                            } else {
                                csv += `,,`; // Empty cells for periods beyond loan tenure
                            }
                        }
                        csv += '\n';
                    }
                    
                    return csv;
                } catch (e) {
                    console.error('Error generating loan-level cashflow CSV:', e);
                    return 'Loan ID,Period,Actual Demand,Estimated Cashflow\n'; // Fallback to old format
                }
            }
            
            // Simulation Parameter Sliders - Update Labels
            document.getElementById('gdpGrowthSlider')?.addEventListener('input', (e) => {
                document.getElementById('gdpGrowthLabel').textContent = `${parseFloat(e.target.value).toFixed(1)}%`;
            });
            document.getElementById('unemploymentSlider')?.addEventListener('input', (e) => {
                document.getElementById('unemploymentLabel').textContent = `${parseFloat(e.target.value).toFixed(1)}%`;
            });
            document.getElementById('cbkRateSlider')?.addEventListener('input', (e) => {
                document.getElementById('cbkRateLabel').textContent = `${parseFloat(e.target.value).toFixed(1)}%`;
            });
            document.getElementById('prepaymentRateSlider')?.addEventListener('input', (e) => {
                document.getElementById('prepaymentRateLabel').textContent = `${parseFloat(e.target.value).toFixed(1)}%`;
            });
            document.getElementById('lossRateSlider')?.addEventListener('input', (e) => {
                document.getElementById('lossRateLabel').textContent = `${parseFloat(e.target.value).toFixed(1)}%`;
            });
            document.getElementById('recoveryRateSlider')?.addEventListener('input', (e) => {
                document.getElementById('recoveryRateLabel').textContent = `${parseFloat(e.target.value).toFixed(0)}%`;
            });
            
            // Run Monte Carlo Simulation
            document.getElementById('runMonteCarloBtn')?.addEventListener('click', () => {
                const numPaths = parseInt(document.getElementById('numPathsSelect').value);
                const correlationModel = document.getElementById('correlationModelSelect').value;
                const timeHorizon = parseInt(document.getElementById('timeHorizonInput').value);
                const lossRate = parseFloat(document.getElementById('lossRateSlider').value);
                const prepaymentRate = parseFloat(document.getElementById('prepaymentRateSlider').value);
                const recoveryRate = parseFloat(document.getElementById('recoveryRateSlider').value);
                
                // Simulate processing
                const btn = document.getElementById('runMonteCarloBtn');
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Running Simulation...';
                
                setTimeout(() => {
                    // Run simulation
                    runMonteCarloSimulation(numPaths, lossRate, prepaymentRate, recoveryRate);
                    
                    // Show results
                    document.getElementById('simulationResults').classList.remove('hidden');
                    document.getElementById('simulationTime').textContent = `Processing time: ${(numPaths / 4000).toFixed(1)}s`;
                    document.getElementById('simulationPaths').textContent = `${numPaths.toLocaleString()} paths`;
                    
                    btn.disabled = false;
                    btn.innerHTML = '‚ñ∂ Run Simulation';
                    
                    // Scroll to results
                    document.getElementById('simulationResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, Math.min(numPaths / 4000 * 1000, 3000)); // Simulate realistic processing time
            });
            
            function runMonteCarloSimulation(numPaths, lossRate, prepaymentRate, recoveryRate) {
                // Mock Monte Carlo simulation with realistic distributions
                const poolValue = 980; // Million KES
                
                // Generate distribution of outcomes
                const outcomes = [];
                for (let i = 0; i < numPaths; i++) {
                    // Simulate random loss and prepayment with some correlation
                    const randomLoss = (lossRate / 100) + (Math.random() - 0.5) * 0.06; // +/- 3%
                    const randomPrepay = (prepaymentRate / 100) + (Math.random() - 0.5) * 0.04; // +/- 2%
                    const randomRecovery = (recoveryRate / 100) + (Math.random() - 0.5) * 0.2; // +/- 10%
                    
                    // Calculate pool cashflow for this path
                    const expectedCF = poolValue * 1.12; // 112% including interest
                    const losses = poolValue * randomLoss * (1 - randomRecovery);
                    const prepayImpact = poolValue * randomPrepay * 0.02; // Small prepay penalty
                    const pathCashflow = expectedCF - losses - prepayImpact;
                    
                    outcomes.push({
                        cashflow: pathCashflow,
                        loss: randomLoss * 100
                    });
                }
                
                // Sort outcomes
                outcomes.sort((a, b) => a.cashflow - b.cashflow);
                
                // Calculate statistics
                const mean = outcomes.reduce((sum, o) => sum + o.cashflow, 0) / numPaths;
                const p5 = outcomes[Math.floor(numPaths * 0.05)].cashflow; // VaR
                const p50 = outcomes[Math.floor(numPaths * 0.50)].cashflow; // Median
                const p95 = outcomes[Math.floor(numPaths * 0.95)].cashflow;
                
                // CVaR (Expected Shortfall) - average of outcomes below P5
                const tailOutcomes = outcomes.slice(0, Math.floor(numPaths * 0.05));
                const cvar = tailOutcomes.reduce((sum, o) => sum + o.cashflow, 0) / tailOutcomes.length;
                
                // Update UI
                document.getElementById('expectedCashflow').textContent = `KES ${mean.toFixed(0)}M`;
                document.getElementById('bestCase').textContent = `KES ${p95.toFixed(0)}M`;
                document.getElementById('baseCase').textContent = `KES ${p50.toFixed(0)}M`;
                document.getElementById('stressedCase').textContent = `KES ${p5.toFixed(0)}M`;
                document.getElementById('expectedShortfall').textContent = `KES ${cvar.toFixed(0)}M`;
                
                // Render distribution charts
                renderCashflowDistribution(outcomes);
                renderLossDistribution(outcomes);
                renderTrancheAnalysis(mean, p5, p50, p95);
            }
            
            function renderCashflowDistribution(outcomes) {
                // Create histogram data
                const numBins = 40;
                const min = Math.min(...outcomes.map(o => o.cashflow));
                const max = Math.max(...outcomes.map(o => o.cashflow));
                const binSize = (max - min) / numBins;
                
                const bins = new Array(numBins).fill(0);
                const labels = [];
                
                for (let i = 0; i < numBins; i++) {
                    labels.push((min + i * binSize).toFixed(0));
                }
                
                outcomes.forEach(o => {
                    const binIndex = Math.min(Math.floor((o.cashflow - min) / binSize), numBins - 1);
                    bins[binIndex]++;
                });
                
                createOrUpdateChart('cashflowDistributionChart', 'bar', {
                    labels: labels,
                    datasets: [{
                        label: 'Frequency',
                        data: bins,
                        backgroundColor: 'rgba(139, 92, 246, 0.7)',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        borderWidth: 1
                    }]
                }, {
                    scales: {
                        x: { title: { display: true, text: 'Pool Cashflow (KES M)' } },
                        y: { title: { display: true, text: 'Frequency' } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                });
            }
            
            function renderLossDistribution(outcomes) {
                // Create histogram for loss rates
                const numBins = 30;
                const lossRates = outcomes.map(o => o.loss);
                const min = Math.min(...lossRates);
                const max = Math.max(...lossRates);
                const binSize = (max - min) / numBins;
                
                const bins = new Array(numBins).fill(0);
                const labels = [];
                
                for (let i = 0; i < numBins; i++) {
                    labels.push((min + i * binSize).toFixed(1) + '%');
                }
                
                lossRates.forEach(loss => {
                    const binIndex = Math.min(Math.floor((loss - min) / binSize), numBins - 1);
                    bins[binIndex]++;
                });
                
                createOrUpdateChart('lossDistributionChart', 'bar', {
                    labels: labels,
                    datasets: [{
                        label: 'Frequency',
                        data: bins,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                }, {
                    scales: {
                        x: { title: { display: true, text: 'Loss Rate (%)' } },
                        y: { title: { display: true, text: 'Frequency' } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                });
            }
            
            function renderTrancheAnalysis(mean, p5, p50, p95) {
                try {
                    // Get configured tranching structure from state
                    const poolValue = parseFloat(document.getElementById('poolValue')?.textContent.replace(/[^\d.]/g, '') || '780');
                    
                    // Calculate equity size from all tranches
                    let totalTrancheSize = 0;
                    state.tranches.forEach(t => {
                        const sizeInput = document.querySelector(`.trancheSizeInput[data-tranche-id="${t.id}"]`);
                        if (sizeInput) {
                            t.size = parseFloat(sizeInput.value || 0);
                            totalTrancheSize += t.size;
                        }
                    });
                    const equitySize = Math.max(0, 100 - totalTrancheSize) / 100;
                    
                    // Update tranche cards with configured values if they exist
                    // This will be handled by the chart rendering below
                } catch (e) {
                    console.warn('Error updating tranche cards:', e);
                }
                
                // Waterfall allocation (stacked bar)
                createOrUpdateChart('waterfallAllocationChart', 'bar', {
                    labels: ['Senior Interest', 'Senior Principal', 'Mezz Interest', 'Mezz Principal', 'Equity Residual'],
                    datasets: [{
                        label: 'Cashflow Allocation (KES M)',
                        data: [114, 670, 17, 101, 119],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(34, 197, 94, 0.6)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(59, 130, 246, 0.6)',
                            'rgba(168, 85, 247, 0.7)'
                        ]
                    }]
                }, {
                    indexAxis: 'y',
                    scales: {
                        x: { stacked: false, title: { display: true, text: 'Cashflow (KES M)' } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                });
                
                // IRR distribution by tranche (box plot simulation using bar) - Dynamic based on state.tranches
                const trancheLabels = state.tranches.length > 0 
                    ? state.tranches.map(t => t.name || 'Tranche').concat(['Equity / Junior'])
                    : ['Senior (Class A)', 'Mezzanine (Class B)', 'Equity / Junior'];
                const trancheDataP5 = state.tranches.length > 0
                    ? state.tranches.map((t, i) => 18.1 + i * 0.5).concat([8.2])
                    : [18.1, 19.5, 8.2];
                const trancheDataP50 = state.tranches.length > 0
                    ? state.tranches.map((t, i) => 19.2 + i * 0.8).concat([12.5])
                    : [19.2, 20.8, 12.5];
                const trancheDataP95 = state.tranches.length > 0
                    ? state.tranches.map((t, i) => 20.5 + i * 1.0).concat([18.3])
                    : [20.5, 22.1, 18.3];
                
                createOrUpdateChart('trancheIRRChart', 'bar', {
                    labels: trancheLabels,
                    datasets: [
                        {
                            label: 'P5 (VaR)',
                            data: trancheDataP5,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)'
                        },
                        {
                            label: 'P50 (Median)',
                            data: trancheDataP50,
                            backgroundColor: 'rgba(251, 191, 36, 0.7)'
                        },
                        {
                            label: 'P95',
                            data: trancheDataP95,
                            backgroundColor: 'rgba(34, 197, 94, 0.7)'
                        }
                    ]
                }, {
                    scales: {
                        y: { title: { display: true, text: 'IRR (%)' } }
                    },
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                });
            }

            function setupRangeSlider(minSlider, maxSlider, minLabel, maxLabel, formatter) {
                minSlider.addEventListener('input', () => {
                    if (parseInt(minSlider.value) > parseInt(maxSlider.value)) {
                        minSlider.value = maxSlider.value;
                    }
                    minLabel.textContent = formatter(minSlider.value);
                });
                maxSlider.addEventListener('input', () => {
                     if (parseInt(maxSlider.value) < parseInt(minSlider.value)) {
                        maxSlider.value = minSlider.value;
                    }
                    maxLabel.textContent = formatter(maxSlider.value);
                });
            }

            setupRangeSlider(kiScoreMinSlider, kiScoreMaxSlider, kiScoreMinLabel, kiScoreMaxLabel, val => val);
            setupRangeSlider(loanAmountMinSlider, loanAmountMaxSlider, loanAmountMinLabel, loanAmountMaxLabel, val => `${val/1000}k`);
            setupRangeSlider(tenureMinSlider, tenureMaxSlider, tenureMinLabel, tenureMaxLabel, val => val);
            setupRangeSlider(interestRateMinSlider, interestRateMaxSlider, interestRateMinLabel, interestRateMaxLabel, val => `${val}%`);



            // --- DealTrack Initialization ---
            dealTrackNav.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    dealTrackNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    const pageId = e.target.dataset.trackView + 'Page';
                    const txId = transactionSelector.value;
                    updateDealTrackPage(pageId, txId);
                }
            });

            saveCovenantBtn.addEventListener('click', () => {
                const tx = state.transactions.find(t => t.id === state.currentTransactionId);
                if (tx) {
                    tx.covenantsSet = true;
                    if (!state.covenantData[tx.id]) {
                        initializeCovenantData();
                    }
                }
                renderActiveTransactions();
                updateMainView('dealScreen');
                showPage('dealScreenHomePage');
                updateHomeTab('transactions');
            });

            // --- Covenant Monitoring Logic ---
            function populateTransactionSelector(selectedTxId) {
                const selectors = [transactionSelector, perfTransactionSelector, impactTransactionSelector];
                selectors.forEach(selector => {
                    selector.innerHTML = '';
                    const eligibleTransactions = state.transactions.filter(t => t.covenantsSet);
                    eligibleTransactions.forEach(tx => {
                        const option = document.createElement('option');
                        option.value = tx.id;
                        option.textContent = tx.name;
                        selector.appendChild(option);
                    });
                     if (selectedTxId && eligibleTransactions.some(t => t.id === selectedTxId)) {
                        selector.value = selectedTxId;
                    }
                });
            }

            function renderCovenantMonitoringPage(txId) {
                const data = state.covenantData[txId];
                if (!data) {
                    covenantStatusTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">No covenant data available for this transaction.</td></tr>';
                    documentStatusTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">No document data available for this transaction.</td></tr>';
                    return;
                }

                const statusClasses = {
                    compliant: 'px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full',
                    submitted: 'px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full',
                    at_risk: 'px-2 py-1 font-semibold leading-tight text-orange-700 bg-orange-100 rounded-full',
                };

                covenantStatusTableBody.innerHTML = '';
                data.covenants.forEach(c => {
                    const row = `
                        <tr class="border-b">
                            <td class="px-4 py-2 font-medium text-gray-800">${c.name}</td>
                            <td class="px-4 py-2">${c.condition}</td>
                            <td class="px-4 py-2">${c.required}</td>
                            <td class="px-4 py-2">${c.actual}</td>
                            <td class="px-4 py-2"><span class="${statusClasses[c.status] || ''}">${c.status.replace('_', ' ')}</span></td>
                            <td class="px-4 py-2 text-center text-xl">${c.trend || ''}</td>
                        </tr>
                    `;
                    covenantStatusTableBody.innerHTML += row;
                });

                documentStatusTableBody.innerHTML = '';
                 data.documents.forEach(d => {
                    const row = `
                        <tr class="border-b">
                            <td class="px-4 py-2 font-medium text-gray-800">${d.name}</td>
                            <td class="px-4 py-2">${d.frequency}</td>
                            <td class="px-4 py-2">${d.nextDue}</td>
                            <td class="px-4 py-2"><span class="${statusClasses[d.status] || ''}">${d.status.replace('_', ' ')}</span></td>
                        </tr>
                    `;
                    documentStatusTableBody.innerHTML += row;
                });
                
                renderEWSChart('par90Chart', data.charts.par90, ewsPar90);
                renderEWSChart('collectionEffChart', data.charts.collectionEff, ewsCollectionEff);
                renderEWSChart('crarChart', data.charts.crar, ewsCrar);
                renderEWSChart('yieldChart', data.charts.yield, ewsYield);
            }

            function renderEWSChart(chartId, chartData, ewsElement) {
                const config = {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            {
                                label: 'Actuals',
                                data: chartData.actuals,
                                borderColor: '#0d9488',
                                backgroundColor: '#0d9488',
                                tension: 0.1,
                                borderWidth: 2
                            },
                            {
                                label: 'Estimates',
                                data: chartData.estimates,
                                borderColor: '#2563eb',
                                backgroundColor: '#2563eb',
                                borderDash: [5, 5],
                                tension: 0.1,
                                borderWidth: 2
                            },
                            {
                                label: 'Breach',
                                data: chartData.breachLine,
                                borderColor: '#ef4444',
                                backgroundColor: '#ef4444',
                                borderDash: [5, 5],
                                pointRadius: 0,
                                borderWidth: 1.5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'month', displayFormats: { month: 'MMM yy' } },
                                grid: { display: false }
                            },
                            y: { beginAtZero: false }
                        },
                        plugins: {
                            legend: { position: 'bottom', labels: { usePointStyle: true } },
                            tooltip: { mode: 'index', intersect: false }
                        }
                    }
                };
                createOrUpdateChart(chartId, config);

                if (chartData.predictedBreach) {
                    ewsElement.innerHTML = `
                        <span class="flex items-center text-red-600">
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                            BREACH PREDICTED
                        </span>`;
                } else {
                    ewsElement.innerHTML = `
                        <span class="flex items-center text-green-600">
                           <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                            STABLE
                        </span>`;
                }
            }
            
            function renderPerformancePage(txId) {
                try {
                    const performancePage = document.getElementById('performancePage');
                    if (!performancePage) {
                        console.warn('Performance page not found');
                        return;
                    }
                    
                    // Ensure page is visible
                    performancePage.classList.add('active');
                    
                    // Check if chart elements exist before rendering
                    if (document.getElementById('posByLoanPurposeChart')) {
                createOrUpdateChart('posByLoanPurposeChart', {
                    type: 'doughnut',
                    data: { labels: ['Boda-Boda', 'Agri-Finance', 'SME Capital', 'Other'], datasets: [{ data: [45, 25, 20, 10], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#0f766e'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
                    }
                    
                    if (document.getElementById('posByCountyChart')) {
                createOrUpdateChart('posByCountyChart', {
                    type: 'doughnut',
                    data: { labels: ['Nairobi', 'Mombasa', 'Kisumu', 'Nakuru', 'Other'], datasets: [{ data: [40, 22, 18, 12, 8], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#0f766e', '#99f6e4'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
                    }

                const barOptions = { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, title: { display: true, text: 'PAR 30+ (%)' } } } };
                    
                    if (document.getElementById('parByLoanPurposeChart')) {
                createOrUpdateChart('parByLoanPurposeChart', { type: 'bar', data: { labels: ['Boda-Boda', 'Agri-Finance', 'SME Capital', 'Other'], datasets: [{ data: [4.2, 3.1, 5.5, 6.8], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#ef4444'] }] }, options: barOptions });
                    }
                    if (document.getElementById('parByCountyChart')) {
                createOrUpdateChart('parByCountyChart', { type: 'bar', data: { labels: ['Nairobi', 'Mombasa', 'Kisumu', 'Nakuru', 'Other'], datasets: [{ data: [4.1, 4.5, 8.1, 3.9, 5.2], backgroundColor: ['#14b8a6', '#5eead4', '#ef4444', '#0d9488', '#0f766e'] }] }, options: barOptions });
                    }
                    if (document.getElementById('parByLoanCycleChart')) {
                createOrUpdateChart('parByLoanCycleChart', { type: 'bar', data: { labels: ['Cycle 1', 'Cycle 2', 'Cycle 3', 'Cycle 4+'], datasets: [{ data: [7.5, 4.1, 2.5, 1.8], backgroundColor: ['#ef4444', '#f97316', '#14b8a6', '#0d9488'] }] }, options: barOptions });
                    }
                    if (document.getElementById('parByKiScoreChart')) {
                createOrUpdateChart('parByKiScoreChart', { type: 'bar', data: { labels: ['> 60', '41-60', '21-40', '< 20'], datasets: [{ data: [9.2, 6.3, 3.1, 1.5], backgroundColor: ['#ef4444', '#f97316', '#14b8a6', '#0d9488'] }] }, options: barOptions });
                    }
                    if (document.getElementById('vintageAnalysisChart')) {
                createOrUpdateChart('vintageAnalysisChart', {
                    type: 'line',
                    data: {
                        labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
                        datasets: [
                            { label: 'Q3 2024', data: [0.5, 1.1, 1.8, 2.5, 3.0, 3.4, 3.7, 3.9, 4.1, 4.2, 4.3, 4.3], borderColor: '#06b6d4', tension: 0.1 },
                            { label: 'Q4 2024', data: [0.4, 0.9, 1.5, 2.1, 2.6, 3.0, 3.3, 3.5, 3.6, null, null, null], borderColor: '#14b8a6', tension: 0.1 },
                            { label: 'Q1 2025', data: [0.3, 0.8, 1.3, 1.9, 2.3, null, null, null, null, null, null, null], borderColor: '#84cc16', tension: 0.1 },
                            { label: 'Q2 2025', data: [0.2, 0.6, 1.1, null, null, null, null, null, null, null, null, null], borderColor: '#f97316', tension: 0.1 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: {
                            x: { title: { display: true, text: 'Months on Book' } },
                            y: { title: { display: true, text: 'PAR 90+ (%)' }, beginAtZero: true }
                        }
                    }
                });
                    }
                    
                    console.log('Performance page rendered for transaction:', txId);
                } catch (e) {
                    console.error('Error rendering performance page:', e);
                }
            }

            function renderImpactPage(txId) {
                try {
                    const impactPage = document.getElementById('impactPage');
                    if (!impactPage) {
                        console.warn('Impact page not found');
                        return;
                    }
                    
                    // Ensure page is visible
                    impactPage.classList.add('active');
                    
                    // Check if chart elements exist before rendering
                    if (document.getElementById('genderPerformanceChart')) {
                createOrUpdateChart('genderPerformanceChart', {
                    type: 'bar',
                    data: { labels: ['PAR 30+', 'Collection %'], datasets: [ { label: 'Female', data: [4.8, 98.5], backgroundColor: '#14b8a6' }, { label: 'Male', data: [5.3, 97.9], backgroundColor: '#0f766e' } ] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
                });
                    }
                    if (document.getElementById('sdgDoughnutChart')) {
                createOrUpdateChart('sdgDoughnutChart', {
                    type: 'doughnut',
                    data: { labels: ['No Poverty', 'Decent Work', 'Reduced Inequality'], datasets: [{ data: [48, 32, 20], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '60%' }
                });
                    }
                    if (document.getElementById('sectorDoughnutChart')) {
                createOrUpdateChart('sectorDoughnutChart', {
                    type: 'doughnut',
                    data: { labels: ['Retail', 'Transport', 'Agriculture', 'Services', 'Other'], datasets: [{ data: [35, 25, 20, 15, 5], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488', '#0f766e', '#99f6e4'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, cutout: '60%' }
                });
                    }
                    if (document.getElementById('ruralUrbanChart')) {
                createOrUpdateChart('ruralUrbanChart', {
                    type: 'bar',
                    data: { labels: ['Rural', 'Peri-Urban', 'Urban'], datasets: [{ label: 'Borrower Count', data: [5197, 2362, 1891], backgroundColor: ['#14b8a6', '#5eead4', '#0d9488'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
                    }
                    if (document.getElementById('borrowerProfileChart')) {
                 createOrUpdateChart('borrowerProfileChart', {
                    type: 'bar',
                    data: {
                        labels: ['First-Time Borrowers', 'Youth (<35)', 'Female Entrepreneurs'],
                        datasets: [{
                            label: 'Number of Borrowers',
                            data: [2835, 3780, 1850],
                            backgroundColor: ['#14b8a6', '#5eead4', '#0d9488']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
                });
            }
                    
                    console.log('Impact page rendered for transaction:', txId);
                } catch (e) {
                    console.error('Error rendering impact page:', e);
                }
            }

            // Mock loan-level data structure matching the provided schema
            function generateMockLoanData() {
                const counties = ['Nairobi', 'Mombasa', 'Kisumu', 'Nakuru', 'Eldoret', 'Thika', 'Machakos', 'Meru'];
                const wards = ['Ward A', 'Ward B', 'Ward C', 'Ward D', 'Ward E'];
                const genders = ['MALE', 'FEMALE'];
                const bundleChoices = ['Open Store', 'Full Bundle', 'Planting Bundle'];
                const liabilityBuckets = ['<20K', '20K-39K', '40K-59K', '60K-79K', '80K-99K', '100K+'];
                const isRenewalOptions = [true, false];
                
                const loans = [];
                const currentDate = new Date();
                
                for (let i = 0; i < 12450; i++) {
                    const disbursedDate = new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1);
                    const tenure = Math.floor(Math.random() * 18) + 6; // 6-24 months
                    const deadlineDate = new Date(disbursedDate);
                    deadlineDate.setMonth(deadlineDate.getMonth() + tenure);
                    
                    const monthlyProjected = 5000 + Math.random() * 45000;
                    const projectedCashflow = [];
                    const actualCashflow = [];
                    
                    // Generate monthly cashflows
                    for (let month = 0; month < tenure; month++) {
                        const projected = monthlyProjected;
                        projectedCashflow.push(projected);
                        
                        // Actual with variations (some over-collection, some shortfall)
                        let actual = projected;
                        const rand = Math.random();
                        if (rand < 0.05) {
                            // Over-collection (5% of loans)
                            actual = projected * (1.05 + Math.random() * 0.15);
                        } else if (rand < 0.15) {
                            // Partial payment (10% of loans)
                            actual = projected * (0.3 + Math.random() * 0.5);
                        } else if (rand < 0.20) {
                            // Default (5% of loans)
                            actual = 0;
                        } else {
                            // Normal payment (80% of loans)
                            actual = projected * (0.95 + Math.random() * 0.1);
                        }
                        actualCashflow.push(actual);
                    }
                    
                    const disbursedMonth = `${disbursedDate.getFullYear()}-${String(disbursedDate.getMonth() + 1).padStart(2, '0')}`;
                    const liability = 15000 + Math.random() * 100000;
                    let liabilityBucket = '<20K';
                    if (liability >= 100000) liabilityBucket = '100K+';
                    else if (liability >= 80000) liabilityBucket = '80K-99K';
                    else if (liability >= 60000) liabilityBucket = '60K-79K';
                    else if (liability >= 40000) liabilityBucket = '40K-59K';
                    else if (liability >= 20000) liabilityBucket = '20K-39K';
                    
                    loans.push({
                        LOAN_APPLICATION_ID: `LOAN-${String(i + 1).padStart(6, '0')}`,
                        FARMER_ID: `FARMER-${String(Math.floor(Math.random() * 5000) + 1).padStart(6, '0')}`,
                        FARMERS_GENDER: genders[Math.floor(Math.random() * genders.length)],
                        WARD: wards[Math.floor(Math.random() * wards.length)],
                        COUNTY: counties[Math.floor(Math.random() * counties.length)],
                        IS_RENEWAL: isRenewalOptions[Math.floor(Math.random() * isRenewalOptions.length)],
                        LOAN_DISBURSED_AT: disbursedDate.toISOString(),
                        'Disbursed month': disbursedMonth,
                        DISBURSED_LIABILITY: liability,
                        Disbursed_Liability_Bucket: liabilityBucket,
                        TENURE: tenure,
                        DEADLINE_DATE: deadlineDate.toISOString(),
                        BUNDLE_CHOICE: bundleChoices[Math.floor(Math.random() * bundleChoices.length)],
                        projectedCashflow: projectedCashflow,
                        actualCashflow: actualCashflow
                    });
                }
                
                return loans;
            }

            // Calculation functions
            function calculateCollectionEfficiency(actual, projected, adjusted = false) {
                if (!projected || projected === 0) return 0;
                const efficiency = (actual / projected) * 100;
                if (adjusted) {
                    return Math.min(efficiency, 100); // Cap at 100%
                }
                return efficiency; // Can exceed 100% for over-collection
            }

            function calculateShortfall(actual, projected) {
                if (!projected || projected === 0) return 0;
                return ((projected - actual) / projected) * 100; // Positive = shortfall, negative = over-collection
            }

            function calculateCumulativeMetrics(monthlyData, adjusted = false) {
                let totalProjected = 0;
                let totalActual = 0;
                
                monthlyData.forEach(month => {
                    totalProjected += month.projected || 0;
                    totalActual += month.actual || 0;
                });
                
                return {
                    collectionEfficiency: calculateCollectionEfficiency(totalActual, totalProjected, adjusted),
                    shortfall: calculateShortfall(totalActual, totalProjected)
                };
            }

            function groupByMaturityCohort(loans, currentDate) {
                const cohorts = {
                    '0-3 months': [],
                    '3-6 months': [],
                    '6-12 months': [],
                    '12+ months': []
                };
                
                loans.forEach(loan => {
                    const deadlineDate = new Date(loan.DEADLINE_DATE);
                    const monthsRemaining = Math.ceil((deadlineDate - currentDate) / (1000 * 60 * 60 * 24 * 30));
                    
                    if (monthsRemaining <= 3) {
                        cohorts['0-3 months'].push(loan);
                    } else if (monthsRemaining <= 6) {
                        cohorts['3-6 months'].push(loan);
                    } else if (monthsRemaining <= 12) {
                        cohorts['6-12 months'].push(loan);
                    } else {
                        cohorts['12+ months'].push(loan);
                    }
                });
                
                return cohorts;
            }

            function groupByOriginationCohort(loans) {
                const cohorts = {};
                loans.forEach(loan => {
                    const disbursedDate = new Date(loan.LOAN_DISBURSED_AT);
                    const year = disbursedDate.getFullYear();
                    const quarter = Math.floor(disbursedDate.getMonth() / 3) + 1;
                    const quarterKey = `Q${quarter} ${year}`;
                    if (!cohorts[quarterKey]) {
                        cohorts[quarterKey] = [];
                    }
                    cohorts[quarterKey].push(loan);
                });
                return cohorts;
            }

            function calculateRiskMetricsByDimension(loans, dimension, currentMonthIndex = null, adjusted = false, cumulative = false) {
                const groups = {};
                
                loans.forEach(loan => {
                    const key = loan[dimension];
                    if (!groups[key]) {
                        groups[key] = [];
                    }
                    groups[key].push(loan);
                });
                
                const metrics = {};
                Object.keys(groups).forEach(key => {
                    const groupLoans = groups[key];
                    let totalProjected = 0;
                    let totalActual = 0;
                    
                    groupLoans.forEach(loan => {
                        if (cumulative) {
                            // Sum all months up to current
                            loan.projectedCashflow.forEach((proj, idx) => {
                                if (currentMonthIndex === null || idx <= currentMonthIndex) {
                                    totalProjected += proj;
                                    totalActual += loan.actualCashflow[idx] || 0;
                                }
                            });
                        } else {
                            // Only current month
                            const monthIdx = currentMonthIndex !== null ? currentMonthIndex : loan.projectedCashflow.length - 1;
                            if (monthIdx < loan.projectedCashflow.length) {
                                totalProjected += loan.projectedCashflow[monthIdx] || 0;
                                totalActual += loan.actualCashflow[monthIdx] || 0;
                            }
                        }
                    });
                    
                    metrics[key] = {
                        collectionEfficiency: calculateCollectionEfficiency(totalActual, totalProjected, adjusted),
                        shortfall: calculateShortfall(totalActual, totalProjected),
                        loanCount: groupLoans.length,
                        aum: totalProjected
                    };
                });
                
                return metrics;
            }

            function renderReportsPage(txId) {
                // Populate transaction selector for reports
                const reportsSelector = document.getElementById('reportsTransactionSelector');
                if (reportsSelector) {
                    reportsSelector.innerHTML = '';
                    state.transactions.filter(t => t.covenantsSet).forEach(tx => {
                        const option = document.createElement('option');
                        option.value = tx.id;
                        option.textContent = tx.name;
                        option.selected = tx.id === txId;
                        reportsSelector.appendChild(option);
                    });
                }

                // Generate mock loan data
                const mockLoans = generateMockLoanData();
                const currentDate = new Date();
                const currentMonthIndex = 14; // Assuming we're at month 14

                // Calculate aggregate metrics
                let totalProjectedCurrent = 0;
                let totalActualCurrent = 0;
                let totalProjectedCumulative = 0;
                let totalActualCumulative = 0;

                mockLoans.forEach(loan => {
                    // Current month
                    if (loan.projectedCashflow.length > currentMonthIndex) {
                        totalProjectedCurrent += loan.projectedCashflow[currentMonthIndex] || 0;
                        totalActualCurrent += loan.actualCashflow[currentMonthIndex] || 0;
                    }
                    // Cumulative
                    loan.projectedCashflow.forEach((proj, idx) => {
                        if (idx <= currentMonthIndex) {
                            totalProjectedCumulative += proj;
                            totalActualCumulative += loan.actualCashflow[idx] || 0;
                        }
                    });
                });

                const currentMonthCE = calculateCollectionEfficiency(totalActualCurrent, totalProjectedCurrent, false);
                const currentMonthCEAdjusted = calculateCollectionEfficiency(totalActualCurrent, totalProjectedCurrent, true);
                const cumulativeCE = calculateCollectionEfficiency(totalActualCumulative, totalProjectedCumulative, false);
                const cumulativeCEAdjusted = calculateCollectionEfficiency(totalActualCumulative, totalProjectedCumulative, true);
                const currentMonthShortfall = calculateShortfall(totalActualCurrent, totalProjectedCurrent);
                const cumulativeShortfall = calculateShortfall(totalActualCumulative, totalProjectedCumulative);

                // Update key metrics
                document.getElementById('reportPoolSize').textContent = 'KES 475.87M';
                document.getElementById('reportTotalLoans').textContent = '12,450';
                document.getElementById('reportCurrentMonthCEUnadjusted').textContent = currentMonthCE.toFixed(1) + '%';
                document.getElementById('reportCurrentMonthCEAdjusted').textContent = currentMonthCEAdjusted.toFixed(1) + '%';
                document.getElementById('reportCumulativeCEUnadjusted').textContent = cumulativeCE.toFixed(1) + '%';
                document.getElementById('reportCumulativeCEAdjusted').textContent = cumulativeCEAdjusted.toFixed(1) + '%';

                // Generate monthly collection efficiency data for trend charts
                const monthlyLabels = [];
                const monthlyCEUnadjusted = [];
                const monthlyCEAdjusted = [];
                const monthlyCECumulativeUnadjusted = [];
                const monthlyCECumulativeAdjusted = [];

                for (let month = 0; month <= currentMonthIndex && month < 12; month++) {
                    monthlyLabels.push(['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][month] || `Month ${month + 1}`);
                    
                    let monthProjected = 0;
                    let monthActual = 0;
                    let cumProjected = 0;
                    let cumActual = 0;

                    mockLoans.forEach(loan => {
                        if (loan.projectedCashflow.length > month) {
                            monthProjected += loan.projectedCashflow[month] || 0;
                            monthActual += loan.actualCashflow[month] || 0;
                        }
                        for (let i = 0; i <= month && i < loan.projectedCashflow.length; i++) {
                            cumProjected += loan.projectedCashflow[i] || 0;
                            cumActual += loan.actualCashflow[i] || 0;
                        }
                    });

                    monthlyCEUnadjusted.push(calculateCollectionEfficiency(monthActual, monthProjected, false));
                    monthlyCEAdjusted.push(calculateCollectionEfficiency(monthActual, monthProjected, true));
                    monthlyCECumulativeUnadjusted.push(calculateCollectionEfficiency(cumActual, cumProjected, false));
                    monthlyCECumulativeAdjusted.push(calculateCollectionEfficiency(cumActual, cumProjected, true));
                }

                // Collection Efficiency Trend (Unadjusted)
                const viewToggle = document.getElementById('collectionEfficiencyViewToggle')?.value || 'both';
                const unadjustedDatasets = [];
                if (viewToggle === 'current' || viewToggle === 'both') {
                    unadjustedDatasets.push({
                        label: 'Current Month Collection Efficiency %',
                        data: monthlyCEUnadjusted,
                        borderColor: '#14b8a6',
                        backgroundColor: 'rgba(20, 184, 166, 0.1)',
                        fill: true,
                        tension: 0.4
                    });
                }
                if (viewToggle === 'cumulative' || viewToggle === 'both') {
                    unadjustedDatasets.push({
                        label: 'Cumulative Collection Efficiency %',
                        data: monthlyCECumulativeUnadjusted,
                        borderColor: '#0d9488',
                        backgroundColor: 'rgba(13, 148, 136, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderDash: [5, 5]
                    });
                }

                createOrUpdateChart('reportCollectionChart', {
                    type: 'line',
                    data: {
                        labels: monthlyLabels,
                        datasets: unadjustedDatasets
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: true, position: 'bottom' } }, 
                        scales: { y: { beginAtZero: false, min: 80, max: 105 } } 
                    }
                });

                // Collection Efficiency Trend (Adjusted)
                const adjustedViewToggle = document.getElementById('adjustedCollectionEfficiencyViewToggle')?.value || 'both';
                const adjustedDatasets = [];
                if (adjustedViewToggle === 'current' || adjustedViewToggle === 'both') {
                    adjustedDatasets.push({
                        label: 'Current Month Collection Efficiency % (Adjusted)',
                        data: monthlyCEAdjusted,
                        borderColor: '#14b8a6',
                        backgroundColor: 'rgba(20, 184, 166, 0.1)',
                        fill: true,
                        tension: 0.4
                    });
                }
                if (adjustedViewToggle === 'cumulative' || adjustedViewToggle === 'both') {
                    adjustedDatasets.push({
                        label: 'Cumulative Collection Efficiency % (Adjusted)',
                        data: monthlyCECumulativeAdjusted,
                        borderColor: '#0d9488',
                        backgroundColor: 'rgba(13, 148, 136, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderDash: [5, 5]
                    });
                }

                createOrUpdateChart('reportAdjustedCollectionChart', {
                    type: 'line',
                    data: {
                        labels: monthlyLabels,
                        datasets: adjustedDatasets
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: true, position: 'bottom' } }, 
                        scales: { y: { beginAtZero: false, min: 80, max: 105 } } 
                    }
                });

                // Cash Flow Waterfall (Total Cashflow - No Principal/Interest Split)
                createOrUpdateChart('reportWaterfallChart', {
                    type: 'bar',
                    data: {
                        labels: ['Inflows', 'Senior Fees', 'Total Cashflow Paid', 'Reserve Top-up', 'Residual'],
                        datasets: [{
                            label: 'Amount (KES M)',
                            data: [44.8, -2.5, -4.26, -0.5, 3.2],
                            backgroundColor: ['#14b8a6', '#9CA3AF', '#3B82F6', '#F59E0B', '#10B981']
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { display: false },
                            title: { display: true, text: 'Simplified Waterfall - Total Cashflow (See Tranche chart for detailed breakdown)' }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: 'KES Millions' }
                            }
                        }
                    }
                });

                // Shortfall Bucket Distribution
                const shortfallView = document.getElementById('shortfallViewToggle')?.value || 'current';
                const shortfallBuckets = { '0-5%': 0, '5-20%': 0, '20-40%': 0, '40%+': 0 };
                
                mockLoans.forEach(loan => {
                    let shortfall = 0;
                    if (shortfallView === 'cumulative') {
                        let cumProjected = 0;
                        let cumActual = 0;
                        loan.projectedCashflow.forEach((proj, idx) => {
                            if (idx <= currentMonthIndex) {
                                cumProjected += proj;
                                cumActual += loan.actualCashflow[idx] || 0;
                            }
                        });
                        shortfall = calculateShortfall(cumActual, cumProjected);
                    } else {
                        if (loan.projectedCashflow.length > currentMonthIndex) {
                            shortfall = calculateShortfall(loan.actualCashflow[currentMonthIndex] || 0, loan.projectedCashflow[currentMonthIndex] || 0);
                        }
                    }
                    
                    if (shortfall <= 5) {
                        shortfallBuckets['0-5%']++;
                    } else if (shortfall <= 20) {
                        shortfallBuckets['5-20%']++;
                    } else if (shortfall <= 40) {
                        shortfallBuckets['20-40%']++;
                    } else {
                        shortfallBuckets['40%+']++;
                    }
                });

                createOrUpdateChart('reportShortfallChart', {
                    type: 'bar',
                    data: {
                        labels: ['0-5%', '5-20%', '20-40%', '40%+'],
                        datasets: [{
                            label: 'Number of Loans',
                            data: [shortfallBuckets['0-5%'], shortfallBuckets['5-20%'], shortfallBuckets['20-40%'], shortfallBuckets['40%+']],
                            backgroundColor: ['#10b981', '#f59e0b', '#fb923c', '#ef4444']
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { display: false },
                            title: { display: true, text: `Shortfall Distribution (${shortfallView === 'cumulative' ? 'Cumulative' : 'Current Month'})` }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: 'Number of Loans' }
                            }
                        }
                    }
                });

                // Portfolio Composition by Bundle Choice (AUM, AUM%, Collection Efficiency)
                const compositionAdjusted = document.getElementById('compositionAdjustedToggle')?.value === 'true';
                const bundleMetrics = calculateRiskMetricsByDimension(mockLoans, 'BUNDLE_CHOICE', currentMonthIndex, compositionAdjusted, false);
                const bundleLabels = Object.keys(bundleMetrics);
                const totalAUM = Object.values(bundleMetrics).reduce((sum, m) => sum + m.aum, 0);
                const bundleAUM = bundleLabels.map(label => bundleMetrics[label].aum / 1000000); // Convert to millions
                const bundleAUMPercent = bundleLabels.map(label => (bundleMetrics[label].aum / totalAUM) * 100);
                const bundleCE = bundleLabels.map(label => bundleMetrics[label].collectionEfficiency);

                createOrUpdateChart('reportCompositionChart', {
                    type: 'bar',
                    data: {
                        labels: bundleLabels,
                        datasets: [
                            {
                                label: 'AUM (KES M)',
                                data: bundleAUM,
                                backgroundColor: '#14b8a6',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'AUM (%)',
                                data: bundleAUMPercent,
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'Collection Efficiency (%)',
                                data: bundleCE,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                yAxisID: 'y1',
                                type: 'line',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { display: true, position: 'bottom' },
                            title: { display: true, text: 'Portfolio by Bundle Choice: AUM, AUM %, and Collection Efficiency' }
                        },
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'AUM (KES M) / AUM (%)' }, beginAtZero: true },
                            y1: { position: 'right', title: { display: true, text: 'Collection Efficiency (%)' }, grid: { drawOnChartArea: false }, beginAtZero: false, min: 80, max: 105 }
                        }
                    }
                });

                // Geographic Concentration (AUM, AUM%, Collection Efficiency)
                const geoAdjusted = document.getElementById('geoAdjustedToggle')?.value === 'true';
                const geoMetrics = calculateRiskMetricsByDimension(mockLoans, 'COUNTY', currentMonthIndex, geoAdjusted, false);
                const geoLabels = Object.keys(geoMetrics).slice(0, 7); // Top 7 counties
                const totalGeoAUM = Object.values(geoMetrics).reduce((sum, m) => sum + m.aum, 0);
                const geoAUM = geoLabels.map(label => geoMetrics[label].aum / 1000000);
                const geoAUMPercent = geoLabels.map(label => (geoMetrics[label].aum / totalGeoAUM) * 100);
                const geoCE = geoLabels.map(label => geoMetrics[label].collectionEfficiency);

                createOrUpdateChart('reportGeoChart', {
                    type: 'bar',
                    data: {
                        labels: geoLabels,
                        datasets: [
                            {
                                label: 'AUM (KES M)',
                                data: geoAUM,
                                backgroundColor: '#14b8a6',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'AUM (%)',
                                data: geoAUMPercent,
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'Collection Efficiency (%)',
                                data: geoCE,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                yAxisID: 'y1',
                                type: 'line',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: true, position: 'bottom' } },
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'AUM (KES M) / AUM (%)' }, beginAtZero: true },
                            y1: { position: 'right', title: { display: true, text: 'Collection Efficiency (%)' }, grid: { drawOnChartArea: false }, beginAtZero: false, min: 80, max: 105 }
                        }
                    }
                });

                // Origination Cohort Analysis (Quarterly)
                const vintageView = document.getElementById('vintageViewToggle')?.value || 'current';
                const vintageAdjusted = document.getElementById('vintageAdjustedToggle')?.value === 'true';
                const originationCohorts = groupByOriginationCohort(mockLoans);
                const cohortQuarters = Object.keys(originationCohorts).sort().slice(-6); // Last 6 quarters
                
                const cohortAUM = [];
                const cohortAUMPercent = [];
                const cohortCE = [];
                const totalCohortAUM = Object.values(originationCohorts).reduce((sum, loans) => {
                    return sum + loans.reduce((loanSum, loan) => {
                        if (vintageView === 'cumulative') {
                            return loanSum + loan.projectedCashflow.slice(0, currentMonthIndex + 1).reduce((a, b) => a + b, 0);
                        } else {
                            return loanSum + (loan.projectedCashflow[currentMonthIndex] || 0);
                        }
                    }, 0);
                }, 0);
                
                cohortQuarters.forEach(quarter => {
                    const cohortLoans = originationCohorts[quarter];
                    let totalProjected = 0;
                    let totalActual = 0;
                    let cohortTotalAUM = 0;
                    
                    cohortLoans.forEach(loan => {
                        if (vintageView === 'cumulative') {
                            loan.projectedCashflow.forEach((proj, idx) => {
                                if (idx <= currentMonthIndex) {
                                    totalProjected += proj;
                                    totalActual += loan.actualCashflow[idx] || 0;
                                    cohortTotalAUM += proj;
                                }
                            });
                        } else {
                            if (loan.projectedCashflow.length > currentMonthIndex) {
                                totalProjected += loan.projectedCashflow[currentMonthIndex] || 0;
                                totalActual += loan.actualCashflow[currentMonthIndex] || 0;
                                cohortTotalAUM += loan.projectedCashflow[currentMonthIndex] || 0;
                            }
                        }
                    });
                    
                    cohortAUM.push(cohortTotalAUM / 1000000); // Convert to millions
                    cohortAUMPercent.push((cohortTotalAUM / totalCohortAUM) * 100);
                    cohortCE.push(calculateCollectionEfficiency(totalActual, totalProjected, vintageAdjusted));
                });

                createOrUpdateChart('reportVintageChart', {
                    type: 'bar',
                    data: {
                        labels: cohortQuarters,
                        datasets: [
                            {
                                label: 'AUM (KES M)',
                                data: cohortAUM,
                                backgroundColor: '#14b8a6',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'AUM (%)',
                                data: cohortAUMPercent,
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'Collection Efficiency (%)',
                                data: cohortCE,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                yAxisID: 'y1',
                                type: 'line',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { display: true, position: 'bottom' },
                            title: { display: true, text: `Origination Cohort Analysis (Quarterly) - ${vintageView === 'cumulative' ? 'Cumulative' : 'Current Month'}` }
                        },
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'AUM (KES M) / AUM (%)' }, beginAtZero: true },
                            y1: { position: 'right', title: { display: true, text: 'Collection Efficiency (%)' }, grid: { drawOnChartArea: false }, beginAtZero: false, min: 80, max: 105 }
                        }
                    }
                });

                // Maturity Cohort Analysis (AUM, AUM%, Collection Efficiency)
                const maturityView = document.getElementById('maturityViewToggle')?.value || 'current';
                const maturityAdjusted = document.getElementById('maturityAdjustedToggle')?.value === 'true';
                const maturityCohorts = groupByMaturityCohort(mockLoans, currentDate);
                const maturityLabels = Object.keys(maturityCohorts);
                
                const maturityAUM = [];
                const maturityAUMPercent = [];
                const maturityCE = [];
                const totalMaturityAUM = Object.values(maturityCohorts).reduce((sum, loans) => {
                    return sum + loans.reduce((loanSum, loan) => {
                        if (maturityView === 'cumulative') {
                            return loanSum + loan.projectedCashflow.slice(0, currentMonthIndex + 1).reduce((a, b) => a + b, 0);
                        } else {
                            return loanSum + (loan.projectedCashflow[currentMonthIndex] || 0);
                        }
                    }, 0);
                }, 0);
                
                maturityLabels.forEach(cohort => {
                    const cohortLoans = maturityCohorts[cohort];
                    let totalProjected = 0;
                    let totalActual = 0;
                    let cohortTotalAUM = 0;
                    
                    cohortLoans.forEach(loan => {
                        if (maturityView === 'cumulative') {
                            loan.projectedCashflow.forEach((proj, idx) => {
                                if (idx <= currentMonthIndex) {
                                    totalProjected += proj;
                                    totalActual += loan.actualCashflow[idx] || 0;
                                    cohortTotalAUM += proj;
                                }
                            });
                        } else {
                            if (loan.projectedCashflow.length > currentMonthIndex) {
                                totalProjected += loan.projectedCashflow[currentMonthIndex] || 0;
                                totalActual += loan.actualCashflow[currentMonthIndex] || 0;
                                cohortTotalAUM += loan.projectedCashflow[currentMonthIndex] || 0;
                            }
                        }
                    });
                    
                    maturityAUM.push(cohortTotalAUM / 1000000); // Convert to millions
                    maturityAUMPercent.push((cohortTotalAUM / totalMaturityAUM) * 100);
                    maturityCE.push(calculateCollectionEfficiency(totalActual, totalProjected, maturityAdjusted));
                });

                createOrUpdateChart('reportMaturityCohortChart', {
                    type: 'bar',
                    data: {
                        labels: maturityLabels,
                        datasets: [
                            {
                                label: 'AUM (KES M)',
                                data: maturityAUM,
                                backgroundColor: '#14b8a6',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'AUM (%)',
                                data: maturityAUMPercent,
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'Collection Efficiency (%)',
                                data: maturityCE,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                yAxisID: 'y1',
                                type: 'line',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { display: true, position: 'bottom' },
                            title: { display: true, text: `Maturity Cohort Analysis - ${maturityView === 'cumulative' ? 'Cumulative' : 'Current Month'}` }
                        },
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'AUM (KES M) / AUM (%)' }, beginAtZero: true },
                            y1: { position: 'right', title: { display: true, text: 'Collection Efficiency (%)' }, grid: { drawOnChartArea: false }, beginAtZero: false, min: 80, max: 105 }
                        }
                    }
                });

                // Risk by Gender (AUM, AUM%, Collection Efficiency)
                const genderMetrics = calculateRiskMetricsByDimension(mockLoans, 'FARMERS_GENDER', currentMonthIndex, false, false);
                const genderLabels = Object.keys(genderMetrics);
                const totalGenderAUM = Object.values(genderMetrics).reduce((sum, m) => sum + m.aum, 0);
                const genderAUM = genderLabels.map(label => genderMetrics[label].aum / 1000000);
                const genderAUMPercent = genderLabels.map(label => (genderMetrics[label].aum / totalGenderAUM) * 100);
                const genderCE = genderLabels.map(label => genderMetrics[label].collectionEfficiency);

                createOrUpdateChart('reportGenderChart', {
                    type: 'bar',
                    data: {
                        labels: genderLabels,
                        datasets: [
                            {
                                label: 'AUM (KES M)',
                                data: genderAUM,
                                backgroundColor: '#14b8a6',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'AUM (%)',
                                data: genderAUMPercent,
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'Collection Efficiency (%)',
                                data: genderCE,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                yAxisID: 'y1',
                                type: 'line',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: true, position: 'bottom' } },
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'AUM (KES M) / AUM (%)' }, beginAtZero: true },
                            y1: { position: 'right', title: { display: true, text: 'Collection Efficiency (%)' }, grid: { drawOnChartArea: false }, beginAtZero: false, min: 80, max: 105 }
                        }
                    }
                });

                // Risk by Liability Bucket (AUM, AUM%, Collection Efficiency)
                const liabilityMetrics = calculateRiskMetricsByDimension(mockLoans, 'Disbursed_Liability_Bucket', currentMonthIndex, false, false);
                const liabilityLabels = ['<20K', '20K-39K', '40K-59K', '60K-79K', '80K-99K', '100K+'];
                const totalLiabilityAUM = liabilityLabels.reduce((sum, label) => sum + (liabilityMetrics[label]?.aum || 0), 0);
                const liabilityAUM = liabilityLabels.map(label => (liabilityMetrics[label]?.aum || 0) / 1000000);
                const liabilityAUMPercent = liabilityLabels.map(label => ((liabilityMetrics[label]?.aum || 0) / totalLiabilityAUM) * 100);
                const liabilityCE = liabilityLabels.map(label => liabilityMetrics[label]?.collectionEfficiency || 0);

                createOrUpdateChart('reportLiabilityBucketChart', {
                    type: 'bar',
                    data: {
                        labels: liabilityLabels,
                        datasets: [
                            {
                                label: 'AUM (KES M)',
                                data: liabilityAUM,
                                backgroundColor: '#14b8a6',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'AUM (%)',
                                data: liabilityAUMPercent,
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'Collection Efficiency (%)',
                                data: liabilityCE,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                yAxisID: 'y1',
                                type: 'line',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: true, position: 'bottom' } },
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'AUM (KES M) / AUM (%)' }, beginAtZero: true },
                            y1: { position: 'right', title: { display: true, text: 'Collection Efficiency (%)' }, grid: { drawOnChartArea: false }, beginAtZero: false, min: 80, max: 105 }
                        }
                    }
                });

                // Risk by Renewal Status (AUM, AUM%, Collection Efficiency)
                const renewalMetrics = calculateRiskMetricsByDimension(mockLoans, 'IS_RENEWAL', currentMonthIndex, false, false);
                const renewalKeys = Object.keys(renewalMetrics);
                const renewalLabels = renewalKeys.map(k => k === 'true' ? 'Renewal' : 'New');
                const totalRenewalAUM = Object.values(renewalMetrics).reduce((sum, m) => sum + m.aum, 0);
                const renewalAUM = renewalKeys.map(key => renewalMetrics[key].aum / 1000000);
                const renewalAUMPercent = renewalKeys.map(key => (renewalMetrics[key].aum / totalRenewalAUM) * 100);
                const renewalCE = renewalKeys.map(key => renewalMetrics[key].collectionEfficiency);

                createOrUpdateChart('reportRenewalChart', {
                    type: 'bar',
                    data: {
                        labels: renewalLabels,
                        datasets: [
                            {
                                label: 'AUM (KES M)',
                                data: renewalAUM,
                                backgroundColor: '#14b8a6',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'AUM (%)',
                                data: renewalAUMPercent,
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                yAxisID: 'y',
                                type: 'bar'
                            },
                            {
                                label: 'Collection Efficiency (%)',
                                data: renewalCE,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                yAxisID: 'y1',
                                type: 'line',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: true, position: 'bottom' } },
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'AUM (KES M) / AUM (%)' }, beginAtZero: true },
                            y1: { position: 'right', title: { display: true, text: 'Collection Efficiency (%)' }, grid: { drawOnChartArea: false }, beginAtZero: false, min: 80, max: 105 }
                        }
                    }
                });

                // Collections Comparison: Actual vs Day 0 Projections
                createOrUpdateChart('reportCollectionsComparisonChart', {
                    type: 'bar',
                    data: {
                        labels: ['Month 1', 'Month 3', 'Month 6', 'Month 9', 'Month 12', 'Month 14 (Current)'],
                        datasets: [
                            {
                                label: 'Day 0 Projected',
                                data: [20.5, 21.0, 21.5, 21.8, 22.0, 22.3],
                                backgroundColor: 'rgba(156, 163, 175, 0.5)',
                                borderColor: '#9CA3AF',
                                borderWidth: 1
                            },
                            {
                                label: 'Actual Collections',
                                data: [20.8, 21.2, 21.7, 21.5, 21.0, 21.2],
                                backgroundColor: 'rgba(20, 184, 166, 0.7)',
                                borderColor: '#14b8a6',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 19,
                                max: 24,
                                title: { display: true, text: 'Collections (KES M)' }
                            }
                        }
                    }
                });

                // Available Credit Enhancement Over Time (Time Series)
                // OC: 20% of Pool (KES 95.17M), JLF: 12% of Pool (KES 57.10M) = Total 32%
                // As utilized, available amounts decrease
                const ceTimeLabels = ['Day 0', 'Month 3', 'Month 6', 'Month 9', 'Month 12', 'Month 14 (Current)'];
                const initialOC = 20.0; // 20% of pool
                const initialJLF = 12.0; // 12% of pool
                
                // Simulate utilization over time (available decreases as utilized)
                const availableOC = [initialOC, 19.8, 19.5, 19.2, 19.0, 18.8];
                const availableJLF = [initialJLF, 12.0, 12.0, 11.9, 11.8, 11.7];
                const availableTotal = availableOC.map((oc, idx) => oc + availableJLF[idx]);
                
                createOrUpdateChart('reportAvailableCEChart', {
                    type: 'line',
                    data: {
                        labels: ceTimeLabels,
                        datasets: [
                            {
                                label: 'Total Available CE (%)',
                                data: availableTotal,
                                borderColor: '#14b8a6',
                                backgroundColor: 'rgba(20, 184, 166, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Available Overcollateralization (%)',
                                data: availableOC,
                                borderColor: '#22c55e',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'Available Junior Liquidity Facility (%)',
                                data: availableJLF,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { 
                                display: true, 
                                text: 'Available Credit Enhancement Decreasing as Utilized Over Time'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 0,
                                max: 35,
                                title: { display: true, text: 'Available Credit Enhancement (%)' }
                            },
                            x: {
                                title: { display: true, text: 'Time Period' }
                            }
                        }
                    }
                });

                // Tranche Cashflow Comparison Charts (Cumulative)
                // Senior Tranche: KES 286.51M @ 14% XIRR
                // Mezzanine Tranche: KES 75.00M @ 14.5% XIRR
                const trancheTimeLabels = ['Month 1', 'Month 3', 'Month 6', 'Month 9', 'Month 12', 'Month 14 (Current)'];
                
                // Senior Tranche cumulative cashflow
                const seniorProjectedCumulative = [3.2, 9.6, 19.2, 28.8, 38.4, 44.8];
                const seniorActualCumulative = [3.15, 9.5, 19.0, 28.5, 38.0, 44.2];
                
                createOrUpdateChart('reportSeniorTrancheCashflowChart', {
                    type: 'line',
                    data: {
                        labels: trancheTimeLabels,
                        datasets: [
                            {
                                label: 'Projected Cumulative Cashflow (KES M)',
                                data: seniorProjectedCumulative,
                                borderColor: '#9CA3AF',
                                backgroundColor: 'rgba(156, 163, 175, 0.1)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'Actual Cumulative Cashflow (KES M)',
                                data: seniorActualCumulative,
                                borderColor: '#3B82F6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Cumulative Cashflow (KES M)' }
                            },
                            x: {
                                title: { display: true, text: 'Time Period' }
                            }
                        }
                    }
                });

                // Mezzanine Tranche cumulative cashflow
                const mezzProjectedCumulative = [0.84, 2.52, 5.04, 7.56, 10.08, 11.76];
                const mezzActualCumulative = [0.82, 2.48, 4.95, 7.42, 9.88, 11.52];
                
                createOrUpdateChart('reportMezzanineTrancheCashflowChart', {
                    type: 'line',
                    data: {
                        labels: trancheTimeLabels,
                        datasets: [
                            {
                                label: 'Projected Cumulative Cashflow (KES M)',
                                data: mezzProjectedCumulative,
                                borderColor: '#9CA3AF',
                                backgroundColor: 'rgba(156, 163, 175, 0.1)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'Actual Cumulative Cashflow (KES M)',
                                data: mezzActualCumulative,
                                borderColor: '#8B5CF6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Cumulative Cashflow (KES M)' }
                            },
                            x: {
                                title: { display: true, text: 'Time Period' }
                            }
                        }
                    }
                });


                // Tranche-Level Payments Chart (Total Cashflow - No Principal/Interest Split)
                // Based on ki platform PCC Series 1: Apollo Agriculture
                // Senior: KES 286.51M | Mezzanine: KES 75.00M | Pool: KES 475.87M
                // Note: Bullet structure - Principal paid at maturity, only interest monthly
                createOrUpdateChart('reportTranchePaymentsChart', {
                    type: 'bar',
                    data: {
                        labels: ['Statutory\n& Fees', 'Class A\nTotal Cashflow\n(14% XIRR)', 'Class A\nPrincipal\n(at maturity)', 'Class B\nTotal Cashflow\n(14.5% XIRR)', 'Class B\nPrincipal\n(at maturity)', 'Liquidity\nReimbursement', 'Residual'],
                        datasets: [{
                            label: 'Amount (KES M)',
                            data: [2.5, 3.35, 0, 0.91, 0, 0, 3.2],
                            backgroundColor: [
                                '#9CA3AF',
                                '#3B82F6',
                                '#2563EB',
                                '#8B5CF6',
                                '#7C3AED',
                                '#F59E0B',
                                '#10B981'
                            ],
                            borderColor: [
                                '#6B7280',
                                '#2563EB',
                                '#1D4ED8',
                                '#7C3AED',
                                '#6D28D9',
                                '#D97706',
                                '#059669'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Monthly Payments - Total Cashflow (Principal at Final Maturity)' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'KES Millions (Monthly)' }
                            }
                        }
                    }
                });

                // 3-Way Comparison: Actual vs Day 0 vs Demand
                createOrUpdateChart('reportThreeWayComparisonChart', {
                    type: 'line',
                    data: {
                        labels: ['Month 1', 'Month 3', 'Month 6', 'Month 9', 'Month 12', 'Month 14 (Current)'],
                        datasets: [
                            {
                                label: 'Day 0 Projected Collections',
                                data: [20.5, 21.0, 21.5, 21.8, 22.0, 22.3],
                                borderColor: '#9CA3AF',
                                backgroundColor: 'rgba(156, 163, 175, 0.1)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.3
                            },
                            {
                                label: 'Actual Collections',
                                data: [20.8, 21.2, 21.7, 21.5, 21.0, 21.2],
                                borderColor: '#14b8a6',
                                backgroundColor: 'rgba(20, 184, 166, 0.2)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Contractual Demand',
                                data: [19.5, 19.8, 20.0, 20.5, 21.0, 21.5],
                                borderColor: '#3B82F6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                borderDash: [10, 3],
                                fill: false,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: 'All Demands Met | Actual tracking close to Projections' }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 18,
                                max: 24,
                                title: { display: true, text: 'Collections (KES M)' }
                            }
                        }
                    }
                });

                // Update key metrics with actual data (ki platform PCC Series 1: Apollo Agriculture)
                document.getElementById('reportPoolSize').textContent = 'KES 475.87M';
                document.getElementById('reportTotalLoans').textContent = '12,450';
                document.getElementById('reportGNPA').textContent = '2.8%';
                document.getElementById('reportYield').textContent = '14.0%';
            }

            function generatePMAReport(txId) {
                const transaction = state.transactions.find(t => t.id === txId) || state.transactions[0];
                const reportMonth = document.getElementById('reportMonthSelector')?.value || '2025-11';
                const [year, month] = reportMonth.split('-');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const monthName = monthNames[parseInt(month) - 1];
                const reportDate = new Date().toLocaleDateString('en-KE', { day: '2-digit', month: 'long', year: 'numeric' });
                
                const reportContent = `
PORTFOLIO MONITORING AGENT LETTER
=====================================

${reportDate}

Required Recipients:
[Issuer Name]
[Security Trustee Name]
[Cash Manager Name]
[Senior Note Agent Name]
[Servicer Name]

Dear Required Recipients,

Re: Portfolio Monitoring Agent Services - ${transaction.name}

We, Kaleidofin Private Limited, in our capacity as the Portfolio Monitoring Agent, hereby provide this letter to the Required Recipients in accordance with Clause 3.1 (Services) and subject to, without limitation, Clause 7.1 (Portfolio Monitoring Agent limitation of liability) of the Portfolio Monitoring Agreement. This letter serves to specify the determinations and confirmations to be made by us for the reporting period ending ${monthName} ${year}, as outlined below:

1. CONSISTENCY AND CALCULATIONS
--------------------------------
We have reviewed the information provided in the Monthly Receivables Data Tape we received on ${reportDate} and compared it with the information in the systems used by the Servicer to service, administer, collect and manage the Portfolio Receivables which we have access to.

We hereby confirm that: NO MANIFEST ERRORS HAVE BEEN IDENTIFIED

The information in the Draft Servicer Report and Monthly Receivables Data Tape regarding Defaulted Receivables, Delinquent Receivables, and Repayment Speed is materially consistent with the information available in the Servicer's systems.

Additionally, we have calculated the following metrics:

   Current Month Collection Efficiency: 98.8%
   Cumulative Collection Efficiency: 97.5%
   Current Month Shortfall: 1.2%
   Cumulative Shortfall: 2.5%
   Repayment Speed: 8.5% CPR

Calculation Details:
- Collection Efficiency = (Actual Collections / Projected Collections) √ó 100
- Shortfall = ((Projected Collections - Actual Collections) / Projected Collections) √ó 100
- Repayment Speed = Annualized prepayment rate (CPR method)

Shortfall Bucket Distribution (Current Month):
   ‚Ä¢ 0-5% Shortfall: 8,450 loans (67.9%)
   ‚Ä¢ 5-20% Shortfall: 2,890 loans (23.2%)
   ‚Ä¢ 20-40% Shortfall: 890 loans (7.1%)
   ‚Ä¢ 40%+ Shortfall: 220 loans (1.8%)

Shortfall Bucket Distribution (Cumulative):
   ‚Ä¢ 0-5% Shortfall: 7,980 loans (64.1%)
   ‚Ä¢ 5-20% Shortfall: 3,120 loans (25.0%)
   ‚Ä¢ 20-40% Shortfall: 1,050 loans (8.4%)
   ‚Ä¢ 40%+ Shortfall: 300 loans (2.4%)

2. CONCENTRATION LIMITS
-----------------------
We confirm that the Portfolio Concentration Limits are satisfied with respect to the current portfolio composition.

Geographic Concentration:
   - Highest single county concentration: 26.4% (within limit)
   - Top 5 counties represent: 85.5% (within limit)

Product Concentration:
   - Highest single product: 45% (within limit)
   - Diversification index: Satisfactory

Status: ‚úì ALL CONCENTRATION LIMITS SATISFIED

3. DISCOUNTED BALANCE AND COLLECTIONS
--------------------------------------
Using the information in the Monthly Receivables Data Tape made available to us by the Servicer on ${reportDate}, we calculate that:

a) The Discounted Balance of all Portfolio Receivables (excluding Defaulted Receivables) is:
   KES 234.5M

b) Present Value Factor Applied: 0.952

c) Repayment Speed Applied: 8.5% CPR

d) Minimum Remaining Tenor Confirmation: All receivables have minimum remaining tenor of not shorter than 6 months ‚úì

e) Collections Reconciliation:
   - Collections specified in Draft Servicer Report: KES 21.2M
   - Amount in Transaction Account (as provided by Cash Manager): KES 21.2M
   - Difference: KES 0.00

Status: ‚úì RECONCILIATION COMPLETE - NO MATERIAL DIFFERENCES

4. SERVICER REPORT VALIDATION
------------------------------
We have liaised with the Servicer regarding the Monthly Servicer Report and confirm that we are reasonably satisfied with the form and content of the proposed Monthly Servicer Report for ${monthName} ${year}.

Status: ‚úì APPROVED FOR PUBLICATION

PORTFOLIO SUMMARY (as of Month-End)
------------------------------------
Pool Size: KES 234.5M
Number of Receivables: 4,850
Average Receivable Size: KES 48,350
Weighted Average Yield: 18.5%
Weighted Average Remaining Tenor: 18 months

Collection Efficiency & Shortfall Status:
- Current Month Collection Efficiency: 98.8%
- Cumulative Collection Efficiency: 97.5%
- Current Month Shortfall: 1.2%
- Cumulative Shortfall: 2.5%

Shortfall Bucket Distribution (Current Month):
- 0-5% Shortfall: 8,450 receivables (67.9%)
- 5-20% Shortfall: 2,890 receivables (23.2%)
- 20-40% Shortfall: 890 receivables (7.1%)
- 40%+ Shortfall: 220 receivables (1.8%)

Shortfall Bucket Distribution (Cumulative):
- 0-5% Shortfall: 7,980 receivables (64.1%)
- 5-20% Shortfall: 3,120 receivables (25.0%)
- 20-40% Shortfall: 1,050 receivables (8.4%)
- 40%+ Shortfall: 300 receivables (2.4%)

CONCLUSION
----------
Based on our review and analysis, we confirm that:
‚úì No manifest errors identified
‚úì All concentration limits satisfied
‚úì Collections properly reconciled
‚úì Servicer Report approved
‚úì Collection efficiency metrics within acceptable thresholds

Should you require any further information or clarification, please do not hesitate to contact us.

Yours faithfully,

_______________________________
[Portfolio Monitoring Agent Representative Name]
Kaleidofin Private Limited
Portfolio Monitoring Agent
Email: pma@kaleidofin.com
Date: ${reportDate}

---
CONFIDENTIAL - FOR AUTHORIZED RECIPIENTS ONLY
Next Report Due: 2 Business Days after next Month-End Servicer Report
`;

                return { content: reportContent, transaction, reportMonth, monthName, year };
            }

            function downloadPMAReportPDF(txId) {
                const {jsPDF} = window.jspdf;
                const reportData = generatePMAReport(txId);
                const doc = new jsPDF();
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('PORTFOLIO MONITORING AGENT LETTER', 105, 20, {align: 'center'});
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const lines = doc.splitTextToSize(reportData.content, 180);
                let y = 35;
                
                lines.forEach(line => {
                    if (y > 280) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(line, 15, y);
                    y += 5;
                });
                
                doc.save(`PMA_Letter_${reportData.transaction.name}_${reportData.monthName}_${reportData.year}.pdf`);
            }

            function previewPMAReport(txId) {
                const reportData = generatePMAReport(txId);
                document.getElementById('previewModalTitle').textContent = 'PMA Letter Preview - Visual Dashboard';
                
                // Create visual preview with charts and tables
                const previewHTML = `
                    <div class="space-y-6">
                        <!-- Header -->
                        <div class="bg-teal-50 p-4 rounded-lg border border-teal-200">
                            <h3 class="font-bold text-lg text-gray-900">Portfolio Monitoring Agent Report</h3>
                            <p class="text-sm text-gray-600">Transaction: ${reportData.transaction.name} | Period: ${reportData.monthName} ${reportData.year}</p>
                        </div>

                        <!-- 1. Tested Eligibility Criteria -->
                        <!-- 1. Key Calculations -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-3">1. Consistency and Calculations</h4>
                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div class="text-center p-3 bg-blue-50 rounded">
                                    <p class="text-xs text-gray-600 mb-1">Current Month Collection Efficiency</p>
                                    <p class="text-2xl font-bold text-blue-700">98.8%</p>
                                </div>
                                <div class="text-center p-3 bg-blue-50 rounded">
                                    <p class="text-xs text-gray-600 mb-1">Cumulative Collection Efficiency</p>
                                    <p class="text-2xl font-bold text-blue-700">97.5%</p>
                                </div>
                                <div class="text-center p-3 bg-orange-50 rounded">
                                    <p class="text-xs text-gray-600 mb-1">Current Month Shortfall</p>
                                    <p class="text-2xl font-bold text-orange-700">1.2%</p>
                                </div>
                                <div class="text-center p-3 bg-orange-50 rounded">
                                    <p class="text-xs text-gray-600 mb-1">Cumulative Shortfall</p>
                                    <p class="text-2xl font-bold text-orange-700">2.5%</p>
                                </div>
                            </div>
                            <div class="mt-4">
                                <p class="text-xs font-semibold text-gray-700 mb-2">Shortfall Bucket Distribution (Current Month):</p>
                                <div class="space-y-1 text-xs">
                                    <div class="flex items-center">
                                        <div class="w-24">0-5%</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-green-500 h-5 rounded" style="width: 67.9%"></div>
                                            <span class="absolute inset-0 flex items-center justify-center text-white font-bold">8,450 (67.9%)</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-24">5-20%</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-yellow-500 h-5 rounded" style="width: 23.2%"></div>
                                            <span class="absolute inset-0 flex items-center justify-start pl-2 text-gray-700 font-bold">2,890 (23.2%)</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-24">20-40%</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-orange-500 h-5 rounded" style="width: 7.1%"></div>
                                            <span class="absolute inset-0 flex items-center justify-start pl-2 text-gray-700 font-bold">890 (7.1%)</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-24">40%+</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-red-500 h-5 rounded" style="width: 1.8%"></div>
                                            <span class="absolute inset-0 flex items-center justify-start pl-2 text-gray-700 font-bold">220 (1.8%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-green-700 font-semibold mt-3">‚úì No manifest errors identified in Servicer data</p>
                        </div>

                        <!-- 2. Concentration Limits -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-3">2. Portfolio Concentration Limits</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span>Highest Single County Concentration</span>
                                    <span class="font-bold">26.4% <span class="text-green-600">(Limit: 30%)</span></span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span>Top 5 Counties Concentration</span>
                                    <span class="font-bold">85.5% <span class="text-green-600">(Limit: 90%)</span></span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span>Single Product Concentration</span>
                                    <span class="font-bold">45% <span class="text-green-600">(Limit: 50%)</span></span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span>Single Borrower Concentration</span>
                                    <span class="font-bold">0.12% <span class="text-green-600">(Limit: 2%)</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Discounted Balance & Collections -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-3">3. Discounted Balance and Collections Reconciliation</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="p-3 bg-gray-50 rounded">
                                    <p class="text-gray-600 mb-1">Discounted Balance (excl. Defaulted)</p>
                                    <p class="text-xl font-bold text-gray-900">KES 234.5M</p>
                                    <p class="text-xs text-gray-500 mt-1">PV Factor: 0.952 | CPR: 8.5%</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded">
                                    <p class="text-gray-600 mb-1">Collections Reconciliation</p>
                                    <p class="text-sm"><span class="font-medium">Servicer Report:</span> KES 21.2M</p>
                                    <p class="text-sm"><span class="font-medium">Transaction Account:</span> KES 21.2M</p>
                                    <p class="text-sm font-bold text-green-700 mt-1">Difference: KES 0.00 ‚úì</p>
                                </div>
                            </div>
                        </div>

                        <!-- 5. Portfolio Summary -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-3">Portfolio Summary (Month-End)</h4>
                            <div class="grid grid-cols-4 gap-3 text-sm text-center">
                                <div class="p-2 bg-teal-50 rounded">
                                    <p class="text-xs text-gray-600">Pool Size</p>
                                    <p class="text-lg font-bold text-teal-700">KES 234.5M</p>
                                </div>
                                <div class="p-2 bg-teal-50 rounded">
                                    <p class="text-xs text-gray-600">Total Loans</p>
                                    <p class="text-lg font-bold text-teal-700">4,850</p>
                                </div>
                                <div class="p-2 bg-teal-50 rounded">
                                    <p class="text-xs text-gray-600">Avg. Size</p>
                                    <p class="text-lg font-bold text-teal-700">KES 48K</p>
                                </div>
                                <div class="p-2 bg-teal-50 rounded">
                                    <p class="text-xs text-gray-600">WAY</p>
                                    <p class="text-lg font-bold text-teal-700">18.5%</p>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <p class="text-xs font-semibold text-gray-700 mb-2">Shortfall Bucket Distribution (Current Month):</p>
                                <div class="space-y-1 text-xs">
                                    <div class="flex items-center">
                                        <div class="w-24">0-5%</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-green-500 h-5 rounded" style="width: 67.9%"></div>
                                            <span class="absolute inset-0 flex items-center justify-center text-white font-bold">67.9%</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-24">5-20%</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-yellow-500 h-5 rounded" style="width: 23.2%"></div>
                                            <span class="absolute inset-0 flex items-center justify-start pl-2 text-gray-700 font-bold">23.2%</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-24">20-40%</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-orange-500 h-5 rounded" style="width: 7.1%"></div>
                                            <span class="absolute inset-0 flex items-center justify-start pl-2 text-gray-700 font-bold">7.1%</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-24">40%+</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-red-500 h-5 rounded" style="width: 1.8%"></div>
                                            <span class="absolute inset-0 flex items-center justify-start pl-2 text-gray-700 font-bold">1.8%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Replenished Loans Table -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-3">Replenished Loans This Month</h4>
                            <p class="text-sm text-gray-600 mb-3">Loans repaid/prepaid and replaced to maintain target pool size:</p>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full text-xs border-collapse">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="border p-2 text-left">Repaid Loan ID</th>
                                            <th class="border p-2 text-right">Repaid Amount</th>
                                            <th class="border p-2 text-center">Repaid Date</th>
                                            <th class="border p-2 text-left">New Loan ID</th>
                                            <th class="border p-2 text-right">New Amount</th>
                                            <th class="border p-2 text-center">Origination Date</th>
                                            <th class="border p-2 text-left">County</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="hover:bg-gray-50">
                                            <td class="border p-2">AGR-10245</td>
                                            <td class="border p-2 text-right">KES 45,200</td>
                                            <td class="border p-2 text-center">08-Nov-2025</td>
                                            <td class="border p-2 font-semibold text-blue-700">AGR-12891</td>
                                            <td class="border p-2 text-right font-semibold">KES 52,000</td>
                                            <td class="border p-2 text-center">12-Nov-2025</td>
                                            <td class="border p-2">Nairobi</td>
                                        </tr>
                                        <tr class="hover:bg-gray-50">
                                            <td class="border p-2">AGR-10312</td>
                                            <td class="border p-2 text-right">KES 38,500</td>
                                            <td class="border p-2 text-center">10-Nov-2025</td>
                                            <td class="border p-2 font-semibold text-blue-700">AGR-12892</td>
                                            <td class="border p-2 text-right font-semibold">KES 41,200</td>
                                            <td class="border p-2 text-center">13-Nov-2025</td>
                                            <td class="border p-2">Kiambu</td>
                                        </tr>
                                        <tr class="hover:bg-gray-50">
                                            <td class="border p-2">AGR-10489</td>
                                            <td class="border p-2 text-right">KES 62,800</td>
                                            <td class="border p-2 text-center">12-Nov-2025</td>
                                            <td class="border p-2 font-semibold text-blue-700">AGR-12893</td>
                                            <td class="border p-2 text-right font-semibold">KES 68,500</td>
                                            <td class="border p-2 text-center">15-Nov-2025</td>
                                            <td class="border p-2">Nakuru</td>
                                        </tr>
                                        <tr class="hover:bg-gray-50">
                                            <td class="border p-2">AGR-10556</td>
                                            <td class="border p-2 text-right">KES 28,900</td>
                                            <td class="border p-2 text-center">14-Nov-2025</td>
                                            <td class="border p-2 font-semibold text-blue-700">AGR-12894</td>
                                            <td class="border p-2 text-right font-semibold">KES 31,000</td>
                                            <td class="border p-2 text-center">16-Nov-2025</td>
                                            <td class="border p-2">Mombasa</td>
                                        </tr>
                                        <tr class="hover:bg-gray-50">
                                            <td class="border p-2">AGR-10623</td>
                                            <td class="border p-2 text-right">KES 51,200</td>
                                            <td class="border p-2 text-center">15-Nov-2025</td>
                                            <td class="border p-2 font-semibold text-blue-700">AGR-12895</td>
                                            <td class="border p-2 text-right font-semibold">KES 48,900</td>
                                            <td class="border p-2 text-center">17-Nov-2025</td>
                                            <td class="border p-2">Kisumu</td>
                                        </tr>
                                        <tr class="hover:bg-gray-50">
                                            <td class="border p-2">AGR-10701</td>
                                            <td class="border p-2 text-right">KES 44,600</td>
                                            <td class="border p-2 text-center">18-Nov-2025</td>
                                            <td class="border p-2 font-semibold text-blue-700">AGR-12896</td>
                                            <td class="border p-2 text-right font-semibold">KES 47,500</td>
                                            <td class="border p-2 text-center">19-Nov-2025</td>
                                            <td class="border p-2">Uasin Gishu</td>
                                        </tr>
                                        <tr class="hover:bg-gray-50">
                                            <td class="border p-2">AGR-10778</td>
                                            <td class="border p-2 text-right">KES 35,700</td>
                                            <td class="border p-2 text-center">20-Nov-2025</td>
                                            <td class="border p-2 font-semibold text-blue-700">AGR-12897</td>
                                            <td class="border p-2 text-right font-semibold">KES 39,800</td>
                                            <td class="border p-2 text-center">21-Nov-2025</td>
                                            <td class="border p-2">Machakos</td>
                                        </tr>
                                        <tr class="hover:bg-gray-50">
                                            <td class="border p-2">AGR-10845</td>
                                            <td class="border p-2 text-right">KES 59,400</td>
                                            <td class="border p-2 text-center">22-Nov-2025</td>
                                            <td class="border p-2 font-semibold text-blue-700">AGR-12898</td>
                                            <td class="border p-2 text-right font-semibold">KES 55,600</td>
                                            <td class="border p-2 text-center">23-Nov-2025</td>
                                            <td class="border p-2">Meru</td>
                                        </tr>
                                        <tr class="hover:bg-gray-50">
                                            <td class="border p-2">AGR-10912</td>
                                            <td class="border p-2 text-right">KES 48,300</td>
                                            <td class="border p-2 text-center">24-Nov-2025</td>
                                            <td class="border p-2 font-semibold text-blue-700">AGR-12899</td>
                                            <td class="border p-2 text-right font-semibold">KES 51,200</td>
                                            <td class="border p-2 text-center">25-Nov-2025</td>
                                            <td class="border p-2">Nyeri</td>
                                        </tr>
                                        <tr class="hover:bg-gray-50">
                                            <td class="border p-2">AGR-10989</td>
                                            <td class="border p-2 text-right">KES 41,500</td>
                                            <td class="border p-2 text-center">26-Nov-2025</td>
                                            <td class="border p-2 font-semibold text-blue-700">AGR-12900</td>
                                            <td class="border p-2 text-right font-semibold">KES 44,800</td>
                                            <td class="border p-2 text-center">27-Nov-2025</td>
                                            <td class="border p-2">Kajiado</td>
                                        </tr>
                                        <tr class="bg-gray-100 font-bold">
                                            <td class="border p-2">TOTAL</td>
                                            <td class="border p-2 text-right">KES 456,100</td>
                                            <td class="border p-2"></td>
                                            <td class="border p-2">10 New Loans</td>
                                            <td class="border p-2 text-right text-green-700">KES 480,500</td>
                                            <td class="border p-2"></td>
                                            <td class="border p-2"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="mt-4 grid grid-cols-3 gap-3 text-sm">
                                <div class="p-2 bg-gray-50 rounded text-center">
                                    <p class="text-xs text-gray-600">Loans Repaid</p>
                                    <p class="text-xl font-bold text-gray-800">10</p>
                                </div>
                                <div class="p-2 bg-green-50 rounded text-center">
                                    <p class="text-xs text-gray-600">Net Increase</p>
                                    <p class="text-xl font-bold text-green-700">KES 24.4K</p>
                                </div>
                                <div class="p-2 bg-blue-50 rounded text-center">
                                    <p class="text-xs text-gray-600">Growth Rate</p>
                                    <p class="text-xl font-bold text-blue-700">+5.4%</p>
                                </div>
                            </div>
                            <p class="text-xs text-green-700 font-semibold mt-3">‚úì All new loans meet eligibility criteria and ki score thresholds</p>
                            <p class="text-xs text-gray-500 italic mt-1">Note: Sample data shown. Full loan-level details in Monthly Receivables Data Tape.</p>
                        </div>

                        <!-- Conclusion -->
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h4 class="font-semibold text-green-900 mb-2">Conclusion - All Checks Passed</h4>
                            <ul class="text-sm text-green-800 space-y-1">
                                <li>‚úì No material breaches of eligibility criteria</li>
                                <li>‚úì No manifest errors identified</li>
                                <li>‚úì All concentration limits satisfied</li>
                                <li>‚úì Collections properly reconciled</li>
                                <li>‚úì All replenished loans tested and compliant</li>
                                <li>‚úì Servicer Report approved for publication</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                document.getElementById('reportPreviewContent').innerHTML = previewHTML;
                document.getElementById('reportPreviewModal').classList.add('active');
                document.getElementById('downloadFromPreview').onclick = () => downloadPMAReportPDF(txId);
            }

            function closeReportPreview() {
                document.getElementById('reportPreviewModal').classList.remove('active');
            }

            function generateCashManagerReport(txId) {
                const transaction = state.transactions.find(t => t.id === txId) || state.transactions[0];
                const reportMonth = document.getElementById('reportMonthSelector')?.value || '2025-11';
                const [year, month] = reportMonth.split('-');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const monthName = monthNames[parseInt(month) - 1];
                
                const reportContent = `
CASH MANAGER INVESTOR REPORT
==============================
Transaction: ${transaction.name}
Originator: ${transaction.originator}
Reporting Date: ${new Date().toLocaleDateString('en-KE')}
Reporting Period: ${monthName} ${year}
Collection Period: 01-${monthName.substring(0,3)}-${year} to ${new Date(year, month, 0).getDate()}-${monthName.substring(0,3)}-${year}
Payment Date: 01-Dec-2025

DEAL STRUCTURE: ki platform PCC Series 1 - Apollo Agriculture
---------------------------------------------------------------
Issuer: ki platform PCC (Mauritius Protected Cell Company)
Originator: Apollo Agriculture Limited (Kenya)
Servicer: Apollo Agriculture Limited (Kenya)
Servicer Performance Guarantor: Apollo Agriculture, Inc. (Parent Company)

RECEIVABLES PORTFOLIO SUMMARY
------------------------------
Pool Cashflows: KES 475.87M (incl. overcollateralization)
Senior Notes (Class A): KES 286.51M | Expected XIRR: 14.00%
Mezzanine Notes (Class B): KES 75.00M | Expected XIRR: 14.50%
Overcollateralization: KES 95.17M (20% of pool)
Junior Liquidity Facility: KES 57.10M (12% of pool - Fixed Deposit)

Total Credit Enhancement: 32% (20% OC + 12% JLF)

Number of Active Loans: 12,450
Transaction Structure: ${transaction.structure}
Legal Final Maturity: 10-Nov-2026
Expected Final Maturity: Aug-2026 (Senior), Sep-2026 (Mezz)

CASH FLOW SUMMARY (THIS MONTH)
-------------------------------
Opening Pool Balance: KES 475.87M

Inflows:
- Total Cashflow Collections: KES 43.3M
- Fees & Other Income: KES 1.5M
Total Inflows: KES 44.8M

Outflows (Monthly - Bullet Structure):
- Statutory & Regulatory Dues: KES 0.8M
- Trustee & Service Provider Fees: KES 1.7M
- Total Cashflow Payment to Senior Notes: KES 3.35M (14% XIRR)
- Total Cashflow Payment to Mezzanine Notes: KES 0.91M (14.5% XIRR)
- Residual to Originator: KES 3.2M
Total Monthly Outflows: KES 9.96M

Note: Principal payments (Senior KES 286.51M, Mezz KES 75M) due at Legal Final Maturity (10-Nov-2026)
Junior Liquidity Facility (KES 57.10M) available if needed at maturity

PRIORITY OF PAYMENTS (WATERFALL) - As per Term Sheet
------------------------------------------------------
Available Receipts This Period: KES 44.8M

TILL SENIOR NOTES OUTSTANDING:

1. Statutory and Regulatory Dues: KES 0.8M ‚úì PAID IN FULL
   - Government taxes and compliance fees

2. Trustee & Service Provider Fees: KES 1.7M ‚úì PAID IN FULL
   - Trustee Fees: KES 0.45M
   - Servicer Fees: KES 0.95M
   - Independent Credit Platform (Kaleidofin): KES 0.30M

3. Expected Total Cashflow Payout to Senior Notes: KES 3.35M ‚úì PAID IN FULL
   - Expected XIRR: 14.00% p.a.
   - Contractual Amount Due: KES 3.35M
   - Amount Paid: KES 3.35M
   - Shortfall: KES 0.00

4. Expected Senior Notes Principal: KES 0.00 (Due at Final Maturity Only)
   - Original Balance: KES 286.51M
   - Outstanding Balance: KES 286.51M
   - Payment Due Date: 10-Nov-2026 (Legal Final Maturity)
   - Note: Bullet structure - no monthly principal payments

5. Overdue Senior Principal (if any): KES 0.00
   - Only applicable on/after Final Maturity Date

6. Overdue Senior Cashflow (if any): KES 0.00
   
ON PAYMENT OF SENIOR NOTES IN FULL:

7. Expected Total Cashflow Payout to Mezzanine Notes: KES 0.91M ‚úì PAID IN FULL
   - Expected XIRR: 14.50% p.a.
   - Contractual Amount Due: KES 0.91M
   - Amount Paid: KES 0.91M

8. Expected Mezzanine Notes Principal: KES 0.00 (Due at Final Maturity Only)
   - Original Balance: KES 75.00M
   - Outstanding Balance: KES 75.00M
   - Payment Due Date: 10-Nov-2026 (Legal Final Maturity)
   - Note: Bullet structure - no monthly principal payments

9. Reimbursement of Junior Liquidity Facility: KES 0.00
   - Facility Amount: KES 57.10M (Fixed Deposit)
   - Drawn to Date: KES 0.00
   - To be reimbursed if drawn

ON PAYMENT OF SENIOR AND MEZZANINE NOTES IN FULL:

10. Residual to Originator (Residual Beneficiary): KES 3.2M ‚úì PAID
    - All excess cashflows after senior obligations

CREDIT ENHANCEMENT STRUCTURE
-----------------------------
Total Credit Enhancement: 32.0% of Pool Cashflows

Components:
1. Overcollateralization: KES 95.17M (20.0% of Pool)
   - Pool Cashflows: KES 475.87M
   - Investment Amount (Senior + Mezz): KES 361.51M
   - Overcollateralization: KES 95.17M
   - Status: ‚úì FULLY IN PLACE

2. Junior Liquidity Facility: KES 57.10M (12.0% of Pool)
   - Fixed Deposit by Originator
   - Placed prior to transaction settlement
   - Available on Legal Final Maturity Date if collections insufficient
   - Priority: First to Senior Notes, then to Mezzanine Notes
   - Status: ‚úì FULLY FUNDED

Credit Enhancement Tracking:
- Initial Credit Enhancement (Day 0): 32.0%
- Current Credit Enhancement: 32.0%
- Change from Day 0: 0.0% (STABLE)
- Minimum Required (Assumed): 15.0%
- Buffer Above Minimum: 17.0%
- Status: ‚úì WELL ABOVE MINIMUM

Credit Enhancement Status & Protection Mechanisms:
- Current Total CE: 32.0%
- Early Amortization Trigger (Typical 10% CE): ‚úì NOT BREACHED (+22.0% buffer)
- Status: ‚úì WELL PROTECTED

Servicer Performance Guarantee: ‚úì IN PLACE
   Guarantor: Apollo Agriculture, Inc. (Parent Company)
   Coverage: Irrevocable and unconditional performance guarantee
   Scope: (i) Infuse resources to ensure proper servicing
          (ii) Step in and assume servicing obligations if needed
          (iii) Liable for losses arising from servicer failure
          (iv) Ensure continuity including appointing replacement servicer
   Duration: Until legal final maturity or full discharge of obligations

Note: The term sheet does not define specific CE trigger levels (e.g., "Trigger 1, 2, 3").
      Protection is structural via 20% OC + 12% JLF, not covenant-based triggers.

Month-on-Month Credit Enhancement Trend:
- 3 Months Ago: 32.0%
- 2 Months Ago: 32.0%
- Last Month: 32.0%
- This Month: 32.0%
- Trend: ‚Üí STABLE (Structural, not performance-based)

INVESTOR ALLOCATIONS (Bullet Structure)
-----------------------------------------
Senior Tranche (Class A):
- Original Balance: KES 286.51M
- Current Outstanding: KES 286.51M (100% - no amortization)
- Expected XIRR: 14.00% p.a.
- This Month Total Cashflow: KES 3.35M
- Principal Payment: KES 0.00 (Due at Final Maturity: 10-Nov-2026)
- Status: Cashflow payments current ‚úì

Mezzanine Tranche (Class B):
- Original Balance: KES 75.00M
- Current Outstanding: KES 75.00M (100% - no amortization)
- Expected XIRR: 14.50% p.a. (Senior XIRR + 50 bps)
- This Month Total Cashflow: KES 0.91M
- Principal Payment: KES 0.00 (Due at Final Maturity: 10-Nov-2026)
- Status: Cashflow payments current ‚úì

Note: Bullet payment structure - Full principal due at Legal Final Maturity
      Liquidity Facility available if pool collections insufficient at maturity

TESTS (COVENANT COMPLIANCE)
----------------------------
Test Name                         | Actual  | Threshold | Status
----------------------------------|---------|-----------|----------
Cumulative Collection Efficiency  | 97.5%   | ‚â• 95.0%   | ‚úì PASS
Current Month Collection Efficiency| 98.8%   | ‚â• 95.0%   | ‚úì PASS
Cumulative Shortfall              | 2.5%    | ‚â§ 5.0%    | ‚úì PASS
Current Month Shortfall           | 1.2%    | ‚â§ 5.0%    | ‚úì PASS

All Tests: ‚úì PASSED

PORTFOLIO PERFORMANCE
---------------------
Weighted Average Coupon: 18.5%
Current Month Collection Efficiency: 98.8%
Cumulative Collection Efficiency: 97.5%
Current Month Shortfall: 1.2%
Cumulative Shortfall: 2.5%
Prepayment Rate (CPR): 8.5% annualized

Shortfall Bucket Distribution (Current Month):
   ‚Ä¢ 0-5% Shortfall: 8,450 loans (67.9%)
   ‚Ä¢ 5-20% Shortfall: 2,890 loans (23.2%)
   ‚Ä¢ 20-40% Shortfall: 890 loans (7.1%)
   ‚Ä¢ 40%+ Shortfall: 220 loans (1.8%)

Shortfall Bucket Distribution (Cumulative):
   ‚Ä¢ 0-5% Shortfall: 7,980 loans (64.1%)
   ‚Ä¢ 5-20% Shortfall: 3,120 loans (25.0%)
   ‚Ä¢ 20-40% Shortfall: 1,050 loans (8.4%)
   ‚Ä¢ 40%+ Shortfall: 300 loans (2.4%)

COMPARISON: ACTUAL VS INITIAL PROJECTIONS
------------------------------------------
At Deal Execution (Day 0), projected cashflows for Month 14:

Metric                    | Initial Projection | Actual This Month | Variance
--------------------------|-------------------|-------------------|----------
Principal Collections     | KES 18.8M        | KES 18.0M        | -4.3%
Interest Collections      | KES 3.5M         | KES 3.2M         | -8.6%
Total Collections         | KES 22.3M        | KES 21.2M        | -4.9%
Collection Efficiency     | 97.5%            | 98.8%            | +1.3pp
GNPA                      | 3.8%             | 3.2%             | -0.6pp
Pool Balance              | KES 238.5M       | KES 234.5M       | -1.7%

Overall Performance vs Projections: BETTER THAN EXPECTED (Lower GNPA, Higher CE)
Cumulative Pool Performance: ON TRACK (98.3% of projected balance)

COMPARISON: ACTUAL VS CONTRACTUAL DEMANDS
------------------------------------------
Contractual payment obligations for this period:

Payment Obligation        | Contractual Demand | Actual Paid | Status
--------------------------|-------------------|-------------|--------
Senior Notes Interest     | KES 6.2M         | KES 6.2M   | ‚úì PAID IN FULL
Senior Notes Principal    | KES 8.8M         | KES 8.8M   | ‚úì PAID IN FULL
Mezzanine Interest        | KES 1.8M         | KES 1.8M   | ‚úì PAID IN FULL
Mezzanine Principal       | KES 1.5M         | KES 1.5M   | ‚úì PAID IN FULL
Senior Fees & Expenses    | KES 1.2M         | KES 1.2M   | ‚úì PAID IN FULL
Reserve Account Target    | KES 5.0M         | KES 5.0M   | ‚úì MET

All Contractual Demands: ‚úì SATISFIED IN FULL
No Shortfalls or Deferrals

UPCOMING OBLIGATIONS
--------------------
Next Payment Date: 01-Jan-2026
Expected Collections: KES 20.5M
Expected Interest Payment: KES 7.8M
Expected Principal Payment: KES 10.0M

COMPLIANCE & COVENANTS
----------------------
‚úì All financial covenants met
‚úì All documentation current
‚úì Reserve accounts fully funded
‚úì No events of default

NOTES
-----
- All payments made on scheduled payment date
- No delays or deferrals
- Portfolio performing within expected parameters
- Credit enhancement levels maintained

---
Report Prepared by: KI Platform - Cash Management Services
Next Report Date: 01-Jan-2026
Contact: cashmanagement@kaleidofin.com
`;

                return { content: reportContent, transaction, reportMonth, monthName, year };
            }

            function downloadCashManagerReportPDF(txId) {
                const {jsPDF} = window.jspdf;
                const reportData = generateCashManagerReport(txId);
                const doc = new jsPDF();
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('CASH MANAGER INVESTOR REPORT', 105, 20, {align: 'center'});
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const lines = doc.splitTextToSize(reportData.content, 180);
                let y = 35;
                
                lines.forEach(line => {
                    if (y > 280) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(line, 15, y);
                    y += 5;
                });
                
                doc.save(`CashManager_Report_${reportData.transaction.name}_${reportData.monthName}_${reportData.year}.pdf`);
            }

            function previewCashReport(txId) {
                const reportData = generateCashManagerReport(txId);
                document.getElementById('previewModalTitle').textContent = 'Cash Manager Investor Report - Visual Dashboard';
                
                const previewHTML = `
                    <div class="space-y-6">
                        <!-- Header -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h3 class="font-bold text-lg text-gray-900">Cash Manager Investor Report</h3>
                            <p class="text-sm text-gray-600">Transaction: ${reportData.transaction.name} | Period: ${reportData.monthName} ${reportData.year}</p>
                        </div>

                        <!-- Priority of Payments Waterfall with Tranches -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-3">Priority of Payments (Waterfall)</h4>
                            <p class="text-sm font-medium mb-3">Available Receipts: <span class="text-teal-700 text-lg">KES 22.0M</span></p>
                            
                            <div class="space-y-2 text-sm">
                                <div class="p-3 bg-gray-50 rounded border-l-4 border-gray-400">
                                    <div class="flex justify-between font-semibold mb-1">
                                        <span>1. Senior Fees & Expenses</span>
                                        <span class="text-gray-700">KES 1.2M ‚úì</span>
                                    </div>
                                    <div class="text-xs text-gray-600 ml-4 space-y-0.5">
                                        <div>‚Ä¢ Cash Manager: KES 0.38M</div>
                                        <div>‚Ä¢ Servicer: KES 0.62M</div>
                                        <div>‚Ä¢ Other: KES 0.20M</div>
                                    </div>
                                </div>

                                <div class="p-3 bg-blue-50 rounded border-l-4 border-blue-500">
                                    <div class="flex justify-between font-semibold mb-1">
                                        <span>2. Senior Notes (Class A) - Interest</span>
                                        <span class="text-blue-700">KES 6.2M ‚úì</span>
                                    </div>
                                    <div class="text-xs text-gray-600 ml-4 space-y-0.5">
                                        <div>‚Ä¢ Contractual Due: KES 6.2M</div>
                                        <div>‚Ä¢ Paid: KES 6.2M</div>
                                        <div>‚Ä¢ Shortfall: KES 0.00</div>
                                    </div>
                                </div>

                                <div class="p-3 bg-blue-50 rounded border-l-4 border-blue-500">
                                    <div class="flex justify-between font-semibold mb-1">
                                        <span>3. Senior Notes (Class A) - Principal</span>
                                        <span class="text-blue-700">KES 8.8M ‚úì</span>
                                    </div>
                                    <div class="text-xs text-gray-600 ml-4 space-y-0.5">
                                        <div>‚Ä¢ Scheduled Amortization: KES 8.8M</div>
                                        <div>‚Ä¢ Paid: KES 8.8M</div>
                                        <div>‚Ä¢ Shortfall: KES 0.00</div>
                                    </div>
                                </div>

                                <div class="p-3 bg-indigo-50 rounded border-l-4 border-indigo-500">
                                    <div class="flex justify-between font-semibold mb-1">
                                        <span>4. Mezzanine Notes (Class B) - Interest</span>
                                        <span class="text-indigo-700">KES 1.8M ‚úì</span>
                                    </div>
                                    <div class="text-xs text-gray-600 ml-4 space-y-0.5">
                                        <div>‚Ä¢ Contractual Due: KES 1.8M</div>
                                        <div>‚Ä¢ Paid: KES 1.8M</div>
                                        <div>‚Ä¢ Shortfall: KES 0.00</div>
                                    </div>
                                </div>

                                <div class="p-3 bg-indigo-50 rounded border-l-4 border-indigo-500">
                                    <div class="flex justify-between font-semibold mb-1">
                                        <span>5. Mezzanine Notes (Class B) - Principal</span>
                                        <span class="text-indigo-700">KES 1.5M ‚úì</span>
                                    </div>
                                    <div class="text-xs text-gray-600 ml-4 space-y-0.5">
                                        <div>‚Ä¢ Scheduled Amortization: KES 1.5M</div>
                                        <div>‚Ä¢ Paid: KES 1.5M</div>
                                        <div>‚Ä¢ Shortfall: KES 0.00</div>
                                    </div>
                                </div>

                                <div class="p-3 bg-yellow-50 rounded border-l-4 border-yellow-500">
                                    <div class="flex justify-between font-semibold mb-1">
                                        <span>6. Reserve Account Top-up</span>
                                        <span class="text-yellow-700">KES 1.2M ‚úì</span>
                                    </div>
                                    <div class="text-xs text-gray-600 ml-4">
                                        <div>Target: KES 5.0M | Funded: KES 1.2M</div>
                                    </div>
                                </div>

                                <div class="p-3 bg-green-50 rounded border-l-4 border-green-500">
                                    <div class="flex justify-between font-semibold">
                                        <span>7. Residual to Junior/Originator</span>
                                        <span class="text-green-700">KES 1.3M ‚úì</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Credit Enhancement Status -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-3">Credit Enhancement & Triggers</h4>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="p-3 bg-teal-50 rounded">
                                    <p class="text-xs text-gray-600 mb-1">Current Credit Enhancement</p>
                                    <p class="text-3xl font-bold text-teal-700">15.5%</p>
                                    <p class="text-xs text-green-600 mt-1">‚Üë +0.5% vs Day 0</p>
                                </div>
                                <div class="p-3 bg-blue-50 rounded">
                                    <p class="text-xs text-gray-600 mb-1">Buffer Above Minimum</p>
                                    <p class="text-3xl font-bold text-blue-700">3.5%</p>
                                    <p class="text-xs text-gray-600 mt-1">Min Required: 12.0%</p>
                                </div>
                            </div>

                            <div class="mb-4">
                                <p class="text-xs font-semibold text-gray-700 mb-2">Credit Enhancement Status:</p>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between p-2 bg-green-50 rounded">
                                        <span>Overcollateralization (20%)</span>
                                        <span class="font-bold text-green-700">KES 95.17M ‚úì IN PLACE</span>
                                    </div>
                                    <div class="flex justify-between p-2 bg-green-50 rounded">
                                        <span>Junior Liquidity Facility (12%)</span>
                                        <span class="font-bold text-green-700">KES 57.10M ‚úì FUNDED</span>
                                    </div>
                                    <div class="flex justify-between p-2 bg-green-50 rounded">
                                        <span>Total CE (32%)</span>
                                        <span class="font-bold text-green-700">‚úì STRUCTURAL PROTECTION</span>
                                    </div>
                                    <div class="flex justify-between p-2 bg-blue-50 rounded border border-blue-200">
                                        <span>Servicer Performance Guarantee</span>
                                        <span class="font-bold text-blue-700">‚úì Apollo Inc (Parent)</span>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600 mt-2 italic">Note: Term sheet does not define specific trigger levels. Protection is structural.</p>
                            </div>

                            <div>
                                <p class="text-xs font-semibold text-gray-700 mb-2">Month-on-Month Trend:</p>
                                <div class="flex items-end justify-between h-24 bg-gray-50 rounded p-2">
                                    <div class="flex flex-col items-center flex-1">
                                        <div class="bg-teal-500 w-8 rounded-t" style="height: 74%"></div>
                                        <span class="text-xs mt-1">-3M</span>
                                        <span class="text-xs font-bold">14.8%</span>
                                    </div>
                                    <div class="flex flex-col items-center flex-1">
                                        <div class="bg-teal-500 w-8 rounded-t" style="height: 80%"></div>
                                        <span class="text-xs mt-1">-2M</span>
                                        <span class="text-xs font-bold">15.1%</span>
                                    </div>
                                    <div class="flex flex-col items-center flex-1">
                                        <div class="bg-teal-600 w-8 rounded-t" style="height: 87%"></div>
                                        <span class="text-xs mt-1">-1M</span>
                                        <span class="text-xs font-bold">15.3%</span>
                                    </div>
                                    <div class="flex flex-col items-center flex-1">
                                        <div class="bg-teal-700 w-8 rounded-t" style="height: 100%"></div>
                                        <span class="text-xs mt-1">Now</span>
                                        <span class="text-xs font-bold">15.5%</span>
                                    </div>
                                </div>
                                <p class="text-xs text-green-600 font-semibold mt-2 text-center">‚Üë IMPROVING (+0.7% over 3 months)</p>
                            </div>
                        </div>

                        <!-- Tests -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-3">Covenant Tests</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between p-2 bg-green-50 rounded">
                                    <span>Cumulative Collection Efficiency: <strong>97.5%</strong></span>
                                    <span class="text-green-700 font-bold">‚úì PASS (‚â•95%)</span>
                                </div>
                                <div class="flex justify-between p-2 bg-green-50 rounded">
                                    <span>Current Month Collection Efficiency: <strong>98.8%</strong></span>
                                    <span class="text-green-700 font-bold">‚úì PASS (‚â•95%)</span>
                                </div>
                                <div class="flex justify-between p-2 bg-green-50 rounded">
                                    <span>Cumulative Shortfall: <strong>2.5%</strong></span>
                                    <span class="text-green-700 font-bold">‚úì PASS (‚â§5%)</span>
                                </div>
                                <div class="flex justify-between p-2 bg-green-50 rounded">
                                    <span>Current Month Shortfall: <strong>1.2%</strong></span>
                                    <span class="text-green-700 font-bold">‚úì PASS (‚â§5%)</span>
                                </div>
                            </div>
                            <p class="text-xs text-green-700 font-semibold mt-3">All Tests: ‚úì PASSED</p>
                        </div>

                        <!-- Shortfall Bucket Distribution -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-3">Shortfall Bucket Distribution</h4>
                            <div class="mb-4">
                                <p class="text-xs font-semibold text-gray-700 mb-2">Current Month:</p>
                                <div class="space-y-1 text-xs">
                                    <div class="flex items-center">
                                        <div class="w-24">0-5%</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-green-500 h-5 rounded" style="width: 67.9%"></div>
                                            <span class="absolute inset-0 flex items-center justify-center text-white font-bold">8,450 (67.9%)</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-24">5-20%</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-yellow-500 h-5 rounded" style="width: 23.2%"></div>
                                            <span class="absolute inset-0 flex items-center justify-start pl-2 text-gray-700 font-bold">2,890 (23.2%)</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-24">20-40%</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-orange-500 h-5 rounded" style="width: 7.1%"></div>
                                            <span class="absolute inset-0 flex items-center justify-start pl-2 text-gray-700 font-bold">890 (7.1%)</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-24">40%+</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-red-500 h-5 rounded" style="width: 1.8%"></div>
                                            <span class="absolute inset-0 flex items-center justify-start pl-2 text-gray-700 font-bold">220 (1.8%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <p class="text-xs font-semibold text-gray-700 mb-2">Cumulative:</p>
                                <div class="space-y-1 text-xs">
                                    <div class="flex items-center">
                                        <div class="w-24">0-5%</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-green-500 h-5 rounded" style="width: 64.1%"></div>
                                            <span class="absolute inset-0 flex items-center justify-center text-white font-bold">7,980 (64.1%)</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-24">5-20%</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-yellow-500 h-5 rounded" style="width: 25.0%"></div>
                                            <span class="absolute inset-0 flex items-center justify-start pl-2 text-gray-700 font-bold">3,120 (25.0%)</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-24">20-40%</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-orange-500 h-5 rounded" style="width: 8.4%"></div>
                                            <span class="absolute inset-0 flex items-center justify-start pl-2 text-gray-700 font-bold">1,050 (8.4%)</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-24">40%+</div>
                                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                                            <div class="bg-red-500 h-5 rounded" style="width: 2.4%"></div>
                                            <span class="absolute inset-0 flex items-center justify-start pl-2 text-gray-700 font-bold">300 (2.4%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actual vs Initial Projections -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-3">Actual vs Initial Projections (Deal Execution)</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="text-left p-2">Metric</th>
                                            <th class="text-right p-2">Projected</th>
                                            <th class="text-right p-2">Actual</th>
                                            <th class="text-right p-2">Variance</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-xs">
                                        <tr class="border-t">
                                            <td class="p-2">Principal Collections</td>
                                            <td class="text-right p-2">KES 18.8M</td>
                                            <td class="text-right p-2">KES 18.0M</td>
                                            <td class="text-right p-2 text-orange-600">-4.3%</td>
                                        </tr>
                                        <tr class="border-t">
                                            <td class="p-2">Interest Collections</td>
                                            <td class="text-right p-2">KES 3.5M</td>
                                            <td class="text-right p-2">KES 3.2M</td>
                                            <td class="text-right p-2 text-orange-600">-8.6%</td>
                                        </tr>
                                        <tr class="border-t">
                                            <td class="p-2">Collection Efficiency</td>
                                            <td class="text-right p-2">97.5%</td>
                                            <td class="text-right p-2">98.8%</td>
                                            <td class="text-right p-2 text-green-600">+1.3pp</td>
                                        </tr>
                                        <tr class="border-t">
                                            <td class="p-2">GNPA</td>
                                            <td class="text-right p-2">3.8%</td>
                                            <td class="text-right p-2">3.2%</td>
                                            <td class="text-right p-2 text-green-600">-0.6pp</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-sm font-semibold text-green-700 mt-3">Performance: BETTER THAN EXPECTED</p>
                        </div>

                        <!-- Actual vs Contractual Demands -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-3">Actual vs Contractual Demands</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between p-2 bg-green-50 rounded">
                                    <span>Senior Notes Interest (Demand: KES 6.2M)</span>
                                    <span class="text-green-700 font-bold">‚úì PAID KES 6.2M</span>
                                </div>
                                <div class="flex justify-between p-2 bg-green-50 rounded">
                                    <span>Senior Notes Principal (Demand: KES 8.8M)</span>
                                    <span class="text-green-700 font-bold">‚úì PAID KES 8.8M</span>
                                </div>
                                <div class="flex justify-between p-2 bg-green-50 rounded">
                                    <span>Mezzanine Interest (Demand: KES 1.8M)</span>
                                    <span class="text-green-700 font-bold">‚úì PAID KES 1.8M</span>
                                </div>
                                <div class="flex justify-between p-2 bg-green-50 rounded">
                                    <span>Mezzanine Principal (Demand: KES 1.5M)</span>
                                    <span class="text-green-700 font-bold">‚úì PAID KES 1.5M</span>
                                </div>
                            </div>
                            <p class="text-sm font-semibold text-green-700 mt-3">All Contractual Demands SATISFIED IN FULL</p>
                        </div>

                        <!-- Conclusion -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-900 mb-2">Compliance Summary</h4>
                            <ul class="text-sm text-blue-800 space-y-1">
                                <li>‚úì All financial covenants met</li>
                                <li>‚úì All contractual payments made in full</li>
                                <li>‚úì Reserve accounts fully funded</li>
                                <li>‚úì Credit enhancement above minimum</li>
                                <li>‚úì No events of default</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                document.getElementById('reportPreviewContent').innerHTML = previewHTML;
                document.getElementById('reportPreviewModal').classList.add('active');
                document.getElementById('downloadFromPreview').onclick = () => downloadCashManagerReportPDF(txId);
            }

            // Event listeners for reports
            document.getElementById('downloadPMAReport')?.addEventListener('click', () => {
                const txId = document.getElementById('reportsTransactionSelector')?.value || state.transactions.filter(t => t.covenantsSet)[0]?.id;
                if (txId) downloadPMAReportPDF(txId);
            });

            document.getElementById('previewPMAReport')?.addEventListener('click', () => {
                const txId = document.getElementById('reportsTransactionSelector')?.value || state.transactions.filter(t => t.covenantsSet)[0]?.id;
                if (txId) previewPMAReport(txId);
            });

            document.getElementById('downloadCashReport')?.addEventListener('click', () => {
                const txId = document.getElementById('reportsTransactionSelector')?.value || state.transactions.filter(t => t.covenantsSet)[0]?.id;
                if (txId) downloadCashManagerReportPDF(txId);
            });

            document.getElementById('previewCashReport')?.addEventListener('click', () => {
                const txId = document.getElementById('reportsTransactionSelector')?.value || state.transactions.filter(t => t.covenantsSet)[0]?.id;
                if (txId) previewCashReport(txId);
            });

            document.getElementById('reportsTransactionSelector')?.addEventListener('change', (e) => {
                renderReportsPage(e.target.value);
            });

            document.getElementById('reportMonthSelector')?.addEventListener('change', (e) => {
                const [year, month] = e.target.value.split('-');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const monthName = monthNames[parseInt(month) - 1];
                document.getElementById('reportPeriodDisplay').textContent = `${monthName} ${year}`;
                const startDate = `01-${monthName.substring(0,3)}-${year}`;
                const endDate = new Date(year, month, 0).getDate() + `-${monthName.substring(0,3)}-${year}`;
                document.getElementById('collectionPeriodDisplay').textContent = `${startDate} to ${endDate}`;
                const nextMonth = parseInt(month) === 12 ? 1 : parseInt(month) + 1;
                const nextYear = parseInt(month) === 12 ? parseInt(year) + 1 : year;
                document.getElementById('paymentDateDisplay').textContent = `01-${monthNames[nextMonth - 1].substring(0,3)}-${nextYear}`;
            });

            // Add event listeners for all chart toggle dropdowns
            const toggleIds = [
                'collectionEfficiencyViewToggle',
                'adjustedCollectionEfficiencyViewToggle',
                'shortfallViewToggle',
                'compositionAdjustedToggle',
                'geoAdjustedToggle',
                'vintageViewToggle',
                'vintageAdjustedToggle',
                'maturityViewToggle',
                'maturityAdjustedToggle'
            ];

            toggleIds.forEach(toggleId => {
                document.getElementById(toggleId)?.addEventListener('change', () => {
                    const txId = document.getElementById('reportsTransactionSelector')?.value || state.transactions.filter(t => t.covenantsSet)[0]?.id;
                    if (txId) renderReportsPage(txId);
                });
            });

            // Modal close event listeners
            document.getElementById('closePreviewModalX')?.addEventListener('click', closeReportPreview);
            document.getElementById('closePreviewModalBtn')?.addEventListener('click', closeReportPreview);
            document.getElementById('reportPreviewModal')?.addEventListener('click', (e) => {
                if (e.target.id === 'reportPreviewModal') {
                    closeReportPreview();
                }
            });

            transactionSelector.addEventListener('change', (e) => {
                renderCovenantMonitoringPage(e.target.value);
            });
             perfTransactionSelector.addEventListener('change', (e) => {
                renderPerformancePage(e.target.value);
            });
            impactTransactionSelector.addEventListener('change', (e) => {
                renderImpactPage(e.target.value);
            });


            function initializeMappingFields() {
                const container = document.getElementById('mappingFieldsContainer');
                const fields = ['loan_id', 'customer_id', 'customer_name', 'customer_dob', 'customer_gender', 'customer_location', 'principal_amount', 'disbursement_date', 'maturity_date', 'interest_rate', 'emi_amount', 'loan_cycle', 'collateral_type', 'collateral_value', 'bureau_score', 'dpd', 'last_payment_date', 'outstanding_principal', 'asset_make', 'asset_model'];
                let html = '<div class="grid grid-cols-2 gap-4"><span class="font-medium text-gray-500">Your File Column</span><span class="font-medium text-gray-500">KI Required Field</span></div>';
                fields.forEach(field => {
                    const formattedField = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    html += `<div class="grid grid-cols-2 gap-4 items-center p-2 bg-gray-50 rounded-md"><span class="text-sm">${field}</span><select class="block w-full rounded-md border-gray-300 shadow-sm text-sm"><option>${formattedField}</option></select></div>`;
                });
                container.innerHTML = html;
            }

            function initializeCountyMultiSelect() {
                 const counties = ["Mombasa", "Kwale", "Kilifi", "Tana River", "Lamu", "Taita-Taveta", "Garissa", "Wajir", "Mandera", "Marsabit", "Isiolo", "Meru", "Tharaka-Nithi", "Embu", "Kitui", "Machakos", "Makueni", "Nyandarua", "Nyeri", "Kirinyaga", "Murang'a", "Kiambu", "Turkana", "West Pokot", "Samburu", "Trans-Nzoia", "Uasin Gishu", "Elgeyo-Marakwet", "Nandi", "Baringo", "Laikipia", "Nakuru", "Narok", "Kajiado", "Kericho", "Bomet", "Kakamega", "Vihiga", "Bungoma", "Busia", "Siaya", "Kisumu", "Homa Bay", "Migori", "Kisii", "Nyamira", "Nairobi"];
                 const select = document.getElementById('countiesMultiSelect');
                 counties.forEach(county => {
                     const option = document.createElement('option');
                     option.value = county;
                     option.innerText = county;
                     select.appendChild(option);
                 });
                 countiesMultiSelect = new Choices(select, { removeItemButton: true });
                 countiesMultiSelect.setValue(['Baringo', 'Bomet', 'Bungoma', 'Busia', 'Elgeyo-Marakwet']);
            }
            
            // Dynamic Tranche Management
            let trancheCounter = 0;
            let creditEnhancementCounter = 0;
            
            function addTranche(name = null, size = null, coupon = null, rating = null) {
                try {
                    const trancheId = `tranche_${trancheCounter++}`;
                    const trancheName = name || `Class ${String.fromCharCode(65 + state.tranches.length)}`;
                    const trancheSize = size !== null ? size : (state.tranches.length === 0 ? 80 : 12);
                    const trancheCoupon = coupon !== null ? coupon : (state.tranches.length === 0 ? 14 : 18);
                    const trancheRating = rating || (state.tranches.length === 0 ? 'AAA' : 'AA');
                    
                    const tranche = { id: trancheId, name: trancheName, size: trancheSize, coupon: trancheCoupon, rating: trancheRating };
                    state.tranches.push(tranche);
                    
                    const container = document.getElementById('tranchesContainer');
                    if (!container) return;
                    
                    const trancheDiv = document.createElement('div');
                    trancheDiv.className = 'border rounded-lg p-3 bg-gray-50';
                    trancheDiv.id = trancheId;
                    trancheDiv.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-xs font-medium text-gray-600">${trancheName}</label>
                            <button class="removeTrancheBtn text-xs text-red-600 hover:text-red-800 font-semibold" data-tranche-id="${trancheId}">
                                Remove
                            </button>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs text-gray-500">Name:</label>
                                <input type="text" class="trancheNameInput w-full text-sm border-gray-300 rounded-md" value="${trancheName}" data-tranche-id="${trancheId}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Size (%):</label>
                                <input type="number" class="trancheSizeInput w-full text-sm border-gray-300 rounded-md" value="${trancheSize}" min="0" max="100" data-tranche-id="${trancheId}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Coupon (%):</label>
                                <input type="number" class="trancheCouponInput w-full text-sm border-gray-300 rounded-md" value="${trancheCoupon}" min="0" max="30" step="0.1" data-tranche-id="${trancheId}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Rating:</label>
                                <select class="trancheRatingInput w-full text-sm border-gray-300 rounded-md" data-tranche-id="${trancheId}">
                                    <option value="AAA" ${trancheRating === 'AAA' ? 'selected' : ''}>AAA</option>
                                    <option value="AA+" ${trancheRating === 'AA+' ? 'selected' : ''}>AA+</option>
                                    <option value="AA" ${trancheRating === 'AA' ? 'selected' : ''}>AA</option>
                                    <option value="AA-" ${trancheRating === 'AA-' ? 'selected' : ''}>AA-</option>
                                    <option value="A+" ${trancheRating === 'A+' ? 'selected' : ''}>A+</option>
                                    <option value="A" ${trancheRating === 'A' ? 'selected' : ''}>A</option>
                                    <option value="A-" ${trancheRating === 'A-' ? 'selected' : ''}>A-</option>
                                    <option value="BBB+" ${trancheRating === 'BBB+' ? 'selected' : ''}>BBB+</option>
                                    <option value="BBB" ${trancheRating === 'BBB' ? 'selected' : ''}>BBB</option>
                                </select>
                            </div>
                        </div>
                    `;
                    container.appendChild(trancheDiv);
                    
                    // Add event listeners
                    trancheDiv.querySelector('.removeTrancheBtn').addEventListener('click', () => removeTranche(trancheId));
                    trancheDiv.querySelector('.trancheNameInput').addEventListener('input', (e) => {
                        const t = state.tranches.find(t => t.id === trancheId);
                        if (t) {
                            t.name = e.target.value;
                            trancheDiv.querySelector('label').textContent = e.target.value;
                        }
                    });
                    trancheDiv.querySelector('.trancheSizeInput').addEventListener('input', updateTranchingStructure);
                    trancheDiv.querySelector('.trancheCouponInput').addEventListener('input', () => {
                        const t = state.tranches.find(t => t.id === trancheId);
                        if (t) t.coupon = parseFloat(trancheDiv.querySelector('.trancheCouponInput').value);
                    });
                    trancheDiv.querySelector('.trancheRatingInput').addEventListener('change', (e) => {
                        const t = state.tranches.find(t => t.id === trancheId);
                        if (t) t.rating = e.target.value;
                    });
                    
                    updateTranchingStructure();
                } catch (e) {
                    console.warn('Error adding tranche:', e);
                }
            }
            
            function removeTranche(trancheId) {
                try {
                    if (state.tranches.length <= 1) {
                        alert('At least one tranche is required.');
                        return;
                    }
                    state.tranches = state.tranches.filter(t => t.id !== trancheId);
                    const trancheEl = document.getElementById(trancheId);
                    if (trancheEl) trancheEl.remove();
                    updateTranchingStructure();
                } catch (e) {
                    console.warn('Error removing tranche:', e);
                }
            }
            
            function addCreditEnhancement(type = null, name = null, value = null, valueType = 'percentage') {
                try {
                    const ceId = `ce_${creditEnhancementCounter++}`;
                    const ceType = type || 'Overcollateralization';
                    const ceName = name || ceType;
                    const ceValue = value !== null ? value : (ceType === 'Overcollateralization' ? 20 : 2);
                    
                    const enhancement = { id: ceId, type: ceType, name: ceName, value: ceValue, valueType: valueType };
                    state.creditEnhancements.push(enhancement);
                    
                    const container = document.getElementById('creditEnhancementsContainer');
                    if (!container) return;
                    
                    const ceDiv = document.createElement('div');
                    ceDiv.className = 'border rounded-lg p-3 bg-gray-50';
                    ceDiv.id = ceId;
                    ceDiv.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-xs font-medium text-gray-600">${ceName}</label>
                            <button class="removeCEBtn text-xs text-red-600 hover:text-red-800 font-semibold" data-ce-id="${ceId}">
                                Remove
                            </button>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs text-gray-500">Type:</label>
                                <select class="ceTypeInput w-full text-sm border-gray-300 rounded-md" data-ce-id="${ceId}">
                                    <option value="Overcollateralization" ${ceType === 'Overcollateralization' ? 'selected' : ''}>Overcollateralization</option>
                                    <option value="Reserve Account" ${ceType === 'Reserve Account' ? 'selected' : ''}>Reserve Account</option>
                                    <option value="Junior Liquidity Facility" ${ceType === 'Junior Liquidity Facility' ? 'selected' : ''}>Junior Liquidity Facility</option>
                                    <option value="Servicer Performance Guarantee" ${ceType === 'Servicer Performance Guarantee' ? 'selected' : ''}>Servicer Performance Guarantee</option>
                                    <option value="Cash Trap" ${ceType === 'Cash Trap' ? 'selected' : ''}>Cash Trap</option>
                                    <option value="Other" ${ceType === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Name:</label>
                                <input type="text" class="ceNameInput w-full text-sm border-gray-300 rounded-md" value="${ceName}" data-ce-id="${ceId}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Value Type:</label>
                                <select class="ceValueTypeInput w-full text-sm border-gray-300 rounded-md" data-ce-id="${ceId}">
                                    <option value="percentage" ${valueType === 'percentage' ? 'selected' : ''}>Percentage (%)</option>
                                    <option value="amount" ${valueType === 'amount' ? 'selected' : ''}>Amount (KES)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Value:</label>
                                <input type="number" class="ceValueInput w-full text-sm border-gray-300 rounded-md" value="${ceValue}" min="0" step="0.1" data-ce-id="${ceId}">
                            </div>
                        </div>
                    `;
                    container.appendChild(ceDiv);
                    
                    // Add event listeners
                    ceDiv.querySelector('.removeCEBtn').addEventListener('click', () => removeCreditEnhancement(ceId));
                    ceDiv.querySelector('.ceTypeInput').addEventListener('change', (e) => {
                        const ce = state.creditEnhancements.find(ce => ce.id === ceId);
                        if (ce) {
                            ce.type = e.target.value;
                            if (ce.name === ce.type || ce.name.startsWith('New')) {
                                ce.name = e.target.value;
                                ceDiv.querySelector('.ceNameInput').value = e.target.value;
                                ceDiv.querySelector('label').textContent = e.target.value;
                            }
                        }
                    });
                    ceDiv.querySelector('.ceNameInput').addEventListener('input', (e) => {
                        const ce = state.creditEnhancements.find(ce => ce.id === ceId);
                        if (ce) {
                            ce.name = e.target.value;
                            ceDiv.querySelector('label').textContent = e.target.value;
                        }
                    });
                    ceDiv.querySelector('.ceValueTypeInput').addEventListener('change', (e) => {
                        const ce = state.creditEnhancements.find(ce => ce.id === ceId);
                        if (ce) ce.valueType = e.target.value;
                    });
                    ceDiv.querySelector('.ceValueInput').addEventListener('input', updateTranchingStructure);
                    
                    updateTranchingStructure();
                } catch (e) {
                    console.warn('Error adding credit enhancement:', e);
                }
            }
            
            function removeCreditEnhancement(ceId) {
                try {
                    state.creditEnhancements = state.creditEnhancements.filter(ce => ce.id !== ceId);
                    const ceEl = document.getElementById(ceId);
                    if (ceEl) ceEl.remove();
                    updateTranchingStructure();
                } catch (e) {
                    console.warn('Error removing credit enhancement:', e);
                }
            }
            
            // Tranching Structure Updates (Safe - only if elements exist)
            function updateTranchingStructure() {
                try {
                    const equitySizeEl = document.getElementById('equityTrancheSize');
                    const totalCELabel = document.getElementById('totalCELabel');
                    
                    // Calculate total tranche size
                    let totalTrancheSize = 0;
                    state.tranches.forEach(tranche => {
                        const sizeInput = document.querySelector(`.trancheSizeInput[data-tranche-id="${tranche.id}"]`);
                        if (sizeInput) {
                            const size = parseFloat(sizeInput.value || 0);
                            tranche.size = size;
                            totalTrancheSize += size;
                        }
                    });
                    
                    const equitySize = Math.max(0, 100 - totalTrancheSize);
                    if (equitySizeEl) {
                        equitySizeEl.textContent = `${equitySize.toFixed(1)}%`;
                    }
                    
                    // Calculate total credit enhancement
                    let totalCE = equitySize; // Subordination from equity
                    state.creditEnhancements.forEach(ce => {
                        const valueInput = document.querySelector(`.ceValueInput[data-ce-id="${ce.id}"]`);
                        const valueTypeInput = document.querySelector(`.ceValueTypeInput[data-ce-id="${ce.id}"]`);
                        if (valueInput && valueTypeInput) {
                            const value = parseFloat(valueInput.value || 0);
                            const valueType = valueTypeInput.value;
                            if (valueType === 'percentage') {
                                totalCE += value;
                            } else {
                                // For amount-based, convert to percentage (assuming pool value)
                                const poolValue = parseFloat(document.getElementById('poolValue')?.textContent.replace(/[^\d.]/g, '') || '780');
                                totalCE += (value / (poolValue * 10)) * 100; // Convert to percentage
                            }
                            ce.value = value;
                            ce.valueType = valueType;
                        }
                    });
                    
                    if (totalCELabel) {
                        totalCELabel.textContent = `${totalCE.toFixed(1)}%`;
                    }
                } catch (e) {
                    console.warn('Error updating tranching structure:', e);
                }
            }
            
            // Initialize tranching structure (safe - only if elements exist)
            function initializeTranchingStructure() {
                try {
                    const addTrancheBtn = document.getElementById('addTrancheBtn');
                    const addCEBtn = document.getElementById('addCreditEnhancementBtn');
                    
                    if (addTrancheBtn) {
                        addTrancheBtn.addEventListener('click', () => addTranche());
                    }
                    
                    if (addCEBtn) {
                        addCEBtn.addEventListener('click', () => addCreditEnhancement());
                    }
                    
                    // Initialize with default 2 tranches if container is empty
                    const tranchesContainer = document.getElementById('tranchesContainer');
                    if (tranchesContainer && tranchesContainer.children.length === 0) {
                        addTranche('Class A', 80, 14, 'AAA');
                        addTranche('Class B', 12, 18, 'AA');
                    }
                    
                    // Initialize with default 2 credit enhancements if container is empty
                    const ceContainer = document.getElementById('creditEnhancementsContainer');
                    if (ceContainer && ceContainer.children.length === 0) {
                        addCreditEnhancement('Overcollateralization', 'Overcollateralization', 20, 'percentage');
                        addCreditEnhancement('Reserve Account', 'Reserve Account', 2, 'percentage');
                    }
                    
                    // Initialize values
                    updateTranchingStructure();
                } catch (e) {
                    console.warn('Error initializing tranching structure:', e);
                }
            }
            
            // Collapsible Section Functionality (Safe - isolated, non-blocking)
            function setupCollapsibleSection(toggleBtnId, contentId, chevronId, defaultExpanded = true) {
                try {
                    const toggleBtn = document.getElementById(toggleBtnId);
                    const content = document.getElementById(contentId);
                    const chevron = document.getElementById(chevronId);
                    
                    if (!toggleBtn || !content || !chevron) return;
                    
                    let isExpanded = defaultExpanded;
                    if (!defaultExpanded) {
                        content.classList.add('hidden');
                        chevron.classList.add('rotate-180');
                    }
                    
                    toggleBtn.addEventListener('click', () => {
                        isExpanded = !isExpanded;
                        if (isExpanded) {
                            content.classList.remove('hidden');
                            chevron.classList.remove('rotate-180');
                        } else {
                            content.classList.add('hidden');
                            chevron.classList.add('rotate-180');
                        }
                    });
                } catch (e) {
                    console.warn('Error setting up collapsible section:', e);
                }
            }
            
            // Initialize collapsible sections (runs after main initialization)
            function initializeCollapsibleSections() {
                try {
                    // Only setup if elements exist (they may not be on current page)
                    setupCollapsibleSection('toggleFiltersSection', 'filtersContent', 'filtersChevron', true);
                    setupCollapsibleSection('toggleResultsSection', 'resultsContent', 'resultsChevron', true);
                    setupCollapsibleSection('toggleMonteCarloSection', 'monteCarloContent', 'monteCarloChevron', false);
                    setupCollapsibleSection('togglePostFinalizationSection', 'postFinalizationContent', 'postFinalizationChevron', true);
                    setupCollapsibleSection('toggleSimulationResultsSection', 'simulationResultsContent', 'simulationResultsChevron', true);
                    
                    // Setup collapsible for initial risk analytics (only if on pool creation page)
                    const initialRiskAnalytics = document.getElementById('initialRiskAnalytics');
                    if (initialRiskAnalytics && !document.getElementById('toggleRiskAnalytics')) {
                        const firstChild = initialRiskAnalytics.firstElementChild;
                        if (firstChild && firstChild.tagName !== 'BUTTON') {
                            const toggleBtn = document.createElement('button');
                            toggleBtn.id = 'toggleRiskAnalytics';
                            toggleBtn.className = 'w-full flex items-center justify-between p-6 text-left hover:bg-gray-50';
                            toggleBtn.innerHTML = `
                                <h3 class="text-xl font-bold text-gray-800">üìä Pre-Filter Risk Analytics</h3>
                                <svg id="riskAnalyticsChevron" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            `;
                            initialRiskAnalytics.insertBefore(toggleBtn, firstChild);
                            const riskContentWrapper = document.createElement('div');
                            riskContentWrapper.id = 'riskAnalyticsContent';
                            riskContentWrapper.className = 'px-6 pb-6';
                            while (initialRiskAnalytics.children.length > 1) {
                                riskContentWrapper.appendChild(initialRiskAnalytics.children[1]);
                            }
                            initialRiskAnalytics.appendChild(riskContentWrapper);
                            setupCollapsibleSection('toggleRiskAnalytics', 'riskAnalyticsContent', 'riskAnalyticsChevron', true);
                        }
                    }
                } catch (e) {
                    console.warn('Error initializing collapsible sections:', e);
                }
            }
            
            // Initial Load - Initialize data FIRST, then render views
            try {
            initializeData();
            initializeMappingFields();
            initializeCountyMultiSelect();
                updateMainView('dealScreen');
                showPage('dealScreenHomePage');
                updateHomeTab('originators');
            } catch (e) {
                console.error('Error during initial page load:', e);
                // Try to at least show the page even if initialization fails
                try {
                    if (dealScreenView) dealScreenView.classList.add('active');
                    if (dealScreenBtn) dealScreenBtn.classList.add('active');
                } catch (e2) {
                    console.error('Critical error - cannot initialize page:', e2);
                }
            }
            
            // Initialize non-critical features after a delay (ensures DOM is ready)
            setTimeout(() => {
                try {
                    initializeTranchingStructure();
                    initializeCollapsibleSections();
                } catch (e) {
                    console.warn('Error initializing non-critical features:', e);
                }
            }, 200);
        });
    </script>
</body>
</html>
